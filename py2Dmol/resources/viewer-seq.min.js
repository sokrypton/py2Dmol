!function(){"use strict";let e=null,t=-1,n=!0,i=null,s=!1,o=null,l=null,a=null,c=0;const r=15,d=new Map;let h={getRenderer:null,getObjectSelect:null,toggleChainResidues:null,setChainResiduesSelected:null,highlightAtom:null,highlightAtoms:null,clearHighlight:null,applySelection:null};function u(){const e=h.getRenderer?h.getRenderer():null;return e?.currentObjectName||null}function g(){const e=u();return e&&d.get(e)||null}function f(e){const t=u();t&&(e&&e.size>0?d.set(t,new Set(e)):d.delete(t))}function m(){s||(s=!0,requestAnimationFrame(()=>{s=!1,S()}))}function p(e,t){const n=t.getBoundingClientRect(),i=void 0!==e.clientX?e.clientX:e.touches&&e.touches[0]?e.touches[0].clientX:e.changedTouches[0].clientX,s=void 0!==e.clientY?e.clientY:e.touches&&e.touches[0]?e.touches[0].clientY:e.changedTouches[0].clientY,o=i-n.left,l=s-n.top,a=200/96;return{x:o*(t.width/a/n.width),y:l*(t.height/a/n.height)}}function x(e,t,n,i){if(!n||!n.selectableItems)return null;const s=t+c;let o=n.selectableItems;i||(o=o.filter(e=>"chain"===e.type));const l=o.filter(e=>"residue"===e.type||"ligand"===e.type),a=o.filter(e=>"chain"===e.type);for(const t of l){const n=t.bounds;if(e>=n.x&&e<n.x+n.width&&s>=n.y&&s<n.y+n.height)return t}for(const t of a){t.bounds;if(i){const i=n.chainLabelPositions?.find(e=>e.chainId===t.chainId);if(i&&e>=i.x&&e<i.x+i.width&&s>=i.y&&s<i.y+i.height)return t}else{const i=n.chainLabelPositions?.find(e=>e.chainId===t.chainId);if(i&&e>=i.x&&e<i.x+i.width&&s>=i.y&&s<i.y+i.height)return t}}return null}function I(e,t,n,i,s,o,l,a,c){let r,d;if(l){r=`rgb(${a.r}, ${a.g}, ${a.b})`;d=(.299*a.r+.587*a.g+.114*a.b)/255>.5?"#000000":"#ffffff"}else{const e={r:Math.round(.3*a.r+178.5),g:Math.round(.3*a.g+178.5),b:Math.round(.3*a.b+178.5)};r=`rgb(${e.r}, ${e.g}, ${e.b})`,d="#000000"}e.fillStyle=r,e.fillRect(n,i,s,o),e.fillStyle=d,e.font="12px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(t,n+s/2,i+o/2),l&&(e.strokeStyle="#000000",e.lineWidth=1,e.beginPath(),e.moveTo(n,i+o),e.lineTo(n+s,i+o),e.stroke())}function v(e,t,n,i,s,o,l,a,c){let r=l.r,d=l.g,h=l.b;a||(r=Math.round(r*c+255*(1-c)),d=Math.round(d*c+255*(1-c)),h=Math.round(h*c+255*(1-c))),e.fillStyle=`rgb(${r}, ${d}, ${h})`,e.fillRect(n,i,s,o),e.fillStyle="#000000",e.font="12px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(t,n+s/2,i+o/2),a&&(e.strokeStyle="#000000",e.lineWidth=1,e.beginPath(),e.moveTo(n,i+o),e.lineTo(n+s,i+o),e.stroke())}function y(e,t,n,i,s,o,l,a,c){let r=l.r,d=l.g,h=l.b;a||(r=Math.round(r*c+255*(1-c)),d=Math.round(d*c+255*(1-c)),h=Math.round(h*c+255*(1-c))),e.fillStyle=`rgb(${r}, ${d}, ${h})`,e.fillRect(n,i,s,o),e.fillStyle="#000000",e.font="9px monospace",e.textAlign="center",e.textBaseline="middle";const u=t.length>8?t.substring(0,7)+"â€¦":t;e.fillText(u,n+s/2,i+o/2),a&&(e.strokeStyle="#000000",e.lineWidth=1,e.beginPath(),e.moveTo(n,i+o),e.lineTo(n+s,i+o),e.stroke())}function S(){if(!e)return;const{canvas:t,ctx:n,allResidueData:i,chainBoundaries:s,layout:o,sortedPositionEntries:l}=e,a=h.getRenderer?h.getRenderer():null;if(!a)return;const d=200/96,u=t.width/d,f=t.height/d,m=o.fullContentHeight||f,p=f,x=Math.max(0,m-p);c=Math.max(0,Math.min(x,c)),n.clearRect(0,0,u,f);const S=a.selectionModel,w=g();let M;if(w&&w.size>0)M=w;else if(S&&S.positions&&S.positions.size>0)M=S.positions;else if(null===a.visibilityMask){const e=a.coords?a.coords.length:0;M=new Set;for(let t=0;t<e;t++)M.add(t)}else M=a.visibilityMask&&a.visibilityMask.size>0?a.visibilityMask:new Set;if(o.chainLabelPositions){let e=S?.chains,t=S?.selectionMode;if(null!==w){const n=a.currentObjectName,i=a.objectsData[n],s=i?.frames?.[0],o=new Set;if(s?.chains&&w)for(const e of w){const t=s.chains[e];t&&o.add(t)}e=o;const l=s?.chains?.length||0,c=w.size>0&&w.size<l,r=new Set(s?.chains||[]);t=o.size===r.size&&Array.from(o).every(e=>r.has(e))&&!c&&w.size>0?"default":"explicit"}for(const i of o.chainLabelPositions){const s=i.y-c;if(s+i.height<0||s>p)continue;const l=i.chainId,r=e?.has(l)||"default"===t&&(!e||0===e.size),d=a?.getChainColorForChainId?.(l)||{r:128,g:128,b:128};I(n,l,i.x,s,i.width,i.height,r,d,o.charHeight)}}if(o.residuePositions&&i){const e=a?.getAtomColor,t=a?._getEffectiveColorMode?.()||"auto";for(const i of o.residuePositions){const s=i.y-c;if(s+i.height<0||s>p)continue;const o=i.residueData;if(!o)continue;let l={r:128,g:128,b:128};if(-1===o.positionIndex)l=o.color||{r:240,g:240,b:240};else if(o.isLigandToken&&o.positionIndices&&o.positionIndices.length>0){const n=o.positionIndices[0];e&&!Number.isNaN(n)&&n>=0&&(l=a.getAtomColor(n,t))}else o.positionIndex>=0&&e&&!Number.isNaN(o.positionIndex)&&(l=a.getAtomColor(o.positionIndex,t));if(o.isLigandToken&&o.positionIndices){const e=o.positionIndices.some(e=>M.has(e));y(n,o.ligandName||"LIG",i.x,s,i.width,i.height,l,e,.3)}else if(-1===o.positionIndex)v(n,"-",i.x,s,i.width,i.height,l,!1,.3);else if(o.positionIndex>=0){const e=M.has(o.positionIndex);v(n,o.letter,i.x,s,i.width,i.height,l,e,.3)}}}!function(t,n,i,s,o){if(!e)return;const l=Math.max(0,o-s),a=l>0?c/l:0,d=Math.max(20,s/o*s),h=a*(s-d),u=n-r;t.fillStyle="#f0f0f0",t.fillRect(u,0,r,s),l>0?(t.fillStyle="#b0b0b0",t.fillRect(u+2,h,11,d)):(t.fillStyle="#d0d0d0",t.fillRect(u+2,0,11,s))}(n,u,0,p,m)}function w(){e&&(i=null,m())}function M(){if(!e)return;const t=h.getRenderer?h.getRenderer():null;if(!t)return;let n=new Set;const s=g();if(s&&s.size>0)n=new Set(s);else if(t.selectionModel&&t.selectionModel.positions&&t.selectionModel.positions.size>0)n=new Set(t.selectionModel.positions);else if(null===t.visibilityMask){const e=t.coords?t.coords.length:0;for(let t=0;t<e;t++)n.add(t)}else t.visibilityMask&&t.visibilityMask.size>0&&(n=new Set(t.visibilityMask));const o=s?s.size:0,l=n.size+o+(null===t?.visibilityMask?"all":"some");(l!==i||s)&&(i=l,m())}function b(){const e=h.getRenderer?h.getRenderer():null;if(!e||!e.canvas)return;o&&o.parentElement&&o.parentElement.removeChild(o),o=document.createElement("canvas"),o.id="highlightOverlay",o.style.position="absolute",o.style.pointerEvents="none",o.style.zIndex="10",o.style.left="0",o.style.top="0";const t=e.canvas.parentElement;t&&(t.style.position="relative",t.appendChild(o)),l=o.getContext("2d"),P()}function P(){const e=h.getRenderer?h.getRenderer():null;if(!(e&&o&&l&&e.canvas))return;const t=e.displayWidth||e.canvas.width,n=e.displayHeight||e.canvas.height;o.width=t,o.height=n,o.style.width=t+"px",o.style.height=n+"px";const i=e.canvas,s=i.parentElement;if(s){const e=s.getBoundingClientRect(),t=i.getBoundingClientRect(),n=t.left-e.left,l=t.top-e.top;o.style.left=n+"px",o.style.top=l+"px"}}window.SEQ={setCallbacks:function(e){if(h=Object.assign({},h,e),e.getRenderer){const e=h.getRenderer?h.getRenderer():null;e&&e.canvas&&b()}},buildView:function(){const s=document.getElementById("sequenceView");if(!s)return;i=null,e=null,s.innerHTML="";const o=h.getRenderer?h.getRenderer():null;if(!o)return;const l=h.getObjectSelect?h.getObjectSelect():null,d=l?.value||o?.currentObjectName;if(!d||!o)return;const u=o.objectsData[d];if(!u||!u.frames||0===u.frames.length)return;const I=o.currentFrame>=0?o.currentFrame:0,v=u.frames[I];if(!v||!v.coords||0===v.coords.length)return;const y=t>=0&&t<u.frames.length?u.frames[t]:null;if(y&&!function(e,t){if(!e||!t)return!0;function n(e){return e.position_names&&e.position_names.length>0?e.position_names.length:e.chains&&e.chains.length>0?e.chains.length:e.coords?Math.floor(e.coords.length/3):0}const i=n(e);if(i!==n(t))return!0;if(0===i)return!1;const s=e.position_names||[],o=t.position_names||[];if(s.length>0&&o.length>0)for(let e=0;e<Math.min(s.length,o.length,i);e++)if(s[e]!==o[e])return!0;const l=e.chains||[],a=t.chains||[];if(l.length>0&&a.length>0)for(let e=0;e<Math.min(l.length,a.length,i);e++)if(l[e]!==a[e])return!0;const c=e.position_types||[],r=t.position_types||[];if(c.length>0&&r.length>0)for(let e=0;e<Math.min(c.length,r.length,i);e++)if(c[e]!==r[e])return!0;return!1}(v,y)&&e)return w(),M(),void(t=I);t=I;const b=v.position_names||[],P=v.residue_numbers||[],R=v.chains||[],L=v.position_types||[];let E=0;if(b.length>0?E=b.length:R.length>0?E=R.length:v.coords&&(E=Math.floor(v.coords.length/3)),0===E)return;const C=b&&b.length===E,A=[];for(let e=0;e<E;e++)A.push({chain:R&&R.length>e&&R[e]?R[e]:"A",resName:b&&b.length>e&&b[e]?b[e]:"UNK",resSeq:P&&P.length>e&&null!=P[e]?P[e]:e+1,positionIndex:e,positionType:L&&L.length>e&&L[e]?L[e]:"P"});const T=A.sort((e,t)=>e.chain<t.chain?-1:e.chain>t.chain?1:e.positionIndex-t.positionIndex),D=[];let N=null,U=0;for(let e=0;e<T.length;e++)T[e].chain!==N&&(null!==N&&D.push({chain:N,startIndex:U,endIndex:e-1}),N=T[e].chain,U=e);null!==N&&D.push({chain:N,startIndex:U,endIndex:T.length-1});const H={ALA:"A",ARG:"R",ASN:"N",ASP:"D",CYS:"C",GLU:"E",GLN:"Q",GLY:"G",HIS:"H",ILE:"I",LEU:"L",LYS:"K",MET:"M",PHE:"F",PRO:"P",SER:"S",THR:"T",TRP:"W",TYR:"Y",VAL:"V",SEC:"U",PYL:"O"},z={DA:"A",DT:"T",DC:"C",DG:"G",A:"A",T:"T",C:"C",G:"G",ADE:"A",THY:"T",CYT:"C",GUA:"G"},k={A:"A",U:"U",C:"C",G:"G",RA:"A",RU:"U",RC:"C",RG:"G",ADE:"A",URA:"U",CYT:"C",GUA:"G",URI:"U",UMP:"U",URD:"U",RURA:"U",RURI:"U"},G=e=>{if(0===e.length)return"protein";let t=0,n=0,i=0,s=!1,o=!1;for(const l of e){const e=(l||"").toString().trim().toUpperCase();"U"===e||e.startsWith("RU")||e.includes("URI")||e.includes("URA")?(s=!0,n++):"T"===e||"DT"===e||e.startsWith("DT")?(o=!0,t++):z[e]?t++:k[e]?n++:H[e]&&i++}return s&&!o?"rna":o&&!s||t>n&&t>i?"dna":n>t&&n>i?"rna":"protein"},q={};for(const e of D){const t=T.slice(e.startIndex,e.endIndex+1).map(e=>e.resName);q[e.chain]=G(t)}const Y=e=>{const t=q[e.chain]||"protein";let n=(e.resName||"").toString().trim().toUpperCase();if("function"==typeof getStandardResidueName)n=getStandardResidueName(n).toUpperCase();else{const e={MSE:"MET",PTR:"TYR",SEP:"SER",TPO:"THR",FME:"MET",HYP:"PRO",PCA:"GLU",ALY:"LYS","5MDA":"DA","5MDC":"DC","5MDG":"DG",M6A:"A",M5C:"C",M7G:"G",PSU:"U"};e[n]&&(n=e[n])}return"dna"===t?z[n]||"N":"rna"===t?k[n]?k[n]:"U"===n||n.includes("U")||n.includes("URI")||n.includes("URA")?"U":n.includes("A")&&!n.includes("D")?"A":n.includes("C")&&!n.includes("D")?"C":n.includes("G")&&!n.includes("D")?"G":"N":H[n]||"X"},$=10,B=14,O=2*($*Math.max(...D.map(e=>e.chain.length),3)+20)/3,_=s?s.getBoundingClientRect():null,j=_&&_.width>0?_.width:924,W=j,Q=Math.floor(W/$),F=document.createElement("canvas");F.id="sequenceCanvas",F.style.cursor="crosshair",F.style.display="block",F.style.width="100%";const K=[],X={charWidth:$,charHeight:B,spacing:4,chainButtonWidth:O,charsPerLine:Q,chainLabelPositions:[],residuePositions:[],selectableItems:[]};let V=4,J=0;if(n)for(const e of D){const t=e.chain,n=T.slice(e.startIndex,e.endIndex+1),i=4,s=V,l=O+Math.round(8/3),a=B;X.chainLabelPositions.push({chainId:t,positionIndex:n[0].positionIndex,x:i,y:s,width:l,height:a});let c=i+l+4,r=c,d=V,h=d,u=null,g=null;const f=20,m=o?.objectsData?.[o.currentObjectName],p=m?.ligandGroups||new Map,x=new Map;for(const[e,t]of p)for(const n of t)x.set(n,e);const I=new Set,v=[];let y=0;for(;y<n.length;){const e=n[y],t=x.get(e.positionIndex);if(t&&!I.has(t)){const e=p.get(t);if(e&&e.length>0){let i=null,s=-1;for(let t=0;t<n.length;t++)if(e.includes(n[t].positionIndex)){i=n[t],s=n[t].positionIndex;break}if(i){const s=C&&i.resName&&"UNK"!==i.resName?i.resName:"LIG";for(v.push({type:"ligand",resSeq:i.resSeq,resName:s,positionIndices:e,chain:i.chain}),I.add(t);y<n.length&&e.includes(n[y].positionIndex);)y++;continue}}}v.push({type:"atom",atom:e}),y++}for(let e=0;e<v.length;e++){const t=v[e],n=e>0?v[e-1]:null,i="ligand"===t.type?f:$;if(c+i>W-4&&(c=r,d+=B,h=Math.max(h,d)),n){const e="ligand"===n.type?n.resSeq:n.atom.resSeq,i="ligand"===n.type?"L":n.atom.positionType,s="ligand"===t.type?t.resSeq:t.atom.resSeq,o="ligand"===t.type?"L":t.atom.positionType,l=s-e;if(i!==o||"L"===o&&"L"===i&&e!==s)c+=$;else if(i===o&&e!==s&&("P"===i||"D"===i||"R"===i)&&l>1){const n=l-1;for(let i=0;i<n;i++)c+$>j-4&&(c=r,d+=B,h=Math.max(h,d)),X.residuePositions.push({residueData:{positionIndex:-1,letter:"-",color:{r:240,g:240,b:240},resSeq:e+i+1,chain:t.chain},x:c,y:d,width:$,height:B}),c+=$}}if(c+i>W-4&&(c=r,d+=B,h=Math.max(h,d)),"ligand"===t.type){const e={isLigandToken:!0,positionIndices:t.positionIndices,ligandName:t.resName,resSeq:t.resSeq,chain:t.chain,resName:t.resName};K.push(e),X.residuePositions.push({residueData:e,x:c,y:d,width:i,height:B})}else{const e=t.atom,n=Y(e),s={positionIndex:e.positionIndex,letter:n,resSeq:e.resSeq,chain:e.chain,resName:e.resName};K.push(s),X.residuePositions.push({residueData:s,x:c,y:d,width:i,height:B})}c+=i,"ligand"===t.type?(u=t.resSeq,g="L"):(u=t.atom.resSeq,g=t.atom.positionType)}V=h+B+4,J=Math.max(J,c)}else{let e=4,t=4,n=V;for(const i of D){const s=i.chain,o=O+Math.round(8/3);e+o>j-4&&(e=t,n+=18),X.chainLabelPositions.push({chainId:s,positionIndex:T[i.startIndex].positionIndex,x:e,y:n,width:o,height:B}),e+=o+4,J=Math.max(J,e)}V=n+B+4}let Z=0;for(const e of X.chainLabelPositions){const t=e.chainId,i=D.find(e=>e.chain===t);if(i){const s=T.slice(i.startIndex,i.endIndex+1).map(e=>e.positionIndex);let o=e.height;if(n){let t=1/0;for(const n of X.chainLabelPositions)n.y>e.y&&(t=Math.min(t,n.y));o=t!==1/0?t-e.y:Math.max(B,o)}X.selectableItems.push({type:"chain",id:`chain-${t}`,chainId:t,positionIndices:s,bounds:{x:e.x,y:e.y,width:e.width,height:o},index:Z++})}}if(n)for(const e of X.residuePositions){const t=e.residueData;let n,i;if(t.isLigandToken&&t.positionIndices)i="ligand",n=t.positionIndices;else{if(!(t.positionIndex>=0))continue;i="residue",n=[t.positionIndex]}X.selectableItems.push({type:i,id:"ligand"===i?`ligand-${t.positionIndices[0]}`:`residue-${t.positionIndex}`,positionIndices:n,residueData:t,bounds:{x:e.x,y:e.y,width:e.width,height:e.height},index:Z++})}const ee=V;X.fullContentHeight=ee,X.scrollbarWidth=r;const te=W+r,ne=Math.min(ee,452),ie=200/96;F.width=te*ie,F.height=ne*ie,F.style.width="100%",F.style.height=ne+"px",s.style.overflowY="visible",s.style.maxHeight="none";const se=F.getContext("2d");se.scale(ie,ie),s.appendChild(F),e={canvas:F,ctx:se,allResidueData:K,chainBoundaries:D,sortedPositionEntries:T,layout:X,mode:n},function(){if(!e)return;const t=h.getRenderer?h.getRenderer():null;if(!t)return;const s={active:!1,startItem:null,endItemIndex:-1,initialPositions:null,unselectMode:!1},{canvas:o,allResidueData:l,chainBoundaries:d,sortedPositionEntries:u,layout:I}=e,v=o.cloneNode(!1);o.parentNode.replaceChild(v,o),e.canvas=v,e.ctx=v.getContext("2d");const y=200,S=96,w=y/S;e.ctx.scale(w,w),v.addEventListener("wheel",e=>{e.preventDefault();const t=I.fullContentHeight||0,n=v.height/w,i=Math.max(0,t-n),s=e.deltaY;c=Math.max(0,Math.min(i,c+s)),m()},{passive:!1});const M=e=>{const n=t.currentObjectName,i=t.objectsData[n],s=i?.frames?.[0];if(!s)return;const o=new Set;if(s.chains)for(const t of e){const e=s.chains[t];e&&o.add(e)}const l=s.chains?.length||0,a=e.size>0&&e.size<l,c=new Set(s.chains),r=o.size===c.size&&Array.from(o).every(e=>c.has(e)),d=r&&!a&&e.size>0?"default":"explicit",h=r&&!a&&e.size>0?new Set:o;t.setSelection({positions:e,chains:h,selectionMode:d,paeBoxes:[]})},b=(e,t)=>{const n=new Set(t);return e.positionIndices&&e.positionIndices.length>0&&e.positionIndices.forEach(e=>{n.has(e)?n.delete(e):n.add(e)}),n},P=(e,t,n,i)=>{const[s,o]=[Math.min(e,t),Math.max(e,t)],l=new Set(n);for(let e=s;e<=o;e++){const t=I.selectableItems[e];t&&t.positionIndices&&t.positionIndices.forEach(e=>{i?l.delete(e):l.add(e)})}return l};v.addEventListener("mousedown__DISABLED",e=>{if(0!==e.button)return;const o=p(e,v),l=x(o.x,o.y,I,n);if(!l)return;if("chain"===l.type){const n=l.chainId,s=t?.getSelection(),o=s?.chains?.has(n)||"default"===s?.selectionMode&&(!s?.chains||0===s.chains.size);return e.altKey&&h.toggleChainResidues?h.toggleChainResidues(n):h.setChainResiduesSelected&&h.setChainResiduesSelected(n,!o),i=null,void m()}const a=t?.getSelection(),c=a?.positions||new Set,r=b(l,c);M(r),i=null,m();const d=l.positionIndices.length>0&&l.positionIndices.every(e=>c.has(e));s.active=!1,s.startItem=l,s.endItemIndex=l.index,s.initialPositions=new Set(r),s.unselectMode=!d;const u=e=>{if(!s.startItem)return;if(!(1&(void 0!==e.buttons?e.buttons:e.which||0)))return;const t=p(e,v),o=x(t.x,t.y,I,n);if(o&&o.index!==s.startItem.index&&(s.active=!0,o.index!==s.endItemIndex)){s.endItemIndex=o.index;const e=P(s.startItem.index,o.index,s.initialPositions,s.unselectMode);h.setPreviewSelectionSet&&h.setPreviewSelectionSet(e),i=null,m()}},g=()=>{const e=h.getPreviewSelectionSet?h.getPreviewSelectionSet():null;s.active&&e&&M(e),h.setPreviewSelectionSet&&h.setPreviewSelectionSet(null),s.active=!1,s.startItem=null,s.endItemIndex=-1,s.initialPositions=null,i=null,m(),window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",g)};window.addEventListener("mousemove",u),window.addEventListener("mouseup",g)}),v.addEventListener("mousemove",t=>{if(!e||e.canvas!==v)return;if(s.active)return;const n=p(t,v),i=function(e,t,n){if(!n||!n.chainLabelPositions)return null;for(const i of n.chainLabelPositions)if(e>=i.x&&e<i.x+i.width&&t>=i.y&&t<i.y+i.height)return i;return null}(n.x,n.y,I),o=function(e,t,n){if(!n||!n.residuePositions)return null;for(const i of n.residuePositions)if(e>=i.x&&e<i.x+i.width&&t>=i.y&&t<i.y+i.height)return i;return null}(n.x,n.y,I);if(o&&o.residueData){const e=o.residueData;e.isLigandToken&&e.positionIndices&&h.highlightAtoms?(h.highlightAtoms(new Set(e.positionIndices)),a={chain:e.chain,resName:e.ligandName||e.resName,resSeq:e.resSeq}):e.positionIndex>=0&&h.highlightAtom?(h.highlightAtom(e.positionIndex),a={chain:e.chain,resName:e.resName,resSeq:e.resSeq}):a=null}else if(i&&h.highlightAtoms){const e=i.chainId,t=d.find(t=>t.chain===e);if(t){const e=u.slice(t.startIndex,t.endIndex+1);if(e.length>0){const t=new Set(e.map(e=>e.positionIndex));h.highlightAtoms(t)}}a=null}else h.clearHighlight&&h.clearHighlight(),a=null;window.SEQ&&window.SEQ.drawHighlights&&window.SEQ.drawHighlights()}),v.addEventListener("mouseup",()=>{}),v.addEventListener("mouseleave",()=>{h.clearHighlight&&h.clearHighlight(),a=null,window.SEQ&&window.SEQ.drawHighlights&&window.SEQ.drawHighlights()}),v.addEventListener("touchstart__DISABLED",e=>{if(1!==e.touches.length)return;e.preventDefault();const o=p(e.touches[0],v),l=x(o.x,o.y,I,n);if(!l)return;if("chain"===l.type){const e=l.chainId,n=t?.getSelection(),s=n?.chains?.has(e)||"default"===n?.selectionMode&&(!n?.chains||0===n.chains.size);return h.setChainResiduesSelected&&h.setChainResiduesSelected(e,!s),i=null,void m()}const a=t?.getSelection(),c=a?.positions||new Set,r=b(l,c);M(r),i=null,m();const d=l.positionIndices.length>0&&l.positionIndices.every(e=>c.has(e));s.active=!1,s.startItem=l,s.endItemIndex=l.index,s.initialPositions=new Set(r),s.unselectMode=!d;const u=e=>{if(1!==e.touches.length)return;if(e.preventDefault(),!s.startItem)return;const t=p(e.touches[0],v),o=x(t.x,t.y,I,n);if(o&&o.index!==s.startItem.index&&(s.active=!0,o.index!==s.endItemIndex)){s.endItemIndex=o.index;const e=P(s.startItem.index,o.index,s.initialPositions,s.unselectMode);h.setPreviewSelectionSet&&h.setPreviewSelectionSet(e),i=null,m()}},g=e=>{e.preventDefault();const t=h.getPreviewSelectionSet?h.getPreviewSelectionSet():null;s.active&&t&&M(t),h.setPreviewSelectionSet&&h.setPreviewSelectionSet(null),s.active=!1,s.startItem=null,s.endItemIndex=-1,s.initialPositions=null,i=null,m(),window.removeEventListener("touchmove",u),window.removeEventListener("touchend",g),window.removeEventListener("touchcancel",g)};window.addEventListener("touchmove",u,{passive:!1}),window.addEventListener("touchend",g,{passive:!1}),window.addEventListener("touchcancel",g,{passive:!1})}),v.addEventListener("mousedown",e=>{if(0!==e.button)return;const o=p(e,v),l=v.width/w,a=v.height/w,d=l-r,u=a;if(o.x>=d&&o.y<=u){e.preventDefault();const t=I.fullContentHeight||0,n=Math.max(0,t-u);if(n>0){Math.max(20,u/t*u);const e=o.y/u;c=Math.max(0,Math.min(n,e*t)),m();const i=e=>{const i=p(e,v),s=Math.max(0,Math.min(1,i.y/u));c=Math.max(0,Math.min(n,s*t)),m()},s=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)}return}const y=x(o.x,o.y,I,n);if(!y)return;const S=t?.getSelection(),R=S?.positions||new Set;if(s.active=!1,s.startItem=y,s.endItemIndex=y.index,s.initialPositions=new Set(R),s.unselectMode=!!(y.positionIndices&&y.positionIndices.length>0&&y.positionIndices.every(e=>R.has(e))),"chain"!==y.type){f(P(y.index,y.index,s.initialPositions,s.unselectMode)),i=null,m()}const L=e=>{if(!(1&(void 0!==e.buttons?e.buttons:e.which||0)))return;const t=p(e,v),o=x(t.x,t.y,I,n);if(o&&"chain"!==y.type&&(s.active=!0,o.index!==s.endItemIndex)){s.endItemIndex=o.index;f(P(s.startItem.index,o.index,s.initialPositions,s.unselectMode)),i=null,m()}},E=e=>{if(window.removeEventListener("mousemove",L),window.removeEventListener("mouseup",E),"chain"===s.startItem?.type){const i=p(e,v),o=x(i.x,i.y,I,n);if(o&&"chain"===o.type&&o.chainId===s.startItem.chainId){const n=o.chainId,i=t?.getSelection(),s=i?.chains?.has(n)||"default"===i?.selectionMode&&(!i?.chains||0===i.chains.size);e.altKey&&h.toggleChainResidues?h.toggleChainResidues(n):h.setChainResiduesSelected&&h.setChainResiduesSelected(n,!s)}}else{const e=g();if(s.active&&e)M(e);else{const e=b(s.startItem,s.initialPositions);M(e)}}f(null),s.active=!1,s.startItem=null,s.endItemIndex=-1,s.initialPositions=null,i=null,m()};window.addEventListener("mousemove",L),window.addEventListener("mouseup",E)}),v.addEventListener("touchstart",e=>{if(1!==e.touches.length)return;e.preventDefault();const o=p(e.touches[0],v),l=x(o.x,o.y,I,n);if(!l)return;const a=t?.getSelection(),c=a?.positions||new Set;if(s.active=!1,s.startItem=l,s.endItemIndex=l.index,s.initialPositions=new Set(c),s.unselectMode=!!(l.positionIndices&&l.positionIndices.length>0&&l.positionIndices.every(e=>c.has(e))),"chain"!==l.type){f(P(l.index,l.index,s.initialPositions,s.unselectMode)),i=null,m()}const r=e=>{if(1!==e.touches.length)return;e.preventDefault();const t=p(e.touches[0],v),o=x(t.x,t.y,I,n);if(o&&"chain"!==l.type&&(s.active=!0,o.index!==s.endItemIndex)){s.endItemIndex=o.index;f(P(s.startItem.index,o.index,s.initialPositions,s.unselectMode)),i=null,m()}},d=e=>{if(e.preventDefault(),"chain"===s.startItem?.type){const i=e.changedTouches&&e.changedTouches[0]||null;if(i){const e=p(i,v),o=x(e.x,e.y,I,n);if(o&&"chain"===o.type&&o.chainId===s.startItem.chainId){const e=o.chainId,n=t?.getSelection(),i=n?.chains?.has(e)||"default"===n?.selectionMode&&(!n?.chains||0===n.chains.size);h.setChainResiduesSelected&&h.setChainResiduesSelected(e,!i)}}}else{const e=g();if(s.active&&e)M(e);else{const e=b(s.startItem,s.initialPositions);M(e)}}f(null),s.active=!1,s.startItem=null,s.endItemIndex=-1,s.initialPositions=null,i=null,m(),window.removeEventListener("touchmove",r),window.removeEventListener("touchend",d),window.removeEventListener("touchcancel",d)};window.addEventListener("touchmove",r,{passive:!1}),window.addEventListener("touchend",d,{passive:!1}),window.addEventListener("touchcancel",d,{passive:!1})})}(),S()},updateColors:w,updateSelection:M,drawHighlights:function(){const e=h.getRenderer?h.getRenderer():null;if(!e||!e.canvas)return;if(e.isDragging)return;if(!(o&&l||(b(),o&&l)))return;P();const t=e.displayWidth||e.canvas.width,n=e.displayHeight||e.canvas.height;if(l.clearRect(0,0,t,n),l.fillStyle="rgba(255, 255, 0, 0.8)",l.strokeStyle="rgba(255, 255, 0, 1.0)",l.lineWidth=1,e.getHighlightCoordinates){const t=e.getHighlightCoordinates();for(const e of t)l.beginPath(),l.arc(e.x,e.y,e.radius,0,2*Math.PI),l.fill(),l.stroke()}else if(null!==e.highlightedAtoms&&e.highlightedAtoms instanceof Set&&e.highlightedAtoms.size>0){for(const t of e.highlightedAtoms)if(e.positionScreenPositions&&t>=0&&t<e.positionScreenPositions.length){const n=e.positionScreenPositions[t];n&&(l.beginPath(),l.arc(n.x,n.y,n.radius,0,2*Math.PI),l.fill(),l.stroke())}}else if(null!==e.highlightedAtom&&void 0!==e.highlightedAtom&&"number"==typeof e.highlightedAtom){const t=e.highlightedAtom;if(e.positionScreenPositions&&t>=0&&t<e.positionScreenPositions.length){const n=e.positionScreenPositions[t];n&&(l.beginPath(),l.arc(n.x,n.y,n.radius,0,2*Math.PI),l.fill(),l.stroke())}}if(a){const e=10,i=14,s=18,o="rgba(255, 255, 255, 0.95)",c="rgba(0, 0, 0, 0.75)",r=4;l.font=`${i}px monospace`,l.textAlign="right",l.textBaseline="bottom";const d=[`Chain: ${a.chain}`,`Residue: ${a.resName}`,`Index: ${a.resSeq}`],h=d.map(e=>l.measureText(e)),u=Math.max(...h.map(e=>e.width)),g=d.length*s,f=8,m=u+2*f,p=g+2*f,x=t-e,I=n-e;l.fillStyle=c,l.beginPath(),l.moveTo(x-m+r,I-p),l.arcTo(x-m,I-p,x-m,I-p+r,r),l.lineTo(x-m,I-r),l.arcTo(x-m,I,x-m+r,I,r),l.lineTo(x-r,I),l.arcTo(x,I,x,I-r,r),l.lineTo(x,I-p+r),l.arcTo(x,I-p,x-r,I-p,r),l.closePath(),l.fill(),l.fillStyle=o,d.forEach((e,t)=>{l.fillText(e,x-f,I-f-(d.length-1-t)*s)})}},updateHighlightOverlaySize:P,setMode:function(e){n=e},getMode:function(){return n},clear:function(){e=null,t=-1,i=null},clearPreview:function(){f(null),i=null,m()}}}();