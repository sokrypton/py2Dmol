function registerCustomColorMode(t,e){window.py2dmol_customColors||(window.py2dmol_customColors={}),window.py2dmol_customColors[t]=e}function getAllValidColorModes(){const t=window.py2dmol_customColors?Object.keys(window.py2dmol_customColors):[];return["auto","chain","rainbow","plddt","deepmind","entropy"].concat(t)}function initializePy2DmolViewer(t,e){class i{constructor(t,e,i){this.x=t,this.y=e,this.z=i}add(t){return new i(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new i(this.x-t.x,this.y-t.y,this.z-t.z)}mul(t){return new i(this.x*t,this.y*t,this.z*t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}length(){return Math.sqrt(this.dot(this))}distanceTo(t){return this.sub(t).length()}distanceToSq(t){const e=this.sub(t);return e.dot(e)}normalize(){const t=this.length();return t>0?this.mul(1/t):new i(0,0,1)}}function s(t){const e=Math.cos(t),i=Math.sin(t);return[[1,0,0],[0,e,-i],[0,i,e]]}function o(t){const e=Math.cos(t),i=Math.sin(t);return[[e,0,i],[0,1,0],[-i,0,e]]}function n(t,e){const i=[[0,0,0],[0,0,0],[0,0,0]];for(let s=0;s<3;s++)for(let o=0;o<3;o++)for(let n=0;n<3;n++)i[s][o]+=t[s][n]*e[n][o];return i}const a=["#33ff33","#00ffff","#ff33cc","#ffff00","#ff9999","#e5e5e5","#7f7fff","#ff7f00","#7fff7f","#199999","#ff007f","#ffdd5e","#8c3f99","#b2b2b2","#007fff","#c4b200","#8cb266","#00bfbf","#b27f7f","#fcd1a5","#ff7f7f","#ffbfdd","#7fffff","#ffff7f","#00ff7f","#337fcc","#d8337f","#bfff3f","#ff7fff","#d8d8ff","#3fffbf","#b78c4c","#339933","#66b2b2","#ba8c84","#84bf00","#b24c66","#7f7f7f","#3f3fa5","#a5512b"],r=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7F","#BCBD22","#17BECF","#AEC7E8","#FFBB78","#98DF8A","#FF9896","#C5B0D5","#C49C94","#F7B6D2","#C7C7C7","#DBDB8D","#9EDAE5","#393B79","#637939","#8C6D31","#843C39","#7B4173","#5254A3","#8CA252","#BD9E39","#AD494A","#A55194"],l={red:"#ff0000",green:"#00ff00",blue:"#0000ff",yellow:"#ffff00",cyan:"#00ffff",magenta:"#ff00ff",orange:"#ffa500",purple:"#800080",pink:"#ffc0cb",brown:"#8b4513",gray:"#808080",grey:"#808080",white:"#ffffff",black:"#000000",lime:"#00ff00",navy:"#000080",teal:"#008080",silver:"#c0c0c0",maroon:"#800000",olive:"#808000",aqua:"#00ffff",fuchsia:"#ff00ff"};function h(t){if(!t||"string"!=typeof t)return{r:128,g:128,b:128};return{r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16)}}function c(t,e,i){const s=i*e,o=s*(1-Math.abs(t/60%2-1)),n=i-s;let a,r,l;return t<60?(a=s,r=o,l=0):t<120?(a=o,r=s,l=0):t<180?(a=0,r=s,l=o):t<240?(a=0,r=o,l=s):t<300?(a=o,r=0,l=s):(a=s,r=0,l=o),{r:Math.round(255*(a+n)),g:Math.round(255*(r+n)),b:Math.round(255*(l+n))}}function d(t,e){return e<=0?t:{r:Math.round(t.r*(1-e)+255*e),g:Math.round(t.g*(1-e)+255*e),b:Math.round(t.b*(1-e)+255*e)}}function u(t,e,i,s=!1){if(i-e<1e-6)return c(240,1,1);let o=(t-e)/(i-e);o=Math.max(0,Math.min(1,o));return c(s?240-180*o:240*(1-o),1,1)}function p(t,e=!1){return function(t,e,i,s=!1){if(i-e<1e-6)return c(s?60:0,1,1);let o=(t-e)/(i-e);return o=Math.max(0,Math.min(1,o)),c(s?60+180*o:240*o,1,1)}(t,50,90,e)}function m(t,e=!1){return e?t>=90?{r:0,g:100,b:255}:t>=70?{r:0,g:200,b:100}:t>=50?{r:255,g:255,b:0}:{r:255,g:0,b:0}:t>=90?{r:13,g:87,b:211}:t>=70?{r:106,g:203,b:241}:t>=50?{r:254,g:217,b:54}:{r:253,g:125,b:77}}const f=["chain","plddt","rainbow","auto","entropy","deepmind"],g={L:.4,P:1,D:1.6,R:1.6,C:.5},y={L:1.5,P:3.8,D:5.9,R:5.9},b=12,w={viewer_id:null,display:{size:[300,300],rotate:!1,autoplay:!1,controls:!0,box:!0},rendering:{shadow:!0,outline:"full",width:3,ortho:1,pastel:.25},color:{mode:"auto",colorblind:!1},pae:{enabled:!1,size:300},overlay:{enabled:!1}};function v(t={}){const e=t||{},i="string"==typeof e.color?e.color:e.color?.mode,s={viewer_id:e.viewer_id??w.viewer_id,display:{size:e.display?.size||e.size||w.display.size,rotate:e.display?.rotate??e.rotate??w.display.rotate,autoplay:e.display?.autoplay??e.autoplay??w.display.autoplay,controls:e.display?.controls??e.controls??w.display.controls,box:e.display?.box??e.box??w.display.box},rendering:{shadow:e.rendering?.shadow??e.shadow??w.rendering.shadow,outline:e.rendering?.outline??e.outline??w.rendering.outline,width:e.rendering?.width??e.width??w.rendering.width,ortho:e.rendering?.ortho??e.ortho??w.rendering.ortho,pastel:e.rendering?.pastel??e.pastel??w.rendering.pastel},color:{mode:i||w.color.mode,colorblind:e.color?.colorblind??e.colorblind??w.color.colorblind},pae:{enabled:e.pae?.enabled??e.pae??w.pae.enabled,size:e.pae?.size||e.pae_size||w.pae.size},overlay:{enabled:e.overlay?.enabled??e.overlay??w.overlay.enabled}},o=new Set(["viewer_id","display","rendering","color","pae","overlay","size","rotate","autoplay","controls","box","shadow","outline","width","ortho","pastel","colorblind","pae_size"]);for(const[t,i]of Object.entries(e))o.has(t)||(s[t]=i);return e.pae_size&&!e.pae?.size&&(s.pae.size=e.pae_size),s}const S=window.viewerConfig||{},M=e||S.viewer_id||t?.id||null,x=v((M&&window.py2dmol_configs?window.py2dmol_configs[M]:null)||S),C=e||x.viewer_id||t?.id||`py2dmol_${Math.random().toString(36).slice(2,10)}`;x.viewer_id=C,e=C,window.viewerConfig=x;const _=t.querySelector("#canvas");if(!_)return void console.error("py2dmol: Could not find #canvas element in container.");const D=void 0!==window.canvasDPR?window.canvasDPR:Math.min(window.devicePixelRatio||1,1.5),j=x.display?.size[0]||300,I=x.display?.size[1]||300;Array.isArray(x.pae?.size)||"object"==typeof x.pae?.size&&void 0!==x.pae.size.length?x.pae.size[0]:x.pae;_.width=j*D,_.height=I*D,_.style.width=j+"px",_.style.height=I+"px";_.getContext("2d").scale(D,D);t.querySelector("#viewerColumn");const A=new class{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.positionScreenPositions=null,this.LARGE_MOLECULE_CUTOFF=1e3,this.displayWidth=parseInt(t.style.width)||t.width,this.displayHeight=parseInt(t.style.height)||t.height;const e=v(window.viewerConfig);window.viewerConfig=e,this.coords=[],this.plddts=[],this.chains=[],this.positionTypes=[],this.entropy=void 0;const i=getAllValidColorModes();this.colorMode=e.color?.mode&&i.includes(e.color.mode)?e.color.mode:"auto",this.colorMode&&i.includes(this.colorMode)||(this.colorMode="auto"),this.resolvedAutoColor="rainbow",this.viewerState={rotation:[[1,0,0],[0,1,0],[0,0,1]],zoom:1,perspectiveEnabled:!1,focalLength:200,center:null,extent:null,currentFrame:-1},this.lineWidth="number"==typeof e.rendering?.width?e.rendering.width:3,this.relativeOutlineWidth=3,this.shadowIntensity=.95,this.shadowEnabled="boolean"!=typeof e.rendering?.shadow||e.rendering.shadow,"string"==typeof e.rendering?.outline&&["none","partial","full"].includes(e.rendering.outline)?this.outlineMode=e.rendering.outline:"boolean"==typeof e.rendering?.outline?this.outlineMode=e.rendering.outline?"full":"none":this.outlineMode="full",this.pastelLevel="number"==typeof e.rendering?.pastel?e.rendering.pastel:.25,this.colorblindMode="boolean"==typeof e.color?.colorblind&&e.color.colorblind,this.isTransparent=!1,this.chainRainbowScales={},this.perChainIndices=[],this.chainIndexMap=new Map,this.ligandOnlyChains=new Set,this.rotatedCoords=[],this.segmentIndices=[],this.segData=[],this.colors=[],this.plddtColors=[],this.colorsNeedUpdate=!0,this.plddtColorsNeedUpdate=!0,this.adjList=null,this.segmentOrder=null,this.segmentFrame=null,this.renderFrameId=0,this.segmentEndpointFlags=null,this.screenX=null,this.screenY=null,this.screenRadius=null,this.screenValid=null,this.screenFrameId=0,this.objectsData={},this.currentObjectName=null,this.previousObjectName=null,this.currentFrame=-1,this.animationFrameId=null,this.cachedSegmentIndices=null,this.cachedSegmentIndicesFrame=-1,this.cachedSegmentIndicesObjectName=null,this.isPlaying=!1,this.animationSpeed=100,this.speedOptions=[100,50,25],this.speedIndex=this.speedOptions.indexOf(this.animationSpeed),-1===this.speedIndex&&(this.speedIndex=0,this.animationSpeed=this.speedOptions[this.speedIndex]),this.frameAdvanceTimer=null,this.lastRenderedFrame=-1,this.recordingFrameSequence=null,this.overlayState={enabled:!1,shouldAutoEnable:"boolean"==typeof e.overlay?.enabled&&e.overlay.enabled,frameIdMap:null,autoColor:null},this.lastOperationMode="unknown",this.isDragging=!1,this.autoRotate="boolean"==typeof e.display?.rotate&&e.display.rotate,this.autoplay="boolean"==typeof e.display?.autoplay&&e.display.autoplay,this.spinVelocityX=0,this.spinVelocityY=0,this.lastDragTime=0,this.lastDragX=0,this.lastDragY=0,this.zoomTimeout=null,this.initialPinchDistance=0,this.isSliderDragging=!1,this.paeRenderer=null,this.visibilityMask=null,this.highlightedAtom=null,this.highlightedAtoms=null,this.selectionModel={positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"default"},this.bonds=null,this.playButton=null,this.overlayButton=null,this.recordButton=null,this.saveSvgButton=null,this.frameSlider=null,this.frameCounter=null,this.objectSelect=null,this.controlsContainer=null,this.speedButton=null,this.rotationCheckbox=null,this.lineWidthSlider=null,this.outlineWidthSlider=null,this.shadowEnabledCheckbox=null,this.outlineModeButton=null,this.outlineModeSelect=null,this.colorblindCheckbox=null,this.orthoSlider=null,this.isRecording=!1,this.mediaRecorder=null,this.recordedChunks=[],this.recordingStream=null,this.recordingEndFrame=0,this._invalidateShadowCache(),this.isZooming=!1,this.isOrientAnimating=!1,this.lastShadowRotationMatrix=null,this._batchLoading=!1,this.typeWidthMultipliers={atom:.5},this.setupInteraction()}setClearColor(t){this.isTransparent=t,this.render("setClearColor")}setSelection(t,e=!1){if(t){if(void 0!==t.positions){const e=t.positions;this.selectionModel.positions=e instanceof Set?new Set(e):new Set(Array.from(e||[]))}if(void 0!==t.chains){const e=t.chains;this.selectionModel.chains=e instanceof Set?new Set(e):new Set(Array.from(e||[]))}if(void 0!==t.paeBoxes&&("clear"===t.paeBoxes||null===t.paeBoxes?this.selectionModel.paeBoxes=[]:Array.isArray(t.paeBoxes)&&(this.selectionModel.paeBoxes=t.paeBoxes.map(t=>({i_start:Math.max(0,Math.floor(t.i_start??0)),i_end:Math.max(0,Math.floor(t.i_end??0)),j_start:Math.max(0,Math.floor(t.j_start??0)),j_end:Math.max(0,Math.floor(t.j_end??0))})))),void 0!==t.selectionMode&&(this.selectionModel.selectionMode=t.selectionMode),"default"===this.selectionModel.selectionMode&&(!this.selectionModel.positions||0===this.selectionModel.positions.size)){const t=this.coords?this.coords.length:0;this.selectionModel.positions=new Set;for(let e=0;e<t;e++)this.selectionModel.positions.add(e)}this.currentObjectName&&this.objectsData[this.currentObjectName]&&(this.objectsData[this.currentObjectName].selectionState={positions:new Set(this.selectionModel.positions),chains:new Set(this.selectionModel.chains),paeBoxes:this.selectionModel.paeBoxes.map(t=>({...t})),selectionMode:this.selectionModel.selectionMode}),this._composeAndApplyMask(e)}}getSelection(){const t=this.selectionModel;let e=new Set(t.positions);if("default"===t.selectionMode&&0===e.size){const t=this.coords?this.coords.length:0;e=new Set;for(let i=0;i<t;i++)e.add(i)}return{positions:e,chains:new Set(t.chains),paeBoxes:t.paeBoxes.map(t=>({...t})),selectionMode:t.selectionMode}}resetSelection(){this.selectionModel={positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"default"},this._composeAndApplyMask()}resetToDefault(){const t=this.coords?this.coords.length:0;if(0===t)return void this.resetSelection();const e=new Set;for(let i=0;i<t;i++)e.add(i);const i=new Set(this.chains);this.setSelection({positions:e,chains:i,paeBoxes:[],selectionMode:"default"})}clearSelection(){this.setSelection({positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"explicit"})}_composeAndApplyMask(t=!1){const e=this.coords?this.coords.length:0;if(0===e)return this.visibilityMask=null,void(t||this.render("_composeAndApplyMask: empty coords"));let i;i=this.selectionModel.chains&&this.selectionModel.chains.size>0?this.selectionModel.chains:new Set(this.chains);let s=null;if(this.selectionModel.positions&&this.selectionModel.positions.size>0||this.selectionModel.chains&&this.selectionModel.chains.size>0)if(s=new Set,this.overlayState.enabled&&this.overlayState.frameIdMap&&this.selectionModel.positions.size>0){const t=new Map,e=new Map;let o=-1,n=0;for(let i=0;i<this.overlayState.frameIdMap.length;i++){const s=this.overlayState.frameIdMap[i];s!==o&&(o>=0&&e.set(o,i-n),t.set(s,i),n=i,o=s)}o>=0&&e.set(o,this.overlayState.frameIdMap.length-n);const a=e.get(0)||0;for(const o of this.selectionModel.positions)if(!(o>=a))for(const[n,a]of t.entries()){if(o<(e.get(n)||0)){const t=a+o,e=this.chains[t];i.has(e)&&s.add(t)}}}else for(let t=0;t<e;t++){const e=this.chains[t];i.has(e)&&((0===this.selectionModel.positions.size||this.selectionModel.positions.has(t))&&s.add(t))}let o=null;if(this.selectionModel.paeBoxes&&this.selectionModel.paeBoxes.length>0)if(o=new Set,this.overlayState.enabled&&this.overlayState.frameIdMap){const t=new Map,e=new Map;let i=-1,s=0;for(let o=0;o<this.overlayState.frameIdMap.length;o++){const n=this.overlayState.frameIdMap[o];n!==i&&(i>=0&&e.set(i,o-s),t.set(n,o),s=o,i=n)}i>=0&&e.set(i,this.overlayState.frameIdMap.length-s);const n=e.get(0)||0;for(const i of this.selectionModel.paeBoxes){const s=Math.max(0,Math.min(n-1,Math.min(i.i_start,i.i_end))),a=Math.max(0,Math.min(n-1,Math.max(i.i_start,i.i_end))),r=Math.max(0,Math.min(n-1,Math.min(i.j_start,i.j_end))),l=Math.max(0,Math.min(n-1,Math.max(i.j_start,i.j_end)));for(let i=s;i<=a;i++)for(const[s,n]of t.entries()){i<(e.get(s)||0)&&o.add(n+i)}for(let i=r;i<=l;i++)for(const[s,n]of t.entries()){i<(e.get(s)||0)&&o.add(n+i)}}}else for(const t of this.selectionModel.paeBoxes){const i=Math.max(0,Math.min(e-1,Math.min(t.i_start,t.i_end))),s=Math.max(0,Math.min(e-1,Math.max(t.i_start,t.i_end))),n=Math.max(0,Math.min(e-1,Math.min(t.j_start,t.j_end))),a=Math.max(0,Math.min(e-1,Math.max(t.j_start,t.j_end)));for(let t=i;t<=s;t++)t<e&&o.add(t);for(let t=n;t<=a;t++)t<e&&o.add(t)}let n=null;if(s&&o){n=new Set(s);for(const t of o)n.add(t)}else n=s||o;const a=this.selectionModel.selectionMode||"default",r=this.visibilityMask;n&&n.size>0?this.visibilityMask=n:this.visibilityMask="default"===a?null:new Set;if(r!==this.visibilityMask&&(null===r||null===this.visibilityMask||r.size!==this.visibilityMask.size)&&!t&&(this._invalidateShadowCache(),this.lastShadowRotationMatrix=null),t||this.render("_composeAndApplyMask"),"undefined"!=typeof document)try{document.dispatchEvent(new CustomEvent("py2dmol-selection-change",{detail:{hasSelection:null!==this.visibilityMask&&this.visibilityMask.size>0,selectionModel:{positions:Array.from(this.selectionModel.positions),chains:Array.from(this.selectionModel.chains),paeBoxes:this.selectionModel.paeBoxes.map(t=>({...t})),selectionMode:this.selectionModel.selectionMode}}}))}catch(t){console.warn("Failed to dispatch selection change event:",t)}}setPAERenderer(t){this.paeRenderer=t}setResidueVisibility(t){if(null===t)this.setSelection({paeBoxes:"clear"});else{const{i_start:e,i_end:i,j_start:s,j_end:o}=t;this.setSelection({paeBoxes:[{i_start:e,i_end:i,j_start:s,j_end:o}]})}}_applyPastel(t){if(this.pastelLevel<=0)return t;const e=this.pastelLevel;return{r:Math.round(t.r*(1-e)+255*e),g:Math.round(t.g*(1-e)+255*e),b:Math.round(t.b*(1-e)+255*e)}}setupInteraction(){this.canvas.addEventListener("mousedown",t=>{const e="highlightOverlay"===t.target.id;if(t.target!==this.canvas&&!e)return;this.isDragging=!0,this.spinVelocityX=0,this.spinVelocityY=0,this.lastDragX=t.clientX,this.lastDragY=t.clientY,this.lastDragTime=performance.now(),this.autoRotate&&(this.autoRotate=!1,this.rotationCheckbox&&(this.rotationCheckbox.checked=!1));const i=t=>{if(!this.isDragging)return;const e=t.target.tagName;if("INPUT"===e||"SELECT"===e||"BUTTON"===e)return this.isDragging=!1,window.removeEventListener("mousemove",i),void window.removeEventListener("mouseup",a);const r=performance.now(),l=r-this.lastDragTime,h=t.clientX-this.lastDragX,c=t.clientY-this.lastDragY;if(0===c&&0===h)return;if(0!==c){const t=s(.01*c);this.viewerState.rotation=n(t,this.viewerState.rotation)}if(0!==h){const t=o(.01*h);this.viewerState.rotation=n(t,this.viewerState.rotation)}const d=this.currentObjectName?this.objectsData[this.currentObjectName]:null;let u=d&&d.frames&&d.frames[this.currentFrame]&&this.segmentIndices?this.segmentIndices.length:0;if(this.visibilityMask&&this.segmentIndices){u=0;for(let t=0;t<this.segmentIndices.length;t++){const e=this.segmentIndices[t];this.visibilityMask.has(e.idx1)&&this.visibilityMask.has(e.idx2)&&u++}}if(u<=this.LARGE_MOLECULE_CUTOFF&&l>0){const t=.5;this.spinVelocityX=this.spinVelocityX*(1-t)+h/l*20*t,this.spinVelocityY=this.spinVelocityY*(1-t)+c/l*20*t}else this.spinVelocityX=0,this.spinVelocityY=0;this.lastDragX=t.clientX,this.lastDragY=t.clientY,this.lastDragTime=r,this.render()},a=()=>{this.isDragging&&(this.isDragging=!1,window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",a))};window.addEventListener("mousemove",i),window.addEventListener("mouseup",a)}),this.canvas.addEventListener("mouseup",()=>{if(!this.isDragging)return;this.isDragging=!1,this._invalidateShadowCache(),this.lastShadowRotationMatrix=null;((this.currentObjectName?this.objectsData[this.currentObjectName]:null)&&this.segmentIndices?this.segmentIndices.length:0)>this.LARGE_MOLECULE_CUTOFF&&this.render(),this.ensureAnimationLoop();performance.now()-this.lastDragTime>100&&(this.spinVelocityX=0,this.spinVelocityY=0)}),this.canvas.addEventListener("wheel",t=>{t.preventDefault(),this.isZooming=!0,this.viewerState.zoom*=1-.001*t.deltaY,this.viewerState.zoom=Math.max(.1,Math.min(5,this.viewerState.zoom)),this.render(),clearTimeout(this.zoomTimeout),this.zoomTimeout=setTimeout(()=>{this.isZooming=!1},100)},{passive:!1}),this.canvas.addEventListener("touchstart",t=>{t.preventDefault(),1===t.touches.length?(this.isDragging=!0,this.spinVelocityX=0,this.spinVelocityY=0,this.lastDragX=t.touches[0].clientX,this.lastDragY=t.touches[0].clientY,this.lastDragTime=performance.now(),this.autoRotate&&(this.autoRotate=!1,this.rotationCheckbox&&(this.rotationCheckbox.checked=!1))):2===t.touches.length&&(this.isDragging=!1,this.initialPinchDistance=this.getTouchDistance(t.touches[0],t.touches[1]))},{passive:!1}),this.canvas.addEventListener("touchmove",t=>{if(t.preventDefault(),1===t.touches.length&&this.isDragging){const e=performance.now(),i=e-this.lastDragTime,a=t.touches[0],r=a.clientX-this.lastDragX,l=a.clientY-this.lastDragY;if(0!==l){const t=s(.01*l);this.viewerState.rotation=n(t,this.viewerState.rotation)}if(0!==r){const t=o(.01*r);this.viewerState.rotation=n(t,this.viewerState.rotation)}const h=this.currentObjectName?this.objectsData[this.currentObjectName]:null;let c=h&&h.frames&&h.frames[this.currentFrame]&&this.segmentIndices?this.segmentIndices.length:0;if(this.visibilityMask&&this.segmentIndices){c=0;for(let t=0;t<this.segmentIndices.length;t++){const e=this.segmentIndices[t];this.visibilityMask.has(e.idx1)&&this.visibilityMask.has(e.idx2)&&c++}}if(c<=this.LARGE_MOLECULE_CUTOFF&&i>0){const t=.5;this.spinVelocityX=this.spinVelocityX*(1-t)+r/i*20*t,this.spinVelocityY=this.spinVelocityY*(1-t)+l/i*20*t}else this.spinVelocityX=0,this.spinVelocityY=0;this.lastDragX=a.clientX,this.lastDragY=a.clientY,this.lastDragTime=e,this.render()}else if(2===t.touches.length){if(this.initialPinchDistance<=0)return;this.isZooming=!0;const e=this.getTouchDistance(t.touches[0],t.touches[1]),i=e/this.initialPinchDistance;this.viewerState.zoom*=i,this.viewerState.zoom=Math.max(.1,Math.min(5,this.viewerState.zoom)),this.render(),this.initialPinchDistance=e,clearTimeout(this.zoomTimeout),this.zoomTimeout=setTimeout(()=>{this.isZooming=!1},100)}},{passive:!1}),this.canvas.addEventListener("touchend",t=>{if(0===t.touches.length&&this.isDragging){this.isDragging=!1,this._invalidateShadowCache(),this.lastShadowRotationMatrix=null;let t=(this.currentObjectName?this.objectsData[this.currentObjectName]:null)&&this.segmentIndices?this.segmentIndices.length:0;if(this.visibilityMask&&this.segmentIndices){t=0;for(let e=0;e<this.segmentIndices.length;e++){const i=this.segmentIndices[e];this.visibilityMask.has(i.idx1)&&this.visibilityMask.has(i.idx2)&&t++}}t>this.LARGE_MOLECULE_CUTOFF&&this.render("touchend: large molecule"),this.ensureAnimationLoop();performance.now()-this.lastDragTime>100&&(this.spinVelocityX=0,this.spinVelocityY=0)}if(t.touches.length<2&&(this.initialPinchDistance=0),0===t.touches.length){const t=this.isDragging;this.isDragging=!1,t&&(this._invalidateShadowCache(),this.lastShadowRotationMatrix=null),this.ensureAnimationLoop()}}),this.canvas.addEventListener("touchcancel",t=>{this.isDragging&&(this.isDragging=!1,this._invalidateShadowCache(),this.lastShadowRotationMatrix=null,this.ensureAnimationLoop()),this.initialPinchDistance=0})}getTouchDistance(t,e){const i=t.clientX-e.clientX,s=t.clientY-e.clientY;return Math.sqrt(i*i+s*s)}_updateSpeedButtonLabel(){if(!this.speedButton)return;const t=`${Math.round(100/this.animationSpeed)}x`;this.speedButton.textContent=t}_cycleSpeed(){const t=this.isPlaying;this.speedIndex=(this.speedIndex+1)%this.speedOptions.length,this.animationSpeed=this.speedOptions[this.speedIndex],this._updateSpeedButtonLabel(),t&&(this.stopAnimation(),this.startAnimation())}setUIControls(t,e,i,s,o,n,a,r,l,h,c,d,u,p,m,f,g){if(this.controlsContainer=t,this.playButton=e,this.overlayButton=i,this.recordButton=s,this.saveSvgButton=o,this.frameSlider=n,this.frameCounter=a,this.objectSelect=r,this.speedButton=l,this.rotationCheckbox=h,this.lineWidthSlider=c,this.outlineWidthSlider=d,this.shadowEnabledCheckbox=u,this.outlineModeButton=p,this.outlineModeSelect=m,this.colorblindCheckbox=f,this.orthoSlider=g,this.lineWidth=this.lineWidthSlider?parseFloat(this.lineWidthSlider.value):this.lineWidth||3,this.relativeOutlineWidth=this.outlineWidthSlider?parseFloat(this.outlineWidthSlider.value):this.relativeOutlineWidth||3,this.autoRotate=!!this.rotationCheckbox&&this.rotationCheckbox.checked,this.playButton.addEventListener("click",()=>{this.togglePlay()}),this.overlayButton&&this.overlayButton.addEventListener("click",()=>{this.toggleOverlay()}),this.recordButton?this.recordButton.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.toggleRecording()}):console.warn("Record button not found - recording will not be available"),this.saveSvgButton&&this.saveSvgButton.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.saveAsSvg()}),this.objectSelect&&this.objectSelect.addEventListener("change",()=>{this.stopAnimation();const t=this.objectSelect.value;this.currentObjectName!==t&&(this._switchToObject(t),this.setFrame(0),this.updatePAEContainerVisibility())}),this.speedButton&&(this._updateSpeedButtonLabel(),this.speedButton.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this._cycleSpeed()})),this.rotationCheckbox.addEventListener("change",t=>{this.autoRotate=t.target.checked,this.spinVelocityX=0,this.spinVelocityY=0}),this.lineWidthSlider&&this.lineWidthSlider.addEventListener("input",t=>{this.lineWidth=parseFloat(t.target.value),this.isPlaying||this.render("updateUIControls: lineWidthSlider")}),this.outlineWidthSlider&&this.outlineWidthSlider.addEventListener("input",t=>{this.relativeOutlineWidth=parseFloat(t.target.value),this.isPlaying||this.render("updateUIControls: outlineWidthSlider")}),this.orthoSlider){const t=1.5,e=20,i=2,s=30;this.orthoSlider.addEventListener("input",o=>{const n=parseFloat(o.target.value),a=this.currentObjectName?this.objectsData[this.currentObjectName]:null;let r=s;if(a&&a.stdDev>0?r=a.stdDev*i:a&&a.maxExtent>0&&(r=a.maxExtent),n>=1)this.viewerState.perspectiveEnabled=!1,this.viewerState.focalLength=r*e;else{const i=t+(e-t)*n;this.viewerState.perspectiveEnabled=!0,this.viewerState.focalLength=r*i}this.isPlaying||this.render("orthoSlider")})}this.shadowEnabledCheckbox&&this.shadowEnabledCheckbox.addEventListener("change",t=>{this.shadowEnabled=t.target.checked,this.render("shadowEnabledCheckbox")}),this.outlineModeButton?(this.outlineModeButton.addEventListener("click",t=>{t.preventDefault(),"none"===this.outlineMode?this.outlineMode="partial":"partial"===this.outlineMode?this.outlineMode="full":this.outlineMode="none",this.updateOutlineButtonStyle(),this.render("outlineModeButton")}),this.updateOutlineButtonStyle()):this.outlineModeSelect&&(this.outlineModeSelect.value=this.outlineMode||"full"),this.colorblindCheckbox&&this.colorblindCheckbox.addEventListener("change",t=>{this.colorblindMode=t.target.checked,this.colorsNeedUpdate=!0,this.plddtColorsNeedUpdate=!0,this.render("colorblindCheckbox"),document.dispatchEvent(new CustomEvent("py2dmol-color-change")),this.paeRenderer&&this.paeRenderer.render()});const y=t=>{this.stopAnimation(),this.setFrame(parseInt(t.target.value))};this.frameSlider.addEventListener("mousedown",t=>{this.isDragging=!1,this.isSliderDragging=!0,t.stopPropagation()}),this.frameSlider.addEventListener("mouseup",t=>{this.isSliderDragging=!1}),window.addEventListener("mouseup",()=>{this.isSliderDragging=!1}),this.frameSlider.addEventListener("input",y),this.frameSlider.addEventListener("change",y);[this.playButton,this.objectSelect,this.speedButton,this.rotationCheckbox,this.lineWidthSlider,this.shadowEnabledCheckbox,this.outlineModeButton,this.outlineModeSelect,this.colorblindCheckbox,this.orthoSlider].forEach(t=>{t&&t.addEventListener("mousedown",t=>{this.isDragging=!1,t.stopPropagation()})})}_setDataField(t,e,i,s,o){i&&i.length===s?(this[t]=i,this[e]=i):null===i?this[t]=o(s):this[e]&&this[e].length===s?this[t]=this[e]:this[t]=o(s)}_invalidateSegmentCache(){this.cachedSegmentIndices=null,this.cachedSegmentIndicesFrame=-1,this.cachedSegmentIndicesObjectName=null}_invalidateShadowCache(){this.cachedShadows=null,this.cachedTints=null}_switchToObject(t){if(this.currentObjectName&&this.currentObjectName!==t&&this.objectsData[this.currentObjectName]){const t=this.objectsData[this.currentObjectName];t.selectionState={positions:new Set(this.selectionModel.positions),chains:new Set(this.selectionModel.chains),paeBoxes:this.selectionModel.paeBoxes.map(t=>({...t})),selectionMode:this.selectionModel.selectionMode},t.viewerState={rotation:this._deepCopyMatrix(this.viewerState.rotation),zoom:this.viewerState.zoom,perspectiveEnabled:this.viewerState.perspectiveEnabled,focalLength:this.viewerState.focalLength,center:this.viewerState.center?{...this.viewerState.center}:null,extent:this.viewerState.extent,currentFrame:this.currentFrame}}this.currentObjectName=t;let e=this.objectsData[t];this.overlayState.enabled&&e&&e.frames&&e.frames.length<=1&&this._exitOverlayMode(e,0),this._invalidateSegmentCache(),this._invalidateShadowCache(),this.lastShadowRotationMatrix=null,this.bonds=null,this.objectsData[t]||(this.objectsData[t]={}),this.objectsData[t].selectionState||(this.objectsData[t].selectionState={positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"default"}),e=this.objectsData[t];const i=e?.frames?.[0],s=i?.coords?.length||0,o=this.objectsData[t].selectionState;if(this.selectionModel.positions=new Set(o.positions),this.selectionModel.chains=new Set(o.chains),this.selectionModel.paeBoxes=o.paeBoxes.map(t=>({...t})),this.selectionModel.selectionMode=o.selectionMode,"default"===this.selectionModel.selectionMode&&(!this.selectionModel.positions||0===this.selectionModel.positions.size)){this.selectionModel.positions=new Set;for(let t=0;t<s;t++)this.selectionModel.positions.add(t)}this.objectsData[t]?.msa?.msasBySequence&&this.objectsData[t]?.msa?.chainToSequence?this._mapEntropyToStructure(t):"entropy"===this.colorMode?this._mapEntropyToStructure():this.entropy=void 0,this.currentObjectName&&this.objectsData[this.currentObjectName]&&(this.objectsData[this.currentObjectName].selectionState={positions:new Set(this.selectionModel.positions),chains:new Set(this.selectionModel.chains),paeBoxes:this.selectionModel.paeBoxes.map(t=>({...t})),selectionMode:this.selectionModel.selectionMode});const n=this.objectsData[t].viewerState;this.viewerState={rotation:this._deepCopyMatrix(n.rotation),zoom:n.zoom,perspectiveEnabled:n.perspectiveEnabled,focalLength:n.focalLength,center:n.center?{...n.center}:null,extent:n.extent,currentFrame:n.currentFrame},this.currentFrame=this.viewerState.currentFrame}addObject(t){this.stopAnimation();if(void 0!==this.objectsData[t]){if(this.objectsData[t].frames&&this.objectsData[t].frames.length>0)return;this.objectsData[t].frames=[],this.objectsData[t].maxExtent=0,this.objectsData[t].stdDev=0,this.objectsData[t].globalCenterSum=new i(0,0,0),this.objectsData[t].totalPositions=0,this.objectsData[t]._lastPlddtFrame=-1,this.objectsData[t]._lastPaeFrame=-1}else if(this.objectsData[t]={maxExtent:0,stdDev:0,frames:[],globalCenterSum:new i(0,0,0),totalPositions:0,_lastPlddtFrame:-1,_lastPaeFrame:-1,bonds:null,contacts:null,ligandGroups:new Map,selectionState:{positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"default"},viewerState:{rotation:[[1,0,0],[0,1,0],[0,0,1]],zoom:1,perspectiveEnabled:!1,focalLength:200,center:null,extent:null,currentFrame:-1}},this.objectSelect){if(!Array.from(this.objectSelect.options).find(e=>e.value===t)){const e=document.createElement("option");e.value=t,e.textContent=t,this.objectSelect.appendChild(e)}}this._switchToObject(t),this.currentFrame=-1,this._invalidateSegmentCache(),this.objectSelect&&(this.objectSelect.value=t),this.setFrame(-1)}addFrame(t,e){let s=e;s||(console.warn("addFrame called without objectName, using current view."),s=this.currentObjectName),s||(console.warn("addFrame: No object active. Creating '0'."),this.addObject("0"),s="0"),this.objectsData[s]||(console.error(`addFrame: Object '${s}' does not exist. Creating it.`),this.addObject(s));const o=this.objectsData[s],n=o.frames.length;this.objectsData[s].frames.push(t),"function"==typeof groupLigandAtoms&&t.chains&&t.position_types&&(this.objectsData[s].ligandGroups=groupLigandAtoms(t.chains,t.position_types,t.residue_numbers||[],t.position_names||[])),void 0!==t.contacts&&null!==t.contacts&&(o.contacts=t.contacts),void 0!==t.bonds&&null!==t.bonds&&(o.bonds=t.bonds),void 0!==t.color&&null!==t.color&&this._invalidateSegmentCache(),this._hasPlddtData(t)?o._lastPlddtFrame=n:0===n&&(o._lastPlddtFrame=-1),this._hasPaeData(t)?o._lastPaeFrame=n:0===n&&(o._lastPaeFrame=-1);let a=!1;this.overlayState.shouldAutoEnable&&1===o.frames.length&&!this.overlayState.enabled&&(this._enterOverlayMode(o,!1),this.overlayState.shouldAutoEnable=!1,a=!0),this.currentObjectName!==s&&(this.stopAnimation(),this.currentObjectName=s,this.lastRenderedFrame=-1,this.objectSelect&&(this.objectSelect.value=s)),void 0===t.color||null===t.color||this._batchLoading||this.render("addFrame-color");let r=new i(0,0,0),l=0;if(t&&t.coords){l=t.coords.length;for(let e=0;e<t.coords.length;e++){const s=t.coords[e];r=r.add(new i(s[0],s[1],s[2]))}o.globalCenterSum=o.globalCenterSum.add(r),o.totalPositions+=l}const h=o.totalPositions>0?o.globalCenterSum.mul(1/o.totalPositions):new i(0,0,0);let c=0,d=0,u=0;for(const t of o.frames)if(t&&t.coords)for(let e=0;e<t.coords.length;e++){const s=t.coords[e],o=new i(s[0],s[1],s[2]).sub(h),n=o.dot(o);n>c&&(c=n),d+=n,u++}if(o.maxExtent=Math.sqrt(c),o.stdDev=u>0?Math.sqrt(d/u):0,1===o.frames.length&&this.viewerState.perspectiveEnabled&&this.orthoSlider&&!this._batchLoading&&this.orthoSlider.dispatchEvent(new Event("input")),this.overlayState.enabled&&!this._batchLoading&&!a){const t=this._mergeFrameRange(o,0,o.frames.length-1);t&&(this.overlayState.frameIdMap=t.frameIdMap,this.overlayState.autoColor=t.autoColor,this._invalidateSegmentCache(),this._loadDataIntoRenderer(t,!1))}if(this.isPlaying||this._batchLoading?this.isPlaying||(this.overlayState.enabled?this.currentFrame=0:this.currentFrame=o.frames.length-1,this.lastRenderedFrame=-1):this.overlayState.enabled?(this.currentFrame=0,this.render("addFrame-overlay")):this.setFrame(o.frames.length-1),this.updateUIControls(),this.updatePAEContainerVisibility(),this.autoplay&&!this.isPlaying&&this.currentObjectName){const t=this.objectsData[this.currentObjectName];t&&t.frames.length>1&&this.startAnimation()}}extractSelection(){if(!this.currentObjectName)return void console.warn("No object loaded. Cannot extract selection.");const t=this.objectsData[this.currentObjectName];if(!t||!t.frames||0===t.frames.length)return void console.warn("No frames available. Cannot extract selection.");const e=t.frames[0];if(!e||!e.coords)return void console.warn("First frame has no coordinates. Cannot extract selection.");let i=new Set;if(this.selectionModel&&this.selectionModel.positions&&this.selectionModel.positions.size>0)i=new Set(this.selectionModel.positions);else if(null!==this.visibilityMask&&this.visibilityMask.size>0)i=new Set(this.visibilityMask);else{console.warn("No selection found. All positions are visible. Extracting all positions.");for(let t=0;t<e.coords.length;t++)i.add(t)}if(0===i.size)return void console.warn("Selection is empty. Cannot extract.");const s=Array.from(i).sort((t,e)=>t-e),o=this.currentObjectName,n=new Map,a=new Map;if(e.chains)for(let t=0;t<e.chains.length;t++){const i=e.chains[t];a.set(i,(a.get(i)||0)+1)}const r=new Map;if(e.chains&&e.residue_numbers)for(const t of s)if(t<e.chains.length&&t<e.residue_numbers.length){const i=e.chains[t],s=e.residue_numbers[t];if(r.set(i,(r.get(i)||0)+1),n.has(i)){const t=n.get(i);t.min=Math.min(t.min,s),t.max=Math.max(t.max,s)}else n.set(i,{min:s,max:s})}let l=o;if(n.size>0){const t=[],e=Array.from(n.keys()).sort();for(const i of e){const e=n.get(i),s=r.get(i)||0,o=a.get(i)||0;s===o&&o>0?t.push(i):t.push(`${i}${e.min}-${e.max}`)}l=`${o}_${t.join("_")}`}else l=`${o}_extracted`;let h=l,c=1;for(;void 0!==this.objectsData[l];)l=`${h}_${c}`,c++;this.addObject(l);for(let e=0;e<t.frames.length;e++){const i=t.frames[e];if(!i||!i.coords)continue;const o=this._resolvePlddtData(t,e),n=this._resolvePaeData(t,e),a=null!==o?o:i.plddts,r=null!==n?n:i.pae,h={coords:[],chains:i.chains?[]:void 0,plddts:a?[]:void 0,position_types:i.position_types?[]:void 0,position_names:i.position_names?[]:void 0,residue_numbers:i.residue_numbers?[]:void 0,pae:void 0,bonds:void 0};for(const t of s)t>=0&&t<i.coords.length&&(h.coords.push(i.coords[t]),i.chains&&t<i.chains.length&&h.chains.push(i.chains[t]),a&&t<a.length&&h.plddts.push(a[t]),i.position_types&&t<i.position_types.length&&h.position_types.push(i.position_types[t]),i.position_names&&t<i.position_names.length&&h.position_names.push(i.position_names[t]),i.residue_numbers&&t<i.residue_numbers.length&&h.residue_numbers.push(i.residue_numbers[t]));if(r){const t=r instanceof Uint8Array,e=Array.isArray(r)&&r.length>0&&Array.isArray(r[0]),i=Array.isArray(r)&&r.length>0&&!Array.isArray(r[0]);if(t||i){const t=Math.round(Math.sqrt(r.length)),e=s.length,i=new Uint8Array(e*e);for(let o=0;o<e;o++)for(let n=0;n<e;n++){const a=s[o],l=s[n];if(a<t&&l<t){const s=a*t+l;i[o*e+n]=r[s]}else i[o*e+n]=0}h.pae=i}else if(e){const t=[];for(let e=0;e<s.length;e++){const i=[];for(let t=0;t<s.length;t++){const o=s[e],n=s[t];o<r.length&&n<r[o].length?i.push(r[o][n]):i.push(0)}t.push(i)}h.pae=t}}if(i.bonds&&Array.isArray(i.bonds)&&i.bonds.length>0){const t=new Set(s),e=new Map;for(let t=0;t<s.length;t++)e.set(s[t],t);const o=[];for(const[s,n]of i.bonds)if(t.has(s)&&t.has(n)){const t=e.get(s),i=e.get(n);o.push([t,i])}o.length>0&&(h.bonds=o)}this.addFrame(h,l)}if(t.msa&&t.msa.msasBySequence&&t.msa.chainToSequence){const i=this.objectsData[l];i&&this._extractMSADataForSelection(t,i,e,s)}this._switchToObject(l),this.setFrame(0);const d=this.objectsData[l];this.paeRenderer&&d?.frames?.[0]?.pae&&this.paeRenderer.setData(d.frames[0].pae),this.updatePAEContainerVisibility(),this.paeRenderer&&this.paeRenderer.render&&this.paeRenderer.render(),this.objectSelect&&(this.objectSelect.value=l),this.setSelection({positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"default"}),this.updateUIControls(),"undefined"!=typeof window&&window.SequenceViewer&&window.SequenceViewer.buildSequenceView&&(window.SequenceViewer.clear&&window.SequenceViewer.clear(),window.SequenceViewer.buildSequenceView())}_extractMSADataForSelection(t,e,i,s){if(!t.msa||!t.msa.msasBySequence||!t.msa.chainToSequence)return;const o=new Set(s),n=e.frames[0];if(!n||!n.chains)return;e.msa={msasBySequence:{},chainToSequence:{},availableChains:[],defaultChain:null,msaToChains:{}};const a="undefined"!=typeof window&&"function"==typeof window.extractChainSequences?window.extractChainSequences:null;if(!a)return void console.warn("extractChainSequences not available, cannot extract MSA data");const r=a(n);for(const[s,n]of Object.entries(t.msa.chainToSequence)){const l=t.msa.msasBySequence[n];if(!l)continue;const h=l.msaData;if(!h)continue;const c=h.querySequence,d=a(i)[s];if(!d)continue;const u=[],p=i.chains.length;for(let t=0;t<p;t++)i.chains[t]===s&&i.position_types&&"P"===i.position_types[t]&&u.push(t);if(0===u.length)continue;u.sort((t,e)=>(i.residue_numbers?i.residue_numbers[t]:t)-(i.residue_numbers?i.residue_numbers[e]:e));const m=c.toUpperCase(),f=d.toUpperCase(),g=Math.min(m.length,f.length,u.length),y=new Set;for(let t=0;t<g;t++)if(m[t]===f[t]){const e=u[t];o.has(e)&&y.add(t)}if(0===y.size)continue;const b=h.sequencesOriginal||h.sequences,w=[],v=[];for(let t=0;t<c.length;t++)y.has(t)&&v.push(c[t]);for(const t of b){const e={name:t.name||"Unknown",sequence:""};void 0!==t.id&&(e.id=t.id),void 0!==t.description&&(e.description=t.description);const i=Array.isArray(t.sequence)?t.sequence.join(""):t.sequence;for(let t=0;t<i.length;t++)y.has(t)&&(e.sequence+=i[t]);w.push(e)}const S=v.join(""),M=S.replace(/-/g,"").toUpperCase();if(0===M.length)continue;let x=">query";const C=void 0!==h.queryIndex?h.queryIndex:0;b&&b[C]&&(x=b[C].name||">query");const _=w.findIndex(t=>t.name&&t.name.toLowerCase().includes("query"));if(-1===_&&w.length>0)w[0].name=x;else if(_>0){const t=w.splice(_,1)[0];w.unshift(t)}const D=new Array(S.length).fill(null),j=u.filter(t=>o.has(t)).sort((t,e)=>(i.residue_numbers?i.residue_numbers[t]:t)-(i.residue_numbers?i.residue_numbers[e]:e));let I=0;for(let t=0;t<S.length;t++){if("-"!==S[t]&&I<j.length){const e=j[I];i.residue_numbers&&e<i.residue_numbers.length&&(D[t]=i.residue_numbers[e]),I++}}const A={sequences:w,querySequence:S,queryLength:M.length,sequencesOriginal:w,queryIndex:0,residueNumbers:D};"undefined"!=typeof window&&"function"==typeof window.computeMSAProperties&&window.computeMSAProperties(A);const F=r[s];F&&F.toUpperCase()===M&&(e.msa.msasBySequence[M]||(e.msa.msasBySequence[M]={msaData:A,chains:[s]}),e.msa.chainToSequence[s]=M,e.msa.availableChains.includes(s)||e.msa.availableChains.push(s),e.msa.defaultChain||(e.msa.defaultChain=s))}"undefined"!=typeof window&&(window.updateMSAContainerVisibility&&setTimeout(()=>{window.updateMSAContainerVisibility()},100),window.updateMSAChainSelectorIndex&&setTimeout(()=>{window.updateMSAChainSelectorIndex()},100))}setFrame(t,e=!1){t=parseInt(t);const i=()=>{const t=this.displayWidth,e=this.displayHeight;this.isTransparent?this.ctx.clearRect(0,0,t,e):(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,t,e))};if(!this.currentObjectName)return this.currentFrame=-1,this.coords=[],i(),this.paeRenderer&&this.paeRenderer.setData(null),this.updateUIControls(),void this.setUIEnabled(!0);const s=this.objectsData[this.currentObjectName];if(!s||t<0||t>=s.frames.length)return this.currentFrame=-1,this.viewerState.currentFrame=-1,this.coords=[],i(),this.paeRenderer&&this.paeRenderer.setData(null),this.updateUIControls(),void this.setUIEnabled(!0);this.currentFrame=t,this.viewerState.currentFrame=t,this.overlayState.enabled?(this._composeAndApplyMask(e),e||this.render("setFrame-overlay")):(this._loadFrameData(t,!0),this._composeAndApplyMask(e),e||this.render("setFrame")),this.lastRenderedFrame=t,this.updatePAEContainerVisibility(),this.setUIEnabled(!0)}_isValidPAE(t){if(!t)return!1;if(Array.isArray(t)&&t.length>0||t.buffer&&t.length>0)return!0;if("object"==typeof t&&"number"!=typeof t.length){const e=Object.keys(t);return e.length>0&&!isNaN(parseInt(e[0]))}return!1}_hasPlddtData(t){return t&&t.plddts&&Array.isArray(t.plddts)&&t.plddts.length>0}_hasPaeData(t){return this._isValidPAE(t&&t.pae)}_resolvePlddtData(t,e){if(e<0||e>=t.frames.length)return null;const i=t.frames[e];if("plddts"in i)return i.plddts;if(this._hasPlddtData(i))return i.plddts;if(t._lastPlddtFrame>=0&&t._lastPlddtFrame<e&&this._hasPlddtData(t.frames[t._lastPlddtFrame]))return t.frames[t._lastPlddtFrame].plddts;for(let i=e-1;i>=0;i--)if(this._hasPlddtData(t.frames[i]))return t.frames[i].plddts;return null}_resolvePaeData(t,e){if(e<0||e>=t.frames.length)return null;if(this._hasPaeData(t.frames[e]))return t.frames[e].pae;if(t._lastPaeFrame>=0&&t._lastPaeFrame<e&&this._hasPaeData(t.frames[t._lastPaeFrame]))return t.frames[t._lastPaeFrame].pae;for(let i=e-1;i>=0;i--)if(this._hasPaeData(t.frames[i]))return t.frames[i].pae;return null}_findPAEContainer(){if(this.paeContainer)return this.paeContainer;if(this.canvas&&this.canvas.parentElement){const t=this.canvas.parentElement.closest("#mainContainer");if(t&&(this.paeContainer=t.querySelector("#paeContainer"),this.paeContainer))return this.paeContainer}return this.paeContainer=document.querySelector("#paeContainer"),this.paeContainer}objectHasPAE(t=null){const e=t||this.currentObjectName;if(!e||!this.objectsData[e])return!1;const i=this.objectsData[e];return!(!i.frames||0===i.frames.length)&&(!!this._hasPaeData(i.frames[0])||i.frames.some(t=>this._hasPaeData(t)))}updatePAEContainerVisibility(){const t=this._findPAEContainer();if(!t)return;const e=this.objectHasPAE();t.style.display=e?"flex":"none";const i=t.querySelector("#paeCanvas");i&&(i.style.display=e?"block":"none")}updateOutlineButtonStyle(){if(!this.outlineModeButton)return;const t=this.outlineModeButton.querySelector("span");t&&(this.outlineModeButton.classList.remove("outline-none","outline-partial","outline-full"),t.style.backgroundColor="",t.style.border="",t.style.color="",t.style.fontWeight="",t.style.transition="none","none"===this.outlineMode?(this.outlineModeButton.classList.add("outline-none"),t.style.backgroundColor="#e5e7eb",t.style.border="3px solid #e5e7eb",t.style.color="#000000",t.style.fontWeight="500"):"partial"===this.outlineMode?(this.outlineModeButton.classList.add("outline-partial"),t.style.backgroundColor="#e5e7eb",t.style.border="3px dashed #000000",t.style.color="#000000",t.style.fontWeight="500"):(this.outlineModeButton.classList.add("outline-full"),t.style.backgroundColor="#e5e7eb",t.style.border="3px solid #000000",t.style.color="#000000",t.style.fontWeight="500"))}setUIEnabled(t){this.playButton.disabled=!t,this.frameSlider.disabled=!t,this.objectSelect&&(this.objectSelect.disabled=!t),this.speedButton&&(this.speedButton.disabled=!t),this.rotationCheckbox.disabled=!t,this.lineWidthSlider.disabled=!t,this.shadowEnabledCheckbox&&(this.shadowEnabledCheckbox.disabled=!t),this.outlineModeButton&&(this.outlineModeButton.disabled=!t),this.outlineModeSelect&&(this.outlineModeSelect.disabled=!t),this.colorblindCheckbox&&(this.colorblindCheckbox.disabled=!t),this.orthoSlider&&(this.orthoSlider.disabled=!t),this.canvas.style.cursor=t?"grab":"wait"}updateUIControls(){if(!this.playButton)return;const t=this.currentObjectName?this.objectsData[this.currentObjectName]:null,e=t?t.frames.length:0,i=Math.max(0,this.currentFrame)+1,s=window.viewerConfig||{},o=!1!==s.display?.controls;this.controlsContainer.style.display=o?"flex":"none";const n=this.canvas?this.canvas.closest(".py2dmol-container")||this.canvas.parentElement?.closest("#mainContainer")?.parentElement:null,a=Object.keys(this.objectsData).length;if(this.objectSelect){const t=this.objectSelect.closest(".toggle-item")||this.objectSelect.parentElement;if(t&&(t.style.display=a<=1?"none":"flex"),n){const t=n.querySelector("#mainControlsContainer"),e=n.querySelector("#objectContainer"),i=t||e;i&&(i.style.display=s.display?.controls?"flex":"none")}}this.frameSlider.max=Math.max(0,e-1),this.isSliderDragging||(this.frameSlider.value=this.currentFrame),this.frameCounter.textContent=`${e>0?i:0} / ${e}`;const r=e>1;if([this.playButton,this.frameSlider,this.frameCounter,this.speedButton].forEach(t=>{t&&(t.style.display=r&&o?"":"none")}),this.controlsContainer){const t=r&&o;this.controlsContainer.style.display=t?"flex":"none"}this._updateSpeedButtonLabel(),this.overlayButton&&(this.overlayButton.disabled=e<=1,this.overlayButton.style.display=e<=1?"none":"");const l=this.overlayState.enabled||e<=1;if(this.playButton){this.playButton.querySelector("i")?(this.playButton.innerHTML=this.isPlaying?'<i class="fa-solid fa-pause"></i>':'<i class="fa-solid fa-play"></i>',this.isPlaying?(this.playButton.classList.remove("btn-secondary"),this.playButton.classList.add("btn-primary")):(this.playButton.classList.remove("btn-primary"),this.playButton.classList.add("btn-secondary"))):(this.playButton.innerHTML="",this.playButton.textContent=this.isPlaying?"❚❚":"▶︎"),this.playButton.disabled=l}if(this.recordButton){const t=this.recordButton.querySelector("i");t?this.isRecording?(t.className="fa-solid fa-stop",this.recordButton.classList.remove("btn-secondary"),this.recordButton.classList.add("btn-danger")):(t.className="fa-solid fa-video",this.recordButton.classList.remove("btn-danger"),this.recordButton.classList.add("btn-secondary")):this.isRecording?(this.recordButton.style.background="#ef4444",this.recordButton.style.color="#fff",this.recordButton.style.borderColor="#dc2626"):(this.recordButton.style.background="",this.recordButton.style.color="",this.recordButton.style.borderColor="");const i=this.currentObjectName&&this.objectsData[this.currentObjectName]&&this.objectsData[this.currentObjectName].frames.length>=2;this.recordButton.disabled=!i||l;const s=this.recordButton.closest(".toggle-item");s?s.style.display=e<=1?"none":"flex":this.recordButton.style.display=e<=1?"none":""}this.frameSlider&&(this.frameSlider.disabled=this.overlayState.enabled,this.frameSlider.style.opacity=this.overlayState.enabled?"0.5":"")}togglePlay(){if(this.isPlaying)this.stopAnimation();else{if(this.isRecording)return void console.warn("Cannot start playback while recording");if(this.overlayState.enabled)return void console.warn("Cannot start playback while in overlay mode");this.startAnimation()}}_mergeFrameRange(t,e,i){if(!t||0===t.frames.length)return null;if((e=Math.max(0,e))>(i=Math.min(t.frames.length-1,i)))return null;let s="rainbow";const o=t.frames[0];if(o){const t=o.chains||[],e=new Set(t);s=o.pae&&o.pae.length>0?"plddt":e.size>1?"chain":"rainbow"}const n=[],a=[],r=[],l=[],h=[],c=[],d=[],u=[];for(let s=e;s<=i;s++){const e=t.frames[s];if(!e)continue;const i=e.coords||[],o=e.bonds||[],p=e.chains||Array(i.length).fill("A"),m=n.length,f=i.length;for(let t=0;t<f;t++)n.push(i[t]),u.push(s);const g=e.plddts&&e.plddts.length===f?e.plddts:Array(f).fill(50),y=e.position_types&&e.position_types.length===f?e.position_types:Array(f).fill("P"),b=e.position_names&&e.position_names.length===f?e.position_names:Array(f).fill("UNK"),w=e.residue_numbers&&e.residue_numbers.length===f?e.residue_numbers:Array.from({length:f},(t,e)=>e+1);a.push(...g),l.push(...y),h.push(...b),c.push(...w);for(let t=0;t<f;t++)r.push(p[t]||"A");for(let t=0;t<o.length;t++){const e=o[t];d.push([e[0]+m,e[1]+m])}}const p=new Set(r);return s=o?.pae&&o.pae.length>0?"plddt":p.size>1?"chain":"rainbow",{coords:n,plddts:a,chains:r,position_types:l,position_names:h,residue_numbers:c,pae:this.pae||null,bonds:d.length>0?d:null,frameIdMap:u,autoColor:s,startFrame:e,endFrame:i}}_enterOverlayMode(t,e=!1){if(!t||0===t.frames.length)return!1;const i=this._mergeFrameRange(t,0,t.frames.length-1);return!!i&&(this.overlayState.enabled=!0,this.overlayState.frameIdMap=i.frameIdMap,this.overlayState.autoColor=i.autoColor,this.lastOperationMode="overlay-enter",this.speedButton&&(this.speedButton.disabled=!0,this.speedButton.style.opacity="0.5",this.speedButton.style.cursor="not-allowed"),this._invalidateSegmentCache(),this.currentFrame=0,this._loadDataIntoRenderer(i,e),!0)}_exitOverlayMode(t,e=0,i=!1){return!(!t||0===t.frames.length)&&(e=Math.max(0,Math.min(e,t.frames.length-1)),this.overlayState.enabled=!1,this.overlayState.frameIdMap=null,this.overlayState.autoColor=null,this.lastOperationMode="overlay-exit",this.speedButton&&(this.speedButton.disabled=!1,this.speedButton.style.opacity="1.0",this.speedButton.style.cursor="pointer"),this.cachedSegmentIndices=null,this.cachedSegmentIndicesFrame=-1,this.cachedSegmentIndicesObjectName=null,this._loadFrameData(e,i),!0)}toggleOverlay(){if(this.isPlaying&&this.stopAnimation(),!this.currentObjectName)return;const t=this.objectsData[this.currentObjectName];if(t&&0!==t.frames.length){if(this.overlayState.enabled){const e=Math.max(0,this.currentFrame);this._exitOverlayMode(t,e,!1)}else this._enterOverlayMode(t,!1);this.overlayButton&&(this.overlayState.enabled?(this.overlayButton.classList.remove("btn-secondary"),this.overlayButton.classList.add("btn-primary")):(this.overlayButton.classList.remove("btn-primary"),this.overlayButton.classList.add("btn-secondary"))),this.updateUIControls()}}startAnimation(){if(!this.currentObjectName)return;const t=this.objectsData[this.currentObjectName];!t||t.frames.length<2||(!this.isRecording&&this.currentFrame>=t.frames.length-1&&(this.currentFrame=0,this.overlayState.enabled||this._loadFrameData(0,!0)),this.isPlaying=!0,this.frameAdvanceTimer&&clearInterval(this.frameAdvanceTimer),this.frameAdvanceTimer=setInterval(()=>{if(this.isPlaying&&this.currentObjectName){if(this.isRecording)return;const t=this.objectsData[this.currentObjectName];if(t&&t.frames.length>1){let e=this.currentFrame+1;e>=t.frames.length&&(e=0),this.currentFrame=e,this.overlayState.enabled||this._loadFrameData(e,!0),this.updateUIControls()}else this.stopAnimation()}},this.animationSpeed),this.updateUIControls())}stopAnimation(){this.isPlaying=!1,this.frameAdvanceTimer&&(clearInterval(this.frameAdvanceTimer),this.frameAdvanceTimer=null),this.recordingFrameSequence&&(clearTimeout(this.recordingFrameSequence),this.recordingFrameSequence=null),this.updateUIControls()}recordFrameSequence(){if(!this.isRecording)return;if(!this.objectsData[this.currentObjectName])return void this.stopRecording();const t=this.currentFrame;t>this.recordingEndFrame?this.stopRecording():(this.overlayState.enabled||this._loadFrameData(t,!0),this.render(),this.lastRenderedFrame=t,this.updateUIControls(),requestAnimationFrame(()=>{const e=Math.max(50,this.animationSpeed);this.recordingFrameSequence=setTimeout(()=>{this.currentFrame=t+1,this.recordFrameSequence()},e)}))}toggleRecording(){this.isRecording?this.stopRecording():this.startRecording()}startRecording(){if(!this.currentObjectName)return void console.warn("Cannot record: No object loaded");const t=this.objectsData[this.currentObjectName];if(!t||t.frames.length<2)return void console.warn("Cannot record: Need at least 2 frames");if("undefined"==typeof MediaRecorder||!this.canvas.captureStream)return console.error("Recording not supported in this browser"),void alert("Video recording is not supported in this browser. Please use Chrome, Edge, or Firefox.");if(this.stopAnimation(),this.mediaRecorder&&"inactive"!==this.mediaRecorder.state)try{this.mediaRecorder.stop()}catch(t){console.warn("Error stopping existing recorder:",t)}this._stopRecordingTracks(),this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!0,this.recordingEndFrame=t.frames.length-1,this.isDragging=!1,this.spinVelocityX=0,this.spinVelocityY=0,this.canvas.style.pointerEvents="none";this.recordingStream=this.canvas.captureStream(30);const e={mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:2e7};MediaRecorder.isTypeSupported(e.mimeType)||(e.mimeType="video/webm;codecs=vp8",e.videoBitsPerSecond=15e6),MediaRecorder.isTypeSupported(e.mimeType)||(e.mimeType="video/webm",e.videoBitsPerSecond=15e6);try{this.mediaRecorder=new MediaRecorder(this.recordingStream,e),this.mediaRecorder.ondataavailable=t=>{t.data&&t.data.size>0&&this.recordedChunks.push(t.data)},this.mediaRecorder.onstop=()=>{this.finishRecording()},this.mediaRecorder.onerror=t=>{console.error("MediaRecorder error:",t.error),this.isRecording=!1,this.updateUIControls(),alert("Recording error: "+t.error.message)},this.mediaRecorder.start(100),this.updateUIControls(),this.stopAnimation(),this.setFrame(0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.recordFrameSequence()})})}catch(t){console.error("Failed to start recording:",t),this.isRecording=!1,this.updateUIControls(),alert("Failed to start recording: "+t.message)}}stopRecording(){this.isRecording&&(this.recordingFrameSequence&&(clearTimeout(this.recordingFrameSequence),this.recordingFrameSequence=null),this.canvas.style.pointerEvents="auto",this.stopAnimation(),this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&this.mediaRecorder.stop(),this._stopRecordingTracks())}finishRecording(){if(0===this.recordedChunks.length){console.warn("No video data recorded"),this.isRecording=!1,this.mediaRecorder=null,this.recordingStream&&(this.recordingStream.getTracks().forEach(t=>t.stop()),this.recordingStream=null),this.stopAnimation();const t=this.currentObjectName?this.objectsData[this.currentObjectName]:null;return t&&t.frames.length>0&&(this.currentFrame=Math.max(0,t.frames.length-1)),void this.updateUIControls()}const t=new Blob(this.recordedChunks,{type:"video/webm"}),e=`py2dmol_animation_${this.currentObjectName||"recording"}_${Date.now()}.webm`;this._downloadVideo(t,e),this.recordedChunks=[],this.isRecording=!1,this.mediaRecorder=null,this._stopRecordingTracks(),this.stopAnimation();const i=this.currentObjectName?this.objectsData[this.currentObjectName]:null;i&&i.frames.length>0&&(this.currentFrame=Math.max(0,i.frames.length-1)),this.updateUIControls()}clearAllObjects(){this.stopAnimation(),this.objectsData={},this.currentObjectName=null,this.objectSelect&&(this.objectSelect.innerHTML=""),this.paeRenderer&&this.paeRenderer.setData(null),this.setFrame(-1)}resetAll(){this.isPlaying&&this.stopAnimation(),this.isRecording&&this.stopRecording(),this.clearAllObjects(),this.viewerState={rotation:[[1,0,0],[0,1,0],[0,0,1]],zoom:1,perspectiveEnabled:!1,focalLength:200,center:null,extent:null,currentFrame:-1},this.isDragging=!1,this.spinVelocityX=0,this.spinVelocityY=0,this.colorsNeedUpdate=!0,this.plddtColorsNeedUpdate=!0,this.shadowEnabled=!0,this.outlineMode="full",this.autoRotate=!1,this.colorblindMode=!1,this.lineWidth=3,this.animationSpeed=100,this.currentFrame=-1,this.lastRenderedFrame=-1,this.shadowEnabledCheckbox&&(this.shadowEnabledCheckbox.checked=!0),this.outlineModeButton?(this.outlineMode="full",this.updateOutlineButtonStyle()):this.outlineModeSelect&&(this.outlineMode="full",this.outlineModeSelect.value="full"),this.rotationCheckbox&&(this.rotationCheckbox.checked=!1),this.colorblindCheckbox&&(this.colorblindCheckbox.checked=!1),this.lineWidthSlider&&(this.lineWidthSlider.value="3.0"),this.orthoSlider&&(this.orthoSlider.value="1.0",this.orthoSlider.dispatchEvent(new Event("input"))),this.frameSlider&&(this.frameSlider.value="0",this.frameSlider.max="0"),this.frameCounter&&(this.frameCounter.textContent="0/0"),this.playButton&&(this.playButton.textContent="▶︎"),this.recordButton&&(this.recordButton.classList.remove("btn-toggle"),this.recordButton.disabled=!1),this.clearSelection(),this.updateUIControls(),this.render()}_loadDataIntoRenderer(t,e=!1){if(t&&t.coords&&t.coords.length>0){const s=t.coords.map(t=>new i(t[0],t[1],t[2]));this.setCoords(s,t.plddts,t.chains,t.position_types,t.pae&&t.pae.length>0,t.position_names,t.residue_numbers,e,t.bonds)}else console.warn(`[_loadDataIntoRenderer] No data to load: coords=${t?.coords?.length}`)}setCoords(t,e,s,o,n=!1,a,r,l=!1,h=null){this.coords=t,null!=h?(this.bonds=h,this.currentObjectName&&this.objectsData[this.currentObjectName]&&(this.objectsData[this.currentObjectName].bonds=h)):this.currentObjectName&&this.objectsData[this.currentObjectName]&&this.objectsData[this.currentObjectName].bonds?this.bonds=this.objectsData[this.currentObjectName].bonds:this.bonds=null;const c=this.coords.length,d=getAllValidColorModes();this.colorMode&&d.includes(this.colorMode)||(this.colorMode="auto"),"entropy"===this.colorMode?this._mapEntropyToStructure():(this.entropy=void 0,this._updateEntropyOptionVisibility()),this.colorsNeedUpdate=!0,this.plddtColorsNeedUpdate=!0,this._setDataField("plddts","cachedPlddts",e,c,t=>Array(t).fill(50)),this._setDataField("chains","cachedChains",s,c,t=>Array(t).fill("A")),this._setDataField("positionTypes","cachedPositionTypes",o,c,t=>Array(t).fill("P")),this._setDataField("positionNames","cachedPositionNames",a,c,t=>Array(t).fill("UNK")),this._setDataField("residueNumbers","cachedResidueNumbers",r,c,t=>Array.from({length:t},(t,e)=>e+1));const u=new Set(this.chains);if(this.overlayState.enabled&&this.overlayState.autoColor?this.resolvedAutoColor=this.overlayState.autoColor:n?this.resolvedAutoColor="plddt":u.size>1?this.resolvedAutoColor="chain":this.resolvedAutoColor="rainbow",this.colorSelect&&this.colorMode&&this.colorSelect.value!==this.colorMode&&(this.colorSelect.value=this.colorMode),this.chainIndexMap=new Map,this.ligandOnlyChains=new Set,this.chains.length>0){const t=[...u].sort();for(const e of t)e&&!this.chainIndexMap.has(e)&&this.chainIndexMap.set(e,this.chainIndexMap.size);for(const e of t){let t=!1;for(let i=0;i<c;i++)if(this.chains[i]===e){const e=this.positionTypes[i];if("P"===e||"D"===e||"R"===e){t=!0;break}}t||this.ligandOnlyChains.add(e)}}this.perChainIndices=new Array(c);const p={};let m=-1;for(let t=0;t<c;t++){const e=this.positionTypes[t],i=this.chains[t]||"A",s=this.ligandOnlyChains.has(i);if(this.overlayState.enabled&&this.overlayState.frameIdMap){const e=this.overlayState.frameIdMap[t];if(e!==m){for(const t in p)p[t]=0;m=e}}"P"===e||"D"===e||"R"===e||"L"===e&&s?(void 0===p[i]&&(p[i]=0),this.perChainIndices[t]=p[i],p[i]++):this.perChainIndices[t]=0}if(this.overlayState.enabled&&this.overlayState.frameIdMap){this.frameRainbowScales={};for(let t=0;t<this.positionTypes.length;t++){const e=this.positionTypes[t],i=this.chains[t]||"A",s=this.overlayState.frameIdMap[t],o=this.ligandOnlyChains.has(i);if("P"===e||"D"===e||"R"===e||"L"===e&&o){this.frameRainbowScales[s]||(this.frameRainbowScales[s]={}),this.frameRainbowScales[s][i]||(this.frameRainbowScales[s][i]={min:1/0,max:-1/0});const e=this.perChainIndices[t],o=this.frameRainbowScales[s][i];o.min=Math.min(o.min,e),o.max=Math.max(o.max,e)}}this.chainRainbowScales=null}else{this.chainRainbowScales={};for(let t=0;t<this.positionTypes.length;t++){const e=this.positionTypes[t],i=this.chains[t]||"A",s=this.ligandOnlyChains.has(i);if("P"===e||"D"===e||"R"===e||"L"===e&&s){this.chainRainbowScales[i]||(this.chainRainbowScales[i]={min:1/0,max:-1/0});const e=this.perChainIndices[t],s=this.chainRainbowScales[i];s.min=Math.min(s.min,e),s.max=Math.max(s.max,e)}}}this.rotatedCoords.length!==c&&(this.rotatedCoords=Array.from({length:c},()=>new i(0,0,0)));const f=null!==this.cachedSegmentIndices&&this.cachedSegmentIndicesFrame===this.currentFrame&&this.cachedSegmentIndicesObjectName===this.currentObjectName&&this.cachedSegmentIndices.length>0,g=this.coords.length;for(;this.rotatedCoords.length<g;)this.rotatedCoords.push(new i(0,0,0));if(f)this.segmentIndices=this.cachedSegmentIndices.map(t=>({...t}));else{this.segmentIndices=[];const t=5,e=7.5,i=2,s=t*t,o=e*e,n=i*i,a=new Map,r=new Map,l=t=>"P"===t||"D"===t||"R"===t,h=this.positionTypes.map(l),d=(t,e)=>"D"!==t&&"R"!==t||"D"!==e&&"R"!==e?s:o;for(let t=0;t<c;t++)if(h[t]){const e=this.positionTypes[t],i=this.chains[t]||"A";if(r.has(i)?r.get(i).last=t:r.set(i,{first:t,last:t}),t<c-1&&h[t+1]){const i=e,s=this.positionTypes[t+1],o=i===s||("D"===i||"R"===i)&&("D"===s||"R"===s);let n=!0;if(this.overlayState.enabled&&this.overlayState.frameIdMap&&(n=this.overlayState.frameIdMap[t]===this.overlayState.frameIdMap[t+1]),o&&this.chains[t]===this.chains[t+1]&&n){const e=this.coords[t],o=this.coords[t+1],n=e.distanceToSq(o);n<d(i,s)&&this.segmentIndices.push({idx1:t,idx2:t+1,colorIndex:this.perChainIndices[t],origIndex:t,chainId:this.chains[t]||"A",type:i,len:Math.sqrt(n)})}}}else if("L"===this.positionTypes[t]){const e=this.chains[t]||"A";a.has(e)||a.set(e,[]),a.get(e).push(t)}if("boolean"!=typeof x.rendering?.detect_cyclic||x.rendering.detect_cyclic)for(const[t,e]of r.entries()){const i=e.first,s=e.last;if(i!==s&&(h[i]&&h[s])){const e=this.positionTypes[i],o=this.positionTypes[s];if(e===o||("D"===e||"R"===e)&&("D"===o||"R"===o)){const n=this.coords[i],a=this.coords[s],r=n.distanceToSq(a);r<d(e,o)&&this.segmentIndices.push({idx1:i,idx2:s,colorIndex:this.perChainIndices[i],origIndex:i,chainId:t,type:e,len:Math.sqrt(r)})}}}if(this.bonds&&Array.isArray(this.bonds)&&this.bonds.length>0)for(const[t,e]of this.bonds){if(t<0||t>=this.coords.length||e<0||e>=this.coords.length)continue;if(this.overlayState.enabled&&this.overlayState.frameIdMap){if(this.overlayState.frameIdMap[t]!==this.overlayState.frameIdMap[e])continue}const i=this.coords[t],s=this.coords[e],o=i.distanceToSq(s),n=this.chains[t]||"A",a=this.positionTypes?.[t]||"L",r=this.positionTypes?.[e]||"L",l="P"===a||"P"===r?"P":"D"===a||"D"===r?"D":"R"===a||"R"===r?"R":"L";this.segmentIndices.push({idx1:t,idx2:e,colorIndex:0,origIndex:t,chainId:n,type:l,len:Math.sqrt(o)})}const u=this.objectsData[this.currentObjectName];if(u?.ligandGroups?.size>0)for(const[t,e]of u.ligandGroups.entries())for(let t=0;t<e.length;t++)for(let i=t+1;i<e.length;i++){const s=e[t],o=e[i];if(s<0||s>=this.coords.length||o<0||o>=this.coords.length)continue;const a=this.coords[s],r=this.coords[o],l=a.distanceToSq(r);if(l<n){const t=this.chains[s]||"A";this.segmentIndices.push({idx1:s,idx2:o,colorIndex:0,origIndex:s,chainId:t,type:"L",len:Math.sqrt(l)})}}else for(const[t,e]of a.entries())for(let i=0;i<e.length;i++)for(let s=i+1;s<e.length;s++){const o=e[i],a=e[s],r=this.coords[o],l=this.coords[a],h=r.distanceToSq(l);h<n&&this.segmentIndices.push({idx1:o,idx2:a,colorIndex:0,origIndex:o,chainId:t,type:"L",len:Math.sqrt(h)})}const p=new Set;for(const t of this.segmentIndices)p.add(t.idx1),p.add(t.idx2);for(let t=0;t<this.coords.length;t++)if(!p.has(t)){const e=this.positionTypes[t]||"P",i=this.chains[t]||"A",s=this.perChainIndices[t]||0;this.segmentIndices.push({idx1:t,idx2:t,colorIndex:s,origIndex:t,chainId:i,type:e,len:0})}if(this.currentObjectName){const t=this.objectsData[this.currentObjectName];if(t&&t.contacts&&Array.isArray(t.contacts)&&t.contacts.length>0)for(const e of t.contacts){const t=this._resolveContactToIndices(e,c);if(t&&t.idx1>=0&&t.idx1<c&&t.idx2>=0&&t.idx2<c&&t.idx1!==t.idx2){const e=this.coords[t.idx1],i=this.coords[t.idx2],s=Math.sqrt(e.distanceToSq(i)),o=this.chains[t.idx1]||"A";this.segmentIndices.push({idx1:t.idx1,idx2:t.idx2,colorIndex:0,origIndex:t.idx1,chainId:o,type:"C",len:s,contactIdx1:t.idx1,contactIdx2:t.idx2,contactWeight:t.weight||1,contactColor:t.color||null})}}}const m=this.coords.length;for(;this.plddts.length<m;)this.plddts.push(50);for(;this.chains.length<m;)this.chains.push("A");for(;this.positionTypes.length<m;)this.positionTypes.push("P");for(;this.positionNames.length<m;)this.positionNames.push("UNK");for(;this.residueNumbers.length<m;)this.residueNumbers.push(-1);if(this.perChainIndices)for(;this.perChainIndices.length<m;)this.perChainIndices.push(0)}this.currentFrame>=0&&this.currentObjectName&&(this.cachedSegmentIndices=this.segmentIndices.map(t=>({...t})),this.cachedSegmentIndicesFrame=this.currentFrame,this.cachedSegmentIndicesObjectName=this.currentObjectName);const y=this.segmentIndices.length,b=this.coords.length;if(!this.adjList||this.adjList.length!==b||!this.segmentOrder||this.segmentOrder.length<y||!f){this.adjList=new Array(b);for(let t=0;t<b;t++)this.adjList[t]=[];(!this.segmentOrder||this.segmentOrder.length<y)&&(this.segmentOrder=new Int32Array(y),this.segmentFrame=new Int32Array(y),this.segmentEndpointFlags=new Uint8Array(y)),(!this.screenX||this.screenX.length<b)&&(this.screenX=new Float32Array(b),this.screenY=new Float32Array(b),this.screenRadius=new Float32Array(b),this.screenValid=new Int32Array(b));for(let t=0;t<y;t++){const e=this.segmentIndices[t];e.idx1<b&&this.adjList[e.idx1].push(t),e.idx2<b&&this.adjList[e.idx2].push(t)}}const w=this.segmentIndices.length;this.segData.length!==w&&(this.segData=Array.from({length:w},()=>({x:0,y:0,z:0,len:0,zVal:0,gx:-1,gy:-1}))),this.colors=this._calculateSegmentColors(),this.colorsNeedUpdate=!1,this.plddtColors=this._calculatePlddtColors(),this.plddtColorsNeedUpdate=!1,this._composeAndApplyMask(l),document.dispatchEvent(new CustomEvent("py2dmol-color-change"))}_loadFrameData(t,e=!1){if(!this.currentObjectName)return;const i=this.objectsData[this.currentObjectName];if(!i||t<0||t>=i.frames.length)return;const s=i.frames[t],o=this._resolvePlddtData(i,t),n=this._resolvePaeData(i,t),a=i.bonds||null,r={...s,plddts:o??s.plddts??null,pae:null!==n?n:s.pae,bonds:a};this._loadDataIntoRenderer(r,e),this.paeRenderer&&this.paeRenderer.setData(null!==n?n:s.pae||null);null!==this.previousObjectName&&this.previousObjectName!==this.currentObjectName?(this.resetToDefault(),this.previousObjectName=this.currentObjectName):"explicit"===this.selectionModel.selectionMode&&0===this.selectionModel.positions.size&&this.resetToDefault(),this.updateUIControls(),"entropy"===this.colorMode&&this._mapEntropyToStructure()}_mapEntropyToStructure(t=null){if(t||(t=this.currentObjectName),!t)return this.entropy=void 0,void this._updateEntropyOptionVisibility();const e=this.objectsData[t];if(!(e&&e.msa&&e.msa.msasBySequence&&e.msa.chainToSequence))return this.entropy=void 0,void this._updateEntropyOptionVisibility();const i=this.currentFrame>=0?this.currentFrame:0,s=e.frames[i];if(!s||!s.chains)return this.entropy=void 0,void this._updateEntropyOptionVisibility();const o=s.chains.length,n=new Array(o).fill(-1),a="undefined"!=typeof window&&"function"==typeof window.extractChainSequences?window.extractChainSequences:null;if(!a)return this.entropy=n,void this._updateEntropyOptionVisibility();const r=a(s);for(const[t,i]of Object.entries(e.msa.chainToSequence)){const a=e.msa.msasBySequence[i];if(!a||!a.msaData||!a.msaData.entropy)continue;const l=a.msaData.entropy;if(!r[t])continue;const h=[];for(let e=0;e<o;e++)s.chains[e]===t&&s.position_types&&"P"===s.position_types[e]&&h.push(e);if(0===h.length)continue;h.sort((t,e)=>(s.residue_numbers?s.residue_numbers[t]:t)-(s.residue_numbers?s.residue_numbers[e]:e));const c=Math.min(l.length,h.length);for(let t=0;t<c;t++){const e=h[t];e<n.length&&(n[e]=l[t])}}this.entropy=n,this._updateEntropyOptionVisibility()}_updateEntropyOptionVisibility(){const t=document.getElementById("entropyColorOption");if(t){const e=this.entropy&&this.entropy.some(t=>void 0!==t&&t>=0);t.hidden=!e,e||"entropy"!==this.colorMode||(this.colorMode="auto",this.colorSelect&&(this.colorSelect.value="auto"),this.colorsNeedUpdate=!0,this.render("_updateEntropyOptionVisibility: auto switch"))}}_getEffectiveColorMode(){const t=getAllValidColorModes();if(this.currentObjectName&&this.objectsData[this.currentObjectName]){const e=this.objectsData[this.currentObjectName].colorMode;if(e&&t.includes(e)){if("auto"===e){return this.resolvedAutoColor||"rainbow"}return e}}if(this.colorMode&&t.includes(this.colorMode)||(console.warn("Invalid colorMode:",this.colorMode,"resetting to auto"),this.colorMode="auto"),"auto"===this.colorMode){return this.resolvedAutoColor||"rainbow"}return this.colorMode}getAtomColor(t,e=null){if(t<0||t>=this.coords.length)return d({r:128,g:128,b:128},this.pastelLevel);let i=this.currentFrame>=0?this.currentFrame:0;this.overlayState.enabled&&this.overlayState.frameIdMap&&t<this.overlayState.frameIdMap.length&&(i=this.overlayState.frameIdMap[t]);const s={frameIndex:i,posIndex:t,chainId:this.chains[t]||"A",renderer:this},{resolvedMode:o,resolvedLiteralColor:n}=function(t){const{frameIndex:e,posIndex:i,chainId:s,renderer:o}=t,n=o.currentObjectName,a=o.objectsData[n];let r=o.colorMode||"auto",l=null;if(a&&a.color){const t=a.color;if("mode"===t.type)r=t.value;else if("literal"===t.type)l=t.value;else if("advanced"===t.type){const e=t.value;if(e.object){const t=e.object;"string"==typeof t&&f.includes(t.toLowerCase())?r=t.toLowerCase():l=t}if(e.chain&&s&&e.chain[s]){const t=e.chain[s];"string"==typeof t&&f.includes(t.toLowerCase())?(r=t.toLowerCase(),l=null):l=t}if(e.position&&void 0!==e.position[i]){const t=e.position[i];"string"==typeof t&&f.includes(t.toLowerCase())?(r=t.toLowerCase(),l=null):l=t}}}if(e>=0&&a&&a.frames&&a.frames[e]){const t=a.frames[e];if(t.color){const e=t.color;if("mode"===e.type)r=e.value,l=null;else if("literal"===e.type)l=e.value;else if("advanced"===e.type){const t=e.value;if(t.frame){const e=t.frame;"string"==typeof e&&f.includes(e.toLowerCase())?(r=e.toLowerCase(),l=null):l=e}if(t.chain&&s&&t.chain[s]){const e=t.chain[s];"string"==typeof e&&f.includes(e.toLowerCase())?(r=e.toLowerCase(),l=null):l=e}if(t.position&&void 0!==t.position[i]){const e=t.position[i];"string"==typeof e&&f.includes(e.toLowerCase())?(r=e.toLowerCase(),l=null):l=e}}}}return{resolvedMode:r,resolvedLiteralColor:l}}(s);if(null!==n){let t;if("string"==typeof n&&n.startsWith("#"))t=h(n);else if("string"==typeof n){const e=l[n.toLowerCase()];t=e?h(e):{r:128,g:128,b:128}}else!n||"object"!=typeof n||void 0===n.r&&void 0===n.g&&void 0===n.b||(t=n);if(t)return d(t,this.pastelLevel)}o&&"auto"!==o&&o!==this.colorMode?e=o:e&&"auto"!==e&&"auto"!==o||(e=this._getEffectiveColorMode());let g;const y="L"===(this.positionTypes&&t<this.positionTypes.length?this.positionTypes[t]:void 0);if("plddt"===e){g=p(null!==this.plddts[t]&&void 0!==this.plddts[t]?this.plddts[t]:50,this.colorblindMode)}else if("deepmind"===e){g=m(null!==this.plddts[t]&&void 0!==this.plddts[t]?this.plddts[t]:50,this.colorblindMode)}else if("entropy"===e){const e=this.entropy&&t<this.entropy.length&&void 0!==this.entropy[t]&&this.entropy[t]>=0?this.entropy[t]:void 0;g=void 0!==e?function(t,e=!1){const i=Math.max(0,Math.min(1,t||0));return c(e?240-180*i:240*(1-i),1,1)}(e,this.colorblindMode):{r:128,g:128,b:128}}else if("chain"===e){const e=this.chains[t]||"A";if(y&&!this.ligandOnlyChains.has(e))g={r:128,g:128,b:128};else if(this.chainIndexMap&&this.chainIndexMap.has(e)){const t=this.chainIndexMap.get(e),i=this.colorblindMode?r:a;g=h(i[t%i.length])}else{g=h((this.colorblindMode?r:a)[0])}}else if(window.py2dmol_customColors&&window.py2dmol_customColors[e]){const i=window.py2dmol_customColors[e];try{g=i(t,this),g||(g={r:128,g:128,b:128})}catch(t){console.error(`Error in custom color function for mode "${e}":`,t),g={r:128,g:128,b:128}}}else if(y)g={r:128,g:128,b:128};else{const e=this.chains[t]||"A";let i=null;if(this.overlayState.enabled&&this.overlayState.frameIdMap&&this.frameRainbowScales){const s=this.overlayState.frameIdMap[t];i=this.frameRainbowScales[s]&&this.frameRainbowScales[s][e]}else i=this.chainRainbowScales&&this.chainRainbowScales[e];if(i&&i.min!==1/0&&i.max!==-1/0){g=u(this.perChainIndices&&t<this.perChainIndices.length?this.perChainIndices[t]:0,i.min,i.max,this.colorblindMode)}else{const e=(this.perChainIndices&&t<this.perChainIndices.length?this.perChainIndices[t]:0)||0;g=u(e,0,Math.max(1,e),this.colorblindMode)}}return d(g,this.pastelLevel)}getChainColorForChainId(t){if(!this.chainIndexMap||!t)return{r:128,g:128,b:128};const e=this.chainIndexMap.get(t)||0,i=this.colorblindMode?r:a;return h(i[e%i.length])}_calculateSegmentColors(t=null){if(0===this.segmentIndices.length)return[];let e=this.overlayState.enabled&&this.overlayState.frameIdMap;return t||e||(t=this._getEffectiveColorMode()),this.segmentIndices.map(i=>{if("C"===i.type)return i.contactColor?i.contactColor:{r:255,g:255,b:0};const s=i.origIndex,o=e?null:t;return this.getAtomColor(s,o)})}_calculatePlddtColors(){const t=this.segmentIndices.length;if(0===t)return[];const e=new Array(t),i="deepmind"===this._getEffectiveColorMode()?m:p;for(let s=0;s<t;s++){const t=this.segmentIndices[s];if("C"===t.type){const i=t.contactColor||{r:255,g:255,b:0};e[s]=d(i,this.pastelLevel);continue}const o=t.origIndex;let n;if("L"===t.type){n=i(null!==this.plddts[o]&&void 0!==this.plddts[o]?this.plddts[o]:50,this.colorblindMode)}else{const e=this.plddts,s=null!==e[o]&&void 0!==e[o]?e[o]:50,a=t.idx2<this.coords.length?t.idx2:t.idx1;n=i((s+(null!==e[a]&&void 0!==e[a]?e[a]:50))/2,this.colorblindMode)}e[s]=d(n,this.pastelLevel)}return e}_rotationMatricesEqual(t,e){if(!t||!e)return!1;for(let i=0;i<3;i++)for(let s=0;s<3;s++)if(Math.abs(t[i][s]-e[i][s])>1e-6)return!1;return!0}_deepCopyMatrix(t){return[[t[0][0],t[0][1],t[0][2]],[t[1][0],t[1][1],t[1][2]],[t[2][0],t[2][1],t[2][2]]]}_resolveContactToIndices(t,e=null){if(!t||!Array.isArray(t))return null;let i=1,s=null;if(t.length>=3&&"number"==typeof t[0]&&"number"==typeof t[1])return i="number"==typeof t[2]?t[2]:1,t.length>=4&&"object"==typeof t[3]&&null!==t[3]&&(s=t[3]),{idx1:t[0],idx2:t[1],weight:i,color:s};if(t.length>=5&&"string"==typeof t[0]){const[o,n,a,r]=t;i="number"==typeof t[4]?t[4]:1,t.length>=6&&"object"==typeof t[5]&&null!==t[5]&&(s=t[5]);const l=null!==e?e:this.chains.length;let h=-1,c=-1,d=!1;for(let t=0;t<l&&(-1===this.residueNumbers[t]||(this.chains[t]===o&&this.residueNumbers[t]===n&&-1===h&&(h=t),this.chains[t]===a&&this.residueNumbers[t]===r&&-1===c&&(c=t),-1===h||-1===c));t++);if(-1===h||-1===c){if(d)console.warn(`Could not resolve contact: [${o}, ${n}, ${a}, ${r}]`);else{const t=new Set,e={};for(let i=0;i<Math.min(l,1e3);i++){if(-1===this.residueNumbers[i])continue;const s=this.chains[i],o=this.residueNumbers[i];t.add(s),e[s]?(e[s].min=Math.min(e[s].min,o),e[s].max=Math.max(e[s].max,o)):e[s]={min:o,max:o,samples:[]},e[s].samples.length<10&&e[s].samples.push(o)}console.warn(`Could not resolve contact: [${o}, ${n}, ${a}, ${r}]`),console.warn("  Available chains:",Array.from(t).sort()),console.warn("  Residue ranges:",Object.keys(e).map(t=>`${t}: ${e[t].min}-${e[t].max} (samples: ${e[t].samples.slice(0,5).join(", ")})`)),console.warn(`  Searching in first ${l} positions`),d=!0}return null}return{idx1:h,idx2:c,weight:i,color:s}}return console.warn("Invalid contact format:",t),null}_calculateTypeWidthMultiplier(t){return g[t]??g.P}_calculateSegmentWidthMultiplier(t,e){const i=e.type,s=this.typeWidthMultipliers?.[i]??this._calculateTypeWidthMultiplier(i);return"C"===i&&void 0!==e.contactWeight?s*e.contactWeight:s}_calculateShadowTint(t,e,i,s){const o=t.len,n=e.len,a=i.idx1===i.idx2,r=s.idx1===s.idx2;let l=o,h=n;a&&(l=y[i.type]??y.P),r&&(h=y[s.type]??y.P);const c=.5*(l+h),d=2*c,u=.5*c,p=y[i.type]??y.P,m=2.5*p,f=d+2.5*p,g=f*f,b=t.x-e.x,w=t.y-e.y,v=b*b+w*w;if(v>g)return{shadow:0,tint:0};let S=0,M=0;const x=t.z-e.z,C=v+x*x;if(C<g){const t=d*d;S=t/(t+C*2)}const _=u+m;if(v<_*_){const t=u*u;M=t/(t+v*2)}let D=1;const j=s.type,I=y.P;return"P"===j?D=1:"D"===j||"R"===j?D=y.D/I:"L"===j&&(D=y.L/I),r&&(D*=.5),D*=.5,{shadow:S*D,tint:M*D}}_calculateFrameShadows(t,e,i,s,o,n,a){e>this.LARGE_MOLECULE_CUTOFF?this._calculateShadowsWithGrid(t,i,s,o,n,a):this._calculateShadowsExhaustive(t,i,s,n,a)}_calculateShadowsExhaustive(t,e,i,s,o){for(let n=t.length-1;n>=0;n--){const a=t[n];let r=0,l=0;const h=i[a],c=e[a],d="C"===c.type,u="P"===c.type||"D"===c.type||"R"===c.type;for(let s=n+1;s<t.length;s++){const o=t[s];if(r>=b)break;const n=i[o],a=e[o],p="C"===a.type,m="P"===a.type||"D"===a.type||"R"===a.type;if(d&&m||u&&p)continue;const{shadow:f,tint:g}=this._calculateShadowTint(h,n,c,a);r=Math.min(r+f,b),l=Math.max(l,g)}s[a]=Math.pow(this.shadowIntensity,r),o[a]=1-l}}_calculateShadowsWithGrid(t,e,i,s,o,n){const a=t.length;let r=Math.ceil(Math.sqrt(a/5));r=Math.max(20,Math.min(150,r));const l=r*r,h=Array.from({length:l},()=>[]),c=-s-1,d=2*(s+1)/r,u=a>15e3?30:a>1e4?50:1/0;if(d<=1e-6)return o.fill(1),void n.fill(1);const p=1/d;for(let e=0;e<t.length;e++){const s=t[e],o=i[s],n=Math.floor((o.x-c)*p),a=Math.floor((o.y-c)*p);n>=0&&n<r&&a>=0&&a<r?(o.gx=n,o.gy=a):(o.gx=-1,o.gy=-1)}for(let e=0;e<t.length;e++){const s=t[e],o=i[s];if(o.gx>=0&&o.gy>=0){h[o.gx+o.gy*r].push(s)}}for(let t=0;t<l;t++){const e=h[t];if(e.length>1)if(e.length>u&&(e.length=u),e.length>2)e.sort((t,e)=>i[e].z-i[t].z);else if(2===e.length&&i[e[0]].z<i[e[1]].z){const t=e[0];e[0]=e[1],e[1]=t}}for(let s=t.length-1;s>=0;s--){const a=t[s];let l=0,c=0;const d=i[a],u=d.gx,p=d.gy,m=e[a],f="C"===m.type,g="P"===m.type||"D"===m.type||"R"===m.type;if(u<0)o[a]=1,n[a]=1;else{for(let t=-1;t<=1;t++){const s=p+t;if(s<0||s>=r)continue;const o=s*r;for(let t=-1;t<=1;t++){const s=u+t;if(s<0||s>=r)continue;if(l>=b)break;const n=h[s+o],a=n.length;for(let t=0;t<a;t++){const s=n[t];if(l>=b&&c>=1)break;const o=i[s],a=e[s],r="C"===a.type,h="P"===a.type||"D"===a.type||"R"===a.type;if(f&&h||g&&r)continue;if(o.z<=d.z)break;if(l>=b)break;const{shadow:u,tint:p}=this._calculateShadowTint(d,o,m,a);l=Math.min(l+u,b),c=Math.max(c,p)}}}o[a]=Math.pow(this.shadowIntensity,l),n[a]=1-c}}}_stopRecordingTracks(){this.recordingStream&&(this.recordingStream.getTracks().forEach(t=>t.stop()),this.recordingStream=null)}_updateCanvasDimensions(){this.displayWidth=parseInt(this.canvas.style.width)||this.canvas.width,this.displayHeight=parseInt(this.canvas.style.height)||this.canvas.height,window.SequenceViewer&&window.SequenceViewer.updateHighlightOverlaySize&&window.SequenceViewer.updateHighlightOverlaySize()}render(t="Unknown"){this.currentFrame<0?this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height):this._renderToContext(this.ctx,this.displayWidth,this.displayHeight)}_renderToContext(t,e,s){if(this.isTransparent?t.clearRect(0,0,e,s):(t.fillStyle="#ffffff",t.fillRect(0,0,e,s)),0===this.coords.length||0===this.segmentIndices.length||!this.currentObjectName)return;const o=this.objectsData[this.currentObjectName];if(!o)return void console.warn("Render called but object data is missing.");for(;this.rotatedCoords.length<this.coords.length;)this.rotatedCoords.push(new i(0,0,0));const n=o&&o.totalPositions>0?o.globalCenterSum.mul(1/o.totalPositions):new i(0,0,0),a=this.viewerState.center||n,r=this.viewerState.rotation,l=o&&o.rotation_matrix&&o.center?o.rotation_matrix:null,h=o&&o.center?o.center:null;for(let t=0;t<this.coords.length;t++){let e=this.coords[t];if(l&&h){const t=e.x-h[0],s=e.y-h[1],o=e.z-h[2],n=l[0][0]*t+l[0][1]*s+l[0][2]*o,a=l[1][0]*t+l[1][1]*s+l[1][2]*o,r=l[2][0]*t+l[2][1]*s+l[2][2]*o;e=new i(n+h[0],a+h[1],r+h[2])}const s=e.x-a.x,o=e.y-a.y,n=e.z-a.z,c=this.rotatedCoords[t];c.x=r[0][0]*s+r[0][1]*o+r[0][2]*n,c.y=r[1][0]*s+r[1][1]*o+r[1][2]*n,c.z=r[2][0]*s+r[2][1]*o+r[2][2]*n}const c=this.rotatedCoords,d=this.segmentIndices.length,u=this.segmentIndices,p=this._getEffectiveColorMode();let m;if("plddt"===p||"deepmind"===p?(this.plddtColors&&this.plddtColors.length===d&&!this.plddtColorsNeedUpdate||(this.plddtColors=this._calculatePlddtColors(),this.plddtColorsNeedUpdate=!1),m=this.plddtColors):(this.colors&&this.colors.length===d&&!this.colorsNeedUpdate||(this.colors=this._calculateSegmentColors(p),this.colorsNeedUpdate=!1),m=this.colors),(!m||m.length!==d)&&(console.warn("Color array mismatch, recalculating."),this.colors=this._calculateSegmentColors(p),this.plddtColors=this._calculatePlddtColors(),this.colorsNeedUpdate=!1,this.plddtColorsNeedUpdate=!1,m="plddt"===p||"deepmind"===p?this.plddtColors:this.colors,m.length!==d))return void console.error("Color array mismatch even after recalculation. Aborting render.");const f=this.visibilityMask,g=[];for(let t=0;t<d;t++){const e=u[t];let i=!1;i=!f||("C"===e.type&&void 0!==e.contactIdx1&&void 0!==e.contactIdx2?f.has(e.contactIdx1)&&f.has(e.contactIdx2):f.has(e.idx1)&&f.has(e.idx2)),i&&g.push(t)}const y=g.length,b=new Float32Array(d);let w=1/0,v=-1/0,S=1/0,M=-1/0;const x=this.segData;for(let t=0;t<y;t++){const e=g[t],i=u[e],s=c[i.idx1],o=c[i.idx2],n=.5*(s.x+o.x),a=.5*(s.y+o.y),r=.5*(s.z+o.z);b[e]=r,r<w&&(w=r),r>v&&(v=r),s.z<S&&(S=s.z),s.z>M&&(M=s.z),o.z<S&&(S=o.z),o.z>M&&(M=o.z);const l=x[e];l.x=n,l.y=a,l.z=r,l.len=i.len,l.zVal=r}const C=new Float32Array(d);let _;_=f?f.size:this.coords.length;const D=[];for(let t=0;t<y;t++){const e=g[t];D.push(b[e])}const j=D.length;let I=0;for(let t=0;t<j;t++)I+=D[t];const A=j>0?I/j:0;let F=0;for(let t=0;t<j;t++){const e=D[t]-A;F+=e*e}const O=j>0?F/j:0,E=Math.sqrt(O);if(E>1e-6){let t=A-2*E,e=A+2*E;const i=64,s=(t+e)/2;e-t<i&&(t=s-i/2,e=s+i/2);const o=e-t;for(let e=0;e<y;e++){const i=g[e];C[i]=(b[i]-t)/o,C[i]=Math.max(0,Math.min(1,C[i]))}}else{const t=64;let e=w,i=v;const s=(w+v)/2;v-w<t&&(e=s-t/2,i=s+t/2);const o=i-e;if(o>1e-6)for(let t=0;t<y;t++){const i=g[t];C[i]=(b[i]-e)/o}else for(let t=0;t<y;t++){C[g[t]]=.5}}const R=this.shadowEnabled,P=o&&o.maxExtent>0?o.maxExtent:30,L=new Float32Array(d),B=new Float32Array(d);L.fill(1),B.fill(1);g.sort((t,e)=>b[t]-b[e]);let N=g;const T=N.length,k=1e6;T>k&&(N=N.slice(T-k));const q=N.length,z=_>this.LARGE_MOLECULE_CUTOFF,V=d>this.LARGE_MOLECULE_CUTOFF,U=!this._rotationMatricesEqual(this.viewerState.rotation,this.lastShadowRotationMatrix),$=z&&(this.isDragging||this.isZooming||this.isOrientAnimating)&&this.cachedShadows&&this.cachedShadows.length===d||!U&&this.cachedShadows&&this.cachedShadows.length===d;if(R&&!$){if(this.overlayState.enabled&&this.overlayState.frameIdMap){const t=new Map,e=new Map;for(let i=0;i<N.length;i++){const s=N[i],o=this.overlayState.frameIdMap[u[s].idx1];t.has(o)||(t.set(o,[]),e.set(o,0)),t.get(o).push(s)}for(let t=0;t<this.coords.length;t++){const i=this.overlayState.frameIdMap[t];e.set(i,(e.get(i)||0)+1)}for(const[i,s]of t){const t=e.get(i);this._calculateFrameShadows(s,t,u,x,P,L,B)}}else this._calculateFrameShadows(N,_,u,x,P,L,B);this.lastShadowRotationMatrix=this._deepCopyMatrix(this.viewerState.rotation),!V||this.isDragging||this.isZooming||this.isOrientAnimating?V||(U?(this.cachedShadows=null,this.cachedTints=null):(this.cachedShadows=new Float32Array(L),this.cachedTints=new Float32Array(B))):(this.cachedShadows=new Float32Array(L),this.cachedTints=new Float32Array(B))}else $&&this.cachedShadows&&this.cachedShadows.length===d?(L.set(this.cachedShadows),B.set(this.cachedTints)):R||(L.fill(1),B.fill(1));const W=this.viewerState.extent||P;let X=.9*e/(2*W),Y=.9*s/(2*W);const G=Math.min(X,Y)*this.viewerState.zoom,H=this.lineWidth*G,Z=e/2,J=s/2;this.renderFrameId++;const K=this.renderFrameId,Q=this.segmentOrder,tt=this.segmentFrame;for(let t=0;t<q;t++){const e=N[t];Q[e]=t,tt[e]=K}const et=this.segmentEndpointFlags;for(let t=0;t<q;t++){const e=N[t],i=u[e],s=i.idx1===i.idx2,o=t,n="P"===i.type||"D"===i.type||"R"===i.type,a=i.chainId,r=i.type,l=t=>{if(s)return!0;if("C"===r)return!0;const e=this.adjList[t];if(!e)return!0;let i=0,l=o;const h=e.length;for(let t=0;t<h;t++){const s=e[t];if(tt[s]!==K)continue;const o=u[s];let h=!1;if(n?o.type===r&&o.chainId===a&&(h=!0):"L"===o.type&&(h=!0),h){i++;const t=Q[s];t<l&&(l=t)}}return i<=1||o===l};let h=0;l(i.idx1)&&(h|=1),l(i.idx2)&&(h|=2),et[e]=h}this.screenFrameId++;const it=this.screenFrameId,st=this.screenX,ot=this.screenY,nt=this.screenRadius,at=this.screenValid,rt=t=>{if(at[t]===it)return;const e=c[t];let i,s,o,n=.5;if(this.positionTypes&&t<this.positionTypes.length){const e=this.positionTypes[t];n=this.typeWidthMultipliers&&this.typeWidthMultipliers[e]||.5}let a=H*n;if(this.viewerState.perspectiveEnabled){const o=this.viewerState.focalLength-e.z;if(o<=.1)return void(at[t]=0);const n=this.viewerState.focalLength/o;i=Z+e.x*G*n,s=J-e.y*G*n,a*=n}else i=Z+e.x*G,s=J-e.y*G;o=Math.max(2,.5*a),st[t]=i,ot[t]=s,nt[t]=o,at[t]=it};for(let t=0;t<q;t++){const e=N[t],i=u[e];rt(i.idx1),rt(i.idx2)}const lt=c.length;if(this.highlightedAtoms&&this.highlightedAtoms.size>0)for(const t of this.highlightedAtoms)t>=0&&t<lt&&rt(t);if(null!==this.highlightedAtom&&void 0!==this.highlightedAtom){const t=this.highlightedAtom;t>=0&&t<lt&&rt(t)}let ht=null,ct=null,dt=null;const ut=(e,i,s)=>{e!==ht&&(t.strokeStyle=e,ht=e),i!==ct&&(t.lineWidth=i,ct=i),s!==dt&&(t.lineCap=s,dt=s)};for(let e=0;e<q;e++){const i=N[e];const s=u[i];let{r:o,g:n,b:a}=m[i];if(o/=255,n/=255,a/=255,"C"!==s.type){C[i];if(R){const t=.5*B[i]/3;o+=(1-o)*t,n+=(1-n)*t,a+=(1-a)*t;const e=.2+.8*L[i];o*=e,n*=e,a*=e}}const r=s.idx1,l=s.idx2;if(at[r]!==it||at[l]!==it)continue;const h=st[r],d=ot[r],p=st[l],f=ot[l],g=x[i],y=this._calculateSegmentWidthMultiplier(g,s);let b=H*y;if(this.viewerState.perspectiveEnabled){const t=c[r],e=c[l],i=this.viewerState.focalLength-t.z,s=this.viewerState.focalLength-e.z;if(i<=.1||s<=.1)continue;b*=(this.viewerState.focalLength/i+this.viewerState.focalLength/s)/2}b=Math.max(.5,b);const w=255*o|0,v=255*n|0,S=255*a|0,M=`rgb(${w},${v},${S})`,_=`rgb(${.7*w|0},${.7*v|0},${.7*S|0})`,D=et[i],j=!!(1&D),I=!!(2&D);if("none"!==this.outlineMode){const e=b+this.relativeOutlineWidth;if(s.idx1===s.idx2){const i=e/2;t.beginPath(),t.arc(h,d,i,0,2*Math.PI),t.fillStyle=_,t.fill()}else if(t.beginPath(),t.moveTo(h,d),t.lineTo(p,f),ut(_,e,"butt"),t.stroke(),"full"===this.outlineMode){const i=e/2;j&&(t.beginPath(),t.arc(h,d,i,0,2*Math.PI),t.fillStyle=_,t.fill()),I&&(t.beginPath(),t.arc(p,f,i,0,2*Math.PI),t.fillStyle=_,t.fill())}}if(s.idx1===s.idx2){const e=b/2;t.beginPath(),t.arc(h,d,e,0,2*Math.PI),t.fillStyle=M,t.fill()}else t.beginPath(),t.moveTo(h,d),t.lineTo(p,f),ut(M,b,"round"),t.stroke()}!this.isDragging&&window.SequenceViewer&&window.SequenceViewer.drawHighlights&&window.SequenceViewer.drawHighlights()}getHighlightCoordinates(){const t=[];if(!(this.screenValid&&this.screenX&&this.screenY&&this.screenRadius))return t;const e=e=>{e>=0&&e<this.screenValid.length&&this.screenValid[e]===this.screenFrameId&&t.push({x:this.screenX[e],y:this.screenY[e],radius:this.screenRadius[e]})};if(this.highlightedAtoms&&this.highlightedAtoms.size>0)for(const t of this.highlightedAtoms)e(t);return null!==this.highlightedAtom&&void 0!==this.highlightedAtom&&e(this.highlightedAtom),t}ensureAnimationLoop(){null===this.animationFrameId&&(this.animationFrameId=requestAnimationFrame(()=>this.animate()))}animate(){let t=!1;if(!this.isRecording&&!this.isDragging){let e=(this.currentObjectName?this.objectsData[this.currentObjectName]:null)&&this.segmentIndices?this.segmentIndices.length:0;if(this.visibilityMask&&this.segmentIndices){e=0;for(let t=0;t<this.segmentIndices.length;t++){const i=this.segmentIndices[t];this.visibilityMask.has(i.idx1)&&this.visibilityMask.has(i.idx2)&&e++}}if(e<=this.LARGE_MOLECULE_CUTOFF){const e=1e-4;if(Math.abs(this.spinVelocityX)>e){const e=o(.005*this.spinVelocityX);this.viewerState.rotation=n(e,this.viewerState.rotation),this.spinVelocityX*=.95,t=!0}else this.spinVelocityX=0;if(Math.abs(this.spinVelocityY)>e){const e=s(.005*this.spinVelocityY);this.viewerState.rotation=n(e,this.viewerState.rotation),this.spinVelocityY*=.95,t=!0}else this.spinVelocityY=0}else this.spinVelocityX=0,this.spinVelocityY=0}if(!this.isDragging&&this.autoRotate&&0===this.spinVelocityX&&0===this.spinVelocityY){const e=o(.005);this.viewerState.rotation=n(e,this.viewerState.rotation),t=!0}const e=this.currentFrame,i=this.lastRenderedFrame;if(i!==e&&this.currentObjectName){const i=this.objectsData[this.currentObjectName];i&&i.frames[e]&&(this.overlayState.enabled||0!==this.coords.length&&-1!==this.lastRenderedFrame||this._loadFrameData(e,!0),t=!0)}t&&(this.render("animate loop"),i!==e&&(this.lastRenderedFrame=e)),this.animationFrameId=requestAnimationFrame(()=>this.animate())}saveAsSvg(){try{if("undefined"==typeof C2S)throw new Error("canvas2svg library not loaded");const t=this.canvas;if(!t)throw new Error("Canvas not found");const e=this.displayWidth||parseInt(t.style.width)||t.width,i=this.displayHeight||parseInt(t.style.height)||t.height,s=new C2S(e,i);this._renderToContext(s,e,i);const o=s.getSerializedSvg();this._downloadSvg(o,this.currentObjectName)}catch(t){console.error("Failed to export SVG:",t);const e=`Error exporting SVG: ${t.message}`;"function"==typeof setStatus?setStatus(e,!0):alert(e)}}_generateFilename(t,e){const i=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5);let s=t||"viewer";return s=s.replace(/[^a-zA-Z0-9_-]/g,"_").substring(0,50),`py2dmol_${s}_${i}.${e}`}_downloadVideo(t,e){this._triggerDownload(t,e)}_downloadSvg(t,e){const i=this._generateFilename(e,"svg"),s=new Blob([t],{type:"image/svg+xml;charset=utf-8"});this._triggerDownload(s,i),"function"==typeof setStatus&&setStatus(`SVG exported to ${i}`)}_triggerDownload(t,e){const i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}}(_),F=t.querySelector("#canvasContainer"),O=t.querySelector("#viewerWrapper"),E=t.querySelector("#controlsContainer");if(F&&(F.style.width=j+"px",F.style.height=I+"px",O&&(O.style.width=j+"px")),F&&window.ResizeObserver){const t=new ResizeObserver(t=>{for(let e of t){let t=e.contentRect.width,i=e.contentRect.height;t=Math.max(t,1),i=Math.max(i,1);const s=parseInt(_.style.width)||j,o=parseInt(_.style.height)||I;if(Math.abs(t-s)>.5||Math.abs(i-o)>.5){const e=t*D,s=i*D;_.width=e,_.height=s,_.style.width=t+"px",_.style.height=i+"px",O&&(O.style.width=t+"px");const o=_.getContext("2d");o.setTransform(1,0,0,1,0,0),o.scale(D,D),A._updateCanvasDimensions(),A.render("ResizeObserver")}}});t.observe(F)}else window.ResizeObserver||console.warn("py2dmol: ResizeObserver not supported. Canvas resizing will not work.");if(x.pae?.enabled)try{const e=t.querySelector("#paeContainer"),i=t.querySelector("#paeCanvas");if(e&&i){A.paeContainer=e,e.style.display="none";const t=()=>{const t=e.getBoundingClientRect(),s=t.width||340,o=t.height||s;i.width=s,i.height=o,i.style.width="100%",i.style.height="100%";return i.getContext("2d").setTransform(1,0,0,1,0,0),A.paeRenderer&&(A.paeRenderer.size=s,A.paeRenderer.scheduleRender()),s};t();const s=()=>{if(!window.PAERenderer)return;t();const s=new window.PAERenderer(i,A),o=e.getBoundingClientRect();if(s.size=o.width||340,A.setPAERenderer(s),A.currentObjectName&&A.objectsData[A.currentObjectName]){const t=A.objectsData[A.currentObjectName];if(t.frames&&t.frames.length>0&&A.currentFrame>=0){const e=t.frames[A.currentFrame];e&&e.pae&&s.setData(e.pae)}}A.updatePAEContainerVisibility()};requestAnimationFrame(()=>{window.PAERenderer?s():window.addEventListener("py2dmol_pae_loaded",s,{once:!0})})}else console.warn("PAE container or canvas not found")}catch(t){console.error("Failed to initialize PAE renderer:",t)}const R=t.querySelector("#colorSelect");let P=getAllValidColorModes();A.colorMode&&P.includes(A.colorMode)||(A.colorMode=x.color?.mode&&P.includes(x.color.mode)?x.color.mode:"auto"),R&&A.colorMode&&(R.value=A.colorMode),R.addEventListener("change",t=>{const e=t.target.value;getAllValidColorModes().includes(e)?(A.colorMode=e,A.colorsNeedUpdate=!0,A.plddtColorsNeedUpdate=!0,"entropy"===e?A._mapEntropyToStructure():A.entropy=void 0,A.render(),document.dispatchEvent(new CustomEvent("py2dmol-color-change"))):R.value=A.colorMode||"auto"}),A.colorSelect=R;const L=t.querySelector("#shadowEnabledCheckbox");L.checked=A.shadowEnabled;const B=t.querySelector("#outlineModeButton"),N=t.querySelector("#outlineModeSelect");B||N&&(N.value=A.outlineMode||"full",N.addEventListener("change",t=>{A.outlineMode=t.target.value,A.render()}));const T=t.querySelector("#colorblindCheckbox");T.checked=A.colorblindMode;const k=t.querySelector("#playButton"),q=t.querySelector("#overlayButton"),z=t.querySelector("#recordButton"),V=t.querySelector("#saveSvgButton"),U=t.querySelector("#frameSlider"),$=t.querySelector("#frameCounter"),W=t.querySelector("#objectSelect"),X=t.querySelector("#speedButton"),Y=t.querySelector("#rotationCheckbox"),G=t.querySelector("#lineWidthSlider"),H=t.querySelector("#outlineWidthSlider"),Z=t.querySelector("#orthoSlider");G&&(G.value=A.lineWidth),H&&(H.value=A.relativeOutlineWidth||3),Y.checked=A.autoRotate,A.setUIControls(E,k,q,z,V,U,$,W,X,Y,G,H,L,B,N,T,Z);const J=t.querySelector("#saveStateButton");var K;if(J&&"function"!=typeof window.saveViewerState&&J.addEventListener("click",()=>{alert("Save state: Use the Python method view.save_state(filepath) to save the current state.")}),void 0!==x.rendering?.ortho&&Z&&(Z.value="number"!=typeof(K=x.rendering.ortho)?1:K>=50&&K<=200?(K-50)/150:K>=0&&K<=1?K:.5),!x.display?.controls){const e=t.querySelector("#rightPanelContainer");e&&(e.style.display="none")}if(!x.display?.box){const e=t.querySelector("#canvasContainer");if(e&&(e.style.border="none",e.style.background="transparent"),_&&(_.style.background="transparent"),x.pae?.enabled){const e=t.querySelector("#paeCanvas");e&&(e.style.border="none",e.style.background="transparent")}A.setClearColor(!0)}const Q=(t,e)=>{try{const i="string"==typeof t?JSON.parse(t):t;A.addFrame(i,e)}catch(t){console.error("Error adding frame:",t)}},tt=t=>{A.addObject(t)},et=()=>{A.clearAllObjects()},it=()=>{A.resetAll()},st=t=>{R&&(R.value=t,R.dispatchEvent(new Event("change")))},ot=(t,e)=>{try{const i="string"==typeof t?JSON.parse(t):t;e||(e=A.currentObjectName),e&&A.objectsData[e]&&(A.objectsData[e].color=i,A.cachedSegmentIndices=null,A.cachedSegmentIndicesFrame=-1,A.cachedSegmentIndicesObjectName=null,A.colors=null,A.plddtColors=null,A.colorsNeedUpdate=!0,A.plddtColorsNeedUpdate=!0,A.render("SetObjectColor"))}catch(t){console.error("Failed to set object color from Python:",t)}},nt=(t,e,i)=>{try{const s=JSON.parse(t),o=JSON.parse(e);i||(i=A.currentObjectName),i&&A.objectsData[i]&&(A.objectsData[i].rotation_matrix=s,A.objectsData[i].center=o,A.cachedShadows=null,A.lastShadowRotationMatrix=null,A.render("SetViewTransform"))}catch(t){console.error("Failed to set view transform from Python:",t)}};if(window.py2dmol_staticData&&window.py2dmol_staticData[e]&&window.py2dmol_staticData[e].length>0)try{for(const t of window.py2dmol_staticData&&window.py2dmol_staticData[e])if(t.name&&t.frames&&t.frames.length>0){const e=t.chains,i=t.position_types,s=t.contacts,o=t.bonds;for(let s=0;s<t.frames.length;s++){const n=t.frames[s],a=(n.coords&&n.coords.length,{coords:n.coords,chains:n.chains||e||void 0,position_types:n.position_types||i||void 0,plddts:n.plddts||void 0,pae:n.pae||void 0,position_names:n.position_names||void 0,residue_numbers:n.residue_numbers||void 0,bonds:n.bonds||o||void 0,color:n.color||void 0});A.addFrame(a,t.name)}if(s){const e=A.objectsData[t.name];e&&(e.contacts=s,A.cachedSegmentIndices=null)}t.color&&A.objectsData[t.name]&&(A.objectsData[t.name].color=t.color,A.cachedSegmentIndices=null),t.rotation_matrix&&t.center&&A.objectsData[t.name]&&(A.objectsData[t.name].rotation_matrix=t.rotation_matrix,A.objectsData[t.name].center=t.center,A.cachedShadows=null,A.lastShadowRotationMatrix=null)}if(window.py2dmol_staticData&&window.py2dmol_staticData[e]&&window.py2dmol_staticData[e].length>0){A.currentObjectName=(window.py2dmol_staticData&&window.py2dmol_staticData[e])[0].name,A.objectSelect.value=(window.py2dmol_staticData&&window.py2dmol_staticData[e])[0].name;const t=(window.py2dmol_staticData&&window.py2dmol_staticData[e])[0].name;A.objectsData[t]?.msa?.msasBySequence&&A.objectsData[t]?.msa?.chainToSequence&&A._mapEntropyToStructure(t),A.overlayState.enabled?(A.currentFrame=0,A.render("staticLoad-overlay")):A.setFrame(0),requestAnimationFrame(()=>{A.updatePAEContainerVisibility()})}}catch(t){console.error("Error loading static object data:",t),A.setFrame(-1)}else if(window.py2dmol_proteinData&&window.py2dmol_proteinData[e]&&window.py2dmol_proteinData[e].coords&&window.py2dmol_proteinData[e].coords.length>0)try{A.addFrame(window.py2dmol_proteinData&&window.py2dmol_proteinData[e],"0")}catch(t){console.error("Error loading initial data:",t),A.setFrame(-1)}else A.setFrame(-1);if(Z&&Z.dispatchEvent(new Event("input")),A.animate(),e){window.py2dmol_viewers[e]={handlePythonUpdate:Q,handlePythonNewObject:tt,handlePythonClearAll:et,handlePythonResetAll:it,handlePythonSetColor:st,handlePythonSetObjectColor:ot,handlePythonSetViewTransform:nt,renderer:A};try{const t=new BroadcastChannel(`py2dmol_${e}`),i="viewer_"+Math.random().toString(36).substring(2,15);t.postMessage({operation:"viewerReady",sourceInstanceId:i}),t.onmessage=t=>{const{operation:e,args:s,sourceInstanceId:o}=t.data;if(o!==i&&"fullStateUpdate"===e){const[t,e]=s;if(0===Object.keys(t).length)return void et();const i=new Set;for(const e of Object.keys(t))A.objectsData[e]||(tt(e),i.add(e));for(const[e,i]of Object.entries(t)){if(!i||0===i.length)continue;const t=A.objectsData[e];for(let s=t?t.frames.length:0;s<i.length;s++)Q(JSON.stringify(i[s]),e)}for(const[t,s]of Object.entries(e)){const e=A.objectsData[t];e&&(s.color&&(e.color=s.color),s.contacts&&(e.contacts=s.contacts),s.bonds&&(e.bonds=s.bonds),i.has(t)&&(s.rotation_matrix&&e.viewerState&&(e.viewerState.rotation=s.rotation_matrix),s.center&&e.viewerState&&(e.viewerState.center=s.center)))}A.cachedSegmentIndices=null,A.cachedSegmentIndicesFrame=-1,A.cachedSegmentIndicesObjectName=null,A.setFrame(A.currentFrame),A.render("broadcast update")}}}catch(t){}}else console.error("py2dmol: viewer_id not found in config. Cannot register API.")}window.py2dmol_viewers||(window.py2dmol_viewers={}),window.py2dmol_customColors||(window.py2dmol_customColors={}),function(){"use strict";function t(t,e){this.width=t,this.height=e,this.strokeStyle="#000000",this.fillStyle="#000000",this.lineWidth=1,this.lineCap="butt",this.currentPath=null,this.operations=[]}function e(t){if(!t||t.startsWith("#"))return t||"#000000";const e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(e){return`#${parseInt(e[1]).toString(16).padStart(2,"0")}${parseInt(e[2]).toString(16).padStart(2,"0")}${parseInt(e[3]).toString(16).padStart(2,"0")}`}return t}t.prototype.beginPath=function(){this.currentPath=[]},t.prototype.moveTo=function(t,e){this.currentPath||this.beginPath(),this.currentPath.push({type:"M",x:t,y:e})},t.prototype.lineTo=function(t,e){this.currentPath||this.beginPath(),this.currentPath.push({type:"L",x:t,y:e})},t.prototype.arc=function(t,e,i,s,o){this.currentPath||this.beginPath(),this.currentPath.push({type:"CIRCLE",x:t,y:e,radius:i})},t.prototype.stroke=function(){if(!this.currentPath||0===this.currentPath.length)return;let t="";for(let e=0;e<this.currentPath.length;e++){const i=this.currentPath[e];"M"===i.type?t+=`M ${i.x} ${i.y} `:"L"===i.type&&(t+=`L ${i.x} ${i.y} `)}this.operations.push({type:"stroke",pathData:t.trim(),strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,lineCap:this.lineCap}),this.currentPath=null},t.prototype.fill=function(){if(this.currentPath&&0!==this.currentPath.length){if(1===this.currentPath.length&&"CIRCLE"===this.currentPath[0].type){const t=this.currentPath[0];this.operations.push({type:"circle",x:t.x,y:t.y,radius:t.radius,fillStyle:this.fillStyle})}else{let t="";for(let e=0;e<this.currentPath.length;e++){const i=this.currentPath[e];"M"===i.type?t+=`M ${i.x} ${i.y} `:"L"===i.type&&(t+=`L ${i.x} ${i.y} `)}this.operations.push({type:"fill",pathData:t.trim(),fillStyle:this.fillStyle})}this.currentPath=null}},t.prototype.fillRect=function(t,e,i,s){this.operations.push({type:"rect",x:t,y:e,width:i,height:s,fillStyle:this.fillStyle})},t.prototype.clearRect=function(){},t.prototype.save=function(){},t.prototype.restore=function(){},t.prototype.scale=function(){},t.prototype.setTransform=function(){},t.prototype.translate=function(){},t.prototype.rotate=function(){},t.prototype.getSerializedSvg=function(){let t=`<svg xmlns="http://www.w3.org/2000/svg" width="${this.width}" height="${this.height}" viewBox="0 0 ${this.width} ${this.height}">\n`;t+=`  <rect width="${this.width}" height="${this.height}" fill="#ffffff"/>\n`;for(let i=0;i<this.operations.length;i++){const s=this.operations[i];if("rect"===s.type)t+=`  <rect x="${s.x}" y="${s.y}" width="${s.width}" height="${s.height}" fill="${e(s.fillStyle)}"/>\n`;else if("circle"===s.type)t+=`  <circle cx="${s.x}" cy="${s.y}" r="${s.radius}" fill="${e(s.fillStyle)}"/>\n`;else if("stroke"===s.type){const i="round"===s.lineCap?"round":"butt";t+=`  <path d="${s.pathData}" stroke="${e(s.strokeStyle)}" stroke-width="${s.lineWidth}" stroke-linecap="${i}" fill="none"/>\n`}else"fill"===s.type&&(t+=`  <path d="${s.pathData}" fill="${e(s.fillStyle)}"/>\n`)}return t+="</svg>",t},"undefined"!=typeof window&&(window.C2S=t),"undefined"!=typeof module&&module.exports&&(module.exports=t)}();