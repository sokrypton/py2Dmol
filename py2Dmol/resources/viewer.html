<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>py2Dmol_viewer</title>
    <style>
        * { box-sizing: border-box; }
        /* Make the container relative to position the init-error message */
        .py2dmol-container {
            position: relative;
        }
        body {
            margin: 0;
            padding: 8px; /* Add some padding around the whole thing */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
        }
        
        #mainContainer {
            display: flex;
            flex-direction: row;
            align-items: flex-start; /* Align tops */
            gap: 15px; /* Space between canvas column and controls column */
            background: transparent;
        }
        
        #viewerColumn {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between canvas and anim controls */
        }

        #canvasContainer {
            display: inline-block;
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: auto; /* REQUIRED for resize to work. Was 'hidden' */
            background: #ffffff;
            resize: both; /* ADDED: This enables the resize handle */
            /* ADDED: Set a minimum size so it doesn't disappear */
            min-width: 150px; 
            min-height: 150px;
        }
        #canvas {
            background: #ffffff;
            cursor: grab;
            display: block;
            /* Prevent touch actions like scrolling on the canvas */
            touch-action: none;
        }
        #canvas:active {
            cursor: grabbing;
        }

        /* Consistent form controls */
        select {
            font-size: 12px;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 28px;
            background: #fff;
        }
        select:focus {
            outline: none;
            border-color: #999;
        }

        #optionsContainer {
            font-size: 12px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px; /* Increased gap for clarity */
        }
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%;
        }
        .toggle-item label { 
            cursor: pointer; 
            white-space: nowrap;
            width: 50px;
            flex-shrink: 0;
            font-size: 12px;
        }
        /* Checkbox labels don't need fixed width */
        .toggle-item label[for="shadowEnabledCheckbox"],
        .toggle-item label[for="colorblindCheckbox"] {
            width: auto;
            margin-left: 4px;
        }
        .toggle-item input[type="range"] {
            cursor: pointer;
            flex-grow: 1; /* Let slider fill the rest */
            width: auto; /* Let flexbox handle it */
            min-width: 0; /* Fix for flexbox overflow */
        }
        .toggle-item input[type="checkbox"] { 
            cursor: pointer; 
            margin: 0;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }


        /* Animation Controls Container */
        #controlsContainer {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            padding: 0 10px;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        #objectContainer {
            font-size: 12px;
        }
        
        /* Simple compact button styles - no shadows, no animations */
        .controlButton {
            position: relative;
            padding: 0 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f0f0f0;
            height: 28px;
            min-width: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #1f2937;
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        /* Record and Play buttons - smaller for emoji/symbol */
        #recordButton, #playButton {
            min-width: 32px;
            padding: 0 6px;
        }
        /* Span styling for toggle buttons only */
        .controlButton.btn-toggle > span {
            display: inline;
            color: inherit;
        }
        .controlButton:hover:not(:disabled) {
            background: #e0e0e0;
        }
        .controlButton:active:not(:disabled) {
            background: #d0d0d0;
        }
        .controlButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f0f0f0;
        }
        /* Toggle button (Rotate) - checked state */
        .controlButton.btn-toggle {
            padding: 0 8px;
        }
        .controlButton.btn-toggle input[type="checkbox"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            margin: 0;
            cursor: pointer;
            z-index: 1;
        }
        .controlButton.btn-toggle input:checked + span {
            background: #10b981;
            color: #fff;
        }
        .controlButton.btn-toggle:has(input:checked) {
            background: #10b981;
            color: #fff;
        }
        .controlButton.btn-toggle input:not(:checked) + span {
            background: transparent;
            color: #1f2937;
        }
        .controlButton.btn-toggle:has(input:not(:checked)) {
            background: #f0f0f0;
            color: #1f2937;
        }
        #frameSlider {
            flex-grow: 1; 
            width: auto;
            margin: 0 10px;
            vertical-align: middle;
        }
        #frameCounter {
            color: #333;
            vertical-align: middle;
            min-width: 80px;
            display: inline-block;
            flex-shrink: 0;
        }
        #speedSelect {
            font-size: 12px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        #objectSelect {
            font-size: 12px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            vertical-align: middle;
            width: 100%;
        }
        #objectSelect:disabled {
             cursor: not-allowed;
            background: #eee;
        }

        /* Right panel for all other controls */
        #rightPanelContainer {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between control groups */
            width: 160px; /* Give it a fixed width */
            border: 1px solid #e0e0e0;
            border-radius: 12px; /* Changed from 8px */
            padding: 12px;
            background: #fdfdfd;
            flex-shrink: 0; /* Don't let it shrink */
        }
        
        /* Styling for groups in the right panel */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .control-group > label {
            font-weight: 600;
            font-size: 12px;
            color: #333;
        }
        
        /* Main Controls Container */
        #mainControlsContainer {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        /* Advanced Options Container */
        #advancedOptionsContainer {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Advanced Options Toggle Button */
        /* Advanced Options toggle uses .controlButton styles */
        #advancedOptionsToggle .toggle-icon {
            font-size: 10px;
            color: #666;
            margin-left: 4px;
        }
        #advancedOptionsToggle.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        /* Advanced Options Content */
        #advancedOptionsContent {
            display: none;
            flex-direction: column;
            gap: 6px;
            overflow: hidden;
        }
        #advancedOptionsContent.visible {
            display: flex;
        }
        
        #paeContainer {
            display: none; /* JS will manage visibility */
            width: 300px;
            height: 300px;
            min-width: 300px;
            min-height: 300px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: #ffffff;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        
        #paeCanvas {
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            touch-action: none; /* Prevent scrolling on PAE canvas */
        }
        
        /* Style for the initialization error message */
        .py2dmol-init-error {
            display: none; /* Hidden by default */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            color: #b91c1c; /* Red text */
            padding: 20px;
            text-align: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border: 2px dashed #f87171; /* Red dashed border */
            border-radius: 12px;
            z-index: 100;
        }
        .py2dmol-init-error p {
            margin: 0;
            font-weight: 500;
        }
        .py2dmol-init-error code {
            background: #fee2e2;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: Consolas, 'Courier New', monospace;
        }

    </style>
</head>
<body>
    <!-- Main container to hold viewer and controls -->
    <div id="mainContainer">
        
        <!-- Left Column -->
        <div id="viewerColumn">
            <!-- Canvas -->
            <div id="canvasContainer">
                <canvas id="canvas"></canvas>
            </div>

            <!-- Animation Controls -->
            <div id="controlsContainer">
                <button id="playButton" class="controlButton">â–¶ï¸Ž</button>
                <button id="recordButton" class="controlButton" title="Record animation to video file">ðŸ”´</button>
                <input type="range" id="frameSlider" min="0" max="0" value="0">
                <span id="frameCounter">Frame: 0 / 0</span>
                <select id="speedSelect">
                    <option value="100">1x</option>
                    <option value="50">2x</option>
                    <option value="25">4x</option>
                </select>
            </div>
        </div>
        
        <!-- PAE Canvas -->
        <div id="paeContainer" style="display: none;">
            <canvas id="paeCanvas" width="300" height="300" style="cursor: crosshair;"></canvas>
        </div>
        
        <!-- Right Column -->
        <div id="rightPanelContainer">
            
            <!-- Main Controls (always visible) -->
            <div id="mainControlsContainer" class="control-group">
                <!-- Action Buttons Row (at top) -->
                <div style="display: flex; gap: 4px; flex-wrap: wrap; align-items: center;">
                    <!-- Save SVG Button -->
                    <div class="toggle-item" style="width: auto; margin: 0;">
                        <button id="saveSvgButton" class="controlButton" title="Save as SVG">SVG</button>
                    </div>
                    <!-- Rotate Toggle Button -->
                    <div class="toggle-item" style="width: auto; margin: 0;">
                        <label class="controlButton btn-toggle" title="Toggle auto-rotation">
                            <input type="checkbox" id="rotationCheckbox">
                            <span>Rotate</span>
                        </label>
                    </div>
                </div>
                <!-- Object Dropdown -->
                <div class="toggle-item">
                    <label for="objectSelect" style="width: 50px;">Object:</label>
                    <select id="objectSelect" style="flex-grow: 1;">
                        <!-- Initially empty -->
                    </select>
                </div>
            </div>

            <!-- Advanced Options (collapsible) -->
            <div id="advancedOptionsContainer" class="control-group">
                <button id="advancedOptionsToggle" class="controlButton">
                    <span>Advanced <span class="toggle-icon">â–¼</span></span>
                </button>
                <div id="advancedOptionsContent">
                    <!-- Color Select -->
                    <div class="toggle-item">
                        <label for="colorSelect" style="width: 50px;">Color:</label>
                        <select id="colorSelect" style="flex-grow: 1;">
                            <option value="auto">Auto</option>
                            <option value="plddt">pLDDT</option>
                            <option value="rainbow">Rainbow</option>
                            <option value="chain">Chain</option>
                        </select>
                    </div>
                    <!-- Width -->
                    <div class="toggle-item">
                        <label for="lineWidthSlider" style="width: 50px;">Width:</label>
                        <input type="range" id="lineWidthSlider" min="2.0" max="4.7" value="3.0" step="0.1">
                    </div>
                    <!-- Ortho -->
                    <div class="toggle-item">
                        <label for="orthoSlider" style="width: 50px;">Ortho:</label>
                        <input type="range" id="orthoSlider" min="0" max="1" value="1.0" step="0.01">
                    </div>
                    <!-- Shadow -->
                    <div class="toggle-item">
                         <input type="checkbox" id="shadowEnabledCheckbox">
                         <label for="shadowEnabledCheckbox">Shadow</label>
                    </div>
                    <!-- Outline -->
                    <div class="toggle-item">
                        <label for="outlineModeSelect" style="width: 50px;">Outline:</label>
                        <select id="outlineModeSelect" style="flex-grow: 1;">
                            <option value="none">None</option>
                            <option value="partial">Partial</option>
                            <option value="full">Full</option>
                        </select>
                    </div>
                    <!-- Colorblind Checkbox -->
                    <div class="toggle-item">
                         <input type="checkbox" id="colorblindCheckbox">
                         <label for="colorblindCheckbox">Colorblind</label>
                    </div>
                </div>
            </div>
        </div>

    </div>    
    <!-- DATA_INJECTION_POINT -->
    
    <!-- Script to handle Advanced Options toggle -->
    <script>
        (function() {
            const initializedToggles = new WeakSet();
            
            // Function to initialize toggle for a specific container
            function initAdvancedToggle(container) {
                const toggleButton = container.querySelector('#advancedOptionsToggle');
                const advancedContent = container.querySelector('#advancedOptionsContent');
                
                if (toggleButton && advancedContent && !initializedToggles.has(toggleButton)) {
                    initializedToggles.add(toggleButton);
                    
                    toggleButton.addEventListener('click', function() {
                        const isVisible = advancedContent.classList.contains('visible');
                        if (isVisible) {
                            advancedContent.classList.remove('visible');
                            toggleButton.classList.remove('expanded');
                        } else {
                            advancedContent.classList.add('visible');
                            toggleButton.classList.add('expanded');
                        }
                    });
                }
            }
            
            // Initialize for all existing containers
            function initAllToggles() {
                // Try to find containers in the document
                const containers = document.querySelectorAll('.py2dmol-container, body');
                containers.forEach(container => {
                    initAdvancedToggle(container);
                });
            }
            
            // Try to initialize immediately
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initAllToggles);
            } else {
                initAllToggles();
            }
            
            // Also try after delays in case the viewer is injected dynamically
            setTimeout(initAllToggles, 100);
            setTimeout(initAllToggles, 500);
            
            // Use MutationObserver to watch for dynamically added viewers
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            if (node.classList && node.classList.contains('py2dmol-container')) {
                                initAdvancedToggle(node);
                            } else if (node.querySelector && node.querySelector('.py2dmol-container')) {
                                initAdvancedToggle(node.querySelector('.py2dmol-container'));
                            }
                            // Also check if the node itself contains the toggle
                            if (node.querySelector && node.querySelector('#advancedOptionsToggle')) {
                                initAdvancedToggle(node);
                            }
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        })();
    </script>
    
    <!-- SVG export is now handled in viewer-mol.js (same as Record button) -->

</body>
</html>