!function(){"use strict";function e(e,t){this.width=e,this.height=t,this.strokeStyle="#000000",this.fillStyle="#000000",this.lineWidth=1,this.font="10px monospace",this.textAlign="left",this.textBaseline="alphabetic",this.operations=[],this.clipStack=[],this.currentClip=null,this.transformStack=[],this.currentTransform={tx:0,ty:0,sx:1,sy:1,rotation:0}}e.prototype.fillRect=function(e,t,n,s){this.operations.push({type:"rect",x:e,y:t,width:n,height:s,fillStyle:this.fillStyle,clip:this.currentClip})},e.prototype.strokeRect=function(e,t,n,s){this.operations.push({type:"strokeRect",x:e,y:t,width:n,height:s,strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,clip:this.currentClip})},e.prototype.fillText=function(e,t,n){this.operations.push({type:"text",text:e,x:t,y:n,fillStyle:this.fillStyle,font:this.font,textAlign:this.textAlign,textBaseline:this.textBaseline,clip:this.currentClip,transform:{tx:this.currentTransform.tx,ty:this.currentTransform.ty,sx:this.currentTransform.sx,sy:this.currentTransform.sy,rotation:this.currentTransform.rotation}})},e.prototype.beginPath=function(){this.currentPath=[]},e.prototype.moveTo=function(e,t){this.currentPath||this.beginPath(),this.currentPath.push({type:"M",x:e,y:t})},e.prototype.lineTo=function(e,t){this.currentPath||this.beginPath(),this.currentPath.push({type:"L",x:e,y:t})},e.prototype.stroke=function(){if(!this.currentPath||0===this.currentPath.length)return;let e="";for(let t=0;t<this.currentPath.length;t++){const n=this.currentPath[t];"M"===n.type?e+=`M ${n.x} ${n.y} `:"L"===n.type&&(e+=`L ${n.x} ${n.y} `)}this.operations.push({type:"stroke",pathData:e.trim(),strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,clip:this.currentClip}),this.currentPath=null},e.prototype.rect=function(e,t,n,s){this.currentPath={type:"rect",x:e,y:t,width:n,height:s}},e.prototype.clip=function(){this.currentPath&&"rect"===this.currentPath.type&&(this.currentClip={type:"rect",x:this.currentPath.x,y:this.currentPath.y,width:this.currentPath.width,height:this.currentPath.height},this.currentPath=null)},e.prototype.save=function(){this.clipStack.push(this.currentClip),this.transformStack.push({...this.currentTransform})},e.prototype.restore=function(){this.clipStack.length>0?this.currentClip=this.clipStack.pop():this.currentClip=null,this.transformStack.length>0?this.currentTransform=this.transformStack.pop():this.currentTransform={tx:0,ty:0,sx:1,sy:1,rotation:0}},e.prototype.clearRect=function(){},e.prototype.translate=function(e,t){this.currentTransform.tx+=e*this.currentTransform.sx,this.currentTransform.ty+=t*this.currentTransform.sy},e.prototype.scale=function(e,t){this.currentTransform.sx*=e,this.currentTransform.sy*=void 0!==t?t:e},e.prototype.rotate=function(e){this.currentTransform.rotation+=e},e.prototype.setTransform=function(){this.currentTransform={tx:0,ty:0,sx:1,sy:1,rotation:0}},e.prototype.fill=function(){};let t=null,n=null;function s(e){if(!e||e.startsWith("#"))return e||"#000000";const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t){return`#${parseInt(t[1]).toString(16).padStart(2,"0")}${parseInt(t[2]).toString(16).padStart(2,"0")}${parseInt(t[3]).toString(16).padStart(2,"0")}`}return e}e.prototype.measureText=function(e){t||(t=document.createElement("canvas"),n=t.getContext("2d")),n.font=this.font,n.textAlign=this.textAlign,n.textBaseline=this.textBaseline;const s=n.measureText(e);return{width:s.width,actualBoundingBoxLeft:s.actualBoundingBoxLeft||0,actualBoundingBoxRight:s.actualBoundingBoxRight||s.width,actualBoundingBoxAscent:s.actualBoundingBoxAscent||0,actualBoundingBoxDescent:s.actualBoundingBoxDescent||0}},e.prototype.getSerializedSvg=function(){let e=`<svg xmlns="http://www.w3.org/2000/svg" width="${this.width}" height="${this.height}" viewBox="0 0 ${this.width} ${this.height}">\n`;e+=`  <rect width="${this.width}" height="${this.height}" fill="#ffffff"/>\n`;for(let t=0;t<this.operations.length;t++){const n=this.operations[t];let i="";if(n.clip&&(i+=`  <g clip-path="url(#clip${t})">\n`,e+=`  <defs><clipPath id="clip${t}"><rect x="${n.clip.x}" y="${n.clip.y}" width="${n.clip.width}" height="${n.clip.height}"/></clipPath></defs>\n`),"rect"===n.type)i+=`  <rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="${s(n.fillStyle)}"/>\n`;else if("strokeRect"===n.type)i+=`  <rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="none" stroke="${s(n.strokeStyle)}" stroke-width="${n.lineWidth}"/>\n`;else if("stroke"===n.type){const e="butt";i+=`  <path d="${n.pathData}" stroke="${s(n.strokeStyle)}" stroke-width="${n.lineWidth}" stroke-linecap="${e}" fill="none"/>\n`}else if("text"===n.type){let e=n.x,t=n.y,o=[];if(n.transform&&(0!==n.transform.tx||0!==n.transform.ty||1!==n.transform.sx||1!==n.transform.sy||0!==n.transform.rotation)){const s=n.transform.tx,i=n.transform.ty;e=s,t=i,1===n.transform.sx&&1===n.transform.sy||(o.push(`translate(${s.toFixed(4)},${i.toFixed(4)})`),o.push(`scale(${n.transform.sx.toFixed(6)},${n.transform.sy.toFixed(6)})`),o.push(`translate(${-s.toFixed(4)},${-i.toFixed(4)})`)),0!==n.transform.rotation&&o.push(`rotate(${(180*n.transform.rotation/Math.PI).toFixed(2)} ${s.toFixed(4)} ${i.toFixed(4)})`)}else if("middle"===n.textBaseline){const e=n.font.match(/(\d+)px/);t+=(e?parseInt(e[1]):10)/2}let l="start";"center"===n.textAlign?l="middle":"right"!==n.textAlign&&"end"!==n.textAlign||(l="end");const a=n.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=parseInt(n.font.match(/(\d+)px/)?.[1]||10);let c="normal";n.font.includes("bold")&&(c="bold");let h="";o.length>0&&(h=` transform="${o.join(" ")}"`);let u="middle"===n.textBaseline?"middle":"alphabetic";i+=`  <text x="${e}" y="${t}" fill="${s(n.fillStyle)}" font-family="monospace" font-size="${r}" font-weight="${c}" text-anchor="${l}" dominant-baseline="${u}"${h}>${a}</text>\n`}n.clip&&(i+="  </g>\n"),e+=i}return e+="</svg>",e};const i="bold 100px monospace",o=new Map;function l(e,t,n,s,l,a,r,c){if(a<=0||l<=0)return;const h=function(e,t){const n=t;if(o.has(n))return o.get(n);e.save(),e.font=i,e.textAlign="left",e.textBaseline="alphabetic";const s=e.measureText(t);e.restore();const l=s.actualBoundingBoxLeft??0,a=s.actualBoundingBoxRight??s.width??100,r=s.actualBoundingBoxAscent??80,c=s.actualBoundingBoxDescent??20;let h=l+a||s.width||100;"Q"!==t&&"q"!==t||(h=s.width||100);const u={left:l,width:h||1,ascent:r,descent:c,height:r+c||1};return o.set(n,u),u}(e,t),u=l/h.width,f=a/h.height,g=h.descent*f*1;e.save(),c&&(e.beginPath(),e.rect(c.x,c.y,c.w,c.h),e.clip()),e.translate(n+h.left*u,s-g),e.scale(u,f),e.fillStyle=r,e.font=i,e.textAlign="left",e.textBaseline="alphabetic",e.fillText(t,0,0),e.restore()}let a=null,r=null,c=null,h=null,u=null,f=null,g=null,d="msa",m=!0,p=!1,y=!0,v=null,b=.75,S=.75,x=.15,q=.15,M=0,w=0,A=0,T=0;const C=20,D=20,L=200,k=40,$=15,P=200/96,_=15,W="#f0f0f0",E="#b0b0b0",R="#d0d0d0",B=[{name:"group1",label:"KR",aminoAcids:["K","R"],color:{r:212,g:68,b:43}},{name:"group2",label:"AFILMVW",aminoAcids:["A","F","I","L","M","V","W"],color:{r:61,g:126,b:223}},{name:"group3",label:"NQST",aminoAcids:["N","Q","S","T"],color:{r:96,g:201,b:65}},{name:"group4",label:"HY",aminoAcids:["H","Y"],color:{r:83,g:177,b:178}},{name:"group5",label:"C",aminoAcids:["C"],color:{r:217,g:133,b:130}},{name:"group6",label:"DE",aminoAcids:["D","E"],color:{r:189,g:85,b:198}},{name:"group7",label:"P",aminoAcids:["P"],color:{r:204,g:204,b:65}},{name:"group8",label:"G",aminoAcids:["G"],color:{r:219,g:157,b:91}}],I={},H={};B.forEach(e=>{I[e.name]=e.color,e.aminoAcids.forEach(t=>{H[t]=e.name})}),I.gap={r:200,g:200,b:200},I.other={r:150,g:150,b:150};const O=B.flatMap(e=>e.aminoAcids),N=[];let z=0;for(let e=1;e<B.length;e++)z+=B[e-1].aminoAcids.length,N.push(z);function F(e){if(!e||"-"===e||"X"===e)return I.gap;const t=H[e.toUpperCase()];return t?I[t]:I.other}const U={A:.082,R:.057,N:.044,D:.053,C:.017,Q:.04,E:.062,G:.072,H:.022,I:.052,L:.09,K:.057,M:.024,F:.039,P:.051,S:.069,T:.058,W:.013,Y:.032,V:.066};function V(e){return e&&"-"!==e&&"X"!==e?U[e.toUpperCase()]||.05:0}let Y={getRenderer:null};const j=948;function X(e){return Math.max(0,Math.min(1,e))}function G(e,t,n){e.fillStyle="#ffffff",e.fillRect(0,0,t,n)}function Q(e){return">query"===e||e.toLowerCase().includes("query")}function K(e){return!e||"-"===e||"."===e||" "===e||"X"===e}function J(){p||(p=!0,requestAnimationFrame(()=>{p=!1,ee(d)}))}function Z(e){switch(e){case"msa":Oe();break;case"pssm":Ne();break;case"logo":ze();break;case"coverage":!function(){if(!Ue())return void(a?Array.isArray(a.sequences)?0===a.sequences.length?console.warn("MSA Viewer: All sequences were filtered out for coverage view. Consider lowering coverage/identity filter thresholds."):a.queryLength||a.querySequence?.length?console.warn("MSA Viewer: Unknown issue preventing coverage view build"):console.warn("MSA Viewer: Query sequence has no length"):console.warn("MSA Viewer: displayedMSA.sequences is not an array:",a.sequences):console.warn("MSA Viewer: displayedMSA is not set"));const e=function(){const e=document.getElementById("msa-buttons");if(!e)return null;const t=e.parentElement||e,n=t.getBoundingClientRect();if(!n||n.width<=0)return null;let s=0;if(window.getComputedStyle){const e=window.getComputedStyle(t),n=e=>{const t=parseFloat(e);return Number.isFinite(t)?t:0};s=n(e.paddingLeft)+n(e.paddingRight)}return{width:Math.max(1,Math.floor(n.width-s)),height:Math.max(1,Math.floor(n.height))}}(),{width:t,height:n}=ge(),s=Math.max(j,e?.width||t||0),i=n>150?n:420,o=He("coverage",{viewElementId:"msa-buttons",contentPadding:0,calculateDimensions:()=>({canvasWidth:s,canvasHeight:i}),additionalCanvasData:{axisLabelHeight:32,yAxisLabelWidth:55}});if(!o)return;const{canvas:l,container:r,canvasData:c}=o;r.classList.add("msa-canvas--coverage"),l&&(l.style.borderRadius="var(--radius-lg)");g=c,Pe&&(Pe.cleanup(),Pe=null);Ye()}()}}function ee(e){switch(e){case"msa":Ae();break;case"pssm":Le();break;case"logo":ke();break;case"coverage":Ye()}}function te(e,t){const n=t.getBoundingClientRect(),s=void 0!==e.clientX?e.clientX:e.touches&&e.touches[0]?e.touches[0].clientX:e.changedTouches[0].clientX,i=void 0!==e.clientY?e.clientY:e.touches&&e.touches[0]?e.touches[0].clientY:e.changedTouches[0].clientY,o=s-n.left,l=i-n.top;return{x:o*(t.width/P/n.width),y:l*(t.height/P/n.height)}}function ne(e,t,n=null){if(!e||0===t)return 0;let s=0,i=0;for(let t=0;t<e.length;t++)n&&!n[t]||(i++,K(e[t])||s++);return i>0?s/i:0}function se(e,t,n=null){if(!e||!t||e.length!==t.length)return 0;let s=0,i=0;for(let o=0;o<e.length;o++){if(n&&!n[o])continue;const l=e[o].toUpperCase(),a=t[o].toUpperCase();i++,K(l)||K(a)||l!==a||s++}return i>0?s/i:0}const ie=[{value:0,color:[239,68,68]},{value:.5,color:[252,211,77]},{value:.75,color:[16,185,129]},{value:1,color:[37,99,235]}];function oe(e,t,n){return[Math.round(e[0]+(t[0]-e[0])*n),Math.round(e[1]+(t[1]-e[1])*n),Math.round(e[2]+(t[2]-e[2])*n)]}function le(e){const t=X(e||0);for(let e=0;e<ie.length-1;e++){const n=ie[e],s=ie[e+1];if(t>=n.value&&t<=s.value){const e=s.value-n.value||1,i=(t-n.value)/e;return oe(n.color,s.color,i)}}return ie[ie.length-1].color}function ae(){if(!Y.getRenderer)return{positions:null,chains:null};const e=Y.getRenderer();if(!e?.currentObjectName)return{positions:null,chains:null};const t=e.objectsData[e.currentObjectName];if(!t?.msa||!v)return{positions:null,chains:null};const n=t.msa.chainToSequence[v],s=n&&t.msa.msasBySequence[n],i=s?.chains||[v];return{positions:void 0!==t.msa.selectedPositions?t.msa.selectedPositions:null,chains:i}}function re(e,t={}){const{selectedPositions:n=null,chains:s=null,minCoverage:i=b,minIdentity:o=x,shouldSort:l=y}=t,a={sequences:e.sequencesOriginal||e.sequences,querySequence:e.querySequence,queryLength:e.queryLength,queryIndex:e.queryIndex||0};e.residueNumbers&&(a.residueNumbers=[...e.residueNumbers]),e.sequencesOriginal&&(a.sequencesOriginal=e.sequencesOriginal);const r=we(a,s,n);let c=ce(r.sequences,i,null);return c=he(c,r.querySequence,o,null),l&&(c=ue(c,r.querySequence,r.queryLength,null)),{sequences:c,querySequence:r.querySequence,queryLength:r.queryLength,queryIndex:r.queryIndex||0,residueNumbers:r.residueNumbers,selectionMask:r.selectionMask}}function ce(e,t=.5,n=null){if(!e||0===e.length)return[];const s=e[0]?.sequence?.length||0;return e.filter(e=>ne(e.sequence,s,n)>=t)}function he(e,t,n=.15,s=null){return e&&0!==e.length&&t?e.filter(e=>{if(Q(e.name))return!0;if(void 0!==e.identity)return e.identity>=n;return se(e.sequence,t,s)>=n}):e}function ue(e,t,n,s=null){if(!e||0===e.length||!t)return e;const i=e.map(e=>({...e,identity:se(e.sequence,t,s),coverage:ne(e.sequence,n,s)}));return i.sort((e,t)=>Q(e.name)?-1:Q(t.name)?1:t.identity-e.identity),i}function fe(e){return"msa"===e?10:D}function ge(){const e=document.querySelector(".msa-canvas");if(e){const t=e.getBoundingClientRect(),n=12;return{width:Math.max(1,Math.floor(t.width-2*n)||j),height:Math.max(1,Math.floor(t.height-2*n)||420)}}return{width:j,height:420}}function de(e){return{logicalWidth:e.width/P,logicalHeight:e.height/P}}function me(e,t,n){let s,i,o,l;return"msa"===e?(s=L,i=35,o=t-s-_,l=n-i-_):"pssm"===e?(s=D,i=35,o=t-s,l=n-i-_):"coverage"===e?(s=k,i=0,o=t-s,l=n):(s=k,i=0,o=t-s,l=n-_),{scrollableAreaX:s,scrollableAreaY:i,scrollableAreaWidth:o,scrollableAreaHeight:l}}function pe(e){return{scrollableAreaY:35,scrollableAreaHeight:e-35-_}}function ye(e,t,n,s){const i="coverage"===e&&r?r:a;if(!i)return{horizontal:{total:0,max:0},vertical:{total:0,max:0}};const{scrollableAreaX:o,scrollableAreaWidth:l,scrollableAreaHeight:c}=me(e,n,s),h=i.queryLength*t,u=Math.max(0,h-l);let f=0,g=0;return"msa"===e&&(f=(i.sequences.length-1)*C,g=Math.max(0,f-c)),{horizontal:{total:h,max:u},vertical:{total:f,max:g}}}function ve(e){if(!a)return;const{scrollableAreaHeight:t}=pe(e),n=(a.sequences.length-1)*C,s=Math.max(0,n-t);A=Math.max(0,Math.min(A,s))}function be(e,t){if(!a)return;let n=0;"msa"===d?n=L:"pssm"===d?n=D:"logo"===d&&(n=k);const s=e-n-("msa"===d?_:0),i=a.queryLength*t,o=Math.max(0,i-s);T=Math.max(0,Math.min(T,o))}function Se(e,t,n,s,i,o,l,r=0){if(!a)return;e.fillStyle="#ffffff",e.fillRect(0,r,t,15);const h=Math.floor(n/s),u=Math.min(a.queryLength,h+Math.ceil((l-o)/s)+1),f=a.residueNumbers||c;let g=i-n%s;for(let t=h;t<u&&t<a.queryLength;t++){let n;n=f&&t<f.length&&null!==f[t]?f[t]:t+1;if(1===n||n%10==0){const t=g;if(t+s>=o&&t<l){const i=Math.max(o,t),a=i+Math.min(s,l-i)/2;e.fillStyle="#333",e.font="10px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(n.toString(),a,r+7.5)}}g+=s}}function xe(e,t,n,s,i,o={}){const{padding:l=8,fontSize:a=12,fontFamily:r="monospace",textColor:c="#333",maxChars:h=32}=o,u=l,f=n+s/2;e.save(),e.fillStyle=c,e.font=`${a}px ${r}`,e.textAlign="left",e.textBaseline="middle";const g=Math.floor(i-l);let d=t;d.length>h&&(d=d.substring(0,h));let m=e.measureText(d).width;return m>=g&&(d=function(e,t,n){if(e.measureText(t).width<=n)return t;let s=t;for(;e.measureText(s).width>n&&s.length>0;)s=s.slice(0,-1);return s}(e,d,g-1),m=e.measureText(d).width),e.beginPath(),e.rect(0,n,i,s),e.clip(),e.fillText(d,u,f),e.restore(),{textX:u,textY:f,textWidth:e.measureText(d).width,wasTruncated:d!==t}}function qe(e,t,n,s,i,o,l,r,c,h,u,f=!0,g=20){if(!a||!i)return;e.fillStyle="#ffffff",e.fillRect(h,n,t-h,s);const d=h,m=t;let p=l-o%g;for(let t=r;t<c&&t<i.sequence.length;t++){if(p+g<d){p+=g;continue}if(p>=m)break;const o=i.sequence[t],l=F(o);let r=l.r,c=l.g,h=l.b;const u=!a.selectionMask||a.selectionMask[t];if(!u){const e=.4;r=Math.floor(r+(255-r)*(1-e)),c=Math.floor(c+(255-c)*(1-e)),h=Math.floor(h+(255-h)*(1-e))}p+g>=d&&p<m&&(e.save(),e.beginPath(),e.rect(d,n,m-d,s),e.clip(),e.fillStyle=`rgb(${r}, ${c}, ${h})`,e.fillRect(p,n,g,s),e.fillStyle=u?"#000":"#999",e.font="10px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(o,p+g/2,n+s/2),e.restore()),p+=g}if(f){const i=n+s,o=t;e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(0,i),e.lineTo(o,i),e.stroke()}}function Me(e,t,n,s,i,o,l){if(!a)return;const r=Math.max(0,l-i),c=n-_,h=t-s;if(e.fillStyle="#ffffff",e.fillRect(0,c,o,_),e.fillStyle=W,e.fillRect(s,c,h,_),r>0){const t=T/r,n=Math.max(20,i/l*i),o=s+t*(i-n);e.fillStyle=E,e.fillRect(o,c+2,n,11)}}function we(e,t,n){if(!e||!e.sequences||0===e.sequences.length)return e;const s=e.queryLength||e.querySequence?.length||0,i=new Array(s);if(null==n)i.fill(!0);else if(0===n.size)i.fill(!1);else for(let e=0;e<s;e++){if(!t||0===t.length){i[e]=!0;continue}let s=!1;for(const i of t){const t=n.get(i);if(t&&t.has(e)){s=!0;break}}i[e]=s}return{...e,selectionMask:i}}function Ae(){if(!h||!a)return;const{canvas:e,ctx:t}=h;if(!e||!t)return;const{logicalWidth:n,logicalHeight:s}=de(e);G(t,n,s),ve(s);const i=function(e){if(!a||!h)return{start:0,end:0};const{scrollableAreaHeight:t}=pe(e);ve(e);const n=Math.max(1,Math.floor(A/C)),s=Math.ceil(t/C);return{start:Math.max(1,n-1),end:Math.min(a.sequences.length,n+s+2)}}(s);M=i.start,w=i.end;const o=fe("msa"),{scrollableAreaX:l,scrollableAreaY:r,scrollableAreaWidth:c,scrollableAreaHeight:u}=me("msa",n,s),f=C,g=$;t.fillStyle="#f0f0f0",t.fillRect(0,0,L,s),t.strokeStyle="#ccc",t.lineWidth=1,t.beginPath(),t.moveTo(L,0),t.lineTo(L,s),t.stroke(),Se(t,n,T,o,l,l,n);const d=Math.floor(T/o),m=Math.min(a.queryLength,d+Math.ceil(c/o)+1),p=l,y=n-_,v=T%o,b=o/2,{positions:S,chains:x}=ae(),q={padding:8,fontSize:12,fontFamily:"monospace",textColor:"#333"};for(let e=M;e<w&&e<a.sequences.length;e++){if(0===e)continue;const n=a.sequences[e],i=r+(e-1)*C-A;i+C>=0&&i<=s&&xe(t,n.name,i,C,L,q);let c=l-v;t.font="10px monospace",t.textAlign="center";for(let e=d;e<m&&e<n.sequence.length;e++){if(c+o<p){c+=o;continue}if(c>=y)break;const s=n.sequence[e],l=F(s);let h=l.r,f=l.g,g=l.b;const d=.3,m=!a.selectionMask||a.selectionMask[e];m||(h=Math.round(h*d+255*(1-d)),f=Math.round(f*d+255*(1-d)),g=Math.round(g*d+255*(1-d))),c+o>=p&&c<y&&(t.save(),t.beginPath(),t.rect(p,r,y-p,u),t.clip(),t.fillStyle=`rgb(${h}, ${f}, ${g})`,t.fillRect(c,i,o,C),t.fillStyle="#000",t.globalAlpha=m?1:.4,t.fillText(s,c+b,i+10),t.globalAlpha=1,t.restore()),c+=o}}if(t.fillStyle="#ffffff",t.fillRect(0,0,n,$),Se(t,n,T,o,l,l,n,0),a.sequences.length>0){const e=a.sequences[0];t.fillStyle="#ffffff",t.fillRect(0,g,n,f),xe(t,e.name,g,f,L,q);let s=l-T%o;const i=l,r=n-_;for(let n=d;n<m&&n<e.sequence.length;n++){if(s+o<i){s+=o;continue}if(s>=r)break;const l=e.sequence[n],c=F(l);let h=c.r,u=c.g,d=c.b;const m=.3,p=!a.selectionMask||a.selectionMask[n];p||(h=Math.round(h*m+255*(1-m)),u=Math.round(u*m+255*(1-m)),d=Math.round(d*m+255*(1-m))),s+o>=i&&s<r&&(t.save(),t.beginPath(),t.rect(i,g,r-i,f),t.clip(),t.fillStyle=`rgb(${h}, ${u}, ${d})`,t.fillRect(s,g,o,f),t.fillStyle="#000",t.font="10px monospace",t.textAlign="center",t.textBaseline="middle",t.globalAlpha=p?1:.4,t.fillText(l,s+o/2,25),t.globalAlpha=1,t.restore()),s+=o}t.strokeStyle="#333",t.lineWidth=2,t.beginPath(),t.moveTo(0,35),t.lineTo(n,35),t.stroke()}!function(e,t,n,s,i,o,l){if(!h||!a)return;const r=(a.sequences.length-1)*C,c=fe("msa"),u=a.queryLength*c,f=Math.max(0,r-l),g=f>0?A/f:0,d=l,m=Math.max(20,d/r*d),p=i+g*(d-m),y=t-_;e.fillStyle=W,e.fillRect(y,i,_,d),f>0?(e.fillStyle=E,e.fillRect(y+2,p,11,m)):(e.fillStyle=R,e.fillRect(y+2,i,11,d));const v=Math.max(0,u-o),b=v>0?T/v:0,S=o,x=Math.max(20,S/u*S),q=s+b*(S-x),M=n-_;if(e.fillStyle="#ffffff",e.fillRect(0,M,s,_),a&&a.queryLength>0){const t=Math.floor(T/c),n=`${t+1}-${Math.min(a.queryLength,t+Math.ceil(o/c))} / ${a.queryLength}`;e.fillStyle="#ffffff",e.fillRect(0,M,s,_),e.strokeStyle="#999",e.lineWidth=1,e.strokeRect(0,M,s,_),e.fillStyle="#333",e.font="11px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(n,s/2,M+7.5)}e.fillStyle=W,e.fillRect(s,M,S,_),v>0?(e.fillStyle=E,e.fillRect(q,M+2,x,11)):(e.fillStyle=R,e.fillRect(s,M+2,S,11))}(t,n,s,l,r,c,u)}function Te(e,t,n,s){const i=`${t}_${(new Date).toISOString().replace(/[:.]/g,"-").slice(0,-5)}.${n}`,o=new Blob([e],{type:s}),l=URL.createObjectURL(o),a=document.createElement("a");a.href=l,a.download=i,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l)}function Ce(){if(!a)return null;if(a.frequencies)return a.frequencies;const e=[],t=a.queryLength,n=a.sequences.length,s=["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V"],i=new Array(n),o=new Uint16Array(n);for(let e=0;e<n;e++){const t=a.sequences[e].sequence;i[e]=t,o[e]=t.length}const l=new Int8Array(128);l.fill(-1),l[65]=0,l[97]=0,l[82]=1,l[114]=1,l[78]=2,l[110]=2,l[68]=3,l[100]=3,l[67]=4,l[99]=4,l[81]=5,l[113]=5,l[69]=6,l[101]=6,l[71]=7,l[103]=7,l[72]=8,l[104]=8,l[73]=9,l[105]=9,l[76]=10,l[108]=10,l[75]=11,l[107]=11,l[77]=12,l[109]=12,l[70]=13,l[102]=13,l[80]=14,l[112]=14,l[83]=15,l[115]=15,l[84]=16,l[116]=16,l[87]=17,l[119]=17,l[89]=18,l[121]=18,l[86]=19,l[118]=19;for(let a=0;a<t;a++){const t=new Uint32Array(20);let r=0;for(let e=0;e<n;e++)if(a<o[e]){const n=i[e].charCodeAt(a);if(45!==n&&88!==n&&120!==n){const e=l[n];e>=0&&(t[e]++,r++)}}const c={},h=r>0?1/r:0;for(let e=0;e<20;e++)t[e]>0&&(c[s[e]]=t[e]*h);e.push(c)}return a.frequencies=e,e}function De(e){if(!e)return null;if(a&&a.logOdds)return a.logOdds;const t=[];for(const n of e){const e={};for(const t in n){const s=V(t);e[t]=Math.log2(n[t]/s)}t.push(e)}return a&&(a.logOdds=t),t}function Le(){if(!u||!a)return;const{canvas:e,ctx:t}=u;if(!e||!t)return;const{logicalWidth:n,logicalHeight:s}=de(e);G(t,n,s);const i=Ce();if(!i)return;const{scrollableAreaX:o,scrollableAreaY:l,scrollableAreaWidth:r,scrollableAreaHeight:c}=me("pssm",n,s),h=10,f=10,g=Math.floor(T/f),d=Math.min(i.length,g+Math.ceil(r/f)+1);Se(t,n,T,f,h,10,n);const m=l+0,p=O.length,y=u.aaRowHeight||C,v=p*y,b=h,S=n-h,x=n;for(let e=0;e<p;e++){const n=O[e],s=m+e*y,i=F(n);t.fillStyle=`rgb(${i.r}, ${i.g}, ${i.b})`,t.fillRect(0,s,h,y),t.fillStyle="#000",t.font="10px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(n,5,s+y/2)}let q=b-T%f;for(let e=g;e<d&&e<i.length;e++){if(q+f<b){q+=f;continue}if(q>=x)break;const n=i[e],s=.3,o=!a.selectionMask||a.selectionMask[e];for(let e=0;e<p;e++){const i=n[O[e]]||0,l=m+e*y,a={r:255,g:255,b:255},r={r:0,g:0,b:139};let c=Math.round(a.r+(r.r-a.r)*i),h=Math.round(a.g+(r.g-a.g)*i),u=Math.round(a.b+(r.b-a.b)*i);o||(c=Math.round(c*s+255*(1-s)),h=Math.round(h*s+255*(1-s)),u=Math.round(u*s+255*(1-s))),q+f>=b&&q<x&&(t.save(),t.beginPath(),t.rect(b,m,x-b,v),t.clip(),t.fillStyle=`rgb(${c}, ${h}, ${u})`,t.fillRect(q,l,f,y),t.restore())}q+=f}const M=a.sequences.length>0?a.sequences[0].sequence:"";t.strokeStyle="#000",t.lineWidth=1;let w=b-T%f;for(let e=g;e<d&&e<i.length;e++){if(w+f<b){w+=f;continue}if(w>=x)break;const n=e<M.length?M[e].toUpperCase():null;if(!n){w+=f;continue}const s=!a.selectionMask||a.selectionMask[e];t.strokeStyle=s?"#000":"#999",t.globalAlpha=s?1:.4;const i=O.indexOf(n);if(i>=0){const e=m+i*y;w+f>=b&&w<x&&(t.save(),t.beginPath(),t.rect(b,m,x-b,v),t.clip(),t.beginPath(),t.moveTo(w,e),t.lineTo(w+f,e),t.moveTo(w,e+y),t.lineTo(w+f,e+y),t.moveTo(w,e),t.lineTo(w,e+y),t.moveTo(w+f,e),t.lineTo(w+f,e+y),t.stroke(),t.restore())}t.globalAlpha=1,w+=f}t.strokeStyle="#000",t.lineWidth=2;for(const e of N){const n=m+e*y;t.beginPath(),t.moveTo(b,n),t.lineTo(b+S,n),t.stroke()}if(a.sequences.length>0){qe(t,n,15,20,a.sequences[0],T,b,g,d,h,u.totalWidth,!0,f)}Me(t,n,s,o,r,h,a.queryLength*f)}function ke(){if(!f||!a)return;const{canvas:e,ctx:t}=f;if(!e||!t)return;const{logicalWidth:n,logicalHeight:s}=de(e);G(t,n,s);const i=Ce();if(!i)return;const o=m?De(i):i;if(!o)return;const{scrollableAreaX:r,scrollableAreaY:c,scrollableAreaWidth:h,scrollableAreaHeight:u}=me("logo",n,s),g=k,d=Math.floor(T/D),p=Math.min(o.length,d+Math.ceil(h/D)+1),y=O.length,v=c+12,b=v+(f.originalLogoHeight||y*D*.5),S=b-v,x=b+20,q=n,M=[];let w=0;if(m){const e=[];for(let t=0;t<o.length;t++){const n=i[t];let s=0;const o={};for(const e in n){const t=n[e];if(t>0){const n=V(e),i=t*Math.log2(t/n);i>0&&(s+=i,o[e]=i)}}e.push({infoContent:s,contributions:o}),s>w&&(w=s)}for(let t=0;t<e.length;t++){const n=e[t],s=n.infoContent,i=n.contributions,l=w>0?s/w*S:0,a={};if(s>0)for(const e in i)a[e]=i[e]/s*l;M.push({infoContent:s,letterHeights:a,posData:o[t]})}}else for(let e=0;e<i.length;e++){const t=i[e],n={};let s=0;for(const e in t)s+=t[e];const l=s>0?1/s:1;for(const e in t)n[e]=t[e]*l*S;M.push({infoContent:0,letterHeights:n,posData:o[e]})}t.fillStyle="#ffffff",t.fillRect(0,0,g,s),t.strokeStyle="#333",t.lineWidth=1,t.beginPath(),t.moveTo(g,v-12),t.lineTo(g,b),t.stroke();const A=m?"Bits":"Probability",C=(v-12+b)/2;t.save(),t.translate(5,C),t.rotate(-Math.PI/2),t.fillStyle="#333",t.font="12px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText(A,0,0),t.restore(),t.fillStyle="#333",t.font="10px sans-serif",t.textAlign="right",t.textBaseline="middle";const L=[];if(m){const e=w>0?w:1;L.push({value:0,label:"0"}),e>0&&(L.push({value:e/2,label:(e/2).toFixed(1)}),L.push({value:e,label:e.toFixed(1)}))}else L.push({value:0,label:"0.0"}),L.push({value:.5,label:"0.5"}),L.push({value:1,label:"1.0"});const $=b;for(const e of L){let n;if(m){const t=w>0?w:1;n=$-e.value/t*S}else n=$-e.value*S;t.fillText(e.label,32,n),t.beginPath(),t.moveTo(35,n),t.lineTo(g,n),t.stroke()}let P=r-T%D;for(let e=d;e<p&&e<M.length;e++){if(P+D<40){P+=D;continue}if(P>=q)break;const n=M[e].letterHeights,s=Object.keys(n).sort((e,t)=>n[e]-n[t]),i=.3,o=!a.selectionMask||a.selectionMask[e];let r=b;for(const e of s){const s=n[e],a=!m,c=a&&s>0&&s<.5?.5:s;if((!!a||s>1)&&c>0){const n=F(e);let s=n.r,a=n.g,u=n.b;o||(s=Math.round(s*i+255*(1-i)),a=Math.round(a*i+255*(1-i)),u=Math.round(u*i+255*(1-i)));if(D>0){t.save(),t.beginPath(),t.rect(40,v,h,b-v),t.clip();c>0&&l(t,e,P,r,D,c,`rgb(${s}, ${a}, ${u})`,{x:40,y:v,w:h,h:b-v}),t.restore()}}r-=c}P+=D}if(a.sequences.length>0){qe(t,n,b,20,a.sequences[0],T,r,d,p,g,f.totalWidth,!1)}const _=b;t.fillStyle="#333",t.font="10px sans-serif",t.textAlign="right",t.textBaseline="middle";const W=m?"0":"0.0";t.fillText(W,32,_),t.beginPath(),t.moveTo(35,_),t.lineTo(g,_),t.stroke();Se(t,n,T,D,g,40,n,x);Me(t,n,s,r,h,g,a.queryLength*D);const E=b,R=r,B=n;t.strokeStyle="#333",t.lineWidth=2,t.beginPath(),t.moveTo(R,E),t.lineTo(B,E),t.stroke()}class $e{constructor(e,t,n){this.canvas=e,this.mode=t,this.config=n,this.listeners=[],this.scrollbarDragState={isDragging:!1,dragType:null,dragStartY:0,dragStartScroll:0},this.panDragState=null,this._cachedDimensions=null,this._cachedScrollableArea=null,this._cachedScrollLimits=null}_getCanvasDimensions(){return this._cachedDimensions||(this._cachedDimensions=de(this.canvas)),this._cachedDimensions}_getScrollableArea(){if(!this._cachedScrollableArea){const{logicalWidth:e,logicalHeight:t}=this._getCanvasDimensions();this._cachedScrollableArea=this.config.getScrollableArea(e,t)}return this._cachedScrollableArea}_getScrollLimits(){if(!this._cachedScrollLimits){const{logicalWidth:e,logicalHeight:t}=this._getCanvasDimensions();this._cachedScrollLimits=this.config.getScrollLimits(e,t)}return this._cachedScrollLimits}_invalidateCache(){this._cachedDimensions=null,this._cachedScrollableArea=null,this._cachedScrollLimits=null}setupWheelScrolling(){const e=e=>{e.preventDefault();const{logicalWidth:t,logicalHeight:n}=this._getCanvasDimensions(),{scrollableAreaX:s,scrollableAreaWidth:i}=this._getScrollableArea(),o=this._getScrollLimits(),l=Math.abs(e.deltaX)>Math.abs(e.deltaY),a=e.shiftKey&&Math.abs(e.deltaY)>0;if(l||a){const t=l?e.deltaX:a?e.deltaY:0;if(0!==t&&o.horizontal.max>0)return T=Math.max(0,Math.min(o.horizontal.max,T+t)),void J()}this.config.supportsVerticalScroll&&Math.abs(e.deltaY)>0&&!l&&!a&&(A=Math.max(0,Math.min(o.vertical.max,A+e.deltaY)),this.config.clampScrollTop&&this.config.clampScrollTop(n),J())};this.canvas.addEventListener("wheel",e,{passive:!1}),this.listeners.push({element:this.canvas,event:"wheel",handler:e})}setupPointerInteractions(){const e=e=>{if(void 0!==e.button&&0!==e.button)return;if(e.touches&&1!==e.touches.length)return;const t=te(e,this.canvas),{logicalWidth:n,logicalHeight:s}=this._getCanvasDimensions(),{scrollableAreaX:i,scrollableAreaY:o,scrollableAreaWidth:l,scrollableAreaHeight:a}=this._getScrollableArea(),r=this._getScrollLimits();if(this.config.supportsVerticalScroll){const i=n-_,l=s-_;if(t.x>=i&&t.x<=n&&t.y>=o&&t.y<l){this.config.clampScrollTop&&this.config.clampScrollTop(s);const n=r.vertical.max,i=n>0?Math.min(1,Math.max(0,A/n)):0,l=Math.max(20,a/r.vertical.total*a),c=o+i*(a-l);if(t.y>=c&&t.y<=c+l)return this.startVerticalScrollbarDrag(t.y,a,l,n,s),void e.preventDefault();if(t.y>=o){const i=Math.max(0,Math.min(1,(t.y-o-l/2)/(a-l)));return A=Math.max(0,Math.min(n,i*n)),this.config.clampScrollTop&&this.config.clampScrollTop(s),J(),void e.preventDefault()}}}const c=s-_,h=n-(this.config.supportsVerticalScroll?_:0);if(t.y>=c&&t.y<=s&&t.x>=i&&t.x<h&&r.horizontal.max>0){const n=T/r.horizontal.max,s=Math.max(20,l/r.horizontal.total*l),o=i+n*(l-s);if(t.x>=o&&t.x<=o+s)return this.startHorizontalScrollbarDrag(t.x,l,s,r.horizontal.max),void e.preventDefault();if(t.x>=i){const n=Math.max(0,Math.min(1,(t.x-i-s/2)/(l-s)));return T=Math.max(0,Math.min(r.horizontal.max,n*r.horizontal.max)),J(),void e.preventDefault()}}const u=this.config.supportsVerticalScroll?_:0;return t.x>=i&&t.x<n-u&&t.y>=o&&t.y<s-_?(this.startPanDrag(t,i,l,o,a,n,s),void e.preventDefault()):void 0};this.canvas.addEventListener("mousedown",e),this.listeners.push({element:this.canvas,event:"mousedown",handler:e});const t=t=>{t.preventDefault(),e(t)};this.canvas.addEventListener("touchstart",t,{passive:!1}),this.listeners.push({element:this.canvas,event:"touchstart",handler:t})}startVerticalScrollbarDrag(e,t,n,s,i){this.scrollbarDragState.isDragging=!0,this.scrollbarDragState.dragType="vertical",this.scrollbarDragState.dragStartY=e,this.scrollbarDragState.dragStartScroll=A,this.scrollbarDragState.scrollableAreaHeight=t,this.scrollbarDragState.canvasHeight=i;const o=e=>{if(!this.scrollbarDragState.isDragging||"vertical"!==this.scrollbarDragState.dragType)return;e.preventDefault(),this._invalidateCache();const t=this._getScrollLimits(),n=t.vertical.max,s=this.scrollbarDragState.scrollableAreaHeight,i=Math.max(20,s/t.vertical.total*s),o=te(e,this.canvas).y-this.scrollbarDragState.dragStartY;if(Math.abs(o)>2){const e=o/(s-i)*n;A=Math.max(0,Math.min(n,this.scrollbarDragState.dragStartScroll+e)),this.config.clampScrollTop&&this.config.clampScrollTop(this.scrollbarDragState.canvasHeight),J()}},l=()=>{this.scrollbarDragState.isDragging=!1,this.scrollbarDragState.dragType=null,window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",l),window.removeEventListener("touchmove",o),window.removeEventListener("touchend",l)};window.addEventListener("mousemove",o),window.addEventListener("mouseup",l),window.addEventListener("touchmove",o,{passive:!1}),window.addEventListener("touchend",l)}startHorizontalScrollbarDrag(e,t,n,s){this.scrollbarDragState.isDragging=!0,this.scrollbarDragState.dragType="horizontal",this.scrollbarDragState.dragStartY=e,this.scrollbarDragState.dragStartScroll=T,this.scrollbarDragState.scrollableAreaWidth=t,this.scrollbarDragState.thumbWidth=n;const i=e=>{if(!this.scrollbarDragState.isDragging||"horizontal"!==this.scrollbarDragState.dragType)return;e.preventDefault(),this._invalidateCache();const t=this._getScrollLimits(),n=t.horizontal.max,s=this.scrollbarDragState.scrollableAreaWidth,i=Math.max(20,s/t.horizontal.total*s),o=te(e,this.canvas).x-this.scrollbarDragState.dragStartY;if(Math.abs(o)>2){const e=o/(s-i)*n;T=Math.max(0,Math.min(n,this.scrollbarDragState.dragStartScroll+e)),J()}},o=()=>{this.scrollbarDragState.isDragging=!1,this.scrollbarDragState.dragType=null,window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",o),window.removeEventListener("touchmove",i),window.removeEventListener("touchend",o)};window.addEventListener("mousemove",i),window.addEventListener("mouseup",o),window.addEventListener("touchmove",i,{passive:!1}),window.addEventListener("touchend",o)}startPanDrag(e,t,n,s,i,o,l){this.panDragState={isDragging:!0,startX:e.x,startY:e.y,startScrollLeft:T,startScrollTop:A},this.canvas.style.cursor="grabbing";const a=e=>{if(!this.panDragState||!this.panDragState.isDragging)return;e.preventDefault();const t=te(e,this.canvas),n=this.panDragState.startX-t.x,s=this.panDragState.startY-t.y,i=this._getScrollLimits();T=Math.max(0,Math.min(i.horizontal.max,this.panDragState.startScrollLeft+n)),this.config.supportsVerticalScroll&&(A=Math.max(0,Math.min(i.vertical.max,this.panDragState.startScrollTop+s)),this.config.clampScrollTop&&this.config.clampScrollTop(l)),J()},r=()=>{this.panDragState&&(this.panDragState.isDragging=!1),this.canvas.style.cursor="default",window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",r),window.removeEventListener("touchmove",a),window.removeEventListener("touchend",r)};window.addEventListener("mousemove",a),window.addEventListener("mouseup",r),window.addEventListener("touchmove",a,{passive:!1}),window.addEventListener("touchend",r)}cleanup(){this.listeners.forEach(({element:e,event:t,handler:n})=>{e.removeEventListener(t,n)}),this.listeners=[],this.scrollbarDragState.isDragging=!1,this.panDragState=null}}let Pe=null;function _e(e){return"msa"===e?h:"pssm"===e?u:"logo"===e?f:"coverage"===e?g:null}function We(e){h?.container&&(h.container.style.display="msa"===e?"block":"none"),u?.container&&(u.container.style.display="pssm"===e?"block":"none"),f?.container&&(f.container.style.display="logo"===e?"block":"none"),g?.container&&(g.container.style.display="coverage"===e?"block":"none")}function Ee(e,t){let{canvasWidth:n,canvasHeight:s}=e;if(n<=0||s<=0){const i=t||ge();n=Math.max(1,i.width||j),s=Math.max(1,i.height||450),e.canvasWidth=n,e.canvasHeight=s}return e}function Re(e){return Math.max(1,e)}function Be(e,t,n){if("pssm"===e){const e=D,s=O.length,i=C,o=s*i,l=Re(t-($+e+_))/o,a=i*l;n.pssmScaleFactor=l,n.aaRowHeight=a}else if("logo"===e){const e=D,s=O.length*D*.5,i=Re(t-(12+e+$+_))/s,o=s*i;n.logoScaleFactor=i,n.originalLogoHeight=o}}function Ie(e){return"msa"===e?Ae:"pssm"===e?Le:"logo"===e?ke:"coverage"===e?Ye:null}function He(e,t){const{viewElementId:n,calculateDimensions:s,additionalCanvasData:i}=t,o="number"==typeof t.contentPadding&&Number.isFinite(t.contentPadding),l=Math.max(0,o?t.contentPadding:12),r=document.getElementById(n);if(!r)return console.warn("MSA Viewer: View element not found"),null;if(!a)return console.warn("MSA Viewer: No MSA data available"),null;const c=_e(e);if(c?.canvas?.parentElement){We(e),c.container.style.visibility="visible";const t=Ee(s()),{canvasWidth:n,canvasHeight:i}=t;return{canvas:c.canvas,container:c.container,canvasData:c,dimensions:{...t,canvasWidth:n,canvasHeight:i}}}r.classList.remove("hidden"),r.style.position=r.style.position||"relative",r.offsetHeight;const d=Ee(s()),{canvasWidth:m,canvasHeight:p,totalWidth:y,totalHeight:v}=d,b=_e(e),S=r.parentElement||r;b?.container?.parentElement&&b.container.parentElement.removeChild(b.container);S.querySelectorAll(".msa-canvas").forEach(e=>{const t=!Array.from(e.querySelectorAll("canvas")).some(e=>h?.canvas===e||u?.canvas===e||f?.canvas===e||g?.canvas===e);t&&e.parentElement?.removeChild(e)});const x=j,q=(M=m>0?m:x,w=x,Math.max(w,M));var M,w;const A=function(e,t){const n=document.createElement("div");return n.className="msa-canvas",n.style.position="relative",n.style.overflow="hidden",n.style.display="block",n.style.visibility="visible",n.style.width=e+"px",n.style.height=t+"px",n}(q,p);e&&(A.dataset.mode=e,A.classList.add(`msa-canvas--${e}`)),A.style.padding=`${l}px`;const T=2*l,C=Math.max(1,x-T),D=function(e,t,n){const s=document.createElement("canvas");return s.width=Re(Math.floor(e*n)),s.height=Re(Math.floor(t*n)),s.style.width="100%",s.style.height="100%",s.style.display="block",s.style.pointerEvents="auto",s.style.cursor="default",s}(Math.max(C,q-T),p,P);A.appendChild(D),A.appendChild(function(){const e=document.createElement("div");return e.className="resize-handle",e}()),(r.parentElement||r).appendChild(A),We(e);const L={canvas:D,ctx:D.getContext("2d"),container:A,totalWidth:y,contentPadding:l,...void 0!==v&&{totalHeight:v},...i||{}};if(L.ctx.scale(P,P),window.ResizeObserver){const t=new ResizeObserver(t=>{for(const n of t){const{width:t,height:s}=n.contentRect;if(t>0&&s>0){const n=Re(Math.floor(t*P)),i=Re(Math.floor(s*P));if(D.width!==n||D.height!==i){if(D.width=n,D.height=i,L.ctx=D.getContext("2d"),L.ctx.scale(P,P),D.style.width="100%",D.style.height="100%",Be(e,s,L),"coverage"===e&&L.sequencesWithIdentity){const e=L.COVERAGE_LINE_HEIGHT||30,t=L.TICK_ROW_HEIGHT_COVERAGE||20,n=L.numSequences||L.sequencesWithIdentity.length,i=s-e-t;L.sequenceRowHeight=Math.max(.5,i/n)}Pe&&Pe._invalidateCache();const o=fe(e);"coverage"!==e&&(be(t,o),ve(s));const l=Ie(e);l&&l()}}}});t.observe(A),L.resizeObserver=t}return{canvas:D,container:A,canvasData:L,dimensions:d}}function Oe(){const e=fe("msa"),t=L+a.queryLength*e,n=(a.sequences.length+1)*C,{width:s,height:i}=ge(),o=He("msa",{viewElementId:"msa-buttons",calculateDimensions:()=>({canvasWidth:s,canvasHeight:i,totalWidth:t,totalHeight:n})});if(!o)return;const{canvas:l,canvasData:r}=o;h=r,r.container&&(r.container.style.display="block",r.container.style.visibility="visible"),ve(o.dimensions.canvasHeight),be(o.dimensions.canvasWidth,e),Pe&&Pe.cleanup();Pe=new $e(l,"msa",{charWidth:e,supportsVerticalScroll:!0,clampScrollTop:e=>ve(e),getScrollableArea:(e,t)=>me("msa",e,t),getScrollLimits:(t,n)=>ye("msa",e,t,n)}),Pe.setupWheelScrolling(),Pe.setupPointerInteractions(),Ae()}function Ne(){const e=10+10*a.queryLength,{width:t}=ge(),n=Math.max(j,t),s=O.length,i=20*s,{height:o}=ge(),l=o?Re(o-50):i,r=Math.max(1,l/i),c=20*r,h=35+s*c+_,f=He("pssm",{viewElementId:"msa-buttons",calculateDimensions:()=>({canvasWidth:n,canvasHeight:h,totalWidth:e}),additionalCanvasData:{canvasWidth:t,totalHeight:h,pssmScaleFactor:r,aaRowHeight:c}});if(!f)return;const{canvas:g,container:d,canvasData:m}=f;u=m,be(f.dimensions.canvasWidth,10),Pe&&Pe.cleanup();Pe=new $e(g,"pssm",{charWidth:10,supportsVerticalScroll:!1,getScrollableArea:(e,t)=>me("pssm",e,t),getScrollLimits:(e,t)=>ye("pssm",10,e,t)}),Pe.setupWheelScrolling(),Pe.setupPointerInteractions();const p=document.createElement("div");p.style.position="absolute",p.style.backgroundColor="rgba(0, 0, 0, 0.85)",p.style.color="#fff",p.style.padding="4px 8px",p.style.borderRadius="4px",p.style.fontSize="12px",p.style.fontFamily="monospace",p.style.pointerEvents="none",p.style.zIndex="1000",p.style.display="none",p.style.whiteSpace="nowrap",u.container.appendChild(p),g.addEventListener("mousemove",e=>{const t=te(e,g),{logicalWidth:n,logicalHeight:s}=de(g),{scrollableAreaX:i,scrollableAreaY:o}=me("pssm",n,s),l=o,r=O.length;if(t.x>=20&&t.x<n&&t.y>=l&&t.y<l+20*r){const n=t.x-20+T,s=Math.floor(n/D),i=t.y-l,o=Math.floor(i/20);if(s>=0&&s<a.queryLength&&o>=0&&o<r){const t=Ce();if(t&&t[s]){const n=O[o],i=t[s][n]||0;p.textContent=`${s+1}${n} - ${i.toFixed(2)}`,p.style.display="block";const l=u.container.getBoundingClientRect();p.style.left=e.clientX-l.left+10+"px",p.style.top=e.clientY-l.top-25+"px"}}else p.style.display="none"}else p.style.display="none"}),g.addEventListener("mouseleave",()=>{p.style.display="none"}),Le()}function ze(){const e=40+a.queryLength*D,{width:t}=ge(),n=Math.max(j,t),s=O.length*D*.5,i=document.getElementById("msaHeader"),o=i?i.offsetHeight+8:40,{height:l}=ge(),r=(l?l-o-62:s)/s,c=s*r,h=12+c+20+$+_,u=He("logo",{viewElementId:"msa-buttons",calculateDimensions:()=>({canvasWidth:n,canvasHeight:h,totalWidth:e}),additionalCanvasData:{canvasWidth:t,totalHeight:h,logoScaleFactor:r,originalLogoHeight:c}});if(!u)return;const{canvas:g,canvasData:d}=u;f=d,be(u.dimensions.canvasWidth,D),Pe&&Pe.cleanup();Pe=new $e(g,"logo",{charWidth:D,supportsVerticalScroll:!1,getScrollableArea:(e,t)=>me("logo",e,t),getScrollLimits:(e,t)=>ye("logo",D,e,t)}),Pe.setupWheelScrolling(),Pe.setupPointerInteractions(),ke()}function Fe(e,t){let n=e||"";return n.length>t?n=n.slice(0,t):n.length<t&&(n=n.padEnd(t,"-")),n}function Ue(){if(!a||!Array.isArray(a.sequences)||0===a.sequences.length)return null;if(r&&!r._coverageCache&&(r._coverageCache={displayedMSA:null,dataset:null}),r&&r._coverageCache&&r._coverageCache.displayedMSA===a)return r._coverageCache.dataset;const e=a.querySequence||"",t=a.queryLength||e.length;if(!t)return null;const n=Fe(e,t),s=a.selectionMask,i=a.sequences.map((e,i)=>{const o=Fe(e.sequence||"",t),l=se(o,n,s);return{...e,sequence:o,identity:l,_originalIndex:i}});i.sort((e,t)=>{const n=e.name&&Q(e.name),s=t.name&&Q(t.name);return n&&!s?-1:!n&&s?1:t.identity===e.identity?(e._originalIndex??0)-(t._originalIndex??0):t.identity-e.identity});const o=new Array(t).fill(0);for(const e of i){const n=e.sequence;for(let e=0;e<t;e++)K(n[e])||o[e]++;delete e._originalIndex}const l={sequencesWithIdentity:i,coveragePerPosition:o,queryLength:t,residueNumbers:a.residueNumbers?[...a.residueNumbers]:null};return r&&r._coverageCache&&(r._coverageCache.displayedMSA=a,r._coverageCache.dataset=l),l}function Ve(){if(!r)return;const{positions:e,chains:t}=ae(),n=a?a.sequences.length:0;a=re(r,{selectedPositions:e,chains:t,minCoverage:b,minIdentity:x,shouldSort:y}),c=a.residueNumbers||null;const s=a.sequences.length;if(n>0&&s!==n){let e=400;h&&h.canvas&&(e=h.canvas.height/P),ve(e)}Pe&&Pe._invalidateCache(),Y.onMSAFilterChange&&Y.onMSAFilterChange(a,v);const i={msa:h,pssm:u,logo:f,coverage:g}[d];i&&i.canvas?J():Z(d)}function Ye(){if(!g||!a)return;const{canvas:e,ctx:t}=g;if(!e||!t)return;const n=Ue();if(!n)return;const{sequencesWithIdentity:s,coveragePerPosition:i,queryLength:o,residueNumbers:l}=n;if(!s||0===s.length||!o)return;const{logicalWidth:r,logicalHeight:c}=de(e);if(r<=0||c<=0)return;const h=g.axisLabelHeight||32,u=g.yAxisLabelWidth||40,f=s.length,d=u,m=20,p=Math.max(10,r-d-65),y=Math.max(40,c-h-20),v=(Math.max(1,f),p/o);if(!Number.isFinite(v)||v<=0)return;G(t,r,c);const b=Math.max(1,Math.round(2*p)),S=Math.max(1,Math.round(2*y)),x=b/o,q=S/Math.max(1,f),M=t.createImageData(b,S),w=M.data;for(let e=0;e<w.length;e+=4)w[e]=255,w[e+1]=255,w[e+2]=255,w[e+3]=255;const A=s.map(e=>le(e.identity)),T=.3;for(let e=0;e<o;e++){const t=Math.max(0,Math.floor(e*x)),n=e===o-1?b:Math.max(t+1,Math.floor((e+1)*x)),i=!a.selectionMask||a.selectionMask[e];for(let o=0;o<f;o++){if(K(s[o].sequence[e]))continue;const l=Math.max(0,Math.floor(o*q)),a=o===f-1?S:Math.max(l+1,Math.floor((o+1)*q)),r=A[o];let c=r[0],h=r[1],u=r[2];i||(c=Math.round(c*T+178.5),h=Math.round(h*T+178.5),u=Math.round(u*T+178.5));for(let e=l;e<a;e++){const s=e*b;for(let e=t;e<n;e++){const t=4*(s+e);w[t]=c,w[t+1]=h,w[t+2]=u,w[t+3]=255}}}}const C=document.createElement("canvas");C.width=b,C.height=S;C.getContext("2d").putImageData(M,0,0),t.save(),t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(C,0,0,b,S,d,m,p,y),t.restore();const D=Math.max(f,1),L=e=>e/D;t.strokeStyle="#000000",t.lineWidth=2,t.beginPath(),i.forEach((e,n)=>{const s=n===o-1?d+p:d+n*v+v/2,i=L(e),l=m+y-i*y;0===n?t.moveTo(s,l):t.lineTo(s,l)}),t.stroke();const k=m+y+2;t.fillStyle="#000000",t.font="10px monospace",t.textAlign="center",t.textBaseline="top";const $=Math.max(1,Math.floor(p/32)),P=(l&&l.length>0?Math.max(...l.filter(e=>null!=e)):o)/$,_=Math.pow(10,Math.floor(Math.log10(P))),W=P/_;let E;E=W<=1?1:W<=2?2:W<=5?5:10;const R=E*_;for(let e=0;e<o;e++){let n=e+1;if(l&&e<l.length){const t=l[e];null!=t&&(n=t)}if(n%R===0){const s=e>=o-1?d+p:d+(e+.5)*v;t.fillText(String(n),s,k)}}const B=d,I=m+y;t.strokeStyle="#000000",t.lineWidth=1,t.beginPath(),t.moveTo(B,m),t.lineTo(B,I),t.stroke(),t.beginPath(),t.moveTo(B,I),t.lineTo(d+p,I),t.stroke(),t.save(),t.textAlign="center",t.textBaseline="top",t.fillText("Positions",d+p/2,k+12),t.restore(),t.textAlign="right",t.textBaseline="middle";const H=Math.max(1,Math.floor(y/16)),O=D/H,N=Math.pow(10,Math.floor(Math.log10(O))),z=O/N;let F;F=z<=1?1:z<=2?2:z<=5?5:10;const U=Math.max(1,F*N),V=[];for(let e=U;e<=D;e+=U)Number.isInteger(e)&&V.push(e);t.strokeStyle="#000000",t.lineWidth=1,V.forEach(e=>{const n=L(e),s=m+y-n*y;t.fillText(String(Math.round(e)),d-6,s),t.beginPath(),t.moveTo(d-6,s),t.lineTo(d-2,s),t.stroke()}),t.textBaseline="middle",t.fillText("0",d-6,I),t.save(),t.translate(15,m+y/2),t.rotate(-Math.PI/2),t.textAlign="center",t.textBaseline="top",t.fillText("Sequences",0,-6),t.restore();const Y=15,j=Math.min(120,y-24),X=d+p+15,Q=X-6,J=m,Z=18+j+6;t.fillStyle="#f8f8f8",t.fillRect(Q+1,21,49,Z),t.fillStyle="#ffffff",t.fillRect(Q,J,49,Z),t.strokeStyle="#d0d0d0",t.lineWidth=1,t.strokeRect(Q,J,49,Z),t.save(),t.beginPath(),t.rect(X,38,Y,j),t.clip();for(let e=0;e<100;e++){const n=le(1-e/99);t.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`;const s=j/100,i=38+e*s;t.fillRect(X,i,Y,s+1)}t.restore(),t.strokeStyle="#666666",t.lineWidth=1,t.strokeRect(X,38,Y,j),t.fillStyle="#000000",t.font="9px monospace",t.textAlign="left",t.textBaseline="middle";[{value:1,label:"100"},{value:.75,label:"75"},{value:.5,label:"50"},{value:.25,label:"25"},{value:0,label:"0"}].forEach(({value:e,label:n})=>{const s=38+(1-e)*j;t.fillText(n,X+Y+4,s)}),t.fillStyle="#333333",t.font="10px monospace",t.textAlign="center",t.textBaseline="top",t.fillText("QID",X+7.5,23)}function je(e){if(!e||!e.chains||!e.position_names)return{};const t={},n={};for(let t=0;t<e.chains.length;t++){const s=e.chains[t],i=e.position_names[t],o=e.residue_numbers?e.residue_numbers[t]:t;"P"===(e.position_types?e.position_types[t]:"P")&&(n[s]||(n[s]=[]),n[s].push({positionName:i,residueNum:o}))}for(const e of Object.keys(n)){const s=n[e];s.sort((e,t)=>e.residueNum-t.residueNum);const i=s.map(e=>{const t=(e.positionName||"").toString().trim().toUpperCase();let n=t;return"function"==typeof getStandardResidueName&&(n=getStandardResidueName(t).toUpperCase()),window.RESIDUE_TO_AA&&window.RESIDUE_TO_AA[n]||"X"}).join("");i.length>0&&(t[e]=i)}return t}function Xe(e,t=null){if(!e||!e.sequences||0===e.sequences.length)return;const n=e.queryLength,s=e.sequences.length;!t&&e.selectionMask&&(t=e.selectionMask);const i=e.frequencies||[],o=["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V"];if(!e.frequencies){const t=new Array(s),l=new Uint16Array(s);for(let n=0;n<s;n++){const s=e.sequences[n].sequence;t[n]=s,l[n]=s.length}if(!e.frequencies)for(let e=0;e<n;e++)i.push({});const a=new Int8Array(128);a.fill(-1),a[65]=0,a[97]=0,a[82]=1,a[114]=1,a[78]=2,a[110]=2,a[68]=3,a[100]=3,a[67]=4,a[99]=4,a[81]=5,a[113]=5,a[69]=6,a[101]=6,a[71]=7,a[103]=7,a[72]=8,a[104]=8,a[73]=9,a[105]=9,a[76]=10,a[108]=10,a[75]=11,a[107]=11,a[77]=12,a[109]=12,a[70]=13,a[102]=13,a[80]=14,a[112]=14,a[83]=15,a[115]=15,a[84]=16,a[116]=16,a[87]=17,a[119]=17,a[89]=18,a[121]=18,a[86]=19,a[118]=19;const r=[];for(let e=0;e<n;e++){const n=new Uint32Array(20);let i=0;for(let o=0;o<s;o++)if(e<l[o]){const s=t[o].charCodeAt(e);if(45!==s&&88!==s&&120!==s){const e=a[s];e>=0&&(n[e]++,i++)}}const c={},h=i>0?1/i:0;for(let e=0;e<20;e++)if(n[e]>0){const t=n[e]*h;c[o[e]]=t}r.push(c)}e.frequencies=r}if(e.frequencies&&!e.entropy){const t=Math.log2(20),n=[];for(let s=0;s<e.frequencies.length;s++){const i=e.frequencies[s];if(!i){n.push(0);continue}let o=0;for(const e in i){const t=i[e];t>0&&(o-=t*Math.log2(t))}const l=o/t;n.push(l)}e.entropy=n}}window.MSA={setCallbacks:function(e){Y=Object.assign({},Y,e)},parseA3M:function(e){const t=e.split("\n"),n=[];let s=null,i="";for(let e=0;e<t.length;e++){const o=t[e].trim();if(o)if(o.startsWith(">")){if(s&&i){const e=i.replace(/[a-z]/g,"").toUpperCase();n.push({name:s,sequence:e})}s=o.substring(1).split(/[\s\t]/)[0],i=""}else i+=o}if(s&&i){const e=i.replace(/[a-z]/g,"").toUpperCase();n.push({name:s,sequence:e})}if(0===n.length)return null;let o=n.findIndex(e=>Q(e.name));-1===o&&(o=0);const l=n[o].sequence;if(!l||0===l.length)return null;const a=l.length;return{sequences:ue(n,l,a),sequencesOriginal:n,querySequence:l,queryLength:a,queryIndex:o}},parseFasta:function(e){const t=e.split("\n"),n=[];let s=null,i="";for(let e=0;e<t.length;e++){const o=t[e].trim();if(o)if(o.startsWith(">")){if(s&&i){const e=i.toUpperCase();n.push({name:s,sequence:e})}s=o.substring(1).split(/[\s\t]/)[0],i=""}else i+=o}if(s&&i){const e=i.toUpperCase();n.push({name:s,sequence:e})}if(0===n.length)return null;const o=n[0].sequence,l=[];for(let e=0;e<o.length;e++)"-"!==o[e]&&l.push(e);const a=l.map(e=>o[e]).join(""),r=a.length,c=o.length,h=n.map(e=>{let t=e.sequence;t.length>c&&(t=t.substring(0,c));const n=l.map(e=>e<t.length?t[e]:"-").join("");return{...e,sequence:n}});return{sequences:ue(h,a,r),sequencesOriginal:h,querySequence:a,queryLength:r,queryIndex:0}},parseSTO:function(e){const t=e.split("\n"),n=new Map;let s=!1;for(let e=0;e<t.length;e++){const i=t[e].trim();if(!i||i.startsWith("#")||"//"===i){if("//"===i)break;continue}if(i.startsWith("# STOCKHOLM")){s=!0;continue}const o=i.split(/\s+/);if(o.length<2)continue;const l=o[0],a=o.slice(1).join("").toUpperCase();n.has(l)?n.set(l,n.get(l)+a):n.set(l,a)}if(0===n.size)return null;const i=Array.from(n.entries()).map(([e,t])=>({name:e,sequence:t})),o=i[0].sequence,l=[];for(let e=0;e<o.length;e++)"-"!==o[e]&&l.push(e);const a=l.map(e=>o[e]).join(""),r=a.length,c=o.length,h=i.map(e=>{let t=e.sequence;t.length>c&&(t=t.substring(0,c));const n=l.map(e=>e<t.length?t[e]:"-").join("");return{...e,sequence:n}});return{sequences:ue(h,a,r),sequencesOriginal:h,querySequence:a,queryLength:r,queryIndex:0}},getMSAData:function(){return a},applyFiltersToMSA:function(e,t,n){if(!e||!e.sequences)return null;let s=ce(e.sequencesOriginal||e.sequences,t);return s=he(s,e.querySequence,n),{querySequence:e.querySequence,queryLength:e.queryLength,sequences:s,sequencesOriginal:e.sequencesOriginal||e.sequences}},setCoverageCutoff:function(e){b=X(e),Ve()},getCoverageCutoff:function(){return b},setPreviewCoverageCutoff:function(e){S=X(e)},applyPreviewCoverageCutoff:function(){this.setCoverageCutoff(S)},setIdentityCutoff:function(e){x=X(e),Ve()},getIdentityCutoff:function(){return x},setPreviewIdentityCutoff:function(e){q=X(e)},applyPreviewIdentityCutoff:function(){this.setIdentityCutoff(q)},setMSAData:function(e,t=null){if(function(){const e=document.getElementById("msa-viewer-container"),t=document.getElementById("msaView");e&&t&&(e.style.display="grid",e.style.gridTemplateRows="auto auto",t.style.position="relative")}(),!t&&Y.getRenderer){const e=Y.getRenderer();if(e&&e.currentObjectName){const n=e.objectsData[e.currentObjectName];n&&n.msa&&(n.msa.defaultChain?t=n.msa.defaultChain:n.msa.availableChains&&n.msa.availableChains.length>0&&(t=n.msa.availableChains[0]))}}if(v=t,r=e,!r.residueNumbers){const e=function(e,t=null){if(!Y.getRenderer)return null;const n=Y.getRenderer();if(!n||!n.currentObjectName)return null;const s=n.objectsData[n.currentObjectName];if(!s||!s.frames||0===s.frames.length)return null;if(!s.msa||!s.msa.msasBySequence||!s.msa.chainToSequence)return null;const i=s.frames[n.currentFrame>=0?n.currentFrame:0];if(!i||!i.chains||!i.residue_numbers)return null;const o=s.msa.chainToSequence[e];if(!o)return null;const l=s.msa.msasBySequence[o];if(!l)return null;const a=t||l.displayedMSA?.querySequence;if(!a)return null;const r=je(i)[e];if(!r)return null;const c=[],h=i.chains.length;for(let t=0;t<h;t++)i.chains[t]===e&&i.position_types&&"P"===i.position_types[t]&&c.push(t);if(0===c.length)return null;c.sort((e,t)=>(i.residue_numbers?i.residue_numbers[e]:e)-(i.residue_numbers?i.residue_numbers[t]:t));const u=new Array(a.length).fill(null),f=a.toUpperCase(),g=r.toUpperCase(),d=Math.min(f.length,g.length,c.length);for(let e=0;e<d;e++)if(f[e]===g[e]){const t=c[e];t<i.residue_numbers.length&&(u[e]=i.residue_numbers[t])}return u}(t,r.querySequence);e&&(r.residueNumbers=e)}const{positions:n,chains:s}=ae();a=re(r,{selectedPositions:n,chains:s,minCoverage:b,minIdentity:x,shouldSort:y}),c=a.residueNumbers||null,r.frequencies&&(a.frequencies=r.frequencies),r.logOdds&&(a.logOdds=r.logOdds),Ce();let i=916,o=fe(d);"msa"===d&&h&&h.canvas?i=h.canvas.width/P:"pssm"===d&&u&&u.canvas?i=u.canvas.width/P:"logo"===d&&f&&f.canvas&&(i=f.canvas.width/P),be(i,o);const l=document.getElementById("msa-viewer-container");l&&l.style.setProperty("display","block","important");const g=document.getElementById("msaView");g&&g.classList.remove("hidden"),Z(d)},setChain:function(e){if(v=e,Y.getRenderer){const t=Y.getRenderer();if(t&&t.currentObjectName){const n=t.objectsData[t.currentObjectName];if(n&&n.msa&&n.msa.msasBySequence&&n.msa.chainToSequence){const t=n.msa.chainToSequence[e];if(t&&n.msa.msasBySequence[t]){const{displayedMSA:s}=n.msa.msasBySequence[t];this.setMSAData(s,e)}}}}},getCurrentChain:function(){return v},updateMSAViewSelectionState:function(){if(!r||!a)return;const{positions:e,chains:t}=ae(),n=we(a,t,e);a.selectionMask=n.selectionMask,J()},getMSAMode:function(){return d},saveLogoAsSvg:function(){if(!f||!f.canvas||!a)return void console.error("Logo canvas or MSA data not available");const t=f.canvas,{logicalHeight:n}=de(t),s=40+a.queryLength*D,i=new e(s,n);!function(e,t,n,s){if(!a)return;e.fillStyle="#ffffff",e.fillRect(0,0,t,n);const i=Ce();if(!i)return;const o=m?De(i):i;if(!o)return;const{scrollableAreaX:r,scrollableAreaY:c}=me("logo",t,n),h=k,u=O.length,g=c+12,d=g+(f&&f.originalLogoHeight||u*D*.5),p=d-g,y=d+20,v=[];let b=0;if(m){const e=[];for(let t=0;t<o.length;t++){const n=i[t];let s=0;const o={};for(const e in n){const t=n[e];if(t>0){const n=V(e),i=t*Math.log2(t/n);i>0&&(s+=i,o[e]=i)}}e.push({infoContent:s,contributions:o}),s>b&&(b=s)}for(let t=0;t<e.length;t++){const n=e[t],s=n.infoContent,i=n.contributions,l=b>0?s/b*p:0,a={};if(s>0)for(const e in i)a[e]=i[e]/s*l;v.push({infoContent:s,letterHeights:a,posData:o[t]})}}else for(let e=0;e<i.length;e++){const t=i[e],n={};let s=0;for(const e in t)s+=t[e];const l=s>0?1/s:1;for(const e in t)n[e]=t[e]*l*p;v.push({infoContent:0,letterHeights:n,posData:o[e]})}e.fillStyle="#ffffff",e.fillRect(0,0,h,n),e.strokeStyle="#333",e.lineWidth=1,e.beginPath(),e.moveTo(h,g-12),e.lineTo(h,d),e.stroke();const S=m?"Bits":"Probability",x=(g-12+d)/2;e.save(),e.translate(5,x),e.rotate(-Math.PI/2),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(S,0,0),e.restore(),e.fillStyle="#333",e.font="10px sans-serif",e.textAlign="right",e.textBaseline="middle";const q=[];if(m){const e=b>0?b:1;q.push({value:0,label:"0"}),e>0&&(q.push({value:e/2,label:(e/2).toFixed(1)}),q.push({value:e,label:e.toFixed(1)}))}else q.push({value:0,label:"0.0"}),q.push({value:.5,label:"0.5"}),q.push({value:1,label:"1.0"});const M=d;for(const t of q){let n;if(m){const e=b>0?b:1;n=M-t.value/e*p}else n=M-t.value*p;e.fillText(t.label,32,n),e.beginPath(),e.moveTo(35,n),e.lineTo(h,n),e.stroke()}const w=s?0:Math.floor(T/D),A=s?v.length:Math.min(v.length,w+Math.ceil((t-r)/D)+1);let C=s?r:r-T%D;for(let t=w;t<A&&t<v.length;t++){const n=v[t].letterHeights,s=Object.keys(n).sort((e,t)=>n[e]-n[t]);let i=d;for(const t of s){const s=n[t];if(s>0){const n=F(t);l(e,t,C,i,D,s,`rgb(${n.r}, ${n.g}, ${n.b})`,null),i-=s}}C+=D}if(e.fillStyle="#000",e.fillRect(r,d,t-r,1),a.sequences.length>0){const n=a.sequences[0];if(s){let t=r;for(let s=0;s<n.sequence.length&&s<v.length;s++){const i=n.sequence[s],o=F(i);e.fillStyle=`rgb(${o.r}, ${o.g}, ${o.b})`,e.fillRect(t,d,D,20),e.fillStyle="#000",e.font="10px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(i,t+10,d+10),t+=D}}else qe(e,t,d,20,n,T,r,w,A,h,0,!1)}Se(e,t,s?0:T,D,h,h,t,y)}(i,s,n,!0);Te(i.getSerializedSvg(),"msa_logo","svg","image/svg+xml;charset=utf-8")},savePSSMAsSvg:function(){if(!u||!u.canvas||!a)return void console.error("PSSM canvas or MSA data not available");const t=u.canvas,{logicalHeight:n}=de(t),s=20+a.queryLength*D,i=new e(s,n);!function(e,t,n,s){if(!a)return;e.fillStyle="#ffffff",e.fillRect(0,0,t,n);const i=Ce();if(!i)return;const{scrollableAreaX:o,scrollableAreaY:l}=me("pssm",t,n),r=10,c=l+0,h=O.length,f=u&&u.aaRowHeight||C,g=r,d=10,m=r+a.queryLength*d,p=s?0:Math.floor(T/d),y=s?i.length:Math.min(i.length,p+Math.ceil((t-o)/d)+1),v=s?g:g-T%d;Se(e,t,s?0:T,d,r,r,t);for(let t=0;t<h;t++){const n=O[t],s=c+t*f,i=F(n);e.fillStyle=`rgb(${i.r}, ${i.g}, ${i.b})`,e.fillRect(0,s,r,f),e.fillStyle="#000",e.font="10px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(n,5,s+f/2)}let b=v;for(let t=p;t<y&&t<i.length;t++){const n=i[t];for(let t=0;t<h;t++){const s=n[O[t]]||0,i=c+t*f,o={r:255,g:255,b:255},l={r:0,g:0,b:139},a=Math.round(o.r+(l.r-o.r)*s),r=Math.round(o.g+(l.g-o.g)*s),h=Math.round(o.b+(l.b-o.b)*s);e.fillStyle=`rgb(${a}, ${r}, ${h})`,e.fillRect(b,i,d,f)}b+=d}const S=a.sequences.length>0?a.sequences[0].sequence:"";e.strokeStyle="#000",e.lineWidth=1;let x=v;for(let t=p;t<y&&t<i.length;t++){const n=t<S.length?S[t].toUpperCase():null;if(n){const t=O.indexOf(n);if(t>=0){const n=c+t*f;e.strokeRect(x,n,d,f)}}x+=d}e.strokeStyle="#000",e.lineWidth=2;for(const t of N){const n=c+t*f;e.beginPath(),e.moveTo(g,n),e.lineTo(g+a.queryLength*d,n),e.stroke()}a.sequences.length>0&&qe(e,m,15,20,a.sequences[0],0,g,0,i.length,r,0,!1,d)}(i,s,n,!0);Te(i.getSerializedSvg(),"msa_pssm","svg","image/svg+xml;charset=utf-8")},savePSSMAsCsv:function(){if(!a)return void console.error("MSA data not available");const e=Ce();if(!e||0===e.length)return void console.error("No frequency data available");let t="Position,"+O.join(",")+"\n";for(let n=0;n<e.length;n++){const s=e[n],i=[n+1];for(const e of O){const t=s[e]||0;i.push(t.toFixed(4))}t+=i.join(",")+"\n"}Te(t,"msa_pssm","csv","text/csv;charset=utf-8")},saveMSAAsFasta:function(){if(!a||!a.sequences||0===a.sequences.length)return void console.error("MSA data not available");let e="";for(const t of a.sequences){const n=t.name||"Unknown",s=t.sequence||"";e+=(n.startsWith(">")?n:">"+n)+"\n",e+=s+"\n"}Te(e,"msa_sequences","fasta","text/plain;charset=utf-8")},setMSAMode:function(e){if(d!==e&&a){T=T/("msa"===d?10:D)*("msa"===e?10:D)}if(d=e,Z(e),requestAnimationFrame(()=>{ee(e)}),a){let t=916,n=fe(e),s=0;if("msa"===e&&h&&h.canvas?(t=h.canvas.width/P,s=L,n=10):"pssm"===e&&u&&u.canvas?(t=u.canvas.width/P,s=D,n=D):"logo"===e&&f&&f.canvas?(t=f.canvas.width/P,s=k,n=D):"coverage"===e&&g&&g.canvas&&(t=g.canvas.width/P,s=k,n=D),t>0){const i=t-s-("msa"===e?_:0),o=a.queryLength*n,l=Math.max(0,o-i),r=T;T=Math.max(0,Math.min(l,T)),r!==T&&J()}}},getUseBitScore:function(){return m},setUseBitScore:function(e){m=e,"logo"===d&&J()},getSortSequences:function(){return y},setSortSequences:function(e){y=e,r&&Ve()},getSequenceCounts:function(){return{filtered:a?a.sequences.length:0,total:r?r.sequencesOriginal?r.sequencesOriginal.length:r.sequences.length:0}},clear:function(){h?.resizeObserver&&h.resizeObserver.disconnect(),u?.resizeObserver&&u.resizeObserver.disconnect(),f?.resizeObserver&&f.resizeObserver.disconnect(),g?.resizeObserver&&g.resizeObserver.disconnect();document.querySelectorAll(".msa-canvas").forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),a=null,r=null,h=null,u=null,f=null,g=null,v=null},buildMSAView:Oe,buildPSSMView:Ne,buildLogoView:ze,computeMSAProperties:Xe,extractSubset:function(e,t,n,s){if(!e.msa||!e.msa.msasBySequence||!e.msa.chainToSequence)return;const i=new Set(s),o=t.frames[0];if(!o||!o.chains)return;t.msa={msasBySequence:{},chainToSequence:{},availableChains:[],defaultChain:null,msaToChains:{}};const l=je(o);for(const[s,o]of Object.entries(e.msa.chainToSequence)){const a=e.msa.msasBySequence[o];if(!a)continue;const r=a.msaData;if(!r)continue;const c=r.querySequence,h=je(n)[s];if(!h)continue;const u=[],f=n.chains.length;for(let e=0;e<f;e++)n.chains[e]===s&&n.position_types&&"P"===n.position_types[e]&&u.push(e);if(0===u.length)continue;u.sort((e,t)=>(n.residue_numbers?n.residue_numbers[e]:e)-(n.residue_numbers?n.residue_numbers[t]:t));const g=c.toUpperCase(),d=h.toUpperCase(),m=Math.min(g.length,d.length,u.length),p=new Set;for(let e=0;e<m;e++)if(g[e]===d[e]){const t=u[e];i.has(t)&&p.add(e)}if(0===p.size)continue;const y=r.sequencesOriginal||r.sequences,v=[],b=[];for(let e=0;e<c.length;e++)p.has(e)&&b.push(c[e]);for(const e of y){const t={name:e.name||"Unknown",sequence:""};void 0!==e.id&&(t.id=e.id),void 0!==e.description&&(t.description=e.description);const n=Array.isArray(e.sequence)?e.sequence.join(""):e.sequence;for(let e=0;e<n.length;e++)p.has(e)&&(t.sequence+=n[e]);v.push(t)}const S=b.join(""),x=S.replace(/-/g,"").toUpperCase();if(0===x.length)continue;let q=">query";const M=void 0!==r.queryIndex?r.queryIndex:0;y&&y[M]&&(q=y[M].name||">query");const w=v.findIndex(e=>e.name&&e.name.toLowerCase().includes("query"));if(-1===w&&v.length>0)v[0].name=q;else if(w>0){const e=v.splice(w,1)[0];v.unshift(e)}const A=new Array(S.length).fill(null),T=u.filter(e=>i.has(e)).sort((e,t)=>(n.residue_numbers?n.residue_numbers[e]:e)-(n.residue_numbers?n.residue_numbers[t]:t));let C=0;for(let e=0;e<S.length;e++){if("-"!==S[e]&&C<T.length){const t=T[C];n.residue_numbers&&t<n.residue_numbers.length&&(A[e]=n.residue_numbers[t]),C++}}const D={sequences:v,querySequence:S,queryLength:x.length,sequencesOriginal:v,queryIndex:0,residueNumbers:A};Xe(D);const L=l[s];L&&L.toUpperCase()===x&&(t.msa.msasBySequence[x]||(t.msa.msasBySequence[x]={msaData:D,chains:[s]}),t.msa.chainToSequence[s]=x,t.msa.availableChains.includes(s)||t.msa.availableChains.push(s),t.msa.defaultChain||(t.msa.defaultChain=s))}"undefined"!=typeof window&&(window.updateMSAContainerVisibility&&setTimeout(()=>{window.updateMSAContainerVisibility()},100),window.updateMSAChainSelectorIndex&&setTimeout(()=>{window.updateMSAChainSelectorIndex()},100));return t.msa},extractSequences:je,getEntropyColor:function(e,t=!1){const n=Math.max(0,Math.min(1,e||0));let s;s=n<.5?240-2*n*120:120-2*(n-.5)*120,t&&(s=n<.5?220+2*n*20:40-2*(n-.5)*40);const i=1*(1-Math.abs(s/60%2-1));let o,l,a;return s<60?(o=1,l=i,a=0):s<120?(o=i,l=1,a=0):s<180?(o=0,l=1,a=i):s<240?(o=0,l=i,a=1):s<300?(o=i,l=0,a=1):(o=1,l=0,a=i),{r:Math.round(255*(o+0)),g:Math.round(255*(l+0)),b:Math.round(255*(a+0))}},mapEntropyToStructure:function(e,t=0){if(!(e&&e.msa&&e.msa.msasBySequence&&e.msa.chainToSequence))return null;const n=e.frames[t];if(!n||!n.chains)return null;const s=n.chains.length,i=new Array(s).fill(-1),o=je(n);for(const[t,l]of Object.entries(e.msa.chainToSequence)){const a=e.msa.msasBySequence[l];if(!a||!a.msaData||!a.msaData.entropy)continue;const r=a.msaData.entropy;if(!o[t])continue;const c=[];for(let e=0;e<s;e++)n.chains[e]===t&&n.position_types&&"P"===n.position_types[e]&&c.push(e);if(0===c.length)continue;c.sort((e,t)=>(n.residue_numbers?n.residue_numbers[e]:e)-(n.residue_numbers?n.residue_numbers[t]:t));const h=Math.min(r.length,c.length);for(let e=0;e<h;e++){const t=c[e];t<i.length&&(i[t]=r[e])}}return i}}}();