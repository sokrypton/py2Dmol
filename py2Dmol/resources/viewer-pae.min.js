!function(){"use strict";function e(e,t,i){const n=i*t,s=n*(1-Math.abs(e/60%2-1)),a=i-n;let o,h,r;return e<60?(o=n,h=s,r=0):e<120?(o=s,h=n,r=0):e<180?(o=0,h=n,r=s):e<240?(o=0,h=s,r=n):e<300?(o=s,h=0,r=n):(o=n,h=0,r=s),{r:Math.round(255*(o+a)),g:Math.round(255*(h+a)),b:Math.round(255*(r+a))}}function t(t,i=!1){const n=Math.max(0,Math.min(30,t||0));if(n<=15){return e(240,1-n/15,1)}return e(i?30:0,(n-15)/15,1)}function i(e){const t=Math.max(0,Math.min(30,e||0))/30;return{r:Math.round(5+220*t),g:Math.round(113+130*t),b:Math.round(47+173*t)}}class n{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d",{alpha:!1}),this.mainRenderer=t,this.paeData=null,this.n=0,this.size=e.width,this.selection={x1:-1,y1:-1,x2:-1,y2:-1},this.isDragging=!1,this.isAdding=!1,this.baseCanvas=null,this.lastSelectionHash=null,this.renderScheduled=!1,this.cachedSequencePositions=null,this.setupInteraction(),"undefined"!=typeof document&&(this.selectionChangeHandler=()=>{this.paeData&&(this.lastSelectionHash=null,this.cachedSequencePositions=null,this.scheduleRender())},document.addEventListener("py2dmol-selection-change",this.selectionChangeHandler),this.colorChangeHandler=()=>{this.paeData&&(this.baseCanvas=null,this.scheduleRender())},document.addEventListener("py2dmol-color-change",this.colorChangeHandler))}scheduleRender(){this.renderScheduled||(this.renderScheduled=!0,requestAnimationFrame(()=>{this.renderScheduled=!1,this.render()}))}expandLigandPositions(e){if("function"==typeof expandLigandSelection){const t=this.mainRenderer.objectsData[this.mainRenderer.currentObjectName];if(t?.ligandGroups)return expandLigandSelection(e,t.ligandGroups)}return new Set(e)}getMousePos(e){const t=this.canvas.getBoundingClientRect(),i=void 0!==e.clientX?e.clientX:e.touches&&e.touches[0]?e.touches[0].clientX:e.changedTouches[0].clientX,n=void 0!==e.clientY?e.clientY:e.touches&&e.touches[0]?e.touches[0].clientY:e.changedTouches[0].clientY,s=i-t.left,a=n-t.top;return{x:s*(this.canvas.width/t.width),y:a*(this.canvas.height/t.height)}}getCellIndices(e){const{x:t,y:i}=this.getMousePos(e);if(!this.paeData)return{i:-1,j:-1};const n=this.n;if(0===n)return{i:-1,j:-1};const s=this.size/n;return{i:Math.floor(i/s),j:Math.floor(t/s)}}setupInteraction(){this.canvas.addEventListener("mousedown",t=>{if(0!==t.button||!this.paeData)return;this.isAdding=t.shiftKey,this.isAdding||this.mainRenderer.setSelection({paeBoxes:[],positions:new Set,chains:new Set,selectionMode:"explicit"},!0),this.isDragging=!0;const{i:i,j:n}=this.getCellIndices(t);this.selection.x1=n,this.selection.y1=i,this.selection.x2=n,this.selection.y2=i,this.lastSelectionHash=null,this.scheduleRender();const s=e=>{if(!this.isDragging||!this.paeData)return;let t;try{t=this.getCellIndices(e)}catch(e){return}const{i:i,j:n}=t,s=this.n,a=Math.max(0,Math.min(s-1,n)),o=Math.max(0,Math.min(s-1,i));this.selection.x2===a&&this.selection.y2===o||(this.selection.x2=a,this.selection.y2=o,this.scheduleRender())},a=t=>{this.isDragging&&(e(t),window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",a))};window.addEventListener("mousemove",s),window.addEventListener("mouseup",a)});const e=e=>{if(!this.isDragging)return;this.isDragging=!1;let t=Math.min(this.selection.y1,this.selection.y2),i=Math.max(this.selection.y1,this.selection.y2),n=Math.min(this.selection.x1,this.selection.x2),s=Math.max(this.selection.x1,this.selection.x2);if(0===this.n||t<0||n<0)return this.selection={x1:-1,y1:-1,x2:-1,y2:-1},void this.render();if(t===i&&n===s)this.mainRenderer.setSelection({paeBoxes:[],positions:new Set,chains:new Set,selectionMode:"default"},!1),this.cachedSequencePositions=null,this.selection={x1:-1,y1:-1,x2:-1,y2:-1};else{const e={i_start:t,i_end:i,j_start:n,j_end:s},a=this.mainRenderer.getSelection(),o=a.paeBoxes||[],h=a.positions||new Set,r=new Set;for(let e=t;e<=i;e++)e>=0&&e<this.mainRenderer.chains.length&&r.add(e);for(let e=n;e<=s;e++)e>=0&&e<this.mainRenderer.chains.length&&r.add(e);const c=this.expandLigandPositions(r);if(this.isAdding){const t=this.expandLigandPositions(h),i=[...o,e],n=new Set([...t,...c]),s=new Set;if(this.mainRenderer.chains)for(const e of n)e>=0&&e<this.mainRenderer.chains.length&&s.add(this.mainRenderer.chains[e]);const a=n.size>0&&n.size<(this.mainRenderer.chains?.length||0);this.mainRenderer.setSelection({paeBoxes:i,positions:n,chains:s,selectionMode:a?"explicit":"default"},!1)}else{const t=new Set;if(this.mainRenderer.chains)for(const e of c)e>=0&&e<this.mainRenderer.chains.length&&t.add(this.mainRenderer.chains[e]);const i=c.size>0&&c.size<(this.mainRenderer.chains?.length||0);this.mainRenderer.setSelection({paeBoxes:[e],positions:c,chains:t,selectionMode:i?"explicit":"default"},!1)}this.cachedSequencePositions=null}this.selection={x1:-1,y1:-1,x2:-1,y2:-1},this.lastSelectionHash=null,this.cachedSequencePositions=null,this.scheduleRender()};this.canvas.addEventListener("mouseup",e),this.canvas.addEventListener("touchstart",t=>{if(1!==t.touches.length||!this.paeData)return;t.preventDefault(),this.isAdding=!1,this.mainRenderer.setSelection({paeBoxes:[],positions:new Set,chains:new Set,selectionMode:"explicit"},!0),this.isDragging=!0;const{i:i,j:n}=this.getCellIndices(t);this.selection.x1=n,this.selection.y1=i,this.selection.x2=n,this.selection.y2=i,this.lastSelectionHash=null,this.scheduleRender();const s=e=>{if(!this.isDragging||!this.paeData||1!==e.touches.length)return;let t;e.preventDefault();try{t=this.getCellIndices(e.touches[0])}catch(e){return}const{i:i,j:n}=t,s=this.n,a=Math.max(0,Math.min(s-1,n)),o=Math.max(0,Math.min(s-1,i));this.selection.x2===a&&this.selection.y2===o||(this.selection.x2=a,this.selection.y2=o,this.scheduleRender())},a=t=>{this.isDragging&&(t.preventDefault(),e(t),window.removeEventListener("touchmove",s),window.removeEventListener("touchend",a),window.removeEventListener("touchcancel",o))},o=e=>{this.isDragging&&(e.preventDefault(),this.isDragging=!1,this.selection={x1:-1,y1:-1,x2:-1,y2:-1},this.render(),window.removeEventListener("touchmove",s),window.removeEventListener("touchend",a),window.removeEventListener("touchcancel",o))};window.addEventListener("touchmove",s,{passive:!1}),window.addEventListener("touchend",a,{passive:!1}),window.addEventListener("touchcancel",o,{passive:!1})})}setData(e){if(this.paeData!==e)try{if(!e||"object"!=typeof e||Array.isArray(e)||e instanceof Uint8Array||(console.warn("PAE data is an object, converting to array (slow!)"),e.predicted_aligned_error&&(e=e.predicted_aligned_error)),e)if(e instanceof Uint8Array)this.paeData=e,this.n=Math.round(Math.sqrt(e.length));else if(Array.isArray(e))if(e.length>0&&Array.isArray(e[0])){const t=e.length;this.n=t;const i=new Uint8Array(t*t);for(let n=0;n<t;n++){const s=e[n];for(let e=0;e<t;e++){let a=Math.round(8*s[e]);a>255&&(a=255),a<0&&(a=0),i[n*t+e]=a}}this.paeData=i}else this.paeData=new Uint8Array(e),this.n=Math.round(Math.sqrt(e.length));else console.error("Invalid PAE data type:",typeof e),this.paeData=null,this.n=0;else this.paeData=null,this.n=0;this.n>0&&this.n*this.n!==this.paeData.length&&console.warn(`PAE data length(${this.paeData.length}) is not a perfect square. inferred N = ${this.n}`),this.lastSelectionHash=null,this.cachedSequencePositions=null,this.n>0&&this.paeData?this._generateBaseImage():this.baseCanvas=null,this.scheduleRender()}finally{}}getSequenceSelectedPAEPositions(){const e=new Set,t=this.mainRenderer;if(!this.paeData||0===this.n)return e;const i=t.selectionModel,n=i.positions&&i.positions.size>0,s=i.chains&&i.chains.size>0;if("default"===(i.selectionMode||"default")&&!n)return e;if(!n&&!s)return e;let a=s?i.chains:new Set(t.chains);const o=this.n;for(let s=0;s<o;s++){if(s>=t.chains.length)continue;const o=t.chains[s];!a.has(o)||n&&!i.positions.has(s)||e.add(s)}return e}_generateBaseImage(){if(!this.paeData||0===this.n)return void(this.baseCanvas=null);const e=this.n,n=document.createElement("canvas");n.width=e,n.height=e;const s=n.getContext("2d",{alpha:!1}),a=s.createImageData(e,e),o=new Uint32Array(a.data.buffer),h=this.mainRenderer&&this.mainRenderer._getEffectiveColorMode?this.mainRenderer._getEffectiveColorMode():"auto",r=this.mainRenderer?.colorblindMode||!1,c=new Uint32Array(256);for(let e=0;e<256;e++){const n=e/8,{r:s,g:a,b:o}="deepmind"===h?i(n):t(n,r);c[e]=255<<24|o<<16|a<<8|s}const l=e*e,d=this.paeData;for(let e=0;e<l;e++)o[e]=c[d[e]];s.putImageData(a,0,0),this.baseCanvas=n}render(){if(this.ctx.clearRect(0,0,this.size,this.size),!this.paeData||0===this.n)return this.ctx.fillStyle="#f9f9f9",this.ctx.fillRect(0,0,this.size,this.size),this.ctx.fillStyle="#999",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.font="14px sans-serif",void this.ctx.fillText("No PAE Data",this.size/2,this.size/2);const e=this.n;this.baseCanvas||this._generateBaseImage(),this.baseCanvas&&(this.ctx.imageSmoothingEnabled=!1,this.ctx.drawImage(this.baseCanvas,0,0,this.size,this.size));const t=this.mainRenderer.selectionModel.paeBoxes||[],i=this.isDragging&&-1!==this.selection.x1?this.selection:null;null===this.cachedSequencePositions&&(this.cachedSequencePositions=this.getSequenceSelectedPAEPositions());const n=this.cachedSequencePositions,s=this.mainRenderer.selectionModel?.selectionMode||"default";if(t.length>0||null!==i||n.size>0||"explicit"===s){const s=this.size/e,a=document.createElement("canvas");a.width=this.size,a.height=this.size;const o=a.getContext("2d");o.fillStyle="white";const h=(e,t,i,n)=>{const a=Math.floor(i*s),h=Math.floor(e*s),r=Math.ceil((n-i+1)*s),c=Math.ceil((t-e+1)*s);o.fillRect(a,h,r,c)};for(const e of t){h(Math.min(e.i_start,e.i_end),Math.max(e.i_start,e.i_end),Math.min(e.j_start,e.j_end),Math.max(e.j_start,e.j_end))}if(i&&-1!==i.x1){h(Math.min(i.y1,i.y2),Math.max(i.y1,i.y2),Math.min(i.x1,i.x2),Math.max(i.x1,i.x2))}if(n.size>0){const e=Array.from(n).sort((e,t)=>e-t),t=[];if(e.length>0){let i=e[0],n=e[0];for(let s=1;s<e.length;s++)e[s]!==n+1&&(t.push([i,n]),i=e[s]),n=e[s];t.push([i,n])}for(const e of t)for(const i of t)h(e[0],e[1],i[0],i[1])}const r=document.createElement("canvas");r.width=this.size,r.height=this.size;const c=r.getContext("2d");c.fillStyle="rgba(255, 255, 255, 0.7)",c.fillRect(0,0,this.size,this.size),c.globalCompositeOperation="destination-out",c.drawImage(a,0,0),this.ctx.drawImage(r,0,0)}this._drawSelectionBoxes(t,i,e,this.size/e),this._drawChainBoundaries(e,this.size/e)}_drawSelectionBoxes(e,t,i,n){this.ctx.strokeStyle="rgba(0, 0, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.setLineDash([]);for(const t of e){const e=Math.min(t.i_start,t.i_end),i=Math.max(t.i_start,t.i_end),s=Math.min(t.j_start,t.j_end),a=Math.max(t.j_start,t.j_end),o=Math.floor(s*n),h=Math.floor(e*n),r=Math.floor((a+1)*n),c=Math.floor((i+1)*n);this.ctx.strokeRect(o,h,r-o,c-h)}if(t&&-1!==t.x1){const e=Math.min(t.y1,t.y2),i=Math.max(t.y1,t.y2),s=Math.min(t.x1,t.x2),a=Math.max(t.x1,t.x2),o=Math.floor(s*n),h=Math.floor(e*n),r=Math.floor((a+1)*n),c=Math.floor((i+1)*n);this.ctx.setLineDash([5,5]),this.ctx.strokeStyle="rgba(0, 0, 0, 0.7)",this.ctx.strokeRect(o,h,r-o,c-h),this.ctx.setLineDash([])}}_drawChainBoundaries(e,t){const i=this.mainRenderer;if(!i.chains||0===i.chains.length)return;const n=new Set;for(let t=0;t<e-1&&t<i.chains.length-1;t++){i.chains[t]!==i.chains[t+1]&&n.add(t+1)}if(0!==n.size){this.ctx.strokeStyle="rgba(0, 0, 0, 0.5)",this.ctx.lineWidth=2,this.ctx.setLineDash([]),this.ctx.beginPath();for(const e of n){const i=Math.floor(e*t);this.ctx.moveTo(i,0),this.ctx.lineTo(i,this.size),this.ctx.moveTo(0,i),this.ctx.lineTo(this.size,i)}this.ctx.stroke()}}}const s={Renderer:n,isValid:function(e){if(!e)return!1;if(Array.isArray(e)&&e.length>0||e.buffer&&e.length>0)return!0;if("object"==typeof e&&"number"!=typeof e.length){const t=Object.keys(e);return t.length>0&&!isNaN(parseInt(t[0]))}return!1},resolveData:function(e,t){if(!e||!e.frames||t<0||t>=e.frames.length)return null;const i=e.frames[t];if(this.isValid(i.pae))return i.pae;if(e._lastPaeFrame>=0&&e._lastPaeFrame<t&&this.isValid(e.frames[e._lastPaeFrame].pae))return e.frames[e._lastPaeFrame].pae;for(let i=t-1;i>=0;i--)if(this.isValid(e.frames[i].pae))return e._lastPaeFrame=i,e.frames[i].pae;return null},hasData:function(e){return!(!e||!e.frames)&&e.frames.some(e=>this.isValid(e.pae))},updateFrame:function(e,t,i){if(!e.paeRenderer)return;const n=this.resolveData(t,i);e.paeRenderer.setData(n),this.updateVisibility(e)},updateVisibility:function(e){if(!e.paeContainer&&e.canvas&&e.canvas.parentElement){const t=e.canvas.parentElement.closest("#mainContainer");e.paeContainer=t?t.querySelector("#paeContainer"):document.querySelector("#paeContainer")}const t=e.paeContainer;if(!t)return;const i=e.currentObjectName,n=e.objectsData[i],s=!!n&&this.hasData(n);t.style.display=s?"flex":"none";const a=t.querySelector("#paeCanvas");a&&(a.style.display=s?"block":"none")},initialize:function(e,t,i){if(i.pae?.enabled)try{let i=t.querySelector("#paeContainer");if(!i){const e=t.closest("#mainContainer");e&&(i=e.querySelector("#paeContainer"))}if(i||(i=document.querySelector("#paeContainer")),!i)return;const s=i.querySelector("#paeCanvas");if(!s)return;e.paeContainer=i,i.style.display="none";const a=()=>{const t=i.getBoundingClientRect().width||340;s.width=t,s.height=t,s.style.width="100%",s.style.height="100%",e.paeRenderer&&(e.paeRenderer.size=t,e.paeRenderer.scheduleRender())},o=new n(s,e);if(e.setPAERenderer(o),a(),e.currentObjectName&&e.objectsData[e.currentObjectName]){const t=e.objectsData[e.currentObjectName],i=e.currentFrame>=0?e.currentFrame:0;this.updateFrame(e,t,i)}this.updateVisibility(e)}catch(e){console.error("Failed to initialize PAE renderer:",e)}}};window.PAE=s,window.PAERenderer=n,"undefined"!=typeof window&&window.dispatchEvent(new Event("py2dmol_pae_loaded"))}();