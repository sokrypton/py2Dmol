!function(){"use strict";function e(e,t,i){const s=i*t,n=s*(1-Math.abs(e/60%2-1)),a=i-s;let h,o,r;return e<60?(h=s,o=n,r=0):e<120?(h=n,o=s,r=0):e<180?(h=0,o=s,r=n):e<240?(h=0,o=n,r=s):e<300?(h=n,o=0,r=s):(h=s,o=0,r=n),{r:Math.round(255*(h+a)),g:Math.round(255*(o+a)),b:Math.round(255*(r+a))}}function t(t,i=!1){const s=Math.max(0,Math.min(30,t||0));if(s<=15){return e(240,1-s/15,1)}return e(i?30:0,(s-15)/15,1)}function i(e){const t=Math.max(0,Math.min(30,e||0))/30;return{r:Math.round(5+220*t),g:Math.round(113+130*t),b:Math.round(47+173*t)}}window.PAERenderer=class{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d",{alpha:!1}),this.mainRenderer=t,this.paeData=null,this.n=0,this.size=e.width,this.selection={x1:-1,y1:-1,x2:-1,y2:-1},this.isDragging=!1,this.isAdding=!1,this.baseCanvas=null,this.lastSelectionHash=null,this.renderScheduled=!1,this.cachedSequencePositions=null,this.setupInteraction(),"undefined"!=typeof document&&(this.selectionChangeHandler=()=>{this.paeData&&(this.lastSelectionHash=null,this.cachedSequencePositions=null,this.scheduleRender())},document.addEventListener("py2dmol-selection-change",this.selectionChangeHandler),this.colorChangeHandler=()=>{this.paeData&&(this.baseCanvas=null,this.scheduleRender())},document.addEventListener("py2dmol-color-change",this.colorChangeHandler))}scheduleRender(){this.renderScheduled||(this.renderScheduled=!0,requestAnimationFrame(()=>{this.renderScheduled=!1,this.render()}))}expandLigandPositions(e){if("function"==typeof expandLigandSelection){const t=this.mainRenderer.objectsData[this.mainRenderer.currentObjectName];if(t?.ligandGroups)return expandLigandSelection(e,t.ligandGroups)}return new Set(e)}getMousePos(e){const t=this.canvas.getBoundingClientRect(),i=void 0!==e.clientX?e.clientX:e.touches&&e.touches[0]?e.touches[0].clientX:e.changedTouches[0].clientX,s=void 0!==e.clientY?e.clientY:e.touches&&e.touches[0]?e.touches[0].clientY:e.changedTouches[0].clientY,n=i-t.left,a=s-t.top;return{x:n*(this.canvas.width/t.width),y:a*(this.canvas.height/t.height)}}getCellIndices(e){const{x:t,y:i}=this.getMousePos(e);if(!this.paeData)return{i:-1,j:-1};const s=this.n;if(0===s)return{i:-1,j:-1};const n=this.size/s;return{i:Math.floor(i/n),j:Math.floor(t/n)}}setupInteraction(){this.canvas.addEventListener("mousedown",t=>{if(0!==t.button)return;if(!this.paeData)return;this.isAdding=t.shiftKey,this.isAdding||this.mainRenderer.setSelection({paeBoxes:[],positions:new Set,chains:new Set,selectionMode:"explicit"},!0),this.isDragging=!0;const{i:i,j:s}=this.getCellIndices(t);this.selection.x1=s,this.selection.y1=i,this.selection.x2=s,this.selection.y2=i,this.lastSelectionHash=null,this.scheduleRender();const n=e=>{if(!this.isDragging)return;if(!this.paeData)return;let t;try{t=this.getCellIndices(e)}catch(e){return}const{i:i,j:s}=t,n=this.n,a=Math.max(0,Math.min(n-1,s)),h=Math.max(0,Math.min(n-1,i));this.selection.x2===a&&this.selection.y2===h||(this.selection.x2=a,this.selection.y2=h,this.scheduleRender())},a=t=>{this.isDragging&&(e(t),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",a))};window.addEventListener("mousemove",n),window.addEventListener("mouseup",a)});const e=e=>{if(!this.isDragging)return;this.isDragging=!1;let t=Math.min(this.selection.y1,this.selection.y2),i=Math.max(this.selection.y1,this.selection.y2),s=Math.min(this.selection.x1,this.selection.x2),n=Math.max(this.selection.x1,this.selection.x2);if(0===this.n||t<0||s<0)return this.selection={x1:-1,y1:-1,x2:-1,y2:-1},void this.render();if(t===i&&s===n)this.mainRenderer.setSelection({paeBoxes:[],positions:new Set,chains:new Set,selectionMode:"default"},!1),this.cachedSequencePositions=null,this.selection={x1:-1,y1:-1,x2:-1,y2:-1};else{const e={i_start:t,i_end:i,j_start:s,j_end:n},a=this.mainRenderer.getSelection(),h=a.paeBoxes||[],o=a.positions||new Set,r=new Set;for(let e=t;e<=i;e++)e>=0&&e<this.mainRenderer.chains.length&&r.add(e);for(let e=s;e<=n;e++)e>=0&&e<this.mainRenderer.chains.length&&r.add(e);const c=this.expandLigandPositions(r);if(this.isAdding){const t=this.expandLigandPositions(o),i=[...h,e],s=new Set([...t,...c]),n=new Set;if(this.mainRenderer.chains&&this.mainRenderer.chains.length>0)for(const e of s)if(e>=0&&e<this.mainRenderer.chains.length){const t=this.mainRenderer.chains[e];t&&n.add(t)}const a=this.mainRenderer.chains?this.mainRenderer.chains.length:0,r=s.size>0&&s.size<a;this.mainRenderer.setSelection({paeBoxes:i,positions:s,chains:n,selectionMode:r?"explicit":"default"},!1)}else{const t=new Set;if(this.mainRenderer.chains&&this.mainRenderer.chains.length>0)for(const e of c)if(e>=0&&e<this.mainRenderer.chains.length){const i=this.mainRenderer.chains[e];i&&t.add(i)}const i=this.mainRenderer.chains?this.mainRenderer.chains.length:0,s=c.size>0&&c.size<i;this.mainRenderer.setSelection({paeBoxes:[e],positions:c,chains:t,selectionMode:s?"explicit":"default"},!1)}this.cachedSequencePositions=null}this.selection={x1:-1,y1:-1,x2:-1,y2:-1},this.lastSelectionHash=null,this.cachedSequencePositions=null,this.scheduleRender()};this.canvas.addEventListener("mouseup",e),this.canvas.addEventListener("touchstart",t=>{if(1!==t.touches.length)return;if(!this.paeData)return;t.preventDefault(),this.isAdding=!1,this.mainRenderer.setSelection({paeBoxes:[],positions:new Set,chains:new Set,selectionMode:"explicit"},!0),this.isDragging=!0;const{i:i,j:s}=this.getCellIndices(t);this.selection.x1=s,this.selection.y1=i,this.selection.x2=s,this.selection.y2=i,this.lastSelectionHash=null,this.scheduleRender();const n=e=>{if(!this.isDragging)return;if(!this.paeData)return;if(1!==e.touches.length)return;let t;e.preventDefault();try{t=this.getCellIndices(e.touches[0])}catch(e){return}const{i:i,j:s}=t,n=this.n,a=Math.max(0,Math.min(n-1,s)),h=Math.max(0,Math.min(n-1,i));this.selection.x2===a&&this.selection.y2===h||(this.selection.x2=a,this.selection.y2=h,this.scheduleRender())},a=t=>{this.isDragging&&(t.preventDefault(),e(t),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",a),window.removeEventListener("touchcancel",h))},h=e=>{this.isDragging&&(e.preventDefault(),this.isDragging=!1,this.selection={x1:-1,y1:-1,x2:-1,y2:-1},this.render(),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",a),window.removeEventListener("touchcancel",h))};window.addEventListener("touchmove",n,{passive:!1}),window.addEventListener("touchend",a,{passive:!1}),window.addEventListener("touchcancel",h,{passive:!1})})}setData(e){if(this.paeData!==e)try{if(!e||"object"!=typeof e||Array.isArray(e)||e instanceof Uint8Array||(console.warn("PAE data is an object, converting to array (slow!)"),e.predicted_aligned_error&&(e=e.predicted_aligned_error)),e)if(e instanceof Uint8Array)this.paeData=e,this.n=Math.round(Math.sqrt(e.length));else if(Array.isArray(e))if(e.length>0&&Array.isArray(e[0])){const t=e.length;this.n=t;const i=new Uint8Array(t*t);for(let s=0;s<t;s++){const n=e[s];for(let e=0;e<t;e++){let a=Math.round(8*n[e]);a>255&&(a=255),a<0&&(a=0),i[s*t+e]=a}}this.paeData=i}else this.paeData=new Uint8Array(e),this.n=Math.round(Math.sqrt(e.length));else console.error("Invalid PAE data type:",typeof e),this.paeData=null,this.n=0;else this.paeData=null,this.n=0;this.n>0&&this.n*this.n!==this.paeData.length&&console.warn(`PAE data length(${this.paeData.length}) is not a perfect square. inferred N = ${this.n}`),this.lastSelectionHash=null,this.cachedSequencePositions=null,this.n>0&&this.paeData?this._generateBaseImage():this.baseCanvas=null,this.scheduleRender()}finally{}}getSequenceSelectedPAEPositions(){const e=new Set,t=this.mainRenderer;if(!this.paeData||0===this.n)return e;const i=t.selectionModel,s=i.positions&&i.positions.size>0,n=i.chains&&i.chains.size>0;if("default"===(i.selectionMode||"default")&&!s)return e;if(!s&&!n)return e;let a;a=n?i.chains:new Set(t.chains);const h=this.n;for(let n=0;n<h;n++){if(n>=t.chains.length)continue;const h=t.chains[n],o=a.has(h),r=!s||i.positions.has(n);o&&r&&e.add(n)}return e}_generateBaseImage(){if(!this.paeData||0===this.n)return void(this.baseCanvas=null);const e=this.n,s=document.createElement("canvas");s.width=e,s.height=e;const n=s.getContext("2d",{alpha:!1}),a=n.createImageData(e,e),h=new Uint32Array(a.data.buffer),o=this.mainRenderer&&this.mainRenderer._getEffectiveColorMode?this.mainRenderer._getEffectiveColorMode():"auto",r=this.mainRenderer?.colorblindMode||!1,c=new Uint32Array(256);for(let e=0;e<256;e++){const s=e/8,{r:n,g:a,b:h}="deepmind"===o?i(s):t(s,r);c[e]=255<<24|h<<16|a<<8|n}const l=e*e,d=this.paeData;for(let e=0;e<l;e++)h[e]=c[d[e]];n.putImageData(a,0,0),this.baseCanvas=s}render(){if(this.ctx.clearRect(0,0,this.size,this.size),!this.paeData||0===this.n)return this.ctx.fillStyle="#f9f9f9",this.ctx.fillRect(0,0,this.size,this.size),this.ctx.fillStyle="#999",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.font="14px sans-serif",void this.ctx.fillText("No PAE Data",this.size/2,this.size/2);const e=this.n;this.baseCanvas||this._generateBaseImage(),this.baseCanvas&&(this.ctx.imageSmoothingEnabled=!1,this.ctx.drawImage(this.baseCanvas,0,0,this.size,this.size));const t=this.mainRenderer.selectionModel.paeBoxes||[],i=this.isDragging&&-1!==this.selection.x1?this.selection:null;null===this.cachedSequencePositions&&(this.cachedSequencePositions=this.getSequenceSelectedPAEPositions());const s=this.cachedSequencePositions,n=this.mainRenderer.selectionModel?.selectionMode||"default",a=t.length>0||null!==i||s.size>0;if(a||"explicit"===n&&!a){const n=this.size/e,a=document.createElement("canvas");a.width=this.size,a.height=this.size;const h=a.getContext("2d");h.fillStyle="white";const o=(e,t,i,s)=>{const a=Math.floor(i*n),o=Math.floor(e*n),r=Math.ceil((s-i+1)*n),c=Math.ceil((t-e+1)*n);h.fillRect(a,o,r,c)};for(const e of t){o(Math.min(e.i_start,e.i_end),Math.max(e.i_start,e.i_end),Math.min(e.j_start,e.j_end),Math.max(e.i_start,e.i_end))}if(i&&-1!==i.x1){o(Math.min(i.y1,i.y2),Math.max(i.y1,i.y2),Math.min(i.x1,i.x2),Math.max(i.x1,i.x2))}if(s.size>0){const e=Array.from(s).sort((e,t)=>e-t),t=[];if(e.length>0){let i=e[0],s=e[0];for(let n=1;n<e.length;n++)e[n]!==s+1&&(t.push([i,s]),i=e[n]),s=e[n];t.push([i,s])}for(const e of t)for(const i of t)o(e[0],e[1],i[0],i[1])}const r=document.createElement("canvas");r.width=this.size,r.height=this.size;const c=r.getContext("2d");c.fillStyle="rgba(255, 255, 255, 0.7)",c.fillRect(0,0,this.size,this.size),c.globalCompositeOperation="destination-out",c.drawImage(a,0,0),this.ctx.drawImage(r,0,0)}this._drawSelectionBoxes(t,i,e,this.size/e),this._drawChainBoundaries(e,this.size/e)}_drawSelectionBoxes(e,t,i,s){this.ctx.strokeStyle="rgba(0, 0, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.setLineDash([]);for(const t of e){const e=Math.min(t.i_start,t.i_end),i=Math.max(t.i_start,t.i_end),n=Math.min(t.j_start,t.j_end),a=Math.max(t.j_start,t.j_end),h=Math.floor(n*s),o=Math.floor(e*s),r=Math.floor((a+1)*s),c=Math.floor((i+1)*s);this.ctx.strokeRect(h,o,r-h,c-o)}if(t&&-1!==t.x1){const e=Math.min(t.y1,t.y2),i=Math.max(t.y1,t.y2),n=Math.min(t.x1,t.x2),a=Math.max(t.x1,t.x2),h=Math.floor(n*s),o=Math.floor(e*s),r=Math.floor((a+1)*s),c=Math.floor((i+1)*s);this.ctx.setLineDash([5,5]),this.ctx.strokeStyle="rgba(0, 0, 0, 0.7)",this.ctx.strokeRect(h,o,r-h,c-o),this.ctx.setLineDash([])}}_drawChainBoundaries(e,t){const i=this.mainRenderer;if(!i.chains||0===i.chains.length)return;const s=new Set;for(let t=0;t<e-1&&t<i.chains.length-1;t++){i.chains[t]!==i.chains[t+1]&&s.add(t+1)}if(0!==s.size){this.ctx.strokeStyle="rgba(0, 0, 0, 0.5)",this.ctx.lineWidth=2,this.ctx.setLineDash([]),this.ctx.beginPath();for(const e of s){const i=Math.floor(e*t);this.ctx.moveTo(i,0),this.ctx.lineTo(i,this.size),this.ctx.moveTo(0,i),this.ctx.lineTo(this.size,i)}this.ctx.stroke()}}},window.getPAEColor=t,window.getPAEColor_DeepMind=i}();