<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone py2Dmol Viewer</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Viewer-Specific CSS (from py2Dmol_viewer.html) */
        
        /* Using a class to scope all viewer styles */
        .py2dmol-viewer-instance * { 
            box-sizing: border-box; 
        }
        .py2dmol-viewer-instance {
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            display: inline-block; /* Makes the instance wrap its content */
            line-height: 0; /* Fix for inline-block extra space */
        }
        
        .py2dmol-viewer-instance #mainContainer {
            display: flex;
            flex-direction: row;
            align-items: flex-start; /* Align tops */
            gap: 15px; /* Space between canvas column and controls column */
            background: transparent;
        }
        
        .py2dmol-viewer-instance #viewerColumn {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between canvas and anim controls */
        }

        .py2dmol-viewer-instance #canvasContainer {
            display: inline-block;
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: auto; /* Changed from hidden for resize */
            background: #ffffff;
            resize: both; /* Enable native resize handle */
            min-width: 200px; /* Prevent resizing too small */
            min-height: 200px;
        }
        .py2dmol-viewer-instance #canvas {
            background: #ffffff;
            cursor: grab;
            display: block;
            touch-action: none;
        }
        .py2dmol-viewer-instance #canvas:active {
            cursor: grabbing;
        }

        .py2dmol-viewer-instance #colorSelect {
            font-size: 12px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%; /* Make it fill its new container */
        }

        .py2dmol-viewer-instance #optionsContainer {
            font-size: 12px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px; /* Increased gap for clarity */
        }
        .py2dmol-viewer-instance .toggle-item {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%; 
        }
        .py2dmol-viewer-instance .toggle-item label { 
            cursor: pointer; 
            white-space: nowrap;
            width: 50px; /* Give label a fixed width */
            flex-shrink: 0;
            font-size: 12px; /* Ensure label font size matches */
        }
        
        .py2dmol-viewer-instance .toggle-item label[for="shadowEnabledCheckbox"],
        .py2dmol-viewer-instance .toggle-item label[for="outlineEnabledCheckbox"],
        .py2dmol-viewer-instance .toggle-item label[for="colorblindCheckbox"],
        .py2dmol-viewer-instance .toggle-item label[for="rotationCheckbox"] {
            width: auto; /* Let it be auto-sized */
            margin-left: 5px; /* Add space next to the slider */
        }
        .py2dmol-viewer-instance .toggle-item input[type="range"] {
            cursor: pointer;
            flex-grow: 1; /* Let slider fill the rest */
            width: auto; /* Let flexbox handle it */
            min-width: 0; /* Fix for flexbox overflow */
        }
        .py2dmol-viewer-instance .toggle-item input[type="checkbox"] { 
            cursor: pointer; 
            margin: 0;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }

        /* Animation Controls Container */
        .py2dmol-viewer-instance #controlsContainer {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            padding: 0 10px;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        .py2dmol-viewer-instance #objectContainer {
            font-size: 12px;
        }
        
        .py2dmol-viewer-instance .controlButton {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #f0f0f0;
            cursor: pointer;
            min-width: 60px;
            font-size: 12px;
            vertical-align: middle;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .py2dmol-viewer-instance .controlButton:disabled {
            cursor: not-allowed;
            background: #eee;
            color: #999;
        }
        .py2dmol-viewer-instance #frameSlider {
            flex-grow: 1; 
            width: auto;
            margin: 0 10px;
            vertical-align: middle;
        }
        .py2dmol-viewer-instance #frameCounter {
            color: #333;
            vertical-align: middle;
            min-width: 80px;
            display: inline-block;
            flex-shrink: 0;
        }
        .py2dmol-viewer-instance #speedSelect {
            font-size: 12px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .py2dmol-viewer-instance #objectSelect {
            font-size: 12px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            vertical-align: middle;
            width: 100%;
        }
        .py2dmol-viewer-instance #objectSelect:disabled {
             cursor: not-allowed;
            background: #eee;
        }

        /* Right panel for all other controls */
        .py2dmol-viewer-instance #rightPanelContainer {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between control groups */
            width: 160px; /* Give it a fixed width */
            border: 1px solid #e0e0e0;
            border-radius: 12px; /* Changed from 8px */
            padding: 12px;
            background: #fdfdfd;
            flex-shrink: 0;
        }
        
        /* Styling for groups in the right panel */
        .py2dmol-viewer-instance .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .py2dmol-viewer-instance .control-group > label {
            font-weight: 600;
            font-size: 12px;
            color: #333;
        }
        
        .py2dmol-viewer-instance #paeContainer {
            display: none; /* JS will manage visibility */
            flex-shrink: 0;
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Standalone py2Dmol Viewer</h1>
        <p class="text-gray-600 mb-6">Upload a PDB/CIF file or fetch from RCSB PDB (4-char ID) / AlphaFold DB (UniProt ID) to visualize protein structures.</p>

        <!-- 3. New App UI -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Fetch Controls -->
                <div>
                    <label for="fetch-id" class="block text-sm font-medium text-gray-700 mb-1">PDB (4-char) or UniProt ID</label>
                    <div class="flex space-x-2">
                        <input type="text" id="fetch-id" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 4HHB or P0A8I3">
                        <button id="fetch-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Fetch</button>
                    </div>
                </div>
                <!-- Upload Controls -->
                <div>
                    <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload PDB / CIF</label>
                    <input type="file" id="file-upload" accept=".pdb,.cif,.ent" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                </div>
            </div>
            <!-- Status Message -->
            <div id="status-message" class="mt-4 text-sm text-gray-600 hidden"></div>
        </div>

        <!-- 4. Viewer HTML (from py2Dmol_viewer.html) -->
        <!-- We wrap this in our new viewer-instance class to scope the styles -->
        <div id="viewer-container" class="py2dmol-viewer-instance">
            <!-- This is the exact HTML from py2Dmol_viewer.html -->
            <div id="mainContainer">
                <div id="viewerColumn">
                    <div id="canvasContainer">
                        <canvas id="canvas"></canvas>
                    </div>
                    <div id="controlsContainer">
                        <button id="playButton" class="controlButton">Play</button>
                        <input type="range" id="frameSlider" min="0" max="0" value="0">
                        <span id="frameCounter">Frame: 0 / 0</span>
                        <select id="speedSelect">
                            <option value="100">1x</option>
                            <option value="50">2x</option>
                            <option value="25">4x</option>
                        </select>
                    </div>
                </div>
                <div id="paeContainer">
                     <canvas id="paeCanvas" width="300" height="300" style="cursor: crosshair; display: block;"></canvas>
                </div>
                <div id="rightPanelContainer">
                    <div id="styleAppearanceContainer" class="control-group">
                        <div class="toggle-item">
                            <label for="colorSelect" style="width: 50px;">Color:</label>
                            <select id="colorSelect" style="flex-grow: 1;">
                                <option value="auto">Auto</option>
                                <option value="plddt">pLDDT</option>
                                <option value="rainbow">Rainbow</option>
                                <option value="chain">Chain</option>
                            </select>
                        </div>
                        <div class="toggle-item">
                            <label for="lineWidthSlider" style="width: 50px;">Width:</label>
                            <input type="range" id="lineWidthSlider" min="2.0" max="4.7" value="3.0" step="0.1">
                        </div>
                        <div class="toggle-item">
                             <input type="checkbox" id="shadowEnabledCheckbox">
                             <label for="shadowEnabledCheckbox">Shadow</label>
                        </div>
                        <div class="toggle-item">
                             <input type="checkbox" id="outlineEnabledCheckbox">
                             <label for="outlineEnabledCheckbox">Outline</label>
                        </div>
                        <div class="toggle-item">
                             <input type="checkbox" id="colorblindCheckbox">
                             <label for="colorblindCheckbox">Colorblind</label>
                        </div>
                        <div class="toggle-item"> 
                            <input type="checkbox" id="rotationCheckbox">
                            <label for="rotationCheckbox">Rotate</label>
                        </div>
                    </div>
                    <div id="objectContainer" class="control-group">
                        <select id="objectSelect">
                            <!-- Initially empty -->
                        </select>
                    </div>
                </div>
            </div>    
            <!-- This is where py2Dmol.js expects to inject config -->
            <!-- We will do it ourselves in the main app script -->
        </div>

    </div> <!-- End of Tailwind max-w-6xl -->

    <!-- 5. py2Dmol.js Rendering Engine (Loaded from external URL) -->
    <script id="py2dmol-renderer" src="https://py2dmol.solab.org/py2Dmol/resources/py2Dmol.js"></script>
    
    <!-- 6. New Standalone App Logic -->
    <script type="module">
        // This is the main script for the standalone application

        // --- Global state for alignment ---
        let refCoords = null; // Store the first loaded coords for alignment
        let viewerApi = null; // Store the viewer's API
        let statusElement = null;
        let paeContainer = null; // Store a reference to the PAE container

        // --- Math Functions (Ported from viewer.py) ---

        /**
         * Calculates the mean of a list of Vec3 objects.
         */
        function getMean(coords) {
            if (coords.length === 0) return { x: 0, y: 0, z: 0 };
            let sum_x = 0, sum_y = 0, sum_z = 0;
            for (const c of coords) {
                sum_x += c[0];
                sum_y += c[1];
                sum_z += c[2];
            }
            return { 
                x: sum_x / coords.length, 
                y: sum_y / coords.length, 
                z: sum_z / coords.length 
            };
        }

        /**
         * Centers coordinates by subtracting the mean.
         */
        function centerCoords(coords, mean) {
            return coords.map(c => [
                c[0] - mean.x,
                c[1] - mean.y,
                c[2] - mean.z
            ]);
        }

        /**
         * Aligns new coords to a reference (best-effort w/o SVD)
         */
        function align_a_to_b(a, b) {
            // This is a simplified version of the Python code
            // It centers 'a' and moves it to 'b's center.
            if (a.length === 0 || b.length === 0) return a;
            
            const a_mean = getMean(a);
            const a_cent = centerCoords(a, a_mean);
            const b_mean = getMean(b);
            
            // Add b_mean to translated coords
            return a_cent.map(c => [
                c[0] + b_mean.x,
                c[1] + b_mean.y,
                c[2] + b_mean.z
            ]);
        }

        /**
         * Creates the initial view (centered)
         */
        function best_view(a) {
            // This just centers the coordinates.
            const a_mean = getMean(a);
            return centerCoords(a, a_mean);
        }

        // --- Parsers ---

        /**
         * Rudimentary PDB parser
         * @param {string} text - The raw PDB file text
         * @returns {Array} List of atom objects
         */
        function parsePDB(text) {
            const atoms = [];
            const lines = text.split('\n');
            for (const line of lines) {
                if (line.startsWith('ATOM') || line.startsWith('HETATM')) {
                    atoms.push({
                        record: line.substring(0, 6).trim(),
                        atomName: line.substring(12, 16).trim(),
                        resName: line.substring(17, 20).trim(),
                        chain: line.substring(21, 22).trim(),
                        resSeq: parseInt(line.substring(22, 26)),
                        x: parseFloat(line.substring(30, 38)),
                        y: parseFloat(line.substring(38, 46)),
                        z: parseFloat(line.substring(46, 54)),
                        b: parseFloat(line.substring(60, 66)),
                        element: line.substring(76, 78).trim()
                    });
                }
            }
            return atoms;
        }

        /**
         * Rudimentary CIF parser
         * @param {string} text - The raw CIF file text
         * @returns {Array} List of atom objects
         */
        function parseCIF(text) {
            const atoms = [];
            const lines = text.split('\n');
            let atomSiteLoop = false;
            const headers = [];
            const headerMap = {};

            for (const line of lines) {
                if (line.startsWith('_atom_site.')) {
                    atomSiteLoop = true;
                    const header = line.trim();
                    headerMap[header] = headers.length;
                    headers.push(header);
                } else if (atomSiteLoop && line.startsWith('#')) {
                    // End of loop
                    atomSiteLoop = false;
                } else if (atomSiteLoop && !line.startsWith(';')) {
                    // Regex to split by spaces, respecting quotes
                    const values = line.match(/(?:[^\s"']+|"([^"]*)"|'([^']*)')+/g);
                    if (!values || values.length < headers.length) continue;
                    
                    const getString = (key) => values[headerMap[key]] || '?';
                    const getFloat = (key) => parseFloat(values[headerMap[key]]) || 0.0;
                    const getInt = (key) => parseInt(values[headerMap[key]]) || 0;

                    atoms.push({
                        record: getString('_atom_site.group_PDB'),
                        atomName: getString('_atom_site.label_atom_id').replace(/['"]+/g, ''), // Remove quotes
                        resName: getString('_atom_site.label_comp_id'),
                        chain: getString('_atom_site.auth_asym_id'),
                        resSeq: getInt('_atom_site.auth_seq_id'),
                        x: getFloat('_atom_site.Cartn_x'),
                        y: getFloat('_atom_site.Cartn_y'),
                        z: getFloat('_atom_site.Cartn_z'),
                        b: getFloat('_atom_site.B_iso_or_equiv'),
                        element: getString('_atom_site.type_symbol')
                    });
                }
            }
            return atoms;
        }

        /**
         * Converts parsed atom list into the format the renderer needs.
         * This is a JS port of `_parse_model` from viewer.py
         * @param {Array} atoms - List of atom objects from parsePDB/parseCIF
         * @returns {object} - { coords, plddts, chains, atom_types }
         */
        function convertParsedToFrameData(atoms) {
            const coords = [];
            const plddts = [];
            const atom_chains = [];
            const atom_types = [];
            
            const rna_bases = ['A', 'C','G', 'U', 'RA', 'RC', 'RG', 'RU'];
            const dna_bases = ['DA', 'DC', 'DG', 'DT', 'T'];

            // Group atoms by residue
            const residues = new Map();
            for (const atom of atoms) {
                if (atom.resName === 'HOH') continue;
                const resKey = `${atom.chain}:${atom.resSeq}`;
                if (!residues.has(resKey)) {
                    residues.set(resKey, {
                        atoms: [], 
                        resName: atom.resName, 
                        chain: atom.chain,
                        record: atom.record
                    });
                }
                residues.get(resKey).atoms.push(atom);
            }

            // Standard amino acid 3-letter codes
            const proteinResidues = new Set([
                "ALA", "ARG", "ASN", "ASP", "CYS", "GLU", "GLN", "GLY", "HIS", "ILE",
                "LEU", "LYS", "MET", "PHE", "PRO", "SER", "THR", "TRP", "TYR", "VAL"
            ]);
            // Standard nucleic acid 3-letter codes
            const nucleicResidues = new Set([
                "A", "C", "G", "U", "T", "DA", "DC", "DG", "DT", "RA", "RC", "RG", "RU"
            ]);

            for (const [resKey, residue] of residues.entries()) {
                const is_protein = proteinResidues.has(residue.resName);
                const is_nucleic = nucleicResidues.has(residue.resName);

                if (is_protein) {
                    const ca = residue.atoms.find(a => a.atomName === 'CA');
                    if (ca) {
                        coords.push([ca.x, ca.y, ca.z]);
                        plddts.push(ca.b);
                        atom_chains.push(ca.chain);
                        atom_types.push('P');
                    }
                } else if (is_nucleic) {
                    let c4_atom = residue.atoms.find(a => a.atomName === "C4'" || a.atomName === "C4*");
                    if (c4_atom) {
                        coords.push([c4_atom.x, c4_atom.y, c4_atom.z]);
                        plddts.push(c4_atom.b);
                        atom_chains.push(c4_atom.chain);
                        if (rna_bases.includes(residue.resName) || residue.resName.startsWith('R')) {
                            atom_types.push('R');
                        } else {
                            atom_types.push('D');
                        }
                    }
                } else if (residue.record === 'HETATM') {
                    // Ligand
                    for (const atom of residue.atoms) {
                        if (atom.element !== 'H' && atom.element !== 'D') { // Skip hydrogens
                            coords.push([atom.x, atom.y, atom.z]);
                            plddts.push(atom.b);
                            atom_chains.push(atom.chain);
                            atom_types.push('L');
                        }
                    }
                }
            }
            return { coords, plddts, chains: atom_chains, atom_types };
        }

        // --- App Main Logic ---

        function setStatus(message, isError = false) {
            if (!statusElement) {
                statusElement = document.getElementById('status-message');
            }
            statusElement.textContent = message;
            statusElement.className = `mt-4 text-sm ${isError ? 'text-red-600' : 'text-gray-600'}`;
            statusElement.classList.remove('hidden');
        }

        /**
         * Main function to process a structure from text.
         */
        function processStructure(text, name, paeData = null) {
            if (!viewerApi) {
                console.error("Viewer API not initialized.");
                setStatus("Error: Viewer API not initialized.", true);
                return;
            }

            setStatus(`Parsing ${name}...`);
            let atoms;
            try {
                if (name.toLowerCase().endsWith('.cif')) {
                    atoms = parseCIF(text);
                } else if (name.toLowerCase().endsWith('.pdb') || name.toLowerCase().endsWith('.ent')) {
                    atoms = parsePDB(text);
                } else {
                    // Try parsing as CIF, then PDB, as a fallback for no extension
                    try {
                        atoms = parseCIF(text);
                        if (!atoms || atoms.length === 0) atoms = parsePDB(text);
                    } catch (e) {
                        atoms = parsePDB(text);
                    }
                }
                
                if (!atoms || atoms.length === 0) {
                    throw new Error("Could not parse any atoms from the file.");
                }
            } catch (e) {
                console.error("Parsing failed:", e);
                setStatus(`Error: ${e.message}`, true);
                return;
            }
            
            setStatus(`Converting ${atoms.length} atoms...`);
            let frameData = convertParsedToFrameData(atoms);
            frameData.pae = paeData;

            if (frameData.coords.length === 0) {
                 setStatus("Error: No C-alpha or ligand atoms found in file.", true);
                 return;
            }

            setStatus(`Aligning ${frameData.coords.length} atoms...`);
            
            // Alignment logic
            if (!refCoords || refCoords.length !== frameData.coords.length) {
                // New structure or different size, just center it
                frameData.coords = best_view(frameData.coords);
                refCoords = frameData.coords; // Set as new reference
            } else {
                // Align to previous structure
                frameData.coords = align_a_to_b(frameData.coords, refCoords);
            }

            setStatus(`Rendering ${name}...`);
            
            // Send to viewer
            viewerApi.handlePythonNewObject(name);
            viewerApi.handlePythonUpdate(JSON.stringify(frameData), name);
            setStatus(`Successfully rendered ${name}.`);
        }

        async function handleFetch() {
            const fetchId = document.getElementById('fetch-id').value.trim().toUpperCase();
            if (!fetchId) {
                setStatus("Please enter a PDB or UniProt ID.", true);
                return;
            }

            // New logic: 4 chars = PDB, else AFDB
            const isPDB = fetchId.length === 4;
            const isAFDB = !isPDB;
            
            let structUrl, paeUrl, name, paeEnabled;

            if (isAFDB) {
                name = `${fetchId}.cif`;
                structUrl = `https://alphafold.ebi.ac.uk/files/AF-${fetchId}-F1-model_v6.cif`;
                paeUrl = `https://alphafold.ebi.ac.uk/files/AF-${fetchId}-F1-predicted_aligned_error_v6.json`;
                paeEnabled = window.viewerConfig.pae; // Check if PAE view is even on
                
                if (paeEnabled) {
                    setStatus(`Fetching ${fetchId} model and PAE...`);
                    if (paeContainer) paeContainer.style.display = 'block'; // Show PAE container
                }
                else {
                    setStatus(`Fetching ${fetchId} model...`);
                    if (paeContainer) paeContainer.style.display = 'none'; // Ensure hidden
                }
                viewerApi.handlePythonSetColor('plddt'); // Set color for AFDB
            } else { // isPDB
                name = `${fetchId}.cif`;
                structUrl = `https://files.rcsb.org/download/${fetchId}.cif`;
                paeUrl = null;
                paeEnabled = false;
                setStatus(`Fetching ${fetchId} from RCSB...`);
                viewerApi.handlePythonSetColor('auto'); // Reset color
                if (paeContainer) paeContainer.style.display = 'none'; // Hide PAE container for PDB
            }

            try {
                // Fetch structure
                const structResponse = await fetch(structUrl);
                if (!structResponse.ok) {
                    throw new Error(`Failed to fetch structure (HTTP ${structResponse.status})`);
                }
                const structText = await structResponse.text();
                
                // Fetch PAE (if applicable)
                let paeData = null;
                if (paeEnabled && paeUrl) {
                    try {
                        const paeResponse = await fetch(paeUrl);
                        if (paeResponse.ok) {
                            const paeJson = await paeResponse.json();
                            // AFDB PAE is wrapped in a list
                            if (paeJson && paeJson.length > 0) {
                                paeData = paeJson[0].predicted_aligned_error;
                            }
                        } else {
                             setStatus(`Fetched model, but PAE data not found (HTTP ${paeResponse.status}).`);
                             if (paeContainer) paeContainer.style.display = 'none'; // Hide if PAE fetch fails
                        }
                    } catch (e) {
                        console.warn("Could not fetch PAE data:", e.message);
                        setStatus(`Fetched model, but PAE data failed to load.`);
                        if (paeContainer) paeContainer.style.display = 'none'; // Hide if PAE fetch fails
                    }
                }
                
                // Process and render
                processStructure(structText, name, paeData);

            } catch (e) {
                console.error("Fetch failed:", e);
                setStatus(`Error: ${e.message}. Check ID and console.`, true);
                if (paeContainer) paeContainer.style.display = 'none'; // Hide on total failure
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // When uploading, always hide PAE
            if (paeContainer) paeContainer.style.display = 'none';
            viewerApi.handlePythonSetColor('auto'); // Reset color

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                if (text) {
                    processStructure(text, file.name);
                } else {
                    setStatus("File is empty or unreadable.", true);
                }
            };
            reader.onerror = () => {
                setStatus("Failed to read file.", true);
            };
            reader.readAsText(file);
        }
        
        /**
         * Initializes the entire application.
         */
        function initApp() {
            // 1. Manually set the viewer config
            window.viewerConfig = { 
                size: [400, 400], // Start a bit bigger
                pae_size: [300, 300],
                color: "auto", 
                shadow: true, 
                outline: true,
                width: 3.0,
                rotate: false,
                controls: true,
                autoplay: false,
                box: true,
                pastel: 0.25,
                pae: true, // Keep PAE logic enabled in the renderer
                colorblind: false,
                viewer_id: "standalone-viewer-1" // Give it a static ID
            };

            // 2. Find the viewer container
            const viewerContainer = document.getElementById('viewer-container');
            if (!viewerContainer) {
                console.error("Fatal: Could not find #viewer-container element.");
                return;
            }

            // 3. Initialize the renderer
            // We need to wait for the external script to load
            const rendererScript = document.getElementById('py2dmol-renderer');
            rendererScript.onload = () => {
                console.log("py2Dmol.js loaded.");
                try {
                    initializePy2DmolViewer(viewerContainer);
                } catch (e) {
                    console.error("Failed to initialize viewer:", e);
                    setStatus("Error: Failed to initialize viewer. See console.", true);
                    return;
                }

                // 4. Get the API
                viewerApi = window.py2dmol_viewers[window.viewerConfig.viewer_id];
                if (!viewerApi) {
                    console.error("Fatal: Could not get viewer API after init.");
                    setStatus("Error: Could not get viewer API. See console.", true);
                    return;
                }

                // 5. Wire up event listeners
                document.getElementById('fetch-btn').addEventListener('click', handleFetch);
                document.getElementById('file-upload').addEventListener('change', handleFileUpload);
                
                // 6. Get status element
                statusElement = document.getElementById('status-message');
                paeContainer = document.getElementById('paeContainer');
                
                // Hide PAE container by default on load
                if (paeContainer) {
                    paeContainer.style.display = 'none';
                }

                setStatus("Ready. Upload a file or fetch an ID.");
            };
            
            rendererScript.onerror = () => {
                console.error("Fatal: Could not load py2Dmol.js renderer script.");
                setStatus("Error: Could not load renderer script. Check network connection.", true);
            }
        }

        // Start the app once the page is loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>