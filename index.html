<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>py2Dmol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4gYm4zQ6UvE6j3v/3Tf7U7T2Y9p6gJzU0bW5V6f6G6X6b6W6w6+g6w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        
        .py2dmol-viewer-instance * { 
            box-sizing: border-box; 
        }
        .py2dmol-viewer-instance {
            position: relative;
            font-family: 'Inter', sans-serif; 
            background: transparent;
            display: inline-block; 
            line-height: 0; 
        }
        
        .py2dmol-viewer-instance #mainContainer {
            display: flex;
            flex-direction: row;
            align-items: flex-start; 
            gap: 24px; 
            background: transparent;
        }
        
        .py2dmol-viewer-instance #viewerColumn {
            display: flex;
            flex-direction: column;
            gap: 10px; 
            min-width: 600px; 
        }

        .py2dmol-viewer-instance #canvasContainer {
            display: inline-block;
            border: 1px solid #e2e8f0; 
            border-radius: 12px;
            overflow: auto; 
            background: #ffffff;
            resize: both; 
            width: 600px; 
            height: 600px; 
            min-width: 200px; 
            min-height: 200px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .py2dmol-viewer-instance #canvas {
            background: #ffffff;
            cursor: grab;
            display: block;
            touch-action: none;
        }
        .py2dmol-viewer-instance #canvas:active {
            cursor: grabbing;
        }

        .py2dmol-viewer-instance #controlsContainer {
            display: flex; 
            flex-wrap: nowrap;
            align-items: center;
            padding: 8px 12px; 
            width: 100%;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            font-family: 'Inter', sans-serif;
            font-size: 12px;
        }
        
        /* New Styles for Play/Pause Button to match Fetch button */
        .py2dmol-viewer-instance .controlButton {
            padding: 10px 14px; 
            min-width: 80px; 
            border-radius: 6px; 
            background: #3b82f6; 
            color: white; 
            border: 1px solid #3b82f6; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.1s;
        }
        .py2dmol-viewer-instance .controlButton:hover {
            background: #2563eb; 
        }
        .py2dmol-viewer-instance .controlButton:disabled {
            background: #93c5fd; 
            cursor: not-allowed;
            color: #dbeafe;
        }
        
        .py2dmol-viewer-instance #frameSlider {
            flex-grow: 1; 
            height: 4px; 
            margin: 0 10px;
            vertical-align: middle;
            -webkit-appearance: none;
            appearance: none;
            background: #94a3b8; 
            border-radius: 2px;
        }
        .py2dmol-viewer-instance #frameSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px; 
            height: 12px;
            background: #3b82f6; /* Styled to match button color */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px #00000080;
        }
        .py2dmol-viewer-instance #frameCounter {
            color: #334155; 
            min-width: 80px;
            font-weight: 500;
        }
        .py2dmol-viewer-instance #speedSelect {
            /* Increased font size for speed dropdown */
            font-size: 14px;
            padding: 5px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #f8fafc;
            color: #334155;
            min-width: 60px;
        }
        
        .py2dmol-viewer-instance #rightPanelContainer {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Reduced from 15px */
            width: 324px; 
            border: none; 
            border-radius: 12px; 
            padding: 16px; 
            background: #ffffff; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0; 
            flex-shrink: 0; 
        }
        
        /* New Styles for Control Group Sections */
        .py2dmol-viewer-instance .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Reduced from 12px */
        }

        .py2dmol-viewer-instance .toggle-item {
            display: flex;
            align-items: center; 
            justify-content: space-between; 
            gap: 10px; 
            width: 100%; 
        }
        .py2dmol-viewer-instance .toggle-item > label { 
            font-weight: 500; 
            color: #334155;
            text-align: left;
            flex-shrink: 1; 
            line-height: 1.25; 
            margin-right: 10px; 
        }
        
        /* Toggle Switch Styling - Fatter Version */
        .py2dmol-viewer-instance .switch {
            position: relative;
            display: inline-block;
            width: 34px; 
            height: 16px; 
            flex-shrink: 0; 
        }
        .py2dmol-viewer-instance .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .py2dmol-viewer-instance .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 16px; 
        }
        .py2dmol-viewer-instance .slider-toggle:before {
            position: absolute;
            content: "";
            height: 12px; 
            width: 12px; 
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .py2dmol-viewer-instance input:checked + .slider-toggle {
            background-color: #3b82f6; 
        }
        .py2dmol-viewer-instance input:checked + .slider-toggle:before {
            transform: translateX(18px); 
        }
        /* End Toggle Switch Styling */

        /* Ensures selects are aligned and take up remaining space */
        .py2dmol-viewer-instance #colorSelect, 
        .py2dmol-viewer-instance #objectSelect {
            /* Increased font size for main control dropdowns */
            font-size: 14px; 
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #f8fafc;
            flex-grow: 1; 
            width: 170px; 
            min-width: 150px; 
            flex-shrink: 0;
        }

        .py2dmol-viewer-instance #colorSelect:focus, 
        .py2dmol-viewer-instance #objectSelect:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); 
            outline: none;
        }
        /* Ensure the range input takes up the remaining space and is centered */
        .py2dmol-viewer-instance #lineWidthSlider {
             flex-grow: 1;
             margin-top: 0; 
        }


        .py2dmol-viewer-instance #paeContainer {
            display: none; 
            flex-shrink: 0;
            /* Adjusted size to 296px to compensate for 1px border on all sides (298px final size) */
            width: 296px; 
            height: 296px; 
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            /* Center the PAE container within the 324px panel */
            margin: 10px auto 0 auto; /* Reduced margin-top from 15px to 10px */
        }
        
        .file-upload-match {
            height: 42px;
            display: flex;
            align-items: center;
            border: 2px dashed transparent; 
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        /* Drag over style */
        .file-upload-match.drag-over {
            border-color: #3b82f6;
            background-color: #f0f8ff;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans p-8">

    <!-- Total width (600 + 24 + 324 = 948px) -->
    <div class="mx-auto" style="width: 948px;"> 
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">py2Dmol</h1>
        <p class="text-gray-500 mb-8">Upload a PDB/CIF file or fetch from RCSB PDB (4-char ID) / AlphaFold DB (UniProt ID) to visualize protein structures.</p>

        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10 border border-gray-100" style="width: 948px;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="fetch-id" class="block text-sm font-semibold text-gray-700 mb-1">PDB (4-char) or UniProt ID</label>
                    <div class="flex space-x-3">
                        <input type="text" id="fetch-id" class="flex-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 4HHB or P0A8I3">
                        <button id="fetch-btn" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-medium shadow-md hover:bg-blue-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Fetch</button>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="file-upload" class="block text-sm font-semibold text-gray-700 mb-1">Upload PDB / CIF</label>
                    <div id="drop-area" class="file-upload-match">
                        <input type="file" id="file-upload" accept=".pdb,.cif,.ent" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer transition duration-150">
                    </div>
                </div>
            </div>
            <div id="status-message" class="mt-4 text-sm font-medium text-gray-600 hidden p-2 bg-blue-50 rounded-lg border border-blue-200"></div>
        </div>


        <div id="viewer-container" class="py2dmol-viewer-instance" style="display: none;">
            
            <div id="mainContainer">
                
                <div id="viewerColumn">
                    <div id="canvasContainer">
                        <canvas id="canvas"></canvas>
                    </div>
                    <div id="controlsContainer">
                        <button id="playButton" class="controlButton"><i class="fa-solid fa-play"></i></button>
                        <input type="range" id="frameSlider" min="0" max="0" value="0">
                        <span id="frameCounter">Frame: 0 / 0</span>
                        <select id="speedSelect">
                            <option value="100">1x</option>
                            <option value="50">2x</option>
                            <option value="25">4x</option>
                        </select>
                    </div>
                </div>
                
                <div id="rightPanelContainer">
                    
                    <div id="styleAppearanceContainer" class="control-group">
                        
                        <div class="toggle-item">
                            <label for="colorSelect" class="font-medium text-gray-700">Color:</label>
                            <select id="colorSelect">
                                <option value="auto">Auto</option>
                                <option value="plddt">pLDDT</option>
                                <option value="rainbow">Rainbow</option>
                                <option value="chain">Chain</option>
                            </select>
                        </div>

                        <div class="toggle-item">
                            <label for="lineWidthSlider" class="font-medium text-gray-700">Width:</label>
                            <input type="range" id="lineWidthSlider" min="2.0" max="4.7" value="3.0" step="0.1">
                        </div>
                        
                        <!-- Toggle Switches for Shadow/Outline/Colorblind -->
                        <div class="toggle-item">
                             <label for="shadowEnabledCheckbox">Shadow:</label>
                             <label class="switch">
                                 <input type="checkbox" id="shadowEnabledCheckbox" checked>
                                 <span class="slider-toggle"></span>
                             </label>
                        </div>
                        
                        <div class="toggle-item">
                             <label for="outlineEnabledCheckbox">Outline:</label>
                             <label class="switch">
                                 <input type="checkbox" id="outlineEnabledCheckbox" checked>
                                 <span class="slider-toggle"></span>
                             </label>
                        </div>
                        
                        <div class="toggle-item">
                             <label for="colorblindCheckbox">Colorblind:</label>
                             <label class="switch">
                                 <input type="checkbox" id="colorblindCheckbox">
                                 <span class="slider-toggle"></span>
                             </label>
                        </div>

                        <div class="toggle-item"> 
                            <label for="rotationCheckbox">Rotate:</label>
                            <label class="switch">
                                <input type="checkbox" id="rotationCheckbox">
                                <span class="slider-toggle"></span>
                            </label>
                        </div>
                    </div>

                    <div id="modelControlContainer" class="control-group" style="padding-top: 0; gap: 8px;">
                         
                         <div id="objectContainer" class="toggle-item" style="margin-top: 0;">
                             <label for="objectSelect" class="font-medium text-gray-700">Object:</label>
                             <select id="objectSelect">
                                 <!-- Initially empty -->
                             </select>
                         </div>
                        
                    </div>
                    
                    <!-- PAE Container is now centered and aligned with no extra space -->
                    <div id="paeContainer">
                         <!-- Canvas size must match the width/height CSS defined above (296px) -->
                         <canvas id="paeCanvas" width="296" height="296" style="cursor: crosshair; display: block;"></canvas>
                    </div>

                </div>
            </div>    
            
        </div>

    </div>
    <script id="py2dmol-renderer" src="https://py2dmol.solab.org/py2Dmol/resources/py2Dmol.js"></script>
    
    <script>
        
        document.addEventListener('DOMContentLoaded', () => {

            let objectsWithPAE = new Set(); 
            let viewerApi = null; 
            let statusElement = document.getElementById('status-message');
            let paeContainer = document.getElementById('paeContainer');
            let objectSelect = document.getElementById('objectSelect');
            let colorSelect = document.getElementById('colorSelect');
            let frameSlider = document.getElementById('frameSlider');
            const viewerContainer = document.getElementById('viewer-container');
            const canvasContainer = document.getElementById('canvasContainer');
            const canvas = document.getElementById('canvas');
            const viewerColumn = document.getElementById('viewerColumn');

            // UPDATED Constants:
            const FIXED_WIDTH = 600; 
            const FIXED_HEIGHT = 600;
            const PAE_PLOT_SIZE = 300; 
            
            // --- Model Parsing Functions (omitted for brevity) ---
            function parsePDB(text) {
                const models = [];
                let currentModelAtoms = [];
                const lines = text.split('\n');
                for (const line of lines) {
                    if (line.startsWith('MODEL')) {
                        if (currentModelAtoms.length > 0) { models.push(currentModelAtoms); }
                        currentModelAtoms = []; 
                    }
                    if (line.startsWith('ATOM') || line.startsWith('HETATM')) {
                        currentModelAtoms.push({
                            record: line.substring(0, 6).trim(), atomName: line.substring(12, 16).trim(),
                            resName: line.substring(17, 20).trim(), chain: line.substring(21, 22).trim(),
                            resSeq: parseInt(line.substring(22, 26)), x: parseFloat(line.substring(30, 38)),
                            y: parseFloat(line.substring(38, 46)), z: parseFloat(line.substring(46, 54)),
                            b: parseFloat(line.substring(60, 66)), element: line.substring(76, 78).trim()
                        });
                    }
                    if (line.startsWith('ENDMDL')) {
                        if (currentModelAtoms.length > 0) { models.push(currentModelAtoms); currentModelAtoms = []; }
                    }
                }
                if (currentModelAtoms.length > 0) { models.push(currentModelAtoms); }
                if (models.length === 0 && currentModelAtoms.length > 0) { models.push(currentModelAtoms); }
                return models;
            }

            function parseCIF(text) {
                const modelMap = new Map(); 
                const lines = text.split('\n');
                let atomSiteLoop = false;
                const headers = [];
                const headerMap = {};
                let modelIDKey = null; 
                let modelID = 1;

                for (const line of lines) {
                    if (line.startsWith('_atom_site.')) {
                        const header = line.trim();
                        headerMap[header] = headers.length;
                        headers.push(header);
                        if (header.includes('model_no') || header.includes('pdbx_PDB_model_num')) { modelIDKey = header; }
                    } else if (headers.length > 0 && (line.startsWith('loop_') || line.startsWith('#'))) { break; }
                }
                
                for (const line of lines) {
                    if (line.startsWith('_atom_site.')) { atomSiteLoop = true; } 
                    else if (atomSiteLoop && line.startsWith('#')) { atomSiteLoop = false; } 
                    else if (atomSiteLoop && !line.startsWith(';')) {
                        const values = line.match(/(?:[^\s"']+|"([^"]*)"|'([^']*)')+/g);
                        if (!values || values.length < headers.length) continue;
                        
                        const getString = (key) => values[headerMap[key]] || '?';
                        const getFloat = (key) => parseFloat(values[headerMap[key]]) || 0.0;
                        const getInt = (key) => parseInt(values[headerMap[key]]) || 0;

                        const atomNameRaw = getString('_atom_site.label_atom_id');
                        let atomName = atomNameRaw;
                        if (atomName.length > 1 && atomName.startsWith("'") && atomName.endsWith("'")) { atomName = atomName.substring(1, atomName.length - 1); } 
                        else if (atomName.length > 1 && atomName.startsWith('"') && atomName.endsWith('"')) { atomName = atomName.substring(1, atomName.length - 1); }
                        
                        const atom = {
                            record: getString('_atom_site.group_PDB'), atomName: atomName, 
                            resName: getString('_atom_site.label_comp_id'), chain: getString('_atom_site.auth_asym_id'),
                            resSeq: getInt('_atom_site.auth_seq_id'), x: getFloat('_atom_site.Cartn_x'),
                            y: getFloat('_atom_site.Cartn_y'), z: getFloat('_atom_site.Cartn_z'),
                            b: getFloat('_atom_site.B_iso_or_equiv'), element: getString('_atom_site.type_symbol')
                        };

                        if (modelIDKey) { modelID = getInt(modelIDKey); }
                        
                        if (!modelMap.has(modelID)) { modelMap.set(modelID, []); }
                        modelMap.get(modelID).push(atom);
                    }
                }
                
                return Array.from(modelMap.keys()).sort((a, b) => a - b).map(id => modelMap.get(id));
            }

            function convertParsedToFrameData(atoms) {
                const coords = []; const plddts = []; const atom_chains = []; const atom_types = [];
                const rna_bases = ['A', 'C','G', 'U', 'RA', 'RC', 'RG', 'RU'];
                const proteinResidues = new Set(["ALA", "ARG", "ASN", "ASP", "CYS", "GLU", "GLN", "GLY", "HIS", "ILE", "LEU", "LYS", "MET", "PHE", "PRO", "SER", "THR", "TRP", "TYR", "VAL"]);
                const nucleicResidues = new Set(["A", "C", "G", "U", "T", "DA", "DC", "DG", "DT", "RA", "RC", "RG", "RU"]);
                const residues = new Map();
                for (const atom of atoms) {
                    if (atom.resName === 'HOH') continue;
                    const resKey = `${atom.chain}:${atom.resSeq}:${atom.resName}`;
                    if (!residues.has(resKey)) { residues.set(resKey, { atoms: [], resName: atom.resName, chain: atom.chain, record: atom.record }); }
                    residues.get(resKey).atoms.push(atom);
                }
                for (const [resKey, residue] of residues.entries()) {
                    const is_protein = proteinResidues.has(residue.resName);
                    const is_nucleic = nucleicResidues.has(residue.resName);
                    if (is_protein) {
                        const ca = residue.atoms.find(a => a.atomName === 'CA');
                        if (ca) { coords.push([ca.x, ca.y, ca.z]); plddts.push(ca.b); atom_chains.push(ca.chain); atom_types.push('P'); }
                    } else if (is_nucleic) {
                        let c4_atom = residue.atoms.find(a => a.atomName === "C4'" || a.atomName === "C4*");
                        if (c4_atom) {
                            coords.push([c4_atom.x, c4_atom.y, c4_atom.z]); plddts.push(c4_atom.b); atom_chains.push(c4_atom.chain);
                            atom_types.push(rna_bases.includes(residue.resName) || residue.resName.startsWith('R') ? 'R' : 'D');
                        }
                    } else if (residue.record === 'HETATM') {
                        for (const atom of residue.atoms) {
                            if (atom.element !== 'H' && atom.element !== 'D') { 
                                coords.push([atom.x, atom.y, atom.z]); plddts.push(atom.b); atom_chains.push(atom.chain); atom_types.push('L');
                            }
                        }
                    }
                }
                return { coords, plddts, chains: atom_chains, atom_types };
            }

            // --- App Main Logic ---

            function setStatus(message, isError = false) {
                statusElement.textContent = message;
                statusElement.className = `mt-4 text-sm font-medium ${isError ? 'text-red-700 bg-red-100 border-red-200' : 'text-blue-700 bg-blue-50 border-blue-200'} p-2 rounded-lg border`;
                statusElement.classList.remove('hidden');
            }
            
            function cleanObjectName(name) {
                return name.replace(/\.(cif|pdb|ent)$/i, '');
            }

            function processStructure(text, name, paeData = null) {
                if (!viewerApi) { setStatus("Error: Viewer API not initialized.", true); return; }

                setStatus(`Parsing ${name} for models...`);
                let models;
                try {
                    const isCIF = text.substring(0, 1000).includes('data_'); 
                    models = isCIF ? parseCIF(text) : parsePDB(text);
                    
                    if (!models || models.length === 0 || models.every(m => m.length === 0)) { throw new Error("Could not parse any models or atoms from the file."); }
                } catch (e) {
                    console.error("Parsing failed:", e);
                    setStatus(`Error: ${e.message}`, true); return;
                }
                
                const objectName = cleanObjectName(name); 
                viewerApi.handlePythonNewObject(objectName);
                
                objectsWithPAE.delete(objectName);

                let framesAdded = 0;
                
                for (let i = 0; i < models.length; i++) {
                    const model = models[i];
                    setStatus(`Converting Model ${i + 1} of ${models.length}...`);
                    let frameData = convertParsedToFrameData(model);
                    
                    if (frameData.coords.length === 0) { console.warn(`Skipping empty model ${i + 1}.`); continue; }

                    frameData.pae = (i === 0) ? paeData : null; 

                    viewerApi.handlePythonUpdate(JSON.stringify(frameData), objectName);
                    framesAdded++;
                }

                if (framesAdded === 0) { setStatus("Error: Found models, but no recognizable backbone atoms (CA/C4') in any of them.", true); return; }
                
                if (paeData) { objectsWithPAE.add(objectName); }

                viewerContainer.style.display = 'flex';
                
                // Show/hide PAE matrix immediately
                paeContainer.style.display = paeData ? 'block' : 'none';

                if (objectSelect) {
                    objectSelect.value = objectName;
                    
                    // Trigger object change logic to set color and finalize UI
                    objectSelect.dispatchEvent(new Event('change')); 
                    
                    if (frameSlider) {
                        frameSlider.value = framesAdded - 1;
                        frameSlider.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                     
                    setStatus(`Successfully rendered ${framesAdded} model${framesAdded > 1 ? 's' : ''} for ${objectName}.`);
                }
            }
            
            async function handleFetch() {
                const fetchId = document.getElementById('fetch-id').value.trim().toUpperCase();
                if (!fetchId) { setStatus("Please enter a PDB or UniProt ID.", true); return; }

                const isPDB = fetchId.length === 4;
                const isAFDB = !isPDB;
                
                let structUrl, paeUrl, name, paeEnabled;

                if (isAFDB) {
                    name = `${fetchId}.cif`;
                    structUrl = `https://alphafold.ebi.ac.uk/files/AF-${fetchId}-F1-model_v6.cif`;
                    paeUrl = `https://alphafold.ebi.ac.uk/files/AF-${fetchId}-F1-predicted_aligned_error_v6.json`;
                    paeEnabled = window.viewerConfig.pae; 
                    
                    if (paeEnabled) { setStatus(`Fetching ${fetchId} model and PAE...`); }
                    else { paeContainer.style.display = 'none'; setStatus(`Fetching ${fetchId} model...`); }
                } else { 
                    name = `${fetchId}.cif`; structUrl = `https://files.rcsb.org/download/${fetchId}.cif`;
                    paeUrl = null; paeEnabled = false;
                    setStatus(`Fetching ${fetchId} from RCSB...`); paeContainer.style.display = 'none'; 
                }

                try {
                    const structResponse = await fetch(structUrl);
                    if (!structResponse.ok) { throw new Error(`Failed to fetch structure (HTTP ${structResponse.status})`); }
                    const structText = await structResponse.text();
                    
                    let paeData = null;
                    if (paeEnabled && paeUrl) {
                        try {
                            const paeResponse = await fetch(paeUrl);
                            if (paeResponse.ok) {
                                const paeJson = await paeResponse.json();
                                if (paeJson && paeJson.length > 0) { paeData = paeJson[0].predicted_aligned_error; }
                            } else { setStatus(`Fetched model, but PAE data not found (HTTP ${paeResponse.status}).`); paeContainer.style.display = 'none'; }
                        } catch (e) {
                            console.warn("Could not fetch PAE data:", e.message); setStatus(`Fetched model, but PAE data failed to load.`); paeContainer.style.display = 'none'; 
                        }
                    }
                    
                    processStructure(structText, name, paeData);

                } catch (e) {
                    console.error("Fetch failed:", e); setStatus(`Error: ${e.message}. Check ID and console.`, true); paeContainer.style.display = 'none'; 
                }
            }

            function handleFileUpload(event) {
                const files = event.target.files || (event.dataTransfer ? event.dataTransfer.files : null);
                
                if (!files || files.length === 0) return;

                // Reset state before processing new files
                paeContainer.style.display = 'none';
                if (colorSelect) { 
                    // When uploading, ensure the internal color mode is 'auto' but DONT change the dropdown value.
                    viewerApi.handlePythonSetColor('auto');
                }
                
                let filesProcessed = 0;
                
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        if (text) { 
                            processStructure(text, file.name); 
                        } else { 
                            setStatus(`File '${file.name}' is empty or unreadable.`, true); 
                        }
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                             objectSelect.dispatchEvent(new Event('change'));
                        }
                    };
                    reader.onerror = () => { setStatus(`Failed to read file '${file.name}'.`, true); };
                    reader.readAsText(file);
                }
            }
            
            function updateColorMode() {
                 const userPreference = colorSelect.value;
                 
                 // Pass the user's preference directly to the viewer.
                 // The viewer (py2Dmol.js) now handles the logic: 
                 // if preference is 'auto' AND PAE is present, it uses plddt internally.
                 viewerApi.handlePythonSetColor(userPreference);
            }
            
            function handleObjectChange() {
                 const selectedObject = objectSelect.value;
                 const hasPAE = objectsWithPAE.has(selectedObject);
                 
                 // 1. Manage PAE visibility
                 paeContainer.style.display = hasPAE ? 'block' : 'none';
                 
                 // 2. Update Color Mode based on user's dropdown choice
                 updateColorMode();
            }

            // --- Initialization Functions (omitted for brevity) ---
            function initDragAndDrop() {
                const dropArea = document.getElementById('drop-area');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.target.files = e.dataTransfer.files; 
                    handleFileUpload(e); 
                }, false);
            }

            function preventDefaults (e) {
              e.preventDefault();
              e.stopPropagation();
            }


            function initApp() {
                console.log("DOM is ready. Initializing app...");

                // UPDATED to use new constants
                window.viewerConfig = { 
                    size: [FIXED_WIDTH, FIXED_HEIGHT],
                    pae_size: [PAE_PLOT_SIZE, PAE_PLOT_SIZE],
                    color: "auto", shadow: true, outline: true, width: 3.0,
                    rotate: false, controls: true, autoplay: false, box: true,
                    pastel: 0.25, pae: true, colorblind: false, viewer_id: "standalone-viewer-1" 
                };
                
                canvasContainer.style.width = `${FIXED_WIDTH}px`;
                canvasContainer.style.height = `${FIXED_HEIGHT}px`;
                canvas.width = FIXED_WIDTH;
                canvas.height = FIXED_HEIGHT;
                viewerColumn.style.minWidth = `${FIXED_WIDTH}px`;


                try {
                    initializePy2DmolViewer(viewerContainer);
                } catch (e) {
                    console.error("Failed to initialize viewer:", e);
                    setStatus("Error: Failed to initialize viewer. See console.", true);
                    return;
                }

                viewerApi = window.py2dmol_viewers[window.viewerConfig.viewer_id];
                
                document.getElementById('fetch-btn').addEventListener('click', handleFetch);
                document.getElementById('file-upload').addEventListener('change', handleFileUpload);
                
                // Centralize logic calls
                objectSelect.addEventListener('change', handleObjectChange);
                colorSelect.addEventListener('change', updateColorMode); 
                
                initDragAndDrop(); 
                
                paeContainer.style.display = 'none';
                setStatus("Ready. Upload a file or fetch an ID.");
            }

            const rendererScript = document.getElementById('py2dmol-renderer');
            if (rendererScript && typeof initializePy2DmolViewer === 'function') {
                initApp();
            } else if (rendererScript) {
                 rendererScript.onload = initApp;
            }

        });
        
    </script>
</body>
</html>