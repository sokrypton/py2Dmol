let viewerApi=null,pendingObjects=[],scatterViewer=null;function isValidPAE(e){return e&&(Array.isArray(e)&&e.length>0||e.buffer&&e.length>0)}function checkObjectHasPAE(e){return!(!e||!e.frames||0===e.frames.length)&&e.frames.some(e=>isValidPAE(e.pae))}let rotationAnimation={active:!1,startMatrix:null,targetMatrix:null,startTime:0,duration:1e3};const FIXED_WIDTH=600,FIXED_HEIGHT=600,PAE_PLOT_SIZE=300,DEFAULT_MSA_COVERAGE=.75,DEFAULT_MSA_IDENTITY=.15;function initializeApp(){initializeViewerConfig(),setupCanvasDimensions();try{const e=document.getElementById("viewer-container");initializePy2DmolViewer(e)}catch(e){return console.error("Failed to initialize viewer:",e),void setStatus("Error: Failed to initialize viewer. See console.",!0)}if(viewerApi=window.py2dmol_viewers[window.viewerConfig.viewer_id],window.MSAViewer&&window.MSAViewer.setCallbacks({getRenderer:()=>viewerApi?.renderer||null,getObjectSelect:()=>document.getElementById("objectSelect"),highlightAtom:highlightPosition,highlightAtoms:highlightPositions,clearHighlight:clearHighlight,applySelection:applySelection,onMSAFilterChange:(e,t)=>{if(!viewerApi?.renderer||!t||!e)return;const n=viewerApi.renderer.currentObjectName;if(!n)return;const i=viewerApi.renderer.objectsData[n];if(!i||!i.msa)return;e.frequencies=null,e.entropy=null,e.logOdds=null,computeMSAProperties(e);const{coverageCutoff:o,identityCutoff:a}=getCurrentMSAFilters();applyFiltersToAllMSAs(n,{coverageCutoff:o,identityCutoff:a,activeChainId:t,activeFilteredMSAData:e}),refreshEntropyColors()}}),viewerApi?.renderer&&window.SequenceViewer&&window.SequenceViewer.drawHighlights){viewerApi.renderer.canvas&&window.SequenceViewer.drawHighlights()}setupEventListeners(),initDragAndDrop();const e=document.getElementById("paeCanvas");e&&(e.style.display="none"),setStatus("Ready. Upload a file or fetch an ID.")}function refreshEntropyColors(){if(!viewerApi?.renderer||"entropy"!==viewerApi.renderer.colorMode)return;const e=viewerApi.renderer;e._mapEntropyToStructure(),e.colors=null,e.colorsNeedUpdate=!0,e.render("app.js: refreshEntropyColors"),document.dispatchEvent(new CustomEvent("py2dmol-color-change")),"function"==typeof updateSequenceViewColors&&updateSequenceViewColors()}function getCurrentMSAFilters(){const e="function"==typeof window.MSAViewer?.getCoverageCutoff?window.MSAViewer.getCoverageCutoff():DEFAULT_MSA_COVERAGE,t="function"==typeof window.MSAViewer?.getIdentityCutoff?window.MSAViewer.getIdentityCutoff():DEFAULT_MSA_IDENTITY;return{coverageCutoff:Number.isFinite(e)?e:DEFAULT_MSA_COVERAGE,identityCutoff:Number.isFinite(t)?t:DEFAULT_MSA_IDENTITY}}function applyFiltersToAllMSAs(e,t={}){if(!viewerApi?.renderer||!e||!window.MSAViewer?.applyFiltersToMSA)return;const n=viewerApi.renderer.objectsData[e];if(!n||!n.msa||!n.msa.msasBySequence)return;const{coverageCutoff:i=DEFAULT_MSA_COVERAGE,identityCutoff:o=DEFAULT_MSA_IDENTITY,activeChainId:a=null,activeFilteredMSAData:r=null}=t,s=a&&n.msa.chainToSequence?n.msa.chainToSequence[a]:null,c=r?.entropy,l=Object.keys(n.msa.msasBySequence);if(1===l.length&&s&&c){const e=n.msa.msasBySequence[l[0]];return void(e?.msaData&&(e.msaData.entropy=c))}for(const[e,t]of Object.entries(n.msa.msasBySequence)){const n=t.msaData;if(!n)continue;if(s&&e===s&&c){n.entropy=c;continue}const a=window.MSAViewer.applyFiltersToMSA(n,i,o);a&&(computeMSAProperties(a),a.entropy?n.entropy=a.entropy:delete n.entropy)}}function initializeViewerConfig(){const e=document.getElementById("biounitCheckbox"),t=document.getElementById("loadLigandsCheckbox");window.viewerConfig={display:{size:[600,600],rotate:!1,autoplay:!1,controls:!0,box:!0},rendering:{shadow:!0,outline:"full",width:3,ortho:1,pastel:.25},color:{mode:"auto",colorblind:!1},pae:{enabled:!0,size:300},scatter:{enabled:!1,size:300,xlabel:null,ylabel:null,xlim:null,ylim:null},overlay:{enabled:!1},ui:{biounit:!0,loadLigands:!1},viewer_id:"standalone-viewer-1"},window.py2dmol_configs||(window.py2dmol_configs={}),window.py2dmol_configs[window.viewerConfig.viewer_id]=window.viewerConfig,window.syncViewerConfig=function(){window.viewerConfig&&window.viewerConfig.viewer_id&&(window.py2dmol_configs[window.viewerConfig.viewer_id]=window.viewerConfig)},e&&(e.checked=window.viewerConfig.ui.biounit),t&&(t.checked=window.viewerConfig.ui.loadLigands),e&&e.addEventListener("change",()=>{window.viewerConfig.ui.biounit=e.checked}),t&&t.addEventListener("change",()=>{window.viewerConfig.ui.loadLigands=t.checked})}function setupCanvasDimensions(){const e=document.getElementById("canvasContainer"),t=document.getElementById("canvas"),n=document.getElementById("viewerColumn");e.style.width="600px",e.style.height="600px",t.width=600,t.height=600,n.style.minWidth="600px"}function handleExampleButtonClick(e){const t=document.getElementById("fetch-id"),n=document.getElementById("fetch-uniprot-id"),i=null!==n,o=i?n:t,a=i?handleMSAFetch:handleFetch;o&&e&&(o.value=e,a())}function setupExampleButtons(){document.querySelectorAll("[data-example-value]").forEach(e=>{const t=e.getAttribute("data-example-value");t&&e.addEventListener("click",()=>{handleExampleButtonClick(t)})})}function getMSACanvasContainers(){return Array.from(document.querySelectorAll(".msa-canvas"))}function showMSACanvasContainers(){getMSACanvasContainers().forEach(e=>{e.style.display="block",e.style.visibility="visible"})}function hideMSACanvasContainers(){getMSACanvasContainers().forEach(e=>{e.style.display="none"})}function removeMSACanvasContainers(){getMSACanvasContainers().forEach(e=>{e.resizeObserver&&e.resizeObserver.disconnect(),e.parentElement&&e.parentElement.removeChild(e)})}function clearMSAViewerState(){if(removeMSACanvasContainers(),window.MSAViewer?.clear)try{window.MSAViewer.clear()}catch(e){console.warn("MSA Viewer clear failed:",e)}const e=document.getElementById("msaSequenceCount");e&&(e.textContent="-")}function setupEventListeners(){document.getElementById("fetch-btn").addEventListener("click",handleFetch);const e=document.getElementById("upload-button"),t=document.getElementById("file-upload");e.addEventListener("click",()=>t.click()),t.addEventListener("change",handleFileUpload),setupExampleButtons();const n=document.getElementById("saveStateButton");n&&n.addEventListener("click",saveViewerState);const i=document.getElementById("copySelectionButton");i&&i.addEventListener("click",()=>{viewerApi&&viewerApi.renderer&&viewerApi.renderer.extractSelection?(viewerApi.renderer.extractSelection(),applySelectionToMSA()):console.warn("Copy selection feature not available")});const o=document.getElementById("orientToggle"),a=document.getElementById("prevObjectButton"),r=document.getElementById("nextObjectButton");if(o){const e=o.querySelector("span");e&&e.addEventListener("click",e=>{e.preventDefault(),applyBestViewRotation()})}a&&a.addEventListener("click",gotoPreviousObject),r&&r.addEventListener("click",gotoNextObject);const s=document.getElementById("objectSelect");s&&s.addEventListener("change",handleObjectChange);const c=document.getElementById("sequenceView"),l=document.getElementById("selectAllResidues"),d=document.getElementById("clearAllResidues"),u=document.querySelector(".sequence-actions");if(c){c.classList.remove("hidden");const e=document.getElementById("sequence-viewer-container");e&&e.classList.remove("collapsed"),u&&(u.style.display="flex")}const m=document.getElementById("sequenceModeSelect");function f(){if(m&&window.SequenceViewer){const e=!window.SequenceViewer.getSequenceViewMode||window.SequenceViewer.getSequenceViewMode();m.value=e?"sequence":"chain"}}if(m&&window.SequenceViewer){const e=!window.SequenceViewer.getSequenceViewMode||window.SequenceViewer.getSequenceViewMode();m.value=e?"sequence":"chain",m.addEventListener("change",e=>{const t="sequence"===e.target.value;window.SequenceViewer&&window.SequenceViewer.setSequenceViewMode(t),buildSequenceView()})}window.SequenceViewer&&window.SequenceViewer.setSequenceViewMode(!0),f(),window.updateSequenceModeDropdown=f;let w=-1;function h(){const e=document.getElementById("copySelectionButton");if(!e||!viewerApi?.renderer)return;const t=viewerApi.renderer,n=t.currentObjectName;if(!n)return void(e.disabled=!0);const i=t.objectsData[n];if(!i||!i.frames||0===i.frames.length)return void(e.disabled=!0);const o=i.frames[t.currentFrame>=0?t.currentFrame:0];if(!o||!o.coords)return void(e.disabled=!0);const a=o.coords.length,r=t.getSelection();let s=new Set;if(t.overlayState&&t.overlayState.enabled)if(r&&r.positions&&r.positions.size>0)s=new Set(r.positions);else for(let e=0;e<a;e++)s.add(e);else if(null!==t.visibilityMask&&t.visibilityMask.size>0)s=new Set(t.visibilityMask);else for(let e=0;e<a;e++)s.add(e);const c=s.size>0,l=s.size>0&&s.size<a;e.disabled=!(c&&l)}requestAnimationFrame(function e(){if(viewerApi?.renderer){const e=viewerApi.renderer,t=e.currentFrame;if(t!==w&&t>=0){w=t,document.dispatchEvent(new CustomEvent("py2dmol-frame-change",{detail:{frameIndex:t}}));const n=e.currentObjectName;if(n&&e.objectsData[n]){const i=e.objectsData[n];i.frames&&i.frames.length>t&&buildSequenceView()}}}requestAnimationFrame(e)}),l&&l.addEventListener("click",e=>{e.preventDefault(),showAllResidues()}),d&&d.addEventListener("click",e=>{e.preventDefault(),hideAllResidues()}),document.addEventListener("py2dmol-selection-change",h),setTimeout(()=>{!function(){if(viewerApi&&viewerApi.renderer){viewerApi.renderer.objectSelect&&viewerApi.renderer.objectSelect.addEventListener("change",h);const e=document.getElementById("frameSlider");e&&(e.addEventListener("input",h),e.addEventListener("change",h))}}(),h()},200);const p=document.getElementById("clearAllButton");p&&p.addEventListener("click",e=>{e.preventDefault(),clearAllObjects()}),document.addEventListener("py2dmol-color-change",()=>{updateSequenceViewColors(),updateSequenceViewSelectionState(),viewerApi?.renderer?.paeRenderer&&viewerApi.renderer.paeRenderer.render()}),document.addEventListener("py2dmol-selection-change",e=>{syncChainPillsToSelection(),updateSequenceViewSelectionState(),applySelectionToMSA()}),updateObjectNavigationButtons()}function setStatus(e,t=!1){const n=document.getElementById("status-message");if(n)n.textContent=e,n.style.display="block",n.className=t?"error":"info";else{const n=document.getElementById("status");n&&(n.textContent=e,n.className=`mt-4 text-sm font-medium ${t?"text-red-700 bg-red-100 border-red-200":"text-blue-700 bg-blue-50 border-blue-200"} p-2 rounded-lg border`,n.classList.remove("hidden"))}}function gotoPreviousObject(){const e=document.getElementById("objectSelect");if(!e||0===e.options.length)return;const t=e.selectedIndex,n=t>0?t-1:e.options.length-1;e.selectedIndex=n,e.dispatchEvent(new Event("change"))}function gotoNextObject(){const e=document.getElementById("objectSelect");if(!e||0===e.options.length)return;const t=e.selectedIndex,n=t<e.options.length-1?t+1:0;e.selectedIndex=n,e.dispatchEvent(new Event("change"))}function updateObjectNavigationButtons(){const e=document.getElementById("objectSelect"),t=document.getElementById("prevObjectButton"),n=document.getElementById("nextObjectButton");if(!e||!t||!n)return;const i=e.options.length<=1;t.disabled=i,n.disabled=i,i?(t.classList.add("greyed-out"),n.classList.add("greyed-out")):(t.classList.remove("greyed-out"),n.classList.remove("greyed-out"))}function handleObjectChange(){const e=document.getElementById("objectSelect").value;if(e){if(viewerApi?.renderer){const t=pendingObjects.find(t=>t.name===e),n=viewerApi.renderer.objectsData[e];t&&t.msa&&n&&!n.msa&&(n.msa=t.msa)}if(viewerApi?.renderer&&e){const t=viewerApi.renderer.objectsData[e];t&&t.msa&&t.msa.msasBySequence&&t.msa.chainToSequence&&viewerApi.renderer._mapEntropyToStructure(e)}viewerApi?.renderer&&"function"==typeof viewerApi.renderer.updatePAEContainerVisibility&&viewerApi.renderer.updatePAEContainerVisibility(),window.SequenceViewer?.clearPreview&&window.SequenceViewer.clearPreview(),buildSequenceView(),window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex(),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility(),refreshEntropyColors()}}function applyBestViewRotation(e=!0){if(!viewerApi||!viewerApi.renderer)return;const t=viewerApi.renderer,n=document.getElementById("objectSelect"),i=n?n.value:null;if(!i)return;const o=t.objectsData[i];if(!o||!o.frames||0===o.frames.length)return;const a=t.currentFrame||0,r=o.frames[a];if(!r||!r.coords||0===r.coords.length)return;0!==t.coords.length&&t.lastRenderedFrame===a||t._loadFrameData(a,!0);const s=t.getSelection();let c=null;if(s&&s.positions&&s.positions.size>0)c=s.positions;else if(!s||"default"!==s.selectionMode||s.chains&&0!==s.chains.size)if(s&&s.chains&&s.chains.size>0){c=new Set;for(let e=0;e<r.coords.length;e++)r.chains&&r.chains[e]&&s.chains.has(r.chains[e])&&c.add(e);0===c.size&&(c=null)}else c=null;else c=null;let l=[];if(c&&c.size>0)for(const e of c)e>=0&&e<r.coords.length&&l.push(r.coords[e]);else l=r.coords;if(0===l.length)return;let d=null,u=null,m=0;if(l.length>0){const e=[0,0,0];for(const t of l)e[0]+=t[0],e[1]+=t[1],e[2]+=t[2];d=[e[0]/l.length,e[1]/l.length,e[2]/l.length];let t=0,n=0;for(const e of l){const i=e[0]-d[0],o=e[1]-d[1],a=e[2]-d[2],r=i*i+o*o+a*a;r>t&&(t=r),n+=r}u=Math.sqrt(t),m=u;const i=l.length>0?Math.sqrt(n/l.length):0;rotationAnimation.visibleStdDev=i,rotationAnimation.originalStdDev=i}else rotationAnimation.visibleStdDev=null,rotationAnimation.originalStdDev=null;const f=t.viewerState.rotation,w=t.canvas,h=w?parseInt(w.style.width)||w.width:null,p=w?parseInt(w.style.height)||w.height:null,S=bestViewTargetRotation_relaxed_AUTO(l,f,h,p),g=12*(180*rotationAngleBetweenMatrices(f,S)/Math.PI),A=Math.max(400,Math.min(2500,g));let y=null,v=null,b=t.viewerState.zoom;if(d&&u&&l.length>0?(y=d,v=u,b=1):(b=t.viewerState.zoom,m>0&&(v=m)),t.autoRotate&&(t.autoRotate=!1,t.rotationCheckbox&&(t.rotationCheckbox.checked=!1,t.rotationCheckbox.dispatchEvent(new Event("change",{bubbles:!0})))),t.spinVelocityX=0,t.spinVelocityY=0,e){if(rotationAnimation.startMatrix=f.map(e=>[...e]),rotationAnimation.targetMatrix=S.map(e=>[...e]),rotationAnimation.startZoom=t.viewerState.zoom,rotationAnimation.targetZoom=b,rotationAnimation.duration=A,rotationAnimation.startTime=performance.now(),rotationAnimation.object=o,y){let e=null;if(t.viewerState.center)e={x:t.viewerState.center.x,y:t.viewerState.center.y,z:t.viewerState.center.z};else{const t=r.coords;if(t&&t.length>0){const n=[0,0,0];for(const e of t)n[0]+=e[0],n[1]+=e[1],n[2]+=e[2];e={x:n[0]/t.length,y:n[1]/t.length,z:n[2]/t.length}}}rotationAnimation.startCenter=e,rotationAnimation.targetCenter={x:y[0],y:y[1],z:y[2]},rotationAnimation.startExtent=null!==t.viewerState.extent&&void 0!==t.viewerState.extent?t.viewerState.extent:o.maxExtent||m,rotationAnimation.targetExtent=v}else rotationAnimation.startCenter=t.viewerState.center?{x:t.viewerState.center.x,y:t.viewerState.center.y,z:t.viewerState.center.z}:null,rotationAnimation.targetCenter=null,rotationAnimation.startExtent=null!==t.viewerState.extent&&void 0!==t.viewerState.extent?t.viewerState.extent:o.maxExtent||m,rotationAnimation.targetExtent=v;rotationAnimation.active=!0,t&&(t.isOrientAnimating=!0),requestAnimationFrame(animateRotation)}else{if(t.viewerState.rotation=S.map(e=>[...e]),y?(t.viewerState.center={x:y[0],y:y[1],z:y[2]},t.viewerState.extent=v):(t.viewerState.center=null,t.viewerState.extent=null!=v?v:null),t.viewerState.zoom=b,null!==rotationAnimation.visibleStdDev&&void 0!==rotationAnimation.visibleStdDev&&(o.stdDev=rotationAnimation.visibleStdDev,t.orthoSlider&&t.perspectiveEnabled)){const e=2,n=1.5,i=20,a=parseFloat(t.orthoSlider.value);if(a<1){const r=o.stdDev*e,s=n+(i-n)*a;t.focalLength=r*s}}t.render("app.js: applyBestViewRotation")}}function animateRotation(){if(!rotationAnimation.active){if(viewerApi&&viewerApi.renderer){const e=viewerApi.renderer;e.isOrientAnimating=!1,e.cachedShadows=null,e.cachedTints=null,e.lastShadowRotationMatrix=null}return}if(!viewerApi||!viewerApi.renderer){if(rotationAnimation.active=!1,viewerApi&&viewerApi.renderer){const e=viewerApi.renderer;e.isOrientAnimating=!1,e.cachedShadows=null,e.cachedTints=null,e.lastShadowRotationMatrix=null}return}const e=viewerApi.renderer,t=performance.now()-rotationAnimation.startTime;let n=t/rotationAnimation.duration;if((n>=.99||t>=rotationAnimation.duration)&&(n=1),n>=1){if(e.viewerState.rotation=rotationAnimation.targetMatrix,rotationAnimation.targetCenter){const t=rotationAnimation.targetCenter;e.viewerState.center={x:t.x,y:t.y,z:t.z},e.viewerState.extent=rotationAnimation.targetExtent}else e.viewerState.center=null,null!==rotationAnimation.targetExtent&&void 0!==rotationAnimation.targetExtent?e.viewerState.extent=rotationAnimation.targetExtent:e.viewerState.extent=null;if(rotationAnimation.object&&null!==rotationAnimation.visibleStdDev&&void 0!==rotationAnimation.visibleStdDev&&(rotationAnimation.object.stdDev=rotationAnimation.visibleStdDev,e.orthoSlider&&e.perspectiveEnabled)){const t=2,n=1.5,i=20,o=parseFloat(e.orthoSlider.value);if(o<1){const a=rotationAnimation.object.stdDev*t,r=n+(i-n)*o;e.focalLength=a*r}}return e.isOrientAnimating=!1,e.cachedShadows=null,e.cachedTints=null,e.lastShadowRotationMatrix=null,e.render(),rotationAnimation.active=!1,rotationAnimation.startCenter=null,rotationAnimation.targetCenter=null,rotationAnimation.startExtent=null,rotationAnimation.targetExtent=null,rotationAnimation.startZoom=null,rotationAnimation.targetZoom=null,rotationAnimation.object=null,rotationAnimation.visibleStdDev=null,void(rotationAnimation.originalStdDev=null)}const i=Math.max(0,Math.min(1,n)),o=i<.5?4*i*i*i:1-Math.pow(-2*i+2,3)/2;if(n>=1)e.viewerState.rotation=rotationAnimation.targetMatrix;else{const t=lerpRotationMatrix(rotationAnimation.startMatrix,rotationAnimation.targetMatrix,o);e.viewerState.rotation=t}if(void 0!==rotationAnimation.targetZoom&&null!==rotationAnimation.startZoom)if(n>=1)e.viewerState.zoom=rotationAnimation.targetZoom;else{const t=o;e.viewerState.zoom=rotationAnimation.startZoom+(rotationAnimation.targetZoom-rotationAnimation.startZoom)*t}if(rotationAnimation.object&&null!==rotationAnimation.visibleStdDev&&void 0!==rotationAnimation.visibleStdDev&&null!==rotationAnimation.originalStdDev&&void 0!==rotationAnimation.originalStdDev){const t=o;if(rotationAnimation.object.stdDev=rotationAnimation.originalStdDev+(rotationAnimation.visibleStdDev-rotationAnimation.originalStdDev)*t,e.orthoSlider&&e.perspectiveEnabled){const t=2,n=1.5,i=20,o=parseFloat(e.orthoSlider.value);if(o<1){const a=rotationAnimation.object.stdDev*t,r=n+(i-n)*o;e.focalLength=a*r}}const n=document.getElementById("orthoSlider");n&&n.dispatchEvent(new Event("input"))}if(rotationAnimation.targetCenter&&rotationAnimation.startCenter)if(n>=1)e.viewerState.center={x:rotationAnimation.targetCenter.x,y:rotationAnimation.targetCenter.y,z:rotationAnimation.targetCenter.z},null!==rotationAnimation.targetExtent&&void 0!==rotationAnimation.targetExtent&&(e.viewerState.extent=rotationAnimation.targetExtent);else{const t=o;e.viewerState.center={x:rotationAnimation.startCenter.x+(rotationAnimation.targetCenter.x-rotationAnimation.startCenter.x)*t,y:rotationAnimation.startCenter.y+(rotationAnimation.targetCenter.y-rotationAnimation.startCenter.y)*t,z:rotationAnimation.startCenter.z+(rotationAnimation.targetCenter.z-rotationAnimation.startCenter.z)*t},null!==rotationAnimation.targetExtent&&void 0!==rotationAnimation.targetExtent?e.viewerState.extent=rotationAnimation.startExtent+(rotationAnimation.targetExtent-rotationAnimation.startExtent)*t:e.viewerState.extent=rotationAnimation.startExtent}else{if(null!==rotationAnimation.targetExtent&&void 0!==rotationAnimation.targetExtent){const t=o,n=null!==rotationAnimation.startExtent&&void 0!==rotationAnimation.startExtent?rotationAnimation.startExtent:rotationAnimation.object&&rotationAnimation.object.maxExtent||30;e.viewerState.extent=n+(rotationAnimation.targetExtent-n)*t}else{const t=o,n=null!==rotationAnimation.startExtent&&void 0!==rotationAnimation.startExtent?rotationAnimation.startExtent:rotationAnimation.object&&rotationAnimation.object.maxExtent||30,i=rotationAnimation.object&&rotationAnimation.object.maxExtent||30;e.viewerState.extent=n+(i-n)*t}n>=.99&&(e.viewerState.center=null,null!==rotationAnimation.targetExtent&&void 0!==rotationAnimation.targetExtent||(e.viewerState.extent=null))}e.render(),requestAnimationFrame(animateRotation)}function parseContactColor(e){if(!e||"string"!=typeof e)return null;const t=e.toLowerCase().trim(),n={red:{r:255,g:0,b:0},green:{r:0,g:255,b:0},blue:{r:0,g:0,b:255},yellow:{r:255,g:255,b:0},orange:{r:255,g:165,b:0},purple:{r:128,g:0,b:128},cyan:{r:0,g:255,b:255},magenta:{r:255,g:0,b:255},pink:{r:255,g:192,b:203},brown:{r:165,g:42,b:42},black:{r:0,g:0,b:0},white:{r:255,g:255,b:255},gray:{r:128,g:128,b:128},grey:{r:128,g:128,b:128}};if(n[t])return n[t];if(e.startsWith("#")||/^[0-9a-fA-F]{6}$/.test(e)){const t=e.startsWith("#")?e.slice(1):e;if(6===t.length){const e=parseInt(t.slice(0,2),16),n=parseInt(t.slice(2,4),16),i=parseInt(t.slice(4,6),16);if(!isNaN(e)&&!isNaN(n)&&!isNaN(i))return{r:e,g:n,b:i}}}const i=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);if(i){const e=parseInt(i[1],10),t=parseInt(i[2],10),n=parseInt(i[3],10);if(!isNaN(e)&&!isNaN(t)&&!isNaN(n))return{r:e,g:t,b:n}}return null}function parseContactsFile(e){const t=[],n=e.split("\n");for(const e of n){const n=e.trim();if(!n||n.startsWith("#"))continue;const i=n.split(/\s+/);if(i.length>=3){const e=parseInt(i[0],10),n=parseInt(i[1],10),o=parseFloat(i[2]);if(!isNaN(e)&&!isNaN(n)&&!isNaN(o)&&o>0){const a=[e,n,o];if(i.length>=4){const e=parseContactColor(i.slice(3).join(" "));e&&a.push(e)}t.push(a);continue}}if(i.length>=5){const e=i[0],n=parseInt(i[1],10),o=i[2],a=parseInt(i[3],10),r=parseFloat(i[4]);if(!isNaN(n)&&!isNaN(a)&&!isNaN(r)&&r>0){const s=[e,n,o,a,r];if(i.length>=6){const e=parseContactColor(i.slice(5).join(" "));e&&s.push(e)}t.push(s)}}}return t}async function addMetadataToExistingObject({msaFiles:e,jsonFiles:t,contactFiles:n,loadMSA:i,loadPAE:o}){if(!viewerApi||!viewerApi.renderer)return setStatus("No viewer available. Please load a structure first.",!0),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1};const a=viewerApi.renderer,r=document.getElementById("objectSelect"),s=r&&r.value?r.value:a.currentObjectName;if(!s||!a.objectsData[s])return setStatus("No object selected. Please load a structure first.",!0),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1};const c=a.objectsData[s];let l=[];if(o&&t.length>0)for(const e of t)try{const t=await e.readAsync("text"),n=JSON.parse(t);if(!n.objects){const t=extractPaeFromJSON(n);if(t){for(const e of c.frames)e.pae=t;const n=a.currentFrame;a.setFrame(n),l.push(`PAE from ${e.name}`)}}}catch(t){console.warn(`Failed to process PAE file ${e.name}:`,t)}if(i&&e.length>0){const t=extractChainSequences(c.frames[0]),n=[];for(const t of e)try{const e=await t.readAsync("text"),i=t.name.toLowerCase(),o=i.endsWith(".a3m"),a=i.endsWith(".fasta")||i.endsWith(".fa")||i.endsWith(".fas"),r=i.endsWith(".sto");if(!o&&!a&&!r)continue;let s=null;o&&window.MSAViewer&&window.MSAViewer.parseA3M?s=window.MSAViewer.parseA3M(e):a&&window.MSAViewer&&window.MSAViewer.parseFasta?s=window.MSAViewer.parseFasta(e):r&&window.MSAViewer&&window.MSAViewer.parseSTO&&(s=window.MSAViewer.parseSTO(e)),s&&s.querySequence&&n.push({msaData:s,filename:t.name})}catch(e){console.warn(`Failed to process MSA file ${t.name}:`,e)}if(n.length>0){const{chainToMSA:e,msaToChains:i}=matchMSAsToChains(n,t),o=storeMSADataInObject(c,e,i);if(o&&o.availableChains.length>0){const e=o.chainToSequence[o.defaultChain];if(e&&o.msasBySequence[e]){const{msaData:t}=o.msasBySequence[e];window.MSAViewer&&(loadMSADataIntoViewer(t,o.defaultChain,s),l.push(`MSA for ${o.availableChains.length} chain(s)`))}}}}if(n.length>0)for(const e of n)try{const t=parseContactsFile(await e.readAsync("text"));if(t.length>0){c.contacts=t,a.cachedSegmentIndices=null;const n=a.currentFrame;a.setFrame(n),l.push(`${t.length} contact(s) from ${e.name}`)}else{setStatus(`Warning: No valid contacts found in ${e.name}. Expected format: "0 30 1.0" or "A 10 B 50 0.5" (weight required). Optional color: "0 30 1.0 red" or "A 10 B 50 0.5 yellow". Lines starting with # are comments.`,!0)}}catch(t){setStatus(`Error processing contacts file ${e.name}: ${t.message}`,!0)}return l.length>0?setStatus(`Added to ${s}: ${l.join(", ")}`):setStatus("No metadata could be added to the current object.",!0),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1}}function buildPendingObject(e,t,n,i,o){let a,r=null,s=null,c=null,l=null,d=null,u=null;try{const n=!(!window.viewerConfig||!window.viewerConfig.ui?.biounit),i=/^\s*data_/m.test(e)||/_atom_site\./.test(e);let o;if(i?(o=parseCIF(e),a=o.models,c=o.loops,s=o.chemCompMap,d=o.structConn,u=o.chemCompBondMap):(o=parsePDB(e),a=o.models,r=o.modresMap,l=o.conectMap),!a||0===a.length||a.every(e=>0===e.length))throw new Error(`Could not parse any models or atoms from ${t}.`);if(n&&a.length>0){const t=i?/_pdbx_struct_(assembly_gen|oper_list)\./.test(e):/REMARK 350/.test(e),n=t?extractBiounitOperations(e,i,c):null;n&&n.length>0&&(a=a.map(e=>applyBiounitOperationsToAtoms(e,n)))}}catch(e){return console.error("Parsing failed:",e),setStatus(`Error: ${e.message}`,!0),0}let m=0;const f=document.getElementById("loadAsFramesCheckbox"),w=document.getElementById("alignFramesCheckbox"),h=(!!f&&f.checked,!!w&&w.checked),p=o.findIndex(e=>e.name===i);let S;if(p>=0)S=o[p];else{const e=pendingObjects.findIndex(e=>e.name===i);e>=0&&pendingObjects.splice(e,1),S={name:i,frames:[]},o.push(S)}const g=f.checked||S.frames.length>0||a.length>1;function A(e){if(window.viewerConfig?.ui?.loadLigands??!1)return e;const t=new Map;for(const n of e){if(!n)continue;const e=`${n.chain}:${n.resSeq}:${n.resName}`;t.has(e)||t.set(e,{resName:n.resName,record:n.record,chain:n.chain,resSeq:n.resSeq,atoms:[]}),t.get(e).atoms.push(n)}const n=Array.from(t.values());n.sort((e,t)=>e.chain!==t.chain?e.chain.localeCompare(t.chain):e.resSeq-t.resSeq);return e.filter(e=>{if(!e)return!1;if("HETATM"!==e.record)return!0;const i=`${e.chain}:${e.resSeq}:${e.resName}`,o=t.get(i);if(!o)return!1;const a=isRealAminoAcid(o,r,s,n),c=isRealNucleicAcid(o,r,s,n);return a||null!==c})}const y=[];let v;for(let e=0;e<a.length;e++){if(!f.checked&&e>0){const t=`${i}_model_${e+1}`;S=o.find(e=>e.name===t)||null,S||(S={name:t,frames:[]},o.push(S))}const t=convertParsedToFrameData(a[e],r,s,!0,l,d,u),c=new Map;for(const t of a[e]){if(!t||"HOH"===t.resName)continue;const e=`${t.chain}:${t.resSeq}:${t.resName}`;c.has(e)||c.set(e,{resName:t.resName,record:t.record,chain:t.chain,resSeq:t.resSeq,atoms:[]}),c.get(e).atoms.push(t)}const m=Array.from(c.values());m.sort((e,t)=>e.chain!==t.chain?e.chain.localeCompare(t.chain):e.resSeq-t.resSeq);const w=[],h=new Map;if(t.position_types&&t.position_names&&t.residue_numbers)for(let e=0;e<t.position_types.length;e++){const n=t.position_types[e],i=t.position_names[e],o=t.residue_numbers[e],a=(t.chains?t.chains[e]:"")+":"+o+":"+i,l=c.get(a);if(l){let e=h.get(a);if(!e){e={is_protein:isRealAminoAcid(l,r,s,m),nucleicType:isRealNucleicAcid(l,r,s,m)},h.set(a,e)}w.push(!e.is_protein&&null===e.nucleicType)}else w.push("L"===n)}else w.push(...t.position_types?t.position_types.map(e=>"L"===e):Array(t.coords.length).fill(!1));const p=A(a[e]);a[e].length,p.length;let g,b=convertParsedToFrameData(p,r,s,!1,l,d,u);if(0===b.coords.length)continue;if(n){if(!(!window.viewerConfig||void 0===window.viewerConfig.ui?.loadLigands||window.viewerConfig.ui.loadLigands)&&w.length>0){w.filter(e=>e).length;const e=!!n.buffer,t=e?Math.sqrt(n.length):n.length,i=w.length;if(t===i)b.pae=filterPAEForLigands(n,w);else if(t<i){let i=0;for(let e=0;e<t;e++)w[e]&&i++;if(i>0){const e=w.slice(0,t);b.pae=filterPAEForLigands(n,e)}else b.pae=e?n.slice():n.map(e=>[...e])}else if(console.warn(`PAE matrix size (${t}) is larger than frame data size (${i}). Truncating and filtering...`),e){const e=new n.constructor(i*i);for(let o=0;o<i;o++)for(let a=0;a<i;a++)e[o*i+a]=n[o*t+a];b.pae=filterPAEForLigands(e,w)}else{const e=n.slice(0,i).map(e=>e.slice(0,i));b.pae=filterPAEForLigands(e,w)}}else b.pae=n&&n.buffer?n.slice():n.map(e=>[...e])}else b.pae=null;if(b.bonds&&b.bonds.length>0)g=b.bonds;else if(0===e){if(b.position_types&&b.position_types.some(e=>"L"===e)){const e=extractLigandBondsFromAtoms(p,b);e&&e.length>0&&(g=e)}}const C={coords:b.coords.map(e=>[...e]),chains:b.chains?[...b.chains]:void 0,position_types:b.position_types?[...b.position_types]:void 0,plddts:b.plddts?[...b.plddts]:void 0,position_names:b.position_names?[...b.position_names]:void 0,residue_numbers:b.residue_numbers?[...b.residue_numbers]:void 0,pae:b.pae};(0===e||void 0!==g&&g!==v)&&void 0!==g&&(C.bonds=g),void 0!==g&&(v=g),y.push(C)}if(0===y.length)return setStatus(`Warning: Found models, but no backbone atoms in ${t}.`,!0),0;if(g&&h){const e=(S.frames.length>0?S.frames:y)[0];if(e&&y.length>0){let t=null;if(e.chains&&e.chains.length>0)for(let n=0;n<e.chains.length;n++){const i=e.chains[n];if(i&&""!==i.trim()){t=i;break}}const n=[];if(null!==t)for(let i=0;i<e.coords.length;i++)e.chains&&e.chains[i]===t&&n.push([...e.coords[i]]);else for(let t=0;t<e.coords.length;t++)n.push([...e.coords[t]]);for(let e=0;e<y.length;e++){const o=y[e],a=[];if(null!==t)for(let e=0;e<o.coords.length;e++)o.chains&&o.chains[e]===t&&a.push([...o.coords[e]]);else for(let e=0;e<o.coords.length;e++)a.push([...o.coords[e]]);if(n.length>0&&a.length>0&&n.length===a.length)try{const e=align_a_to_b(o.coords,a,n);for(let t=0;t<o.coords.length;t++)o.coords[t][0]=e[t][0],o.coords[t][1]=e[t][1],o.coords[t][2]=e[t][2]}catch(t){console.error(`Alignment failed for frame ${S.frames.length+e+1} of ${i}:`,t),setStatus(`Warning: Alignment failed for frame ${S.frames.length+e+1} in ${i}. See console.`,!0)}else n.length!==a.length&&console.warn(`Alignment skipped for frame ${S.frames.length+e+1} of ${i}: chain length mismatch (reference: ${n.length}, frame: ${a.length})`)}}}let b=null;if(y.length>0&&y[0].chains&&y[0].chains.length>0)for(let e=0;e<y[0].chains.length;e++){const t=y[0].chains[e];if(t&&""!==t.trim()){b=t;break}}for(let e=0;e<y.length;e++){const t=y[e],n=[];if(null!==b)for(let e=0;e<t.coords.length;e++)t.chains&&t.chains[e]===b&&n.push(t.coords[e]);else for(let e=0;e<t.coords.length;e++)n.push(t.coords[e]);if(n.length>0){const e=[0,0,0];for(const t of n)e[0]+=t[0],e[1]+=t[1],e[2]+=t[2];e[0]/=n.length,e[1]/=n.length,e[2]/=n.length;for(const n of t.coords)n[0]-=e[0],n[1]-=e[1],n[2]-=e[2]}}for(const e of y)S.frames.push(e),m++;return 0===m&&setStatus(`Warning: Found models, but no backbone atoms in ${t}.`,!0),m}function applyPendingObjects(){const e=document.getElementById("viewer-container"),t=document.getElementById("sequence-viewer-container"),n=document.getElementById("objectSelect"),i=viewerApi?.renderer;if(!viewerApi||0===pendingObjects.length)return e&&(e.style.display="none"),void setStatus("Ready. Upload a file or fetch an ID.");const o=i?{object:i.currentObjectName,frame:"number"==typeof i.currentFrame?i.currentFrame:null}:null,a=new Set(Object.keys(i?.objectsData||{})),r=[];i&&(i._batchLoading=!0);for(const e of pendingObjects)if(e&&e.frames&&0!==e.frames.length){if(a.has(e.name)){if(i.objectSelect){const t=i.objectSelect.querySelector(`option[value="${e.name}"]`);t&&t.remove()}if(n){const t=n.querySelector(`option[value="${e.name}"]`);t&&t.remove()}i.objectsData[e.name]&&delete i.objectsData[e.name],a.delete(e.name)}i.addObject(e.name),r.push(e.name);for(const t of e.frames)i.addFrame(t,e.name);if(i&&e.msa&&i.objectsData[e.name]&&(i.objectsData[e.name].msa=e.msa),i&&e.contacts&&i.objectsData[e.name]&&(i.objectsData[e.name].contacts=e.contacts,i.cachedSegmentIndices=null,i.currentObjectName===e.name)){const e=i.currentFrame;i.setFrame(e)}}if(pendingObjects.length>0){const n=e?.querySelector("#canvasContainer"),o=e?.querySelector("#canvas");if(n&&o&&i){const e=window.getComputedStyle(n),t=parseInt(e.width)||600,a=parseInt(e.height)||600;if(t>0&&a>0){o.style.width=t+"px",o.style.height=a+"px";const e=window.devicePixelRatio||1;o.width=t*e,o.height=a*e;o.getContext("2d").scale(e,e),i._updateCanvasDimensions?.()}}e&&(e.style.display="flex"),t&&(t.style.display="block")}if(i&&(i._batchLoading=!1),r.length>0){const e=r[r.length-1];i?._switchToObject&&i._switchToObject(e),i?.objectSelect&&(i.objectSelect.value=e),n&&(n.value=e),i?.updatePAEContainerVisibility&&i.updatePAEContainerVisibility(),i?.updateScatterContainerVisibility&&i.updateScatterContainerVisibility(),"function"==typeof updateObjectNavigationButtons&&updateObjectNavigationButtons(),window.SequenceViewer?.clearPreview&&window.SequenceViewer.clearPreview(),"function"==typeof buildSequenceView&&buildSequenceView(),window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex(),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility(),i?.updateUIControls&&i.updateUIControls(),i?.setFrame&&i.setFrame(0,!0),"function"==typeof applyBestViewRotation&&applyBestViewRotation(!1)}else o?.object&&i?.objectsData?.[o.object]?(i?._switchToObject&&i._switchToObject(o.object),"number"==typeof o.frame&&i?.setFrame&&i.setFrame(o.frame),i?.render&&i.render(),i?.objectSelect&&(i.objectSelect.value=o.object),n&&(n.value=o.object),i?.updatePAEContainerVisibility&&i.updatePAEContainerVisibility(),"function"==typeof updateObjectNavigationButtons&&updateObjectNavigationButtons(),window.SequenceViewer?.clearPreview&&window.SequenceViewer.clearPreview(),"function"==typeof buildSequenceView&&buildSequenceView(),window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex(),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility()):(setStatus("Error: No valid structures were loaded to display.",!0),e&&(e.style.display="none"))}function updateChainSelectionUI(){const e=viewerApi?.renderer,t=e?.currentObjectName;if(!e||!t)return;const n=e.objectsData?.[t];if(!n?.frames?.length)return;const i=e.objectsData?.[t]?.selectionState;i&&("default"!==i.selectionMode||i.positions&&i.positions.size>0||i.chains&&i.chains.size>0||i.paeBoxes&&i.paeBoxes.length>0)||("function"==typeof e.resetToDefault?e.resetToDefault():"function"==typeof e.setSelection&&e.setSelection({selectionMode:"default",positions:new Set,chains:new Set}))}function setChainResiduesSelected(e,t){if(!viewerApi?.renderer)return;const n=viewerApi.renderer.getSelection(),i=viewerApi.renderer.currentObjectName;if(!i)return;const o=viewerApi.renderer.objectsData[i];if(!o?.frames?.length)return;const a=o.frames[0];if(!a?.residue_numbers||!a?.chains)return;const r=new Set(a.chains);let s=new Set(n.chains);0===s.size&&"default"===n.selectionMode&&(s=new Set(r));const c=new Set(s),l=new Set(n.positions);if(t){c.add(e);for(let t=0;t<a.chains.length;t++)a.chains[t]===e&&l.add(t)}else{c.delete(e);for(let t=0;t<a.chains.length;t++)a.chains[t]===e&&l.delete(t)}const d=c.size===r.size&&Array.from(c).every(e=>r.has(e)),u=l.size>0&&l.size<a.chains.length,m=d&&!u&&l.size>0?"default":"explicit",f=d&&!u&&l.size>0?new Set:c;viewerApi.renderer.setSelection({chains:f,positions:l,selectionMode:m,paeBoxes:[]})}function toggleChainResidues(e){if(!viewerApi?.renderer)return;const t=viewerApi.renderer.currentObjectName;if(!t)return;const n=viewerApi.renderer.objectsData[t];if(!n?.frames?.length)return;const i=n.frames[0];if(!i?.chains)return;const o=viewerApi.renderer.getSelection(),a=[];for(let t=0;t<i.chains.length;t++)i.chains[t]===e&&a.push(t);const r=a.length>0&&a.every(e=>o.positions.has(e)),s=new Set(o.positions);a.forEach(e=>{r?s.delete(e):s.add(e)});const c=new Set;for(const e of s){const t=i.chains[e];t&&c.add(t)}const l=s.size>0&&s.size<i.chains.length;viewerApi.renderer.setSelection({positions:s,chains:c,selectionMode:l?"explicit":"default",paeBoxes:[]})}function syncChainPillsToSelection(){updateSequenceViewSelectionState()}function applySelection(e=null){if(!viewerApi||!viewerApi.renderer)return;if(!viewerApi.renderer.currentObjectName)return void(viewerApi.renderer.resetSelection?viewerApi.renderer.resetSelection():(viewerApi.renderer.visibilityMask=null,viewerApi.renderer.render()));const t=viewerApi.renderer.getSelection();let n=t?.chains||new Set;"default"!==t?.selectionMode||t.chains&&0!==t.chains.size||viewerApi.renderer.chains&&(n=new Set(viewerApi.renderer.chains));const i=null!==e?e:t.positions;viewerApi.renderer.setSelection({positions:i,chains:n})}function highlightPosition(e){viewerApi&&viewerApi.renderer&&(viewerApi.renderer.highlightedAtom=e,viewerApi.renderer.highlightedAtoms=null,window.SequenceViewer&&window.SequenceViewer.drawHighlights&&window.SequenceViewer.drawHighlights())}function highlightPositions(e){viewerApi&&viewerApi.renderer&&(viewerApi.renderer.highlightedAtoms=e instanceof Set?e:new Set(e),viewerApi.renderer.highlightedAtom=null,window.SequenceViewer&&window.SequenceViewer.drawHighlights&&window.SequenceViewer.drawHighlights())}function clearHighlight(){viewerApi&&viewerApi.renderer&&(viewerApi.renderer.highlightedAtom=null,viewerApi.renderer.highlightedAtoms=null,window.SequenceViewer&&window.SequenceViewer.drawHighlights&&window.SequenceViewer.drawHighlights())}function showAllResidues(){viewerApi?.renderer&&viewerApi.renderer.resetToDefault()}function hideAllResidues(){viewerApi?.renderer&&viewerApi.renderer.clearSelection()}function clearAllObjects(){pendingObjects=[];const e=document.getElementById("viewer-container"),t=document.getElementById("sequence-viewer-container"),n=document.getElementById("msa-buttons");if(e&&(e.style.display="none"),t&&(t.style.display="none"),n&&(n.style.display="none"),window.MSAViewer&&window.MSAViewer.clear)try{window.MSAViewer.clear()}catch(e){console.error("Failed to clear MSA viewer:",e)}if(viewerApi&&viewerApi.renderer)try{viewerApi.renderer.resetAll(),setStatus("Ready. Upload a file or fetch an ID.")}catch(e){console.error("Failed to reset viewer:",e),setStatus("Error: Failed to reset viewer. See console.",!0)}else if(viewerApi&&viewerApi.renderer)try{viewerApi.renderer.resetAll(),setStatus("Ready. Upload a file or fetch an ID.")}catch(e){console.error("Failed to reset viewer:",e),setStatus("Error: Failed to reset viewer. See console.",!0)}else setStatus("Ready. Upload a file or fetch an ID.")}if(document.addEventListener("DOMContentLoaded",()=>{document.getElementById("viewer-container")&&initializeApp()}),window.SequenceViewer){function initializeHighlightOverlayIfNeeded(){if(viewerApi?.renderer&&window.SequenceViewer&&window.SequenceViewer.drawHighlights){viewerApi.renderer.canvas&&window.SequenceViewer.drawHighlights()}}window.SequenceViewer.setCallbacks({getRenderer:()=>viewerApi?.renderer||null,getObjectSelect:()=>document.getElementById("objectSelect"),toggleChainResidues:toggleChainResidues,setChainResiduesSelected:setChainResiduesSelected,highlightAtom:highlightPosition,highlightAtoms:highlightPositions,clearHighlight:clearHighlight,applySelection:applySelection}),viewerApi?.renderer&&initializeHighlightOverlayIfNeeded()}function initializeMSAViewerCommon(){document.getElementById("msa-buttons");const e=document.getElementById("msaModeSelect"),t=document.getElementById("coverageSlider"),n=document.getElementById("coverageValue"),i=document.getElementById("identitySlider"),o=document.getElementById("identityValue");if(t&&n){if(window.MSAViewer&&window.MSAViewer.getCoverageCutoff){const e=window.MSAViewer.getCoverageCutoff();t.value=Math.round(100*e),n.textContent=Math.round(100*e)+"%"}else t.value=75,n.textContent="75%";const e=()=>{const e=parseInt(t.value);n.textContent=e+"%";const i=e/100;if(window.MSAViewer?.setCoverageCutoff)try{window.MSAViewer.setCoverageCutoff(i),p&&p()}catch(e){console.error("Error applying coverage filter:",e)}};t.addEventListener("input",()=>{const e=parseInt(t.value);n.textContent=e+"%"}),t.addEventListener("mouseup",e),t.addEventListener("touchend",e),t.addEventListener("change",e)}if(i&&o){if(window.MSAViewer&&window.MSAViewer.getIdentityCutoff){const e=window.MSAViewer.getIdentityCutoff();i.value=Math.round(100*e),o.textContent=Math.round(100*e)+"%"}else i.value=15,o.textContent="15%";const e=()=>{const e=parseInt(i.value);o.textContent=e+"%";const t=e/100;if(window.MSAViewer?.setIdentityCutoff)try{window.MSAViewer.setIdentityCutoff(t),p&&p()}catch(e){console.error("Error applying identity filter:",e)}};i.addEventListener("input",()=>{const e=parseInt(i.value);o.textContent=e+"%"}),i.addEventListener("mouseup",e),i.addEventListener("touchend",e),i.addEventListener("change",e)}const a=document.getElementById("msaSortContainer"),r=document.getElementById("msaSortCheckbox"),s=document.getElementById("logoBitScoreContainer"),c=document.getElementById("logoBitScoreCheckbox"),l=document.getElementById("msaSaveContainer"),d=document.getElementById("logoSaveContainer"),u=document.getElementById("pssmSaveContainer"),m=document.getElementById("msaSaveFastaButton"),f=document.getElementById("logoSaveSvgButton"),w=document.getElementById("pssmSaveSvgButton"),h=document.getElementById("pssmSaveCsvButton");if(l&&(l.style.display="flex"),d&&(d.style.display="none"),u&&(u.style.display="none"),a&&(a.style.display="flex"),e&&window.MSAViewer){const t=window.MSAViewer.getMSAMode?window.MSAViewer.getMSAMode():"msa";e.value=t,e.addEventListener("change",e=>{const t=e.target.value;window.MSAViewer&&window.MSAViewer.setMSAMode(t),a&&(a.style.display="msa"===t?"flex":"none"),s&&(s.style.display="logo"===t?"flex":"none"),l&&(l.style.display="msa"===t?"flex":"none"),d&&(d.style.display="logo"===t?"flex":"none"),u&&(u.style.display="pssm"===t?"flex":"none")}),s&&(s.style.display="logo"===t?"flex":"none")}function p(){const e=document.getElementById("msaSequenceCount");if(e&&window.MSAViewer&&window.MSAViewer.getSequenceCounts){const t=window.MSAViewer.getSequenceCounts();t&&t.total>0?e.textContent=`${t.filtered} / ${t.total}`:e.textContent="-"}}return m&&window.MSAViewer&&m.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),window.MSAViewer.saveMSAAsFasta&&window.MSAViewer.saveMSAAsFasta()}),f&&window.MSAViewer&&f.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),window.MSAViewer.saveLogoAsSvg&&window.MSAViewer.saveLogoAsSvg()}),w&&window.MSAViewer&&w.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),window.MSAViewer.savePSSMAsSvg&&window.MSAViewer.savePSSMAsSvg()}),h&&window.MSAViewer&&h.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),window.MSAViewer.savePSSMAsCsv&&window.MSAViewer.savePSSMAsCsv()}),r&&r.addEventListener("change",e=>{window.MSAViewer&&window.MSAViewer.setSortSequences(e.target.checked)}),c&&window.MSAViewer&&(c.checked=!window.MSAViewer.getUseBitScore||window.MSAViewer.getUseBitScore(),c.addEventListener("change",e=>{const t=e.target.checked;window.MSAViewer.setUseBitScore&&window.MSAViewer.setUseBitScore(t)})),window.updateMSASequenceCount=p,{updateMSASequenceCount:p}}async function loadStandaloneMSA(e){const t=e.name.toLowerCase(),n=t.endsWith(".a3m"),i=t.endsWith(".fasta")||t.endsWith(".fa")||t.endsWith(".fas"),o=t.endsWith(".sto");if(n||i||o)try{const t=await e.readAsync("text");let a=null;if(n&&window.MSAViewer&&window.MSAViewer.parseA3M?a=window.MSAViewer.parseA3M(t):i&&window.MSAViewer&&window.MSAViewer.parseFasta?a=window.MSAViewer.parseFasta(t):o&&window.MSAViewer&&window.MSAViewer.parseSTO&&(a=window.MSAViewer.parseSTO(t)),!a||!a.querySequence)throw setStatus("Failed to parse MSA file",!0),new Error("Failed to parse MSA file");{window.MSAViewer.setMSAData(a,null),setStatus(`Loaded MSA: ${a.sequences.length} sequences, length ${a.queryLength}`);const e=document.getElementById("msaSequenceCount");if(e&&window.MSAViewer&&window.MSAViewer.getSequenceCounts){const t=window.MSAViewer.getSequenceCounts();t&&(e.textContent=`${t.filtered} / ${t.total}`)}const t=document.getElementById("msa-buttons");t&&(t.style.display="block"),showMSACanvasContainers()}}catch(e){throw console.error("Error loading MSA:",e),setStatus("Error loading MSA file: "+e.message,!0),e}else setStatus("Please upload an A3M (.a3m), FASTA (.fasta, .fa, .fas), or STO (.sto) file",!0)}async function resolvePDBToUniProt(e){setStatus(`Looking up UniProt ID for PDB ${e}...`);try{const t=await fetchPDBeMappings(e),n=Object.values(t).map(e=>e.uniprot_id).filter(e=>e);if(0===n.length)throw new Error(`No UniProt mapping found for PDB ID ${e}`);const i=n[0];return setStatus(`Found UniProt ID ${i} for PDB ${e}`),i}catch(e){throw console.error("Error fetching PDBe mappings:",e),e}}async function fetchMSAFromAlphaFold(e,t=null){setStatus(`Fetching MSA for ${e} from AlphaFold DB...`);const n=`https://alphafold.ebi.ac.uk/files/msa/AF-${e}-F1-msa_v6.a3m`,i=await fetch(n);if(!i.ok){if(404===i.status){throw new Error(`MSA not found for ${t?`PDB ${t} (UniProt ${e})`:`UniProt ID ${e}`}. The structure may not be available in AlphaFold DB.`)}throw new Error(`Failed to fetch MSA (HTTP ${i.status})`)}const o=await i.text();if(!o||0===o.trim().length)throw new Error("Empty MSA file received");return o}function initializeMSAViewerIndex(){const e=initializeMSAViewerCommon(),{updateMSASequenceCount:t}=e,n=document.getElementById("msaChainSelect"),i=document.getElementById("msa-buttons");if(n&&window.MSAViewer&&viewerApi?.renderer){function o(){const e=viewerApi.renderer.currentObjectName;if(!e)return void(n.style.display="none");const t=viewerApi.renderer.objectsData[e];if(t&&t.frames&&0!==t.frames.length)if(t.msa&&t.msa.msasBySequence&&t.msa.chainToSequence){const e={},i=t.msa.msaToChains||{};if(Object.keys(i).length>0){for(const[t,n]of Object.entries(i))if(n&&n.length>0){const i=n.sort().join("");e[i]={chains:n.sort(),querySeq:t}}}else for(const[n,i]of Object.entries(t.msa.msasBySequence)){const i=[];for(const[e,o]of Object.entries(t.msa.chainToSequence||{}))o===n&&i.push(e);if(i.length>0){const t=i.sort().join("");e[t]={chains:i.sort(),querySeq:n}}}const o=Object.keys(e).sort();if(o.length>1||1===o.length&&e[o[0]].chains.length>1){n.innerHTML="",o.forEach(t=>{const i=document.createElement("option");i.value=t;const o=e[t].chains;i.textContent=o.length>1?o.join(""):o[0],n.appendChild(i)});const i=t.msa.defaultChain||t.msa.availableChains&&t.msa.availableChains[0];if(i){const t=o.find(t=>e[t].chains.includes(i));n.value=t||o[0]}else n.value=o[0];n.style.display="block"}else n.style.display="none"}else n.style.display="none";else n.style.display="none"}n.addEventListener("change",e=>{const t=e.target.value;if(!t)return;const n=viewerApi.renderer.currentObjectName;if(!n)return;const i=viewerApi.renderer.objectsData[n];if(i&&i.msa&&i.msa.msasBySequence&&i.msa.chainToSequence){const e=t[0];if(e&&i.msa.chainToSequence[e]){const t=i.msa.chainToSequence[e],n=i.msa.msasBySequence[t];if(n){const{msaData:t}=n;window.MSAViewer.setMSAData(t,e),i.msa.defaultChain=e;const o=viewerApi.renderer.currentFrame||0;viewerApi.renderer._loadFrameData(o,!1)}}}}),window.updateMSAChainSelectorIndex=o,o()}function a(){if(!i)return;const e=viewerApi?.renderer?.currentObjectName;if(!e)return void(i.style.display="none");const t=viewerApi.renderer.objectsData[e];if(!t)return i.style.display="none",void clearMSAViewerState();if(!t.msa)return i.style.display="none",void clearMSAViewerState();let n=null,o=null,a=!1;if(t.msa.msasBySequence&&t.msa.chainToSequence&&t.msa.availableChains){const e=t.msa.defaultChain||(t.msa.availableChains.length>0?t.msa.availableChains[0]:null);if(e&&t.msa.chainToSequence[e]){const i=t.msa.chainToSequence[e],r=t.msa.msasBySequence[i];r&&(n=r.msaData,o=e,a=!!n)}}a&&n&&window.MSAViewer?(clearMSAViewerState(),i.style.display="block",i.offsetWidth,loadMSADataIntoViewer(n,o,e),applySelectionToMSA(),refreshEntropyColors()):(i.style.display="none",clearMSAViewerState())}if(viewerApi&&viewerApi.renderer&&(window.updateMSAContainerVisibility=a,a()),window.MSAViewer&&window.MSAViewer.setMSAData){const r=window.MSAViewer.setMSAData;r._indexHtmlWrapped||(window.MSAViewer.setMSAData=function(e,n){r.call(this,e,n),t()},window.MSAViewer.setMSAData._indexHtmlWrapped=!0),t()}}const isIndexHTML=null!==document.getElementById("fetch-id")&&null===document.getElementById("fetch-uniprot-id");function buildSequenceView(){window.SequenceViewer&&window.SequenceViewer.buildSequenceView()}function updateSequenceViewColors(){window.SequenceViewer&&window.SequenceViewer.updateSequenceViewColors()}function updateSequenceViewSelectionState(){window.SequenceViewer&&window.SequenceViewer.updateSequenceViewSelectionState()}async function handleFetch(){const e=[],t=document.getElementById("fetch-id").value.trim().toUpperCase();if(!t)return void setStatus("Please enter a PDB or UniProt ID.",!0);setStatus(`Fetching ${t} data...`);const n=4===t.length,i=!n;let o,a,r,s;const c=document.getElementById("loadPAECheckbox"),l=document.getElementById("loadMSACheckbox"),d=!c||c.checked,u=!!l&&l.checked;i?(r=`${t}.cif`,o=`https://alphafold.ebi.ac.uk/files/AF-${t}-F1-model_v6.cif`,a=`https://alphafold.ebi.ac.uk/files/AF-${t}-F1-predicted_aligned_error_v6.json`,s=window.viewerConfig.pae?.enabled&&d):(r=`${t}.cif`,o=`https://files.rcsb.org/download/${t}.cif`,a=null,s=!1);try{const c=await fetch(o);if(!c.ok)throw new Error(`Failed to fetch structure (HTTP ${c.status})`);const l=await c.text();let m=null;if(s&&a&&d)try{const e=await fetch(a);if(e.ok){const t=await e.json();m=extractPaeFromJSON(t)}else console.warn(`PAE data not found (HTTP ${e.status}).`)}catch(e){console.warn("Could not fetch PAE data:",e.message)}const f=buildPendingObject(l,r,m,cleanObjectName(r),e);if(pendingObjects.push(...e),applyPendingObjects(),n&&window.MSAViewer&&u)try{setStatus(`Fetching UniProt mappings for ${t}...`);const n=await fetchPDBeMappings(t);if(0===Object.keys(n).length)setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Note: No UniProt mappings found for this PDB structure.`);else{const t=cleanObjectName(r),i=viewerApi?.renderer;if(i&&i.objectsData&&i.objectsData[t]){const o=i.objectsData[t];if(o&&o.frames&&o.frames.length>0){const i=o.frames[0],a=extractChainSequences(i);if(Object.keys(a).length>0){const r=[],s=[],c={};for(let e=0;e<i.chains.length;e++){const t=i.chains[e];if("P"!==(i.position_types?i.position_types[e]:"P"))continue;const n=i.residue_numbers?i.residue_numbers[e]:null,o=null==n?null:Number(n),a=Number.isFinite(o)?o:null;c[t]||(c[t]={sequence:"",residueNumbers:[]});const r=i.position_names[e],s=RESIDUE_TO_AA[r?.toUpperCase()]||"X";c[t].sequence+=s,c[t].residueNumbers.push(a)}for(const[e,t]of Object.entries(n)){if(!t.uniprot_id)continue;const n=t.uniprot_id,i=c[e];if(!i||!i.sequence){console.warn(`No PDB sequence found for chain ${e}`);continue}const o=i.sequence,a=i.residueNumbers;s.push(fetchMSAFromAlphaFold(n).then(async i=>{if(!i||0===i.trim().length)return console.warn(`Empty MSA file for UniProt ID ${n} (chain ${e})`),null;const r=window.MSAViewer.parseA3M(i);if(!r||!r.querySequence)return console.warn(`Failed to parse MSA for UniProt ID ${n} (chain ${e})`),null;const s=trimMSAToPDB(r,o,t,a);return{chainId:e,msaData:s,filename:`AF-${n}-F1-msa_v6.a3m`}}).catch(t=>(console.warn(`Error fetching MSA for chain ${e} (UniProt ${n}):`,t),null)))}const l=await Promise.all(s);for(const e of l)e&&r.push({msaData:e.msaData,filename:e.filename});if(r.length>0){const{chainToMSA:n,msaToChains:i}=matchMSAsToChains(r,a);if(Object.keys(n).length>0){const a=storeMSADataInObject(o,n,i);if(a&&a.availableChains.length>0){const n=a.chainToSequence[a.defaultChain],{msaData:i}=a.msasBySequence[n],o=a.defaultChain,r=pendingObjects.find(e=>e.name===t);r&&(r.msa={msasBySequence:a.msasBySequence,chainToSequence:a.chainToSequence,availableChains:a.availableChains,defaultChain:a.defaultChain,msaToChains:a.msaToChains});const s=document.getElementById("msa-buttons");s&&(s.style.display="block"),s&&s.offsetWidth,loadMSADataIntoViewer(i,o,t),setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). MSA loaded for ${a.availableChains.length} chain(s).`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Warning: MSA sequences did not match any chains.`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Warning: Could not match MSAs to chains.`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Note: No MSAs available for mapped UniProt IDs.`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Warning: Could not extract chain sequences for MSA matching.`)}}}}catch(t){console.warn("PDBe mappings/MSA download failed:",t),setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Note: Could not load MSAs (${t.message}).`)}if(i&&window.MSAViewer&&u)try{const n=`https://alphafold.ebi.ac.uk/files/msa/AF-${t}-F1-msa_v6.a3m`;setStatus(`Fetching MSA for ${t}...`);const i=await fetch(n);if(i.ok){const n=await i.text();if(n&&n.trim().length>0){const i=window.MSAViewer.parseA3M(n);if(i&&i.querySequence){const n=cleanObjectName(r),o=viewerApi?.renderer;if(o&&o.objectsData&&o.objectsData[n]){const a=o.objectsData[n];if(a&&a.frames&&a.frames.length>0){const o=extractChainSequences(a.frames[0]);if(Object.keys(o).length>0){const r=[{msaData:i,filename:`AF-${t}-F1-msa_v6.a3m`}],{chainToMSA:s,msaToChains:c}=matchMSAsToChains(r,o);if(Object.keys(s).length>0){const t=storeMSADataInObject(a,s,c);if(t&&t.availableChains.length>0){const i=t.chainToSequence[t.defaultChain],{msaData:o}=t.msasBySequence[i],a=t.defaultChain,r=pendingObjects.find(e=>e.name===n);r&&(r.msa={msasBySequence:t.msasBySequence,chainToSequence:t.chainToSequence,availableChains:t.availableChains,defaultChain:t.defaultChain,msaToChains:t.msaToChains});const s=document.getElementById("msa-buttons");s&&(s.style.display="block"),s&&s.offsetWidth,window.MSAViewer.setMSAData(o,a),viewerApi?.renderer&&n&&viewerApi.renderer._mapEntropyToStructure(n),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility(),window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex(),setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). MSA loaded for chain ${a}.`)}}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Warning: MSA sequence did not match any chain.`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Warning: Could not extract chain sequences for MSA matching.`)}}}}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Warning: MSA file was empty.`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Note: MSA not available for this structure.`)}catch(t){console.warn("MSA download failed:",t),setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}). Note: Could not download MSA (${t.message}).`)}else setStatus(`Successfully fetched and loaded ${e.length} object(s) (${f} total frame${1!==f?"s":""}).`)}catch(e){console.error("Fetch failed:",e),setStatus(`Error: Fetch failed for ${t}. ${e.message}.`,!0)}}isIndexHTML&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeMSAViewerIndex):initializeMSAViewerIndex());const RESIDUE_TO_AA={ALA:"A",ARG:"R",ASN:"N",ASP:"D",CYS:"C",GLU:"E",GLN:"Q",GLY:"G",HIS:"H",ILE:"I",LEU:"L",LYS:"K",MET:"M",PHE:"F",PRO:"P",SER:"S",THR:"T",TRP:"W",TYR:"Y",VAL:"V",SEC:"U",PYL:"O",MSE:"M",HSD:"H",HSE:"H",HID:"H",HIE:"H",HIP:"H"};function extractChainSequences(e){if(!e||!e.chains||!e.position_names)return{};const t={},n={};for(let t=0;t<e.chains.length;t++){const i=e.chains[t],o=e.position_names[t],a=e.residue_numbers?e.residue_numbers[t]:t;"P"===(e.position_types?e.position_types[t]:"P")&&(n[i]||(n[i]=[]),n[i].push({positionName:o,residueNum:a}))}for(const e of Object.keys(n)){const i=n[e];i.sort((e,t)=>e.residueNum-t.residueNum);const o=i.map(e=>{const t=(e.positionName||"").toString().trim().toUpperCase();let n=t;return"function"==typeof getStandardResidueName&&(n=getStandardResidueName(t).toUpperCase()),RESIDUE_TO_AA[n]||"X"}).join("");o.length>0&&(t[e]=o)}return t}function sequencesMatch(e,t){if(!e||!t)return!1;const n=e.toUpperCase(),i=t.toUpperCase();if(n===i)return!0;const o=Math.min(n.length,i.length),a=Math.max(n.length,i.length);return!(a>0&&(a-o)/a>.1)&&(n.length<=i.length?i.includes(n):n.includes(i))}function storeMSADataInObject(e,t,n){if(!e||!t||0===Object.keys(t).length)return null;e.msa||(e.msa={msasBySequence:{},chainToSequence:{},availableChains:[],defaultChain:null,msaToChains:{}});const i=e.msa;i.msaToChains=n;for(const[e,{msaData:o}]of Object.entries(t)){const t=o.querySequence.toUpperCase();i.msasBySequence[t]||(i.msasBySequence[t]={msaData:o,chains:n[t]||[]}),i.chainToSequence[e]=t,i.availableChains.includes(e)||i.availableChains.push(e)}return i.availableChains.length>0&&!i.defaultChain&&(i.defaultChain=i.availableChains[0]),i}function loadMSADataIntoViewer(e,t,n,i={}){if(!window.MSAViewer||!e)return;const{updateChainSelector:o=!0}=i;window.MSAViewer.setMSAData(e,t);const a=window.MSAViewer.getMSAData();if(a&&(a.frequencies=null,a.entropy=null,a.logOdds=null,computeMSAProperties(a)),o&&window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex(),window.updateMSASequenceCount&&window.updateMSASequenceCount(),showMSACanvasContainers(),n&&a){const{coverageCutoff:e,identityCutoff:i}=getCurrentMSAFilters();applyFiltersToAllMSAs(n,{coverageCutoff:e,identityCutoff:i,activeChainId:t,activeFilteredMSAData:a})}refreshEntropyColors()}function computeMSAProperties(e,t=null){if(!e||!e.sequences||0===e.sequences.length)return;const n=e.queryLength,i=e.sequences.length;!t&&e.selectionMask&&(t=e.selectionMask);const o=e.frequencies||[],a=["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V"];if(!e.frequencies){const t=new Array(i),r=new Uint16Array(i);for(let n=0;n<i;n++){const i=e.sequences[n].sequence;t[n]=i,r[n]=i.length}if(!e.frequencies)for(let e=0;e<n;e++)o.push({});const s=new Int8Array(128);s.fill(-1),s[65]=0,s[97]=0,s[82]=1,s[114]=1,s[78]=2,s[110]=2,s[68]=3,s[100]=3,s[67]=4,s[99]=4,s[81]=5,s[113]=5,s[69]=6,s[101]=6,s[71]=7,s[103]=7,s[72]=8,s[104]=8,s[73]=9,s[105]=9,s[76]=10,s[108]=10,s[75]=11,s[107]=11,s[77]=12,s[109]=12,s[70]=13,s[102]=13,s[80]=14,s[112]=14,s[83]=15,s[115]=15,s[84]=16,s[116]=16,s[87]=17,s[119]=17,s[89]=18,s[121]=18,s[86]=19,s[118]=19;const c=[];for(let e=0;e<n;e++){const n=new Uint32Array(20);let o=0;for(let a=0;a<i;a++)if(e<r[a]){const i=t[a].charCodeAt(e);if(45!==i&&88!==i&&120!==i){const e=s[i];e>=0&&(n[e]++,o++)}}const l={},d=o>0?1/o:0;for(let e=0;e<20;e++)if(n[e]>0){const t=n[e]*d;l[a[e]]=t}c.push(l)}e.frequencies=c}if(e.frequencies&&!e.entropy){const t=Math.log2(20),n=[];for(let i=0;i<e.frequencies.length;i++){const o=e.frequencies[i];if(!o){n.push(0);continue}let a=0;for(const e in o){const t=o[e];t>0&&(a-=t*Math.log2(t))}const r=a/t;n.push(r)}e.entropy=n}}function mergeMSAs(e){if(!e||0===e.length)return null;if(1===e.length)return computeMSAProperties(e[0].msaData),e[0].msaData;const t=e[0].msaData,n={querySequence:t.querySequence,queryLength:t.queryLength,sequences:[...t.sequences],filenames:e.map(e=>e.filename||"").filter(e=>e)},i=new Set;for(const e of n.sequences){const t=(e.sequence||"").replace(/-/g,"").toUpperCase();t&&i.add(t)}for(let t=1;t<e.length;t++){const{msaData:o}=e[t];if(o&&o.sequences)for(const e of o.sequences){const t=(e.sequence||"").replace(/-/g,"").toUpperCase();t&&!i.has(t)&&(i.add(t),n.sequences.push(e))}}return computeMSAProperties(n),n}function matchMSAsToChains(e,t){const n={},i={};for(const{msaData:o,filename:a}of e){if(!o||!o.querySequence)continue;const e=o.querySequence.toUpperCase(),r=[];for(const[i,s]of Object.entries(t))sequencesMatch(e,s)&&(n[i]||(n[i]=[]),n[i].push({msaData:o,filename:a}),r.push(i));if(r.length>0){i[e]||(i[e]=[]);for(const t of r)i[e].includes(t)||i[e].push(t)}}const o={};for(const[e,t]of Object.entries(n))if(t.length>1){const n=mergeMSAs(t);n&&(o[e]={msaData:n})}else 1===t.length&&(computeMSAProperties(t[0].msaData),o[e]={msaData:t[0].msaData});const a={};for(const[e,{msaData:t}]of Object.entries(o)){const n=t.querySequence.toUpperCase();a[n]||(a[n]=[]),a[n].includes(e)||a[n].push(e)}return{chainToMSA:o,msaToChains:a}}async function fetchPDBeMappings(e){const t=e.toLowerCase(),n=`https://www.ebi.ac.uk/pdbe/api/mappings/uniprot/${t}/`;try{const e=await fetch(n);if(!e.ok){if(404===e.status)throw new Error(`PDBe mappings not found for PDB ID ${t.toUpperCase()}`);throw new Error(`Failed to fetch PDBe mappings (HTTP ${e.status})`)}const i=(await e.json())[t];if(!i||!i.UniProt)return{};const o=Object.entries(i.UniProt);if(0===o.length)return{};const a={};for(const[e,t]of o)if(t.mappings&&Array.isArray(t.mappings))for(const n of t.mappings){const t=n.struct_asym_id;if(!t)continue;if(a[t]){if(a[t].uniprot_id!==e){console.warn(`Chain ${t} already mapped to ${a[t].uniprot_id}, skipping ${e}`);continue}}else a[t]={uniprot_id:e,pdb_to_uniprot:{},uniprot_to_pdb:{}};const i=n.start.residue_number,o=n.end.residue_number,r=n.unp_start,s=n.unp_end;if(null==i||null==o||null==r||null==s){console.warn(`Invalid mapping range for chain ${t}:`,n);continue}const c=o-i+1,l=s-r+1,d=Math.min(c,l);for(let e=0;e<d;e++){const n=i+e,o=r+e,s=String(n);a[t].pdb_to_uniprot[s]||(a[t].pdb_to_uniprot[s]=o),a[t].uniprot_to_pdb[o]||(a[t].uniprot_to_pdb[o]=n)}}return a}catch(e){throw console.error(`Error fetching PDBe mappings for ${t.toUpperCase()}:`,e),e}}function trimMSAToPDB(e,t,n,i=null){if(!e||!e.querySequence||!t)return e;const o=e.querySequence.toUpperCase(),a=t.toUpperCase();if(o===a)return e;const r={};if(n&&n.pdb_to_uniprot&&Object.keys(n.pdb_to_uniprot).length>0){const o={};for(let t=0;t<e.querySequence.length;t++){o[t+1]=t}if(i&&i.length===t.length)for(let e=0;e<t.length;e++){const t=i[e];if(null==t||"number"==typeof t&&!Number.isFinite(t))continue;const a=String(t),s=n.pdb_to_uniprot[a];if(void 0!==s){const t=o[s];void 0!==t&&(r[e]=t)}}else for(const[e,i]of Object.entries(n.pdb_to_uniprot)){const n=parseInt(e);if(!isNaN(n)){const e=n-1;if(e>=0&&e<t.length){const t=o[i];void 0!==t&&(r[e]=t)}}}}else{const n=o.indexOf(a),i=a.indexOf(o);let s=0,c=0;n>=0?(s=n,c=0):i>=0?(s=0,c=i):(s=0,c=0);let l=s,d=c;for(let n=0;n<e.querySequence.length&&d<t.length;n++)"-"!==e.querySequence[n]&&(l<o.length&&d<a.length&&(o[l]===a[d]||Math.abs(l-s-(d-c))<5)&&(r[d]=n,d++),l++)}const s=[],c=[];for(let n=0;n<t.length;n++){const i=r[n];if(void 0!==i&&i<e.querySequence.length){e.querySequence[i];c.push(t[n]);for(let t=0;t<e.sequences.length;t++){s[t]||(s[t]={...e.sequences[t],sequence:[]});const n=i<e.sequences[t].sequence.length?e.sequences[t].sequence[i]:"-";s[t].sequence.push(n)}}else{c.push(t[n]);for(let t=0;t<e.sequences.length;t++)s[t]||(s[t]={...e.sequences[t],sequence:[]}),s[t].sequence.push("-")}}const l=s.map(e=>({...e,sequence:e.sequence.join("")})),d=c.join(""),u=void 0!==e.queryIndex?e.queryIndex:0;l.length>0?u>=0&&u<l.length?l[u].sequence=d:l.unshift({name:l[0]?.name?.toLowerCase().includes("query")?l[0].name:"query",sequence:d,identity:1,coverage:1}):l.push({name:"query",sequence:d,identity:1,coverage:1});const m=d.length;for(const e of l)if(e.name.toLowerCase().includes("query"))e.identity=1,e.coverage=1;else{let t=0,n=0;for(let i=0;i<e.sequence.length&&i<d.length;i++){const o=e.sequence[i].toUpperCase(),a=d[i].toUpperCase();"-"!==o&&"X"!==o&&"-"!==a&&"X"!==a&&(n++,o===a&&t++)}e.identity=n>0?t/n:0;let i=0;for(let t=0;t<e.sequence.length;t++)"-"!==e.sequence[t]&&"X"!==e.sequence[t]&&i++;e.coverage=m>0?i/m:0}return{querySequence:d,queryLength:d.length,sequences:l,queryIndex:u>=0&&u<l.length?u:0}}function applySelectionToMSA(){if(!viewerApi?.renderer||!window.MSAViewer)return;const e=viewerApi.renderer,t=e.currentObjectName;if(!t)return;const n=e.objectsData[t];if(!n||!n.frames||0===n.frames.length)return;if(!n.msa||!n.msa.msasBySequence||!n.msa.chainToSequence)return;const i=n.frames[e.currentFrame>=0?e.currentFrame:0];if(!i||!i.chains)return;const o=e.getSelection();let a=new Set;const r=o&&"explicit"===o.selectionMode;if(o&&o.positions&&o.positions.size>0?a=new Set(o.positions):null!==e.visibilityMask&&e.visibilityMask.size>0&&(a=new Set(e.visibilityMask)),r&&0===a.size)return n.msa.selectedPositions=new Map,void(window.MSAViewer&&window.MSAViewer.updateMSAViewSelectionState&&window.MSAViewer.updateMSAViewSelectionState());if(0===a.size)return n.msa.selectedPositions=null,void(window.MSAViewer&&window.MSAViewer.updateMSAViewSelectionState&&window.MSAViewer.updateMSAViewSelectionState());let s;s=o&&o.chains&&o.chains.size>0?o.chains:new Set(e.chains);const c=new Map;for(const[e,t]of Object.entries(n.msa.chainToSequence)){if(!s.has(e))continue;const o=n.msa.msasBySequence[t];if(!o||!o.msaData)continue;const r=o.msaData.querySequence,l=extractChainSequences(i)[e];if(!l)continue;const d=[],u=i.chains.length;for(let t=0;t<u;t++)i.chains[t]===e&&i.position_types&&"P"===i.position_types[t]&&d.push(t);if(0===d.length)continue;d.sort((e,t)=>(i.residue_numbers?i.residue_numbers[e]:e)-(i.residue_numbers?i.residue_numbers[t]:t));const m=r.toUpperCase(),f=l.toUpperCase(),w=Math.min(m.length,f.length,d.length),h=new Set;for(let e=0;e<w;e++)if(m[e]===f[e]){const t=d[e];a.has(t)&&h.add(e)}h.size>0&&c.set(e,h)}n.msa.selectedPositions=c,window.MSAViewer&&window.MSAViewer.updateMSAViewSelectionState&&window.MSAViewer.updateMSAViewSelectionState()}async function processFiles(e,t,n=null){const i=[];let o=0,a=0;const r=[],s=[],c=[],l=[],d=[];for(const t of e){const e=t.name.toLowerCase();t.name.startsWith("__MACOSX/")||t.name.startsWith("._")||(e.endsWith(".py2dmol.json")?c.push(t):e.endsWith(".json")?s.push(t):e.match(/\.(cif|pdb|ent)$/)?r.push(t):e.endsWith(".a3m")||e.endsWith(".fasta")||e.endsWith(".fa")||e.endsWith(".fas")||e.endsWith(".sto")?l.push(t):e.endsWith(".cst")&&d.push(t))}const u=document.getElementById("loadPAECheckbox"),m=document.getElementById("loadMSACheckbox"),f=!u||u.checked,w=!!m&&m.checked,h=l.length>0&&(0===r.length||w)?l:[];let p=[];if(s.length>0){const e=s.map(async e=>{try{const t=await e.readAsync("text");return{file:e,text:t,error:null}}catch(t){return console.warn(`Failed to read JSON file ${e.name}:`,t),{file:e,text:null,error:t}}});p=await Promise.all(e)}const S=new Map,g=p.map(({file:e,text:t,error:n})=>new Promise(async i=>{if(!n&&t){try{const n=fastExtractPaeFromText(t);if(n){const t=e.name.replace(/\.json$/i,"");S.set(t,{data:n,is_pae_extracted:!0})}else{const n=JSON.parse(t);if(n.objects&&Array.isArray(n.objects))c.push(e);else{const t=e.name.replace(/\.json$/i,"");S.set(t,n)}}}catch(t){console.warn(`Failed to parse JSON file ${e.name}:`,t)}i()}else i()}));if(await Promise.all(g),c.length>0)try{const e=c[0],t=await e.readAsync("text"),n=JSON.parse(t);if(n.objects&&Array.isArray(n.objects))return await loadViewerState(n),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1}}catch(e){return console.error("Failed to load state file:",e),setStatus(`Error loading state file: ${e.message}`,!0),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1}}if(0===r.length){const e=document.getElementById("viewer-container"),t=e&&"none"===window.getComputedStyle(e).display;if((w&&l.length>0||f&&s.length>0||d.length>0)&&!t){return await addMetadataToExistingObject({msaFiles:w?l:[],jsonFiles:f?s:[],contactFiles:d,loadMSA:w,loadPAE:f})}}if(0===r.length&&h.length>0){const e=document.getElementById("viewer-container");if(e&&"none"===window.getComputedStyle(e).display&&1===h.length){const e=h[0];return await loadStandaloneMSA(e),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1}}return setStatus("MSA-only uploads are not supported on this page. Please use msa.html for standalone MSAs.",!0),{objectsLoaded:0,framesAdded:0,structureCount:0,paePairedCount:0,isTrajectory:!1}}if(0===r.length)throw new Error("No structural files (*.cif, *.pdb, *.ent) found.");function A(e,t){let n=null,i=0;const o=e.split(/[-_]/);for(const[a,r]of t.entries()){const t=a.split(/[-_]/);let s=0;for(;s<o.length&&s<t.length&&o[s]===t[s];)s++;const c=a.includes("pae")||a.includes("full_data")||a.includes("scores")||a.includes("aligned_error")?1:0,l=e.match(/_model_(\d+)$/i),d=l?l[1]:null;let u=0;if(null!==d){const e=a.match(/_(?:full_data|data|model|pae)_(\d+)$/i);e&&e[1]===d&&(u=100)}const m=e.match(/_rank_(\d+)_/i),f=a.match(/_rank_(\d+)_/i);m&&f&&m[1]===f[1]&&(u+=50);const w=10*s+c+u;if(w>i){let e=!1;(r.pae||r.predicted_aligned_error||Array.isArray(r)&&r.length>0&&r[0].predicted_aligned_error)&&(e=!0),e&&(i=w,n=r)}}return n}for(const e of r)try{const s=await e.readAsync("text"),c=cleanObjectName(e.name),l=A(c,S);let d=null;l&&(d=l instanceof Uint8Array?l:extractPaeFromJSON(l),d&&a++);const u=t&&r.length>1?n||cleanObjectName(r[0].name):c;o+=buildPendingObject(s,e.name,d,u,i)}catch(t){console.error(`Error processing file ${e.name}:`,t),setStatus(`Error processing ${e.name}: ${t.message}`,!0)}if(d.length>0)for(const e of d)try{const t=parseContactsFile(await e.readAsync("text"));if(t.length>0){const n=e.name.replace(/\.cst$/i,"").toLowerCase(),o=i.find(e=>{const t=e.name.toLowerCase();return t.includes(n)||n.includes(t)||r.some(e=>{const t=e.name.replace(/\.(cif|pdb|ent)$/i,"").toLowerCase();return n.includes(t)||t.includes(n)})});if(o)o.contacts=t;else if(i.length>0){i[i.length-1].contacts=t}}}catch(t){setStatus(`Error processing contacts file ${e.name}: ${t.message}`,!0)}if(i.length>0&&pendingObjects.push(...i),applyPendingObjects(),h.length>0&&w){const e=viewerApi?.renderer?.currentObjectName||(viewerApi?.renderer?.objectsData&&Object.keys(viewerApi.renderer.objectsData).length>0?Object.keys(viewerApi.renderer.objectsData)[0]:null);if(e&&viewerApi?.renderer){const t=viewerApi.renderer.objectsData[e];if(t&&t.frames&&0!==t.frames.length){const n=extractChainSequences(t.frames[0]);if(0===Object.keys(n).length)setStatus("Warning: Could not extract sequences from structure. MSA matching skipped.",!0);else{const i=[];for(const e of h)try{const t=await e.readAsync("text"),n=window.MSAViewer?window.MSAViewer.parseA3M(t):null;n&&n.querySequence&&i.push({msaData:n,filename:e.name})}catch(t){console.error(`Failed to parse MSA file ${e.name}:`,t)}if(i.length>0){const{chainToMSA:o,msaToChains:a}=matchMSAsToChains(i,n),r=storeMSADataInObject(t,o,a);if(r&&r.availableChains.length>0){const t=r.chainToSequence[r.defaultChain];if(t&&r.msasBySequence[t]){const{msaData:n}=r.msasBySequence[t];window.MSAViewer&&(loadMSADataIntoViewer(n,r.defaultChain,e),setStatus(`Loaded MSAs: ${r.availableChains.length} chain(s) matched to ${Object.keys(r.msasBySequence).length} unique MSA(s)`),viewerApi?.renderer&&e&&viewerApi.renderer._mapEntropyToStructure(e),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility(),window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex())}}else setStatus("Warning: No chains matched to MSA sequences.",!0)}}}else setStatus("Warning: MSA files found but no structure loaded. MSA matching skipped.",!0)}}return{objectsLoaded:i.length,framesAdded:o,paePairedCount:a,structureCount:r.length,isTrajectory:t&&r.length>1}}async function handleZipUpload(e,t){setStatus(`Unzipping ${e.name} and collecting data...`);try{const n=new JSZip,i=await n.loadAsync(e),o=new Map;if(i.forEach((e,t)=>{if(e.startsWith("__MACOSX/")||e.startsWith("._")||t.dir)return;const n=e.replace(/^\/+|\/+$/g,""),i=n.split("/").pop();if(!i.toLowerCase().match(/\.(cif|pdb|ent|json|a3m)$/))return;const a=n.includes("/")?n.substring(0,n.lastIndexOf("/")):"",r={name:i,readAsync:e=>t.async(e)};o.has(a)||o.set(a,[]),o.get(a).push(r)}),0===o.size)throw new Error("No structural files (*.cif, *.pdb, *.ent) found.");const a=[];for(const[e,t]of o.entries()){const e=t.filter(e=>{const t=e.name.toLowerCase();return t.endsWith(".a3m")||t.endsWith(".fasta")||t.endsWith(".fa")||t.endsWith(".fas")||t.endsWith(".sto")});a.push(...e)}const r=o.get(""),s=[];if(r&&r.length>0)s.push("");else{const e=Array.from(o.keys()).filter(e=>""!==e).sort();s.push(...e)}if(0===s.length)throw new Error("No structural files (*.cif, *.pdb, *.ent) found.");let c=0,l=0,d=0,u=null;for(const n of s){const i=o.get(n).filter(e=>{const t=e.name.toLowerCase();return!(t.endsWith(".a3m")||t.endsWith(".fasta")||t.endsWith(".fa")||t.endsWith(".fas")||t.endsWith(".sto"))});if(0===i.length)continue;const a=n?cleanObjectName(n.split("/").pop()):cleanObjectName(e.name.replace(/\.zip$/i,""));if(""===n){const e=i.filter(e=>e.name.toLowerCase().endsWith(".json"));if(e.length>0)try{const t=await e[0].readAsync("text"),n=JSON.parse(t);if(n.objects&&Array.isArray(n.objects))return void await loadViewerState(n)}catch(e){}}const r=await processFiles(i,t,a);!u&&viewerApi?.renderer?.currentObjectName&&(u=viewerApi.renderer.currentObjectName),c+=r.isTrajectory?1:r.objectsLoaded,l+=r.framesAdded,d+=r.paePairedCount}if(a.length>0&&viewerApi?.renderer){const e=viewerApi.renderer.currentObjectName||u;if(e){const t=document.getElementById("loadMSACheckbox");if(!!t&&t.checked){const t=viewerApi.renderer.objectsData[e];if(t&&t.frames&&t.frames.length>0){const n=extractChainSequences(t.frames[0]);if(Object.keys(n).length>0){const i=[];for(const e of a)try{const t=await e.readAsync("text"),n=window.MSAViewer?window.MSAViewer.parseA3M(t):null;n&&n.querySequence&&i.push({msaData:n,filename:e.name})}catch(t){console.error(`Failed to parse MSA file ${e.name}:`,t)}if(i.length>0){const{chainToMSA:o,msaToChains:a}=matchMSAsToChains(i,n),r=storeMSADataInObject(t,o,a);if(r&&r.availableChains.length>0){const t=r.chainToSequence[r.defaultChain];if(t&&r.msasBySequence[t]){const{msaData:n}=r.msasBySequence[t];window.MSAViewer&&(loadMSADataIntoViewer(n,r.defaultChain,e),setStatus(`Loaded MSAs: ${r.availableChains.length} chain(s) matched to ${Object.keys(r.msasBySequence).length} unique MSA(s)`),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility(),window.updateMSAChainSelectorIndex&&window.updateMSAChainSelectorIndex())}}}}}else{const e=a[0];if(e)try{const t=await e.readAsync("text"),n=window.MSAViewer?window.MSAViewer.parseA3M(t):null;n&&window.MSAViewer&&(window.MSAViewer.setMSAData(n),setStatus(`Loaded MSA from ${e.name}. Load structure to match to chains.`))}catch(e){console.error("Failed to parse MSA file:",e)}}}else;}}const m=d>0?` (${d} PAE matrices paired)`:"";setStatus(`Successfully loaded ${c} new object(s) from ${e.name} (${l} total frame${1!==l?"s":""}${m}).`)}catch(t){console.error("ZIP processing failed:",t),setStatus(`Error processing ZIP file: ${e.name}. ${t.message}`,!0)}}function handleFileUpload(e){const t=e.target.files||(e.dataTransfer?e.dataTransfer.files:null);if(!t||0===t.length)return;const n=document.getElementById("loadAsFramesCheckbox").checked,i=[],o=[],a=[];for(const e of t)e.name.toLowerCase().endsWith(".zip")?i.push(e):e.name.toLowerCase().endsWith(".csv")?a.push(e):o.push({name:e.name,readAsync:t=>e.text()});if(setStatus(`Processing ${t.length} selected files...`),i.length>0)return handleZipUpload(i[0],n),void(i.length>1&&setStatus(`Loaded ${i[0].name}. Please upload one ZIP at a time.`,!0));o.length>0?(async()=>{try{const e=await processFiles(o,n);if(0===e.objectsLoaded&&0===e.framesAdded&&o.some(e=>e.name.toLowerCase().endsWith(".py2dmol.json")||e.name.toLowerCase().endsWith(".json")))return;const t=e.isTrajectory?1:e.objectsLoaded,i=o.length>1?`${o.length} files`:o[0].name,r=e.paePairedCount>0?` (${e.paePairedCount}/${e.structureCount} PAE matrices paired)`:"";setStatus(`Successfully loaded ${t} new object(s) from ${i} (${e.framesAdded} total frame${1!==e.framesAdded?"s":""}${r}).`),a.length>0&&processCSVFiles(a)}catch(e){console.error("Loose file processing failed:",e),setStatus(`Error processing loose files: ${e.message}`,!0)}})():a.length>0&&processCSVFiles(a)}function processCSVFiles(e){if(0===e.length)return;const t=e[0],n=new FileReader;n.onload=n=>{try{parseAndLoadScatterData(n.target.result),e.length>1?setStatus(`Loaded scatter data from ${t.name}. Additional CSV files ignored.`):setStatus(`Loaded scatter data from ${t.name}`)}catch(e){console.error("Error loading CSV:",e),setStatus(`Error loading CSV: ${e.message}`,!0)}},n.readAsText(t)}function initDragAndDrop(){const e=document.getElementById("global-drop-overlay");document.getElementById("file-upload");let t=0;document.body.addEventListener("dragenter",n=>{preventDefaults(n),0===t&&(e.style.display="flex"),t++},!1),document.body.addEventListener("dragleave",n=>{preventDefaults(n),t--,0!==t&&null!==n.relatedTargEt||(e.style.display="none")},!1),document.body.addEventListener("drop",n=>{preventDefaults(n),t=0,e.style.display="none";const i=n.dataTransfer;i.files.length>0&&handleFileUpload({target:{files:i.files}})},!1),document.body.addEventListener("dragover",preventDefaults,!1)}function preventDefaults(e){e.preventDefault(),e.stopPropagation()}function parseAndLoadScatterData(e){const t=e.trim().split("\n");if(t.length<2)throw new Error("CSV must have at least a header row and one data row");const n=t[0].split(",").map(e=>e.trim());if(n.length<2)throw new Error("CSV must have at least 2 columns");const i=n[0],o=n[1],a=[],r=[];for(let e=1;e<t.length;e++){const n=t[e].split(",").map(e=>e.trim());if(n.length<2)continue;const i=parseFloat(n[0]),o=parseFloat(n[1]);isNaN(i)||isNaN(o)||(a.push(i),r.push(o))}if(0===a.length)throw new Error("No valid data points found in CSV");const s=document.getElementById("scatterCanvas");if(!s)throw new Error("Scatter canvas not found");if(!scatterViewer&&viewerApi?.renderer&&(scatterViewer=new ScatterPlotViewer(s,viewerApi.renderer),viewerApi.renderer.setScatterRenderer(scatterViewer)),scatterViewer){scatterViewer.setData(a,r,i,o),s.style.display="block";const e=document.getElementById("scatterContainer");if(e&&(e.style.display="block"),viewerApi?.renderer?.currentObjectName){const e=viewerApi.renderer.objectsData[viewerApi.renderer.currentObjectName];if(e&&e.frames){for(let t=0;t<e.frames.length&&t<a.length;t++)e.frames[t].scatter=[a[t],r[t]];e.scatterConfig||(e.scatterConfig={}),e.scatterConfig.xlabel=i,e.scatterConfig.ylabel=o,viewerApi.renderer.scatterRenderer&&viewerApi.renderer.updateScatterData(viewerApi.renderer.currentObjectName)}else console.warn("[SCATTER CSV] Cannot store - currentObj or frames missing:",{currentObj:!!e,frames:e?.frames?.length})}window.viewerConfig&&(window.viewerConfig.scatter.enabled=!0,window.syncViewerConfig())}}function detectRedundantFields(e){if(!e||0===e.length)return{};const t={};for(const n of["chains","position_types","bonds"]){let i=null;for(const t of e)if(null!=t[n]){i=t[n];break}if(null==i)continue;e.every(e=>null==e[n]||JSON.stringify(e[n])===JSON.stringify(i))&&(t[n]=i)}return t}function saveViewerState(){if(!viewerApi||!viewerApi.renderer)return void setStatus("Error: No viewer data to save.",!0);const e=viewerApi.renderer;try{const t=[];for(const[n,i]of Object.entries(e.objectsData)){const o=[];for(const e of i.frames){const t={};e.coords&&(t.coords=e.coords.map(e=>e.map(e=>Math.round(100*e)/100))),e.plddts&&(t.plddts=e.plddts.map(e=>Math.round(e))),e.chains&&(t.chains=e.chains),e.position_types&&(t.position_types=e.position_types),e.residue_numbers&&(t.residue_numbers=e.residue_numbers),e.bonds&&(t.bonds=e.bonds),e.scatter&&(t.scatter=e.scatter),e.color&&(t.color=e.color),e.position_names&&(t.position_names=e.position_names.map(e=>"function"==typeof getStandardResidueName?getStandardResidueName(e):e)),e.pae&&(e.pae instanceof Uint8Array?t.pae=Array.from(e.pae):Array.isArray(e.pae)&&e.pae.length>0&&"number"==typeof e.pae[0]?t.pae=e.pae:Array.isArray(e.pae)&&e.pae.length>0&&Array.isArray(e.pae[0])&&(t.pae=e.pae.map(e=>e.map(e=>Math.round(10*e)/10)))),o.push(t)}const a=detectRedundantFields(o),r=[];for(const e of o){const t={...e};for(const e in a)null!=t[e]&&JSON.stringify(t[e])===JSON.stringify(a[e])&&delete t[e];r.push(t)}const s={name:n,frames:r,hasPAE:checkObjectHasPAE({frames:r})};if(Object.assign(s,a),i.msa&&i.msa.msasBySequence&&i.msa.chainToSequence&&i.msa.availableChains){s.msa={msasBySequence:{},chainToSequence:i.msa.chainToSequence,availableChains:i.msa.availableChains||[],defaultChain:i.msa.defaultChain||null,msaToChains:i.msa.msaToChains||{}};for(const[e,t]of Object.entries(i.msa.msasBySequence))t&&t.msaData&&(s.msa.msasBySequence[e]={msaData:{sequences:t.msaData.sequences,querySequence:t.msaData.querySequence,queryLength:t.msaData.queryLength,queryIndex:t.msaData.queryIndex},chains:t.chains||[]})}i.contacts&&Array.isArray(i.contacts)&&i.contacts.length>0&&(s.contacts=i.contacts);const c=i.scatterConfig;if(c&&(s.scatter_config=c),i.color&&(s.color=i.color),i.viewerState){const t=n===e.currentObjectName?e.viewerState:i.viewerState;s.viewerState={rotation:t.rotation,zoom:t.zoom,perspectiveEnabled:t.perspectiveEnabled,focalLength:t.focalLength,center:t.center,extent:t.extent,currentFrame:t.currentFrame}}t.push(s)}const n=document.getElementById("orthoSlider"),i=n?parseFloat(n.value):1,o=!window.viewerConfig||"boolean"!=typeof window.viewerConfig.rendering?.detect_cyclic||window.viewerConfig.rendering.detect_cyclic,a={current_object_name:e.currentObjectName,current_frame:e.viewerState.currentFrame,rotation_matrix:e.viewerState.rotation,zoom:e.viewerState.zoom,perspective_enabled:e.viewerState.perspectiveEnabled,focal_length:e.viewerState.focalLength,center:e.viewerState.center,extent:e.viewerState.extent,color_mode:e.colorMode||"auto",line_width:e.lineWidth||3,shadow_enabled:!1!==e.shadowEnabled,outline_mode:e.outlineMode||"full",colorblind_mode:e.colorblindMode||!1,pastel_level:e.pastelLevel||.25,detect_cyclic:o,ortho_slider_value:i,animation_speed:e.animationSpeed||100};if(window.MSAViewer){const t=window.MSAViewer.getMSAData?window.MSAViewer.getMSAData():null,n=Object.values(e.objectsData).some(e=>null!=e.msa);if(t||n){const e=window.MSAViewer.getCurrentChain?window.MSAViewer.getCurrentChain():null;e&&(a.msa_chain=e)}}const r={};for(const[t,n]of Object.entries(e.objectsData))n.selectionState&&(r[t]={positions:Array.from(n.selectionState.positions),chains:Array.from(n.selectionState.chains),pae_boxes:n.selectionState.paeBoxes.map(e=>({...e})),selection_mode:n.selectionState.selectionMode});const s={version:"2.0",config:window.viewerConfig,objects:t,viewer_state:a,selections_by_object:r},c=new Date,l=`py2dmol_state_${c.toISOString().replace(/[:.]/g,"-").slice(0,-5)}.json`,d=JSON.stringify(s,null,2),u=new Blob([d],{type:"application/json"}),m=URL.createObjectURL(u),f=document.createElement("a");f.href=m,f.download=l,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(m),setStatus(`State saved to ${l}`)}catch(e){console.error("Failed to save state:",e),setStatus(`Error saving state: ${e.message}`,!0)}}async function loadViewerState(e){if(!viewerApi||!viewerApi.renderer)return void setStatus("Error: Viewer not initialized.",!0);const t=viewerApi.renderer;try{t.clearAllObjects();const n=document.getElementById("viewer-container"),i=document.getElementById("sequence-viewer-container");if(n&&(n.style.display="flex"),i&&(i.style.display="block"),!(e.objects&&Array.isArray(e.objects)&&e.objects.length>0))return void setStatus("Error: No valid objects found in state file.",!0);for(const n of e.objects){if(!n.name||!n.frames||!Array.isArray(n.frames)||0===n.frames.length){console.warn("Skipping invalid object in state file:",n);continue}const e=n.chains,i=n.position_types,o=n.bonds,a=n.scatter_config;t.addObject(n.name),a&&(t.objectsData[n.name].scatterConfig=a);const r=t.isPlaying;t.isPlaying=!0;for(const a of n.frames){if(!a.coords||0===a.coords.length){console.warn("Skipping frame with no coordinates");continue}const r={coords:a.coords,chains:a.chains||e,position_types:a.position_types||i,plddts:a.plddts,pae:a.pae,scatter:a.scatter,position_names:a.position_names,residue_numbers:a.residue_numbers,bonds:a.bonds||o};t.addFrame(r,n.name)}if(t.isPlaying=r,n.msa&&(t.objectsData[n.name]||(t.objectsData[n.name]={}),n.msa.msasBySequence&&n.msa.chainToSequence&&n.msa.availableChains)){t.objectsData[n.name].msa={msasBySequence:{},chainToSequence:n.msa.chainToSequence||{},availableChains:n.msa.availableChains||[],defaultChain:n.msa.defaultChain||null,msaToChains:n.msa.msaToChains||{}};for(const[e,i]of Object.entries(n.msa.msasBySequence))if(i&&i.msaData){const o={sequences:i.msaData.sequences,querySequence:i.msaData.querySequence,queryLength:i.msaData.queryLength,queryIndex:void 0!==i.msaData.queryIndex?i.msaData.queryIndex:0};o.sequencesOriginal=i.msaData.sequencesOriginal||i.msaData.sequences,t.objectsData[n.name].msa.msasBySequence[e]={msaData:o,chains:i.chains||[]},"function"==typeof computeMSAProperties&&computeMSAProperties(o)}}n.contacts&&Array.isArray(n.contacts)&&n.contacts.length>0&&(t.objectsData[n.name]||(t.objectsData[n.name]={}),t.objectsData[n.name].contacts=n.contacts,t.cachedSegmentIndices=null),n.color&&(t.objectsData[n.name]||(t.objectsData[n.name]={}),t.objectsData[n.name].color=n.color),n.viewerState&&(t.objectsData[n.name]||(t.objectsData[n.name]={}),t.objectsData[n.name].viewerState={rotation:n.viewerState.rotation,zoom:n.viewerState.zoom,perspectiveEnabled:n.viewerState.perspectiveEnabled,focalLength:n.viewerState.focalLength,center:n.viewerState.center,extent:n.viewerState.extent,currentFrame:n.viewerState.currentFrame})}if(e.config&&(e.config.scatter&&(window.viewerConfig.scatter={enabled:e.config.scatter.enabled||!1,size:e.config.scatter.size||300,xlabel:e.config.scatter.xlabel||null,ylabel:e.config.scatter.ylabel||null,xlim:e.config.scatter.xlim||null,ylim:e.config.scatter.ylim||null}),e.config.pae&&(window.viewerConfig.pae={enabled:!1!==e.config.pae.enabled,size:e.config.pae.size||300}),window.syncViewerConfig()),window.viewerConfig?.scatter?.enabled){const e=document.getElementById("scatterCanvas");if(e&&t.currentObjectName){const n=t.objectsData[t.currentObjectName];if(n&&n.frames&&n.frames.length>0){const i=[],o=[];for(const e of n.frames)e.scatter&&Array.isArray(e.scatter)&&2===e.scatter.length?(i.push(e.scatter[0]),o.push(e.scatter[1])):(i.push(NaN),o.push(NaN));if(i.some(e=>!isNaN(e))){scatterViewer||(scatterViewer=new ScatterPlotViewer(e,t));const a=n.scatterConfig||{},r=a.xlabel||"X",s=a.ylabel||"Y",c=a.xlim||null,l=a.ylim||null;scatterViewer.setData(i,o,r,s),c&&Array.isArray(c)&&2===c.length&&(scatterViewer.xMin=c[0],scatterViewer.xMax=c[1]),l&&Array.isArray(l)&&2===l.length&&(scatterViewer.yMin=l[0],scatterViewer.yMax=l[1]),scatterViewer.render();const d=document.getElementById("scatterContainer");d&&(d.style.display="block"),e.style.display="block"}}}}if(e.viewer_state){const n=e.viewer_state;if(n.current_object_name&&t.objectsData[n.current_object_name])t.currentObjectName=n.current_object_name,t.objectSelect&&(t.objectSelect.value=n.current_object_name);else if(e.objects&&e.objects.length>0){const n=e.objects[0].name;t.currentObjectName=n,t.objectSelect&&(t.objectSelect.value=n)}if(n.rotation_matrix&&Array.isArray(n.rotation_matrix)&&(t.viewerState.rotation=n.rotation_matrix),"number"==typeof n.zoom&&(t.viewerState.zoom=n.zoom),"number"==typeof n.current_frame&&(t.viewerState.currentFrame=n.current_frame,t.currentFrame=n.current_frame),"boolean"==typeof n.perspective_enabled&&(t.viewerState.perspectiveEnabled=n.perspective_enabled),"number"==typeof n.focal_length&&(t.viewerState.focalLength=n.focal_length),void 0!==n.center&&null!==n.center&&(t.viewerState.center=n.center),"number"==typeof n.extent&&(t.viewerState.extent=n.extent),n.color_mode){if(["auto","chain","rainbow","plddt","deepmind","entropy"].includes(n.color_mode)){t.colorMode=n.color_mode;const e=document.getElementById("colorSelect");e&&(e.value=n.color_mode,t.colorsNeedUpdate=!0,t.plddtColorsNeedUpdate=!0,t.render())}}if("number"==typeof n.line_width){t.lineWidth=n.line_width;const e=document.getElementById("lineWidthSlider");e&&(e.value=n.line_width,e.dispatchEvent(new Event("input")))}if("boolean"==typeof n.shadow_enabled){t.shadowEnabled=n.shadow_enabled;const e=document.getElementById("shadowEnabledCheckbox");e&&(e.checked=n.shadow_enabled,e.dispatchEvent(new Event("change")))}if("string"==typeof n.outline_mode&&["none","partial","full"].includes(n.outline_mode)?(t.outlineMode=n.outline_mode,t.updateOutlineButtonStyle()):"boolean"==typeof n.outline_enabled&&(t.outlineMode=n.outline_enabled?"full":"none",t.updateOutlineButtonStyle()),"boolean"==typeof n.colorblind_mode){t.colorblindMode=n.colorblind_mode;const e=document.getElementById("colorblindCheckbox");e&&(e.checked=n.colorblind_mode,e.dispatchEvent(new Event("change")))}"number"==typeof n.pastel_level&&(t.pastelLevel=n.pastel_level);let i=!0;if(e.config&&"boolean"==typeof e.config.rendering?.detect_cyclic?i=e.config.rendering.detect_cyclic:"boolean"==typeof n.detect_cyclic&&(i=n.detect_cyclic),window.viewerConfig&&(window.viewerConfig.rendering||(window.viewerConfig.rendering={}),window.viewerConfig.rendering.detect_cyclic=i),t.cachedSegmentIndices=null,"number"==typeof n.ortho_slider_value){const e=document.getElementById("orthoSlider");if(e){let t=n.ortho_slider_value;t>1&&(t=(t-50)/150),t=Math.max(0,Math.min(1,t)),e.value=t,e.dispatchEvent(new Event("input"))}}else if("number"==typeof n.focal_length){const e=document.getElementById("orthoSlider");if(e){const i=t.currentObjectName?t.objectsData[t.currentObjectName]:null,o=i&&i.maxExtent>0?i.maxExtent:30,a=n.focal_length/o;let r=.5;a>=20?r=1:a>=1.5&&(r=(a-1.5)/18.5),r=Math.max(0,Math.min(1,r)),e.value=r,e.dispatchEvent(new Event("input"))}}"number"==typeof n.animation_speed&&(t.animationSpeed=n.animation_speed)}if(e.selections_by_object)for(const[n,i]of Object.entries(e.selections_by_object))if(t.objectsData[n]){t.objectsData[n].selectionState||(t.objectsData[n].selectionState={positions:new Set,chains:new Set,paeBoxes:[],selectionMode:"default"});let e=new Set;void 0!==i.positions&&Array.isArray(i.positions)&&(e=new Set(i.positions.filter(e=>"number"==typeof e&&e>=0))),t.objectsData[n].selectionState={positions:e,chains:new Set(i.chains||[]),paeBoxes:i.pae_boxes||[],selectionMode:i.selection_mode||"default"}}setTimeout(()=>{try{if(!t.currentObjectName&&e.objects&&e.objects.length>0){const n=e.objects[0].name;t.currentObjectName=n,t.objectSelect&&(t.objectSelect.value=n)}if(t.currentObjectName&&t.objectsData[t.currentObjectName]?.selectionState&&t._switchToObject(t.currentObjectName),t.currentObjectName&&t.objectsData[t.currentObjectName]){const n=t.objectsData[t.currentObjectName];if(n.frames&&n.frames.length>0){if(e.viewer_state){const i=e.viewer_state,o="number"==typeof i.current_frame&&i.current_frame>=0&&i.current_frame<n.frames.length?i.current_frame:0;t.setFrame(o)}else t.setFrame(0);if(t.paeRenderer&&n.frames&&n.frames.length>0){const e=t.currentFrame>=0?t.currentFrame:0,i=n.frames[e];i&&i.pae&&t.paeRenderer.setData(i.pae)}t.updateScatterContainerVisibility&&t.updateScatterContainerVisibility(),buildSequenceView(),updateObjectNavigationButtons();const i=t.objectsData[t.currentObjectName];if(i&&i.msa&&i.msa.msasBySequence&&i.msa.chainToSequence){let n=null;if(n=e.viewer_state&&e.viewer_state.msa_chain?e.viewer_state.msa_chain:i.msa.defaultChain||i.msa.availableChains[0],n&&i.msa.chainToSequence[n]){const e=i.msa.chainToSequence[n],o=i.msa.msasBySequence[e];o&&o.msaData&&window.MSAViewer&&loadMSADataIntoViewer(o.msaData,n,t.currentObjectName)}}t.objectSelect&&handleObjectChange(),window.updateMSAContainerVisibility&&window.updateMSAContainerVisibility(),t.render(),setStatus("State loaded successfully.")}else setStatus("Error: Object has no frames.",!0)}else setStatus("Error: Could not set current object.",!0),console.error("Current object:",t.currentObjectName,"Available objects:",Object.keys(t.objectsData))}catch(e){console.error("Error in setTimeout during state load:",e),setStatus(`Error loading state: ${e.message}`,!0)}},100)}catch(e){console.error("Failed to load state:",e),setStatus(`Error loading state: ${e.message}`,!0)}}window.extractChainSequences=extractChainSequences,window.saveViewerState=saveViewerState;